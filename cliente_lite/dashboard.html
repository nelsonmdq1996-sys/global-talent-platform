<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Talent - Panel RRHH</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configuraci√≥n de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. React & ReactDOM & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons (Librer√≠a Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        body {
            background-color: #020617; /* slate-950 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ADAPTADOR DE ICONOS LUCIDE (VERSI√ìN FINAL ROBUSTA) ---
const LucideIcon = ({ name, size = 24, className, ...props }) => {
    // 1. Intentamos buscar el icono tal cual viene (Ej: "UserPlus")
    let iconData = lucide.icons[name];

    // 2. Si no existe, probamos convertirlo a kebab-case (Ej: "user-plus")
    if (!iconData) {
        const iconNameKebab = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
        iconData = lucide.icons[iconNameKebab];
    }

    // 3. Si sigue sin existir, no renderizamos nada (evita errores)
    if (!iconData) {
        console.warn(`Icono no encontrado: ${name}`);
        return null;
    }

    return (
        <svg
            {...props}
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={`lucide lucide-${name.toLowerCase()} ${className || ''}`}
        >
            {iconData.map((child, index) => {
                const [tagName, attrs] = child;
                return React.createElement(tagName, { ...attrs, key: index });
            })}
        </svg>
    );
};

        // Lista de iconos requeridos (Agregu√© 'Sparkles' para el an√°lisis)
        const iconList = [
            'LayoutDashboard', 'Users', 'FileText', 'HelpCircle', 'Settings', 
            'Search', 'CheckCircle', 'XCircle', 'ChevronRight', 'Filter', 
            'Clock', 'Calendar', 'FileJson', 'RefreshCw', 'Send', 'UserPlus', 
            'Video', 'ExternalLink', 'AlertTriangle', 'MessageSquare', 'ArrowRight',
            'Briefcase', 'Lock', 'UserCheck', 'Loader2', 'Trash2', 'Undo2', 'MoreVertical',
            'CheckSquare', 'Printer', 'Eye', 'Mail', 'Activity', 'Server', 'Database', 'Globe',
            'ThumbsUp', 'ThumbsDown', 'Link', 'Download', 'Share2', 'History',
            'BarChart2', 'List', 'Sparkles'
        ];

        const Icons = {};
        iconList.forEach(name => {
            Icons[name] = (props) => <LucideIcon name={name} {...props} />;
        });

        Icons.LinkIcon = Icons.Link;

        const { 
            LayoutDashboard, Users, FileText, HelpCircle, Settings, 
            Search, CheckCircle, XCircle, ChevronRight, Filter, 
            Clock, Calendar, FileJson, RefreshCw, Send, UserPlus, 
            Video, ExternalLink, AlertTriangle, MessageSquare, ArrowRight,
            Briefcase, Lock, UserCheck, Loader2, Trash2, Undo2, MoreVertical,
            CheckSquare, Printer, Eye, Mail, Activity, Server, Database, Globe,
            ThumbsUp, ThumbsDown, LinkIcon, Download, Share2, History,
            BarChart2, List, Sparkles
        } = Icons;

        // --- 1. ARQUITECTURA DE DATOS (CEREBRO) ---

        const MOCK_DB = [
        { 
            id: 'c1', 
            nombre: 'Sofia Mart√≠nez', 
            email: 'sofia.m@example.com', 
            puesto: 'Asistente de Marketing', 
            ia_score: 94, 
            fecha: '2023-10-24T10:00:00Z', 
            stage: 'stage_1', 
            status_interno: 'new', // Esto activa la alerta de "Nuevo"
            cv_url: '#', 
            video_url: '#', 
            notes: 'Experiencia s√≥lida en Meta Ads. Perfil interesante.', 
            alerts: ['Ingl√©s C1', 'Certificada Google'],
            history: [
                { date: '2023-10-24T10:00:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Zoho Forms' }
            ]
        },
        { 
            id: 'c2', 
            nombre: 'Lucas Ramirez', 
            email: 'lucas.r@example.com', 
            puesto: 'Asistente IA', 
            ia_score: 88, 
            fecha: '2023-10-24T09:30:00Z', 
            stage: 'stage_1', 
            status_interno: 'viewed', 
            cv_url: '#', 
            video_url: null, 
            notes: '', 
            alerts: ['Experto en Zapier'],
            history: [
                { date: '2023-10-24T09:30:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Zoho Forms' },
                { date: '2023-10-24T11:00:00Z', event: 'Revisi√≥n Inicial', detail: 'Abierto por Admin' }
            ]
        },
        { 
            id: 'c3', 
            nombre: 'Mariana Lopez', 
            email: 'mariana.l@example.com', 
            puesto: 'Asistente Financiero', 
            ia_score: 91, 
            fecha: '2023-10-22T14:00:00Z', 
            stage: 'stage_2', 
            status_interno: 'interview_scheduled', 
            assignedTo: 'Admin', 
            interview_date: '2023-10-26T10:00:00Z', 
            meet_link: 'https://meet.google.com/abc-defg-hij',
            cv_url: '#', 
            video_url: 'https://loom.com/share/demo', 
            form2_received: false, 
            form2_sent: false,
            qualified: null, 
            notes: 'Pre-calificada correctamente. Agendar t√©cnica.',
            history: [
                { date: '2023-10-22T14:00:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Web' },
                { date: '2023-10-23T09:00:00Z', event: 'Aprobado a Gesti√≥n', detail: 'Por Admin' },
                { date: '2023-10-23T10:30:00Z', event: 'Entrevista Agendada', detail: 'Para 26/10' }
            ]
        },
        { 
            id: 'c4', 
            nombre: 'Javier Costa', 
            email: 'javier.c@example.com', 
            puesto: 'Desarrollador Web', 
            ia_score: 75, 
            fecha: '2023-10-20T11:00:00Z', 
            stage: 'trash', 
            status_interno: 'discarded', 
            cv_url: '#', 
            notes: 'Salario fuera de rango', 
            alerts: ['Salario Alto'],
            history: [
                { date: '2023-10-20T11:00:00Z', event: 'Ingreso', detail: '' },
                { date: '2023-10-21T09:00:00Z', event: 'Descarte', detail: 'Salario fuera de rango' }
            ]
        },
        { 
            id: 'c5', 
            nombre: 'Elena Volkov', 
            email: 'elena@example.com', 
            puesto: 'Project Manager', 
            ia_score: 98, 
            fecha: '2023-10-15T09:00:00Z', 
            stage: 'stage_3', 
            status_interno: 'ready_for_report', 
            cv_url: '#', 
            video_url: '#', 
            form2_received: true, 
            form2_sent: true,
            qualified: true, 
            report_generated: false, 
            notes: 'Lista para presentar al cliente.',
            history: [
                { date: '2023-10-15T09:00:00Z', event: 'Ingreso', detail: '' },
                { date: '2023-10-16T14:00:00Z', event: 'Aprobado a Gesti√≥n', detail: 'Por Admin' },
                { date: '2023-10-18T10:00:00Z', event: 'Entrevista Completada', detail: 'Exitosa' },
                { date: '2023-10-19T11:00:00Z', event: 'Calificado Positivo', detail: 'Pasa a Informe' }
            ]
        },
        ];

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // üëá ESTA ES LA URL DE TU SERVIDOR EN RENDER (Ya te la puse correcta)

    const API_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
    ? "http://localhost:3001"       // Si estoy en mi compu
    : window.location.origin;       // <--- MAGIA: Detecta la URL real autom√°ticamente (sea cual sea)

console.log(`üöÄ Conectado a la API en: ${API_URL}`);

const api = {
            reports: {
                generate: async (id, manualData = null) => {
                    try {
                        const response = await fetch(`${API_URL}/candidatos/${id}/resumen`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ forceRegenerate: !!manualData, manualData: manualData })
                        });
                        return await response.json();
                    } catch (e) { return null; }
                }
            },
            candidates: {
                list: async () => {
                    try {
                        const res = await fetch(`${API_URL}/buscar`);
                        const data = await res.json();
                        const lista = data.resultados || [];
                        return lista.map(c => ({
                            id: c.id,
                            nombre: c.nombre || "Sin Nombre",
                            email: c.email || "S/E",
                            puesto: c.puesto || "General",
                            
                            // üî• DATOS CLAVE QUE FALTABAN
                            ia_score: c.ia_score || 0,
                            ia_motivos: c.ia_motivos || c.motivo || "An√°lisis pendiente...", 
                            ia_alertas: c.ia_alertas || [],
                            respuestas_filtro: c.respuestas_filtro || {}, // <--- ESTO TRAE SALARIO/MONITOREO
                            
                            // üé• VIDEO Y ARCHIVOS
                            cv_url: c.cv_url || '#',
                            video_url: c.video_url || null, // <--- ESTO TRAE EL LINK AZUL
                            
                            // ESTADOS
                            fecha: c.fecha || c.creado_en,
                            stage: c.stage || (c.status_interno === 'new' ? 'stage_1' : 'stage_1'), 
                            status_interno: c.status_interno || 'new',
                            
                            notes: c.motivo || '', 
                            history: c.historial_movimientos || [],
                            informe_final_data: c.informe_final_data || null
                        }));
                    } catch (error) {
                        console.error("Error cargando:", error);
                        return []; 
                    }
                },
                // üöÄ EL ARREGLO DEL BOT√ìN (USANDO PATCH)
                update: async (id, updates) => {
                    try {
                        await fetch(`${API_URL}/candidatos/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        return { ok: true };
                    } catch (e) {
                        console.error(e);
                        return { ok: false };
                    }
                },
                manualUpload: async (formData) => {
                    const res = await fetch(`${API_URL}/manual-upload`, { method: 'POST', body: formData });
                    return await res.json();
                }
            },
            metrics: {
                get: async () => {
                    try {
                        const res = await fetch(`${API_URL}/panel/metrics`);
                        const data = await res.json();
                        return { totals: data.totals }; 
                    } catch (e) { return { totals: {} }; }
                }
            }
        };

        const formatDate = (isoString) => {
            if (!isoString) return '-';
            try {
                return new Date(isoString).toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
            } catch (e) {
                return '-';
            }
        };

        const formatTime = (isoString) => {
            if (!isoString) return '';
            try {
                return new Date(isoString).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return '';
            }
        };

        const STATUS_LABELS = {
            'new': 'Nuevo Ingreso',
            'viewed': 'En Revisi√≥n',
            'interview_pending': 'Pendiente Entrevista',
            'interview_scheduled': 'Entrevista Agendada',
            'interview_completed': 'Entrevista Realizada',
            'pending_form2': 'Pendiente Formulario 2',
            'ready_for_report': 'Listo para Informe',
            'discarded': 'Descartado'
        };

        const getStatusLabel = (status) => STATUS_LABELS[status] || status || 'En Proceso';

        // --- 2. DESIGN SYSTEM (TRAJE PREMIUM COMPACTO) ---

        const Badge = ({ children, type = 'neutral', className = '' }) => {
        const styles = {
            neutral: "bg-slate-800 text-slate-400 border-slate-700",
            success: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
            warning: "bg-amber-500/10 text-amber-400 border-amber-500/20",
            blue: "bg-blue-500/10 text-blue-400 border-blue-500/20",
            purple: "bg-purple-500/10 text-purple-400 border-purple-500/20",
            danger: "bg-rose-500/10 text-rose-400 border-rose-500/20",
        };
        if (type === 'green') type = 'success';
        if (type === 'slate') type = 'neutral';
        
        return (
            <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider border ${styles[type] || styles.neutral} ${className}`}>
            {children}
            </span>
        );
        };

        const Card = ({ children, className = "", onClick }) => (
        <div 
            onClick={onClick}
            className={`bg-slate-900 border border-slate-800 rounded-xl transition-all relative overflow-hidden ${onClick ? 'cursor-pointer hover:border-slate-600 hover:shadow-md' : ''} ${className}`}
        >
            {children}
        </div>
        );

        const Button = ({ children, variant = "primary", icon: Icon, onClick, className = "", disabled = false, size = "md" }) => {
        const sizes = { sm: "px-2.5 py-1.5 text-xs", md: "px-4 py-2 text-sm", icon: "p-2" }; // Sizes m√°s compactos
        const baseStyle = `flex items-center justify-center gap-2 rounded-lg font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ${sizes[size]}`;
        const variants = {
            primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20 border border-blue-500/50",
            secondary: "bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-700 hover:border-slate-600",
            ghost: "text-slate-400 hover:text-white hover:bg-slate-800/50 border border-transparent",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20 border border-emerald-500/50",
            danger: "bg-rose-900/20 text-rose-400 hover:bg-rose-900/40 border border-rose-900/50"
        };

        return (
            <button onClick={(e) => { e.stopPropagation(); onClick && onClick(e); }} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
            {Icon && (disabled ? <Loader2 size={size === 'sm' ? 14 : 16} className="animate-spin"/> : <Icon size={size === 'sm' ? 14 : 16} />)}
            {children}
            </button>
        );
        };

        const Avatar = ({ name, url, size = "md" }) => {
            const dims = size === 'lg' ? 'w-10 h-10 text-sm' : 'w-8 h-8 text-xs';
            return (
                <div className={`${dims} rounded-full bg-gradient-to-tr from-slate-700 to-slate-600 flex items-center justify-center font-bold text-white border border-slate-500/50 shrink-0 overflow-hidden shadow-sm`}>
                    {url ? <img src={url} alt={name} className="w-full h-full object-cover" /> : (name ? name.charAt(0) : '?')}
                </div>
            );
        };

        // --- COMPONENTE GRAFICO DE EMBUDO HORIZONTAL ---
        const HorizontalFunnel = ({ stats }) => {
            const maxVal = Math.max(stats.new, stats.interview, stats.ready) || 1;
            
            // Alerta de nuevos (Si hay status 'new' > 0)
            const newAlert = stats.newUnseen > 0;

            const steps = [
                { id: 'stage_1', label: 'Explorar', count: stats.new, color: 'bg-blue-600', width: 'w-full' },
                { id: 'stage_2', label: 'Gesti√≥n', count: stats.interview, color: 'bg-purple-600', width: 'w-2/3' },
                { id: 'stage_3', label: 'Informes', count: stats.ready, color: 'bg-emerald-600', width: 'w-1/3' },
            ];

            return (
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-5 mb-6">
                    <h3 className="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2">
                        <BarChart2 size={16}/> Flujo de Conversi√≥n Actual
                    </h3>
                    <div className="space-y-4">
                        {steps.map((step) => (
                            <div key={step.id} className="relative">
                                <div className="flex justify-between text-xs mb-1 font-medium">
                                    <span className="text-white flex items-center gap-2">
                                        {step.label}
                                        {step.id === 'stage_1' && newAlert && (
                                            <span className="flex items-center gap-1 text-[9px] bg-blue-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">
                                                +{stats.newUnseen} Nuevos
                                            </span>
                                        )}
                                    </span>
                                    <span className="text-slate-400">{step.count} Candidatos</span>
                                </div>
                                <div className="h-3 w-full bg-slate-950 rounded-full overflow-hidden border border-slate-800/50">
                                    <div 
                                        className={`h-full rounded-full ${step.color} shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all duration-1000`} 
                                        style={{ width: `${(step.count / (stats.total || 1)) * 100}%`, minWidth: '5%' }}
                                    ></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // --- 3. VISTAS DEL SISTEMA ---

        function DashboardView({ candidates, onNavigate }) {
        // Calculamos estad√≠sticas con l√≥gica de "Nuevos sin ver"
        const stats = {
            new: candidates.filter(c => c.stage === 'stage_1').length,
            newUnseen: candidates.filter(c => c.stage === 'stage_1' && c.status_interno === 'new').length,
            interview: candidates.filter(c => c.stage === 'stage_2').length,
            ready: candidates.filter(c => c.stage === 'stage_3').length,
            trash: candidates.filter(c => c.stage === 'trash').length,
            total: candidates.filter(c => c.stage !== 'trash').length
        };

        return (
            <div className="animate-in fade-in duration-500 max-w-7xl mx-auto">
            <header className="mb-6 flex justify-between items-end">
                <div>
                    <h1 className="text-2xl font-bold text-white mb-1 tracking-tight">Panel de Control</h1>
                    <p className="text-slate-400 text-sm">Resumen operativo compacto.</p>
                </div>
                <div className="px-3 py-1.5 bg-slate-900 border border-slate-800 rounded-lg flex items-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span className="text-[10px] font-bold text-slate-400 uppercase">Sistema Online</span>
                </div>
            </header>
            
            {/* Nuevo Grafico de Embudo Horizontal Compacto */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div className="lg:col-span-2">
                    <HorizontalFunnel stats={stats} />
                </div>
                <div className="space-y-4">
                    {/* Tarjetas de Acceso R√°pido Compactas */}
                    <button onClick={() => onNavigate('stage_1')} className="w-full p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-blue-500/50 transition-all group flex items-center justify-between">
                        <div className="text-left">
                            <p className="text-[10px] uppercase font-bold text-slate-500">Bandeja de Entrada</p>
                            <div className="flex items-center gap-2">
                                <span className="text-2xl font-bold text-white">{stats.new}</span>
                                {stats.newUnseen > 0 && (
                                    <span className="text-[10px] bg-rose-500 text-white px-2 py-0.5 rounded-full animate-bounce">
                                        {stats.newUnseen} pendientes
                                    </span>
                                )}
                            </div>
                        </div>
                        <UserPlus className="text-blue-500 group-hover:scale-110 transition-transform" size={24}/>
                    </button>

                    <button onClick={() => onNavigate('trash')} className="w-full p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-rose-500/50 transition-all group flex items-center justify-between">
                        <div className="text-left">
                            <p className="text-[10px] uppercase font-bold text-slate-500">Papelera</p>
                            <span className="text-2xl font-bold text-white">{stats.trash}</span>
                        </div>
                        <Trash2 className="text-rose-500 group-hover:scale-110 transition-transform" size={24}/>
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-5">
                    <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Activity size={16}/> Actividad Reciente</h3>
                    <div className="space-y-3">
                        {candidates.slice(0, 3).map(c => (
                            <div key={c.id} className="flex items-center gap-3 p-2.5 bg-slate-950/50 rounded-lg border border-slate-800/50">
                                <div className={`w-1.5 h-1.5 rounded-full ${c.stage === 'stage_3' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                                <p className="text-xs text-slate-300">
                                    <span className="font-bold text-white">{c.nombre}</span> <span className="text-slate-500">en</span> <span className="text-slate-400">{c.stage === 'stage_1' ? 'Explorar' : c.stage === 'stage_2' ? 'Gesti√≥n' : 'Informe'}</span>
                                </p>
                                <span className="ml-auto text-[10px] text-slate-600">{formatDate(c.fecha)}</span>
                            </div>
                        ))}
                    </div>
                </div>
                
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Globe size={16}/> Integraciones</h3>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="p-3 bg-slate-950 rounded-lg border border-slate-800 flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center text-green-500"><Globe size={16}/></div>
                                <div>
                                    <p className="text-xs font-bold text-white">Zoho Forms</p>
                                    <p className="text-[10px] text-green-400">Online</p>
                                </div>
                            </div>
                            <div className="p-3 bg-slate-950 rounded-lg border border-slate-800 flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500"><Calendar size={16}/></div>
                                <div>
                                    <p className="text-xs font-bold text-white">Google Meet</p>
                                    <p className="text-[10px] text-blue-400">Online</p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            </div>
        );
        }

        // --- NUEVA VISTA: BUSQUEDA Y TRACKING ---
        function SearchView({ candidates, onSelect }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [roleFilter, setRoleFilter] = useState('Todos');

            const results = candidates.filter(c => {
                const matchesText = c.nombre.toLowerCase().includes(searchTerm.toLowerCase()) || c.email.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesRole = roleFilter === 'Todos' || c.puesto.includes(roleFilter);
                return matchesText && matchesRole;
            });

            const roles = ['Todos', ...new Set(candidates.map(c => c.puesto))];

            return (
                <div className="h-full flex flex-col max-w-7xl mx-auto">
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold text-white">B√∫squeda y Seguimiento</h1>
                        <p className="text-slate-400 text-sm mt-1">Localiza candidatos y revisa su estado actual.</p>
                    </div>

                    <div className="flex gap-4 mb-6">
                        <div className="relative flex-1">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16}/>
                            <input 
                                type="text" 
                                placeholder="Buscar por nombre o email..." 
                                className="w-full pl-10 pr-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <select 
                            className="px-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-white text-sm focus:border-blue-500 focus:outline-none"
                            value={roleFilter}
                            onChange={e => setRoleFilter(e.target.value)}
                        >
                            {roles.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                    </div>

                    <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden flex-1">
                        <div className="overflow-y-auto h-full">
                            <table className="w-full text-left">
                                <thead className="bg-slate-950 text-xs uppercase text-slate-500 sticky top-0 z-10">
                                    <tr>
                                        <th className="p-4 font-bold">Candidato</th>
                                        <th className="p-4 font-bold">Etapa Actual</th>
                                        <th className="p-4 font-bold">Estado Detallado</th>
                                        <th className="p-4 font-bold text-right">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {results.map(c => (
                                        <tr key={c.id} className="hover:bg-slate-800/50 group">
                                            <td className="p-4">
                                                <div className="flex items-center gap-3">
                                                    <Avatar name={c.nombre} size="sm"/>
                                                    <div>
                                                        <p className="font-bold text-sm text-white">{c.nombre}</p>
                                                        <p className="text-xs text-slate-500">{c.email}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4">
                                                <Badge type={c.stage === 'stage_3' ? 'green' : c.stage === 'trash' ? 'danger' : 'blue'}>
                                                    {c.stage === 'stage_1' ? 'Explorar' : c.stage === 'stage_2' ? 'Gesti√≥n' : c.stage === 'stage_3' ? 'Informes' : 'Papelera'}
                                                </Badge>
                                            </td>
                                            <td className="p-4 text-xs text-slate-400">
                                                {getStatusLabel(c.status_interno)}
                                            </td>
                                            <td className="p-4 text-right">
                                                <Button size="sm" variant="secondary" onClick={() => onSelect(c.id)}>
                                                    Ver Ficha
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                    {results.length === 0 && (
                                        <tr>
                                            <td colSpan={4} className="p-8 text-center text-slate-500 text-sm">
                                                No se encontraron resultados.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // --- VISTA EXPLORAR TALENTO (DISE√ëO FINAL) ---
function ExploreView({ candidates, onSelect, onUpdate, loading }) {
    const [filter, setFilter] = useState('');

    // --- HELPERS INTERNOS (CORREGIDOS PARA FIREBASE) ---
    const parseFirebaseDate = (iso) => {
        if (!iso) return null;
        if (typeof iso === 'object' && iso._seconds) {
            return new Date(iso._seconds * 1000);
        }
        return new Date(iso);
    };

    const simpleDate = (iso) => {
        const d = parseFirebaseDate(iso);
        if (!d || isNaN(d.getTime())) return '-';
        return d.getDate() + ' ' + d.toLocaleString('es-ES', { month: 'short' });
    };

    const isToday = (iso) => {
        const d = parseFirebaseDate(iso);
        if (!d || isNaN(d.getTime())) return false;
        
        const today = new Date();
        return d.getDate() === today.getDate() && 
               d.getMonth() === today.getMonth() && 
               d.getFullYear() === today.getFullYear();
    };
    
    // 1. Ordenamiento Seguro (Usa el arreglador de fechas)
    const sortedCandidates = [...candidates].sort((a, b) => {
        const dateA = parseFirebaseDate(a.fecha) || new Date(0);
        const dateB = parseFirebaseDate(b.fecha) || new Date(0);
        return dateB - dateA;
    });

    // 2. Filtrado (Se mantiene igual, pero usa la lista ya ordenada)
    const filtered = sortedCandidates.filter(c => 
        c.stage === 'stage_1' && 
        (c.nombre.toLowerCase().includes(filter.toLowerCase()) || c.puesto.toLowerCase().includes(filter.toLowerCase()))
    );
    
    // 2. Filtrado
    const filtered = sortedCandidates.filter(c => 
        c.stage === 'stage_1' && 
        (c.nombre.toLowerCase().includes(filter.toLowerCase()) || c.puesto.toLowerCase().includes(filter.toLowerCase()))
    );

    return (
        <div className="h-full flex flex-col max-w-7xl mx-auto px-4">
            {/* CABECERA ESTILO DISE√ëO */}
            <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
                <div>
                    <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                        Explorar Talento 
                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-blue-400 text-sm font-bold border border-slate-700">
                            {filtered.length}
                        </span>
                    </h1>
                    <p className="text-slate-400 text-sm mt-2">Revisa los perfiles ingresados recientemente.</p>
                </div>
                
                <div className="flex gap-3 w-full md:w-auto">
                    <div className="relative group flex-1 md:w-64">
                        <input 
                            type="text" 
                            placeholder="Buscar..." 
                            value={filter} 
                            onChange={(e) => setFilter(e.target.value)} 
                            className="w-full pl-4 pr-4 py-2.5 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-300 focus:border-blue-500 focus:outline-none transition-all placeholder-slate-600"
                        />
                    </div>
                    <button className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-900/20 whitespace-nowrap">
                        Agregar Candidato
                    </button>
                    {/* Placeholder visual */}
                    <div className="w-12 h-10 bg-slate-800 rounded-lg border border-slate-700 hidden md:block"></div>
                </div>
            </div>

            {/* GRILLA DE TARJETAS */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
                {filtered.map(c => (
                    <div 
                        key={c.id} 
                        onClick={() => onSelect(c.id)} 
                        className="bg-slate-900 border border-slate-800 rounded-xl p-6 cursor-pointer hover:border-slate-600 transition-all group relative flex flex-col justify-between min-h-[180px]"
                    >
                        {/* HEADER: PUESTO + SCORE */}
                        <div className="flex justify-between items-start mb-3">
                            <span className="text-[11px] font-bold text-blue-400 uppercase tracking-wider max-w-[70%] leading-tight">
                                {c.puesto || "CANDIDATURA GENERAL"}
                            </span>
                            
                            {/* Score Box: Verde si >=90, Amarillo si no */}
                            <div className={`flex items-center justify-center px-2 py-1 rounded border ${
                                (c.ia_score || 0) >= 90 
                                ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' 
                                : 'bg-amber-500/10 border-amber-500/20 text-amber-400'
                            }`}>
                                <span className="text-xs font-bold">{c.ia_score || 0}</span>
                            </div>
                        </div>

                        {/* BODY: NOMBRE + ETIQUETA NUEVO */}
                        <div className="mb-6">
                            <h3 className="text-lg font-bold text-white group-hover:text-blue-100 transition-colors mb-2">
                                {c.nombre || "Sin Nombre"}
                            </h3>
                            {isToday(c.fecha) && (
                                <span className="inline-block px-2 py-0.5 bg-blue-600 text-white text-[10px] font-bold rounded shadow-sm animate-pulse">
                                    NUEVO
                                </span>
                            )}
                        </div>

                        {/* FOOTER: FECHA GRIS + DIVISOR */}
                        <div className="mt-auto border-t border-slate-800 pt-3">
                            <span className="text-xs text-slate-500 font-medium">
                                {simpleDate(c.fecha)}
                            </span>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

        function ManageView({ candidates, onSelect, currentUser }) {
        const stage2 = candidates.filter(c => c.stage === 'stage_2');
        return (
            <div className="h-full flex flex-col max-w-7xl mx-auto">
            <div className="mb-6">
                <h1 className="text-2xl font-bold text-white">Gesti√≥n de Candidatos</h1>
                <p className="text-slate-400 text-sm mt-1">Etapa 2: Entrevistas y evaluaci√≥n.</p>
            </div>
            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-sm">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-950/50 text-xs uppercase text-slate-500 font-bold tracking-wider">
                        <tr>
                            <th className="px-6 py-4 border-b border-slate-800">Candidato</th>
                            <th className="px-6 py-4 border-b border-slate-800">Puesto</th>
                            <th className="px-6 py-4 border-b border-slate-800">Estado</th>
                            <th className="px-6 py-4 border-b border-slate-800">Responsable</th>
                            <th className="px-6 py-4 border-b border-slate-800 text-right">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-800/50">
                        {stage2.map(c => (
                            <tr key={c.id} onClick={() => onSelect(c.id)} className="hover:bg-slate-800/60 cursor-pointer transition-colors group">
                                <td className="px-6 py-3">
                                    <div className="flex items-center gap-3">
                                        <Avatar name={c.nombre} />
                                        <div>
                                            <span className="font-bold text-slate-200 text-sm group-hover:text-white">{c.nombre}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] text-slate-500">{c.email}</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-6 py-3"><span className="text-xs text-slate-400">{c.puesto}</span></td>
                                <td className="px-6 py-3"><Badge type="blue">{getStatusLabel(c.status_interno)}</Badge></td>
                                <td className="px-6 py-3">
                                    {c.assignedTo ? (
                                        <div className="flex items-center gap-2">
                                            <Avatar name={c.assignedTo} size="sm"/>
                                            <span className={`text-xs ${c.assignedTo === currentUser ? 'text-blue-400 font-medium' : 'text-slate-500'}`}>{c.assignedTo === currentUser ? 'M√≠o' : c.assignedTo}</span>
                                        </div>
                                    ) : <span className="text-xs text-slate-600 italic">Sin asignar</span>}
                                </td>
                                <td className="px-6 py-3 text-right"><ChevronRight size={16} className="ml-auto text-slate-600 group-hover:text-white"/></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            </div>
        );
        }

// =========================================================
// ‚ö° VISTA REPORTE (CON AUTOGUARDADO ANTI-DESASTRES)
// =========================================================
function ReportView({ candidates, onUpdate, setCurrentReport }) {
    // ESTADOS INTERNOS
    const [view, setView] = React.useState('list'); 
    const [selectedCandidate, setSelectedCandidate] = React.useState(null);
    const [editorData, setEditorData] = React.useState(null);
    const [loading, setLoading] = React.useState(false);
    const [isGenerating, setIsGenerating] = React.useState(false);
    
    // ESTADOS PARA CARGA MANUAL
    const [showManual, setShowManual] = React.useState(false);
    const [manualFile, setManualFile] = React.useState(null);
    const [manualNotes, setManualNotes] = React.useState("");

    // ‚ö° ESTADO NUEVO: Indicador de autoguardado
    const [autoSaveMsg, setAutoSaveMsg] = React.useState("");

    // Filtrar candidatos listos (Etapa 3)
    const pipelineCandidates = candidates.filter(c => c.stage === 'stage_3');

    // ‚ö° MAGIA 1: RECUPERAR BORRADOR AL INICIAR
    React.useEffect(() => {
        const savedDraft = localStorage.getItem('report_draft_manual_notes');
        const savedEditor = localStorage.getItem('report_draft_editor_data');
        
        if (savedDraft) {
            setManualNotes(savedDraft);
            setShowManual(true); // Abrimos el panel si hab√≠a notas
            setAutoSaveMsg("Borrador de notas restaurado");
        }
        
        if (savedEditor) {
            setEditorData(JSON.parse(savedEditor));
            setView('editor'); // Vamos directo al editor si hab√≠a datos
            setAutoSaveMsg("Informe en progreso restaurado");
        }

        // Limpiar mensaje despu√©s de 3 segs
        setTimeout(() => setAutoSaveMsg(""), 3000);
    }, []);

    // ‚ö° MAGIA 2: AUTOGUARDADO DE NOTAS (Cada vez que escriben)
    React.useEffect(() => {
        if (manualNotes) {
            localStorage.setItem('report_draft_manual_notes', manualNotes);
        }
    }, [manualNotes]);

    // ‚ö° MAGIA 3: AUTOGUARDADO DEL EDITOR (Si ya gener√≥ el informe)
    React.useEffect(() => {
        if (editorData) {
            localStorage.setItem('report_draft_editor_data', JSON.stringify(editorData));
        }
    }, [editorData]);

    // ‚ö° MAGIA 4: LIMPIEZA (Funci√≥n para borrar cuando terminamos exitosamente)
    const clearDrafts = () => {
        localStorage.removeItem('report_draft_manual_notes');
        localStorage.removeItem('report_draft_editor_data');
        setManualNotes("");
        setEditorData(null);
        setManualFile(null);
        setView('list');
    };

    // --- MANEJADOR DE UPLOAD MANUAL ---
    const handleManualUpload = async () => {
        if (!manualFile && !manualNotes) return alert("Por favor adjunta un CV o escribe notas.");
        
        setIsGenerating(true);
        const formData = new FormData();
        if (manualFile) formData.append("cv", manualFile);
        formData.append("notas", manualNotes);
        formData.append("puesto", "Perfil Analizado Manualmente");
        formData.append("responsable", "Admin");

        try {
            const res = await fetch(`${API_URL}/manual-upload`, { method: 'POST', body: formData });
            if (!res.ok) throw new Error("Error en el servidor");
            
            const data = await res.json();
            
            // Al tener √©xito, guardamos el editorData (Magia 3 se activa sola) y borramos las notas crudas viejas
            setEditorData(data);
            setSelectedCandidate({ nombre: data.nombre || "Candidato Manual", puesto: data.puesto }); 
            setView('editor'); 
            
            // Opcional: Borramos el draft de notas crudas porque ya tenemos el procesado
            localStorage.removeItem('report_draft_manual_notes');

        } catch (e) {
            console.error(e);
            alert("Ocurri√≥ un error al procesar el archivo. Revisa la consola.");
        } finally {
            setIsGenerating(false);
        }
    };

    // --- ABRIR CANDIDATO DEL PIPELINE ---
    const handleOpenCandidate = async (candidate) => {
        setLoading(true);
        try {
            let initialData = candidate.informe_final_data;
            if (!initialData) {
                const res = await api.reports.generate(candidate.id);
                initialData = res;
            }
            if (!initialData) {
                initialData = {
                    nombre: candidate.nombre,
                    puesto: candidate.puesto,
                    resumen_ejecutivo: "Generando resumen...",
                    ficha_tecnica: {},
                    competencias_tecnicas: [],
                    habilidades_blandas: [],
                    herramientas: [],
                    plus: "",
                    formacion_sugerida: "",
                    conclusion_final: "",
                    responsable: "Admin"
                };
            }
            setEditorData(initialData);
            setSelectedCandidate(candidate);
            setView('editor');
        } catch (e) {
            console.error(e);
            alert("Error cargando datos del candidato.");
        } finally {
            setLoading(false);
        }
    };

    // --- GUARDAR CAMBIOS ---
    const handleSaveEditor = async () => {
        setView('preview');
    };

    // =========================================================
    // RENDER: 1. VISTA PREVIA (HOJA A4)
    // =========================================================
    if (view === 'preview') {
        return (
            <ProfessionalReport 
                data={editorData} 
                onBack={() => setView('editor')} 
                onEdit={() => setView('editor')} 
                // Pasamos la funci√≥n de limpieza al componente de reporte si descarga OK
                // (Opcional: podr√≠as limpiar ac√° si consideras que llegar al preview es "terminar")
            />
        );
    }

    // =========================================================
    // RENDER: 2. EDITOR V3 (CON TODOS LOS CAMPOS)
    // =========================================================
    if (view === 'editor') {
        return (
            <div className="max-w-7xl mx-auto h-[calc(100vh-100px)] flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-300">
                {/* Header Editor */}
                <div className="flex justify-between items-center mb-4 px-1">
                    <div>
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            Editando Informe
                            {/* ‚ö° INDICADOR VISUAL DE GUARDADO */}
                            <span className="text-[10px] font-normal text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full border border-emerald-500/20 animate-pulse">
                                Autoguardado activo
                            </span>
                        </h2>
                        <p className="text-slate-400 text-xs">Candidato: {editorData.nombre}</p>
                    </div>
                    <div className="flex gap-2">
                        {/* ‚ö° Bot√≥n de Cancelar ahora limpia el borrador expl√≠citamente */}
                        <button onClick={() => { 
                            if(confirm("¬øDescartar cambios y salir?")) clearDrafts(); 
                        }} className="px-3 py-2 text-xs text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors">
                            Descartar y Salir
                        </button>
                        
                        <button onClick={handleSaveEditor} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <Eye size={16}/> Previsualizar
                        </button>
                    </div>
                </div>

                <div className="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-hidden">
                    {/* COLUMNA IZQUIERDA: FORMULARIOS */}
                    <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-y-auto custom-scrollbar p-6 space-y-6">
                        
                        {/* 1. Resumen */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Resumen Ejecutivo</label>
                            <textarea 
                                className="w-full h-32 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.resumen_ejecutivo || editorData.resumen_profesional || ""}
                                onChange={(e) => setEditorData({...editorData, resumen_ejecutivo: e.target.value})}
                            />
                        </div>

                        {/* 2. Ficha T√©cnica */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Ficha T√©cnica</label>
                            <div className="grid grid-cols-2 gap-3">
                                <input placeholder="Ubicaci√≥n" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.ubicacion || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, ubicacion: e.target.value}})} />
                                <input placeholder="Experiencia" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.nivel_experiencia || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, nivel_experiencia: e.target.value}})} />
                                <input placeholder="Ingl√©s" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.nivel_ingles || editorData.ficha_tecnica?.idiomas || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, nivel_ingles: e.target.value}})} />
                                <input placeholder="Disponibilidad" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.disponibilidad || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, disponibilidad: e.target.value}})} />
                            </div>
                        </div>

                        {/* 3. Competencias T√©cnicas */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Competencias T√©cnicas
                                <button onClick={() => setEditorData({...editorData, competencias_tecnicas: [...(editorData.competencias_tecnicas||[]), {competencia: "", nivel: "Alto"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.competencias_tecnicas || []).map((c, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={c.competencia} 
                                        onChange={(e) => {
                                            const newArr = [...editorData.competencias_tecnicas];
                                            newArr[i].competencia = e.target.value;
                                            setEditorData({...editorData, competencias_tecnicas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={c.nivel}
                                        onChange={(e) => {
                                            const newArr = [...editorData.competencias_tecnicas];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, competencias_tecnicas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = editorData.competencias_tecnicas.filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, competencias_tecnicas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 4. Soft Skills (NUEVO V3) */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Habilidades Blandas
                                <button onClick={() => setEditorData({...editorData, habilidades_blandas: [...(editorData.habilidades_blandas||[]), {habilidad: "", nivel: "Alto"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.habilidades_blandas || []).map((h, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={h.habilidad} 
                                        onChange={(e) => {
                                            const newArr = [...(editorData.habilidades_blandas||[])];
                                            newArr[i].habilidad = e.target.value;
                                            setEditorData({...editorData, habilidades_blandas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={h.nivel}
                                        onChange={(e) => {
                                            const newArr = [...(editorData.habilidades_blandas||[])];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, habilidades_blandas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = (editorData.habilidades_blandas||[]).filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, habilidades_blandas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 5. Herramientas (NUEVO V3) */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Herramientas
                                <button onClick={() => setEditorData({...editorData, herramientas: [...(editorData.herramientas||[]), {herramienta: "", nivel: "Avanzado"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.herramientas || []).map((t, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={t.herramienta} 
                                        onChange={(e) => {
                                            const newArr = [...(editorData.herramientas||[])];
                                            newArr[i].herramienta = e.target.value;
                                            setEditorData({...editorData, herramientas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={t.nivel}
                                        onChange={(e) => {
                                            const newArr = [...(editorData.herramientas||[])];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, herramientas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = (editorData.herramientas||[]).filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, herramientas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 6. Plus */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Plus / Valor Agregado</label>
                            <textarea 
                                className="w-full h-20 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.plus || ""}
                                onChange={(e) => setEditorData({...editorData, plus: e.target.value})}
                            />
                        </div>

                        {/* 7. Formaci√≥n Sugerida */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Formaci√≥n Sugerida</label>
                            <textarea 
                                className="w-full h-20 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.formacion_sugerida || ""}
                                onChange={(e) => setEditorData({...editorData, formacion_sugerida: e.target.value})}
                            />
                        </div>

                        {/* 8. Recomendaci√≥n */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Recomendaci√≥n Final</label>
                            <textarea 
                                className="w-full h-24 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.recomendacion_final || editorData.conclusion_final || ""}
                                onChange={(e) => setEditorData({...editorData, recomendacion_final: e.target.value})}
                            />
                        </div>

                    </div>

                    {/* COLUMNA DERECHA: PREVIEW COMPACTA */}
                    <div className="bg-white rounded-xl overflow-hidden shadow-xl hidden lg:block opacity-90 pointer-events-none transform scale-[0.85] origin-top border-4 border-slate-800">
                        <div className="p-10 text-black">
                            <h1 className="text-xl font-bold">{editorData.nombre}</h1>
                            <p className="text-sm text-gray-500 mb-4">{editorData.puesto}</p>
                            <p className="text-xs text-gray-800 line-clamp-6 mb-4">{editorData.resumen_ejecutivo}</p>
                            <div className="p-4 bg-gray-100 rounded border border-gray-300 text-center text-gray-500 text-xs uppercase font-bold tracking-widest">
                                Vista Previa del Documento
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================
    // RENDER: 3. LISTA PIPELINE Y CARGA MANUAL (DEFAULT)
    // =========================================================
    return (
        <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500 pb-20">
            
            {/* CABECERA */}
            <div className="flex items-center justify-between border-b border-slate-800 pb-6">
                <div>
                    <h1 className="text-2xl font-bold text-white">Generar Informe Final</h1>
                    <p className="text-slate-400 text-sm">Gesti√≥n de entregables y cierre de procesos.</p>
                    {/* ‚ö° MENSAJE DE RESTAURACI√ìN SI APLICA */}
                    {autoSaveMsg && (
                        <div className="mt-2 text-xs font-bold text-emerald-400 flex items-center gap-1 animate-pulse">
                            <Clock size={12}/> {autoSaveMsg}
                        </div>
                    )}
                </div>
                <button 
                    onClick={() => setShowManual(!showManual)}
                    className={`px-4 py-2 rounded-lg text-xs font-bold transition-all border ${showManual ? 'bg-amber-500/10 border-amber-500/50 text-amber-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                >
                    {showManual ? "‚úï CERRAR MODO MANUAL" : "‚ö° MODO MANUAL"}
                </button>
            </div>

            {/* ZONA MANUAL (Dise√±o Gold Premium) */}
            {showManual && (
                <section className="bg-slate-900 border border-amber-500/20 rounded-2xl p-8 shadow-2xl animate-in slide-in-from-top duration-300 mb-8 relative overflow-hidden">
                    {/* Efecto de brillo de fondo */}
                    <div className="absolute top-0 right-0 w-64 h-64 bg-amber-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                        
                        {/* COLUMNA IZQUIERDA: PDF */}
                        <div className="flex flex-col gap-3">
                            <label className="text-[11px] font-bold text-amber-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                <FileText size={14}/> 1. Adjuntar Curr√≠culum (PDF)
                            </label>
                            
                            {/* ‚ö° AVISO DE ARCHIVO NO PERSISTENTE */}
                            <label className={`flex flex-col items-center justify-center w-full h-56 border-2 border-dashed rounded-xl cursor-pointer transition-all group ${manualFile ? 'border-amber-500/50 bg-amber-500/5' : 'border-slate-800 bg-slate-950 hover:bg-slate-900 hover:border-slate-700'}`}>
                                <div className="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4">
                                    <div className={`mb-3 p-3 rounded-full transition-all ${manualFile ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-500 group-hover:text-amber-500'}`}>
                                        {manualFile ? <CheckCircle size={24}/> : <Download size={24}/>}
                                    </div>
                                    <p className={`text-sm font-medium ${manualFile ? 'text-amber-400' : 'text-slate-400'}`}>
                                        {manualFile ? manualFile.name : "Click para buscar PDF o TXT"}
                                    </p>
                                    {!manualFile && <p className="text-xs text-slate-600 mt-1">Si recargas la p√°gina, deber√°s subirlo de nuevo.</p>}
                                </div>
                                <input 
                                    type="file" 
                                    className="hidden" 
                                    accept=".pdf,.txt,.doc,.docx" 
                                    onChange={(e) => setManualFile(e.target.files[0])} 
                                />
                            </label>
                        </div>

                        {/* COLUMNA DERECHA: NOTAS */}
                        <div className="flex flex-col gap-3">
                            <label className="text-[11px] font-bold text-amber-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                <Sparkles size={14}/> 2. Notas y An√°lisis (Autoguardado)
                            </label>
                            <textarea 
                                className="w-full h-56 bg-slate-950 border border-slate-800 rounded-xl p-5 text-sm text-slate-200 focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/20 focus:outline-none transition-all resize-none custom-scrollbar leading-relaxed placeholder-slate-700"
                                placeholder="Pega aqu√≠ tu evaluaci√≥n. Si se corta internet, este texto se guarda solo."
                                value={manualNotes}
                                onChange={(e) => setManualNotes(e.target.value)}
                            />
                        </div>

                        {/* BOT√ìN DE ACCI√ìN */}
                        <div className="md:col-span-2 mt-2">
                            <button 
                                className={`w-full py-4 font-black text-sm uppercase tracking-[0.15em] rounded-xl flex items-center justify-center gap-3 transition-all transform active:scale-[0.99] shadow-lg ${
                                    isGenerating 
                                    ? 'bg-slate-800 text-slate-500 cursor-wait' 
                                    : 'bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-amber-50 shadow-amber-900/20 border border-amber-500/20'
                                }`}
                                disabled={isGenerating || (!manualFile && !manualNotes)}
                                onClick={handleManualUpload}
                            >
                                {isGenerating ? (
                                    <><Loader2 className="animate-spin" size={20}/> ANALIZANDO CON GEMINI...</>
                                ) : (
                                    <><Sparkles size={20}/> GENERAR FICHA DE INFORME FINAL </>
                                )}
                            </button>
                        </div>
                    </div>
                </section>
            )}

            {/* LISTA DEL PIPELINE */}
            <section className="space-y-4 pt-4">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Candidatos en Espera ({pipelineCandidates.length})</h3>
                {pipelineCandidates.length === 0 ? (
                    <div className="p-8 border border-slate-800 border-dashed rounded-xl text-center text-slate-600 text-sm">
                        No hay candidatos pendientes en esta etapa.
                    </div>
                ) : (
                    <div className="grid gap-3">
                        {pipelineCandidates.map(c => (
                            <div key={c.id} className="p-4 bg-slate-900 border border-slate-800 rounded-xl flex items-center justify-between hover:bg-slate-800/50 transition-colors cursor-pointer group" onClick={() => handleOpenCandidate(c)}>
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">
                                        {c.nombre.substring(0,2).toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-bold text-white group-hover:text-blue-400 transition-colors">{c.nombre}</h4>
                                        <p className="text-[10px] text-slate-500">{c.puesto || "Candidato"}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {c.informe_final_data && <span className="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20">Informe Listo</span>}
                                    <ChevronRight className="text-slate-600 group-hover:text-white"/>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </section>
        </div>
    );
}
// --- VISTA DETALLE MEJORADA (CV Editable + Selector de Responsable) ---
function CandidateDetail({ candidate, onBack, onUpdate }) {
            const [noteInput, setNoteInput] = useState(candidate.notes || "");
            
            // 1. ESTADO PARA EDICI√ìN DE CV
            const [isEditingCv, setIsEditingCv] = useState(false);
            const [newCvLink, setNewCvLink] = useState(candidate.cv_url || "");

            // 2. ESTADO PARA RESPONSABLE (Selector local simple)
            const [responsable, setResponsable] = useState(candidate.assignedTo || "Admin");
            const team = ["Viviana", "Gladymar", "Sandra", "Informes", "Admin"];

            // Recuperar alertas del backend
            const flags = candidate.ia_alertas || candidate.alerts || [];
            
            // Recuperar Skills
            const hardSkills = candidate.respuestas_filtro?.herramientas 
                ? candidate.respuestas_filtro.herramientas.split(',').map(s => s.trim()) 
                : ['Sin datos t√©cnicos'];

            // Funci√≥n para guardar el Link manual
            const saveCvLink = () => {
                onUpdate(candidate.id, { cv_url: newCvLink });
                setIsEditingCv(false);
            };

            // Funci√≥n para Aprobar asignando responsable
            const handleApprove = () => {
                onUpdate(candidate.id, { 
                    stage: 'stage_2', 
                    status_interno: 'interview_pending',
                    assignedTo: responsable // <--- AQU√ç SE GUARDA QUI√âN LO APROB√ì
                });
            };

            return (
                <div className="flex flex-col h-full animate-in slide-in-from-right duration-300 pb-10 max-w-7xl mx-auto px-4">
                    {/* HEADER */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors">
                                <ArrowRight className="rotate-180" size={24} />
                            </button>
                            <div>
                                <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                                    {candidate.nombre}
                                    {/* Etiqueta de Responsable si ya tiene */}
                                    {candidate.assignedTo && <span className="text-[10px] bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded border border-purple-500/30 uppercase">Resp: {candidate.assignedTo}</span>}
                                </h1>
                                <p className="text-sm text-slate-400">{candidate.puesto}</p>
                            </div>
                        </div>
                        
                        {/* BOTONERA DE ACCI√ìN CON SELECTOR DE USUARIO */}
                        <div className="flex items-center gap-3 bg-slate-900 p-2 rounded-xl border border-slate-800">
                            {/* Selector de Usuario para Aprobar */}
                            <div className="flex flex-col px-2">
                                <label className="text-[9px] text-slate-500 uppercase font-bold">Soy:</label>
                                <select 
                                    value={responsable} 
                                    onChange={(e) => setResponsable(e.target.value)}
                                    className="bg-transparent text-white text-xs font-bold outline-none cursor-pointer hover:text-blue-400"
                                >
                                    {team.map(u => <option key={u} value={u} className="bg-slate-900">{u}</option>)}
                                </select>
                            </div>
                            <div className="h-8 w-px bg-slate-700 mx-1"></div>
                            
                            <button onClick={() => onUpdate(candidate.id, { stage: 'trash' })} className="px-4 py-2 rounded-lg border border-rose-900/50 text-rose-400 hover:bg-rose-900/20 text-sm font-medium transition-colors">
                                Descartar
                            </button>
                            <button onClick={handleApprove} className="px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium transition-colors shadow-lg shadow-emerald-900/20">
                                Aprobar ({responsable})
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* COLUMNA IZQUIERDA */}
                        <div className="lg:col-span-4 space-y-6">
                            {/* SCORE CARD */}
                            <Card className="p-6 bg-slate-900 border-slate-800">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-sm font-bold text-slate-400 uppercase tracking-wider">IA Match</span>
                                    <div className={`px-3 py-1 rounded-full border ${
                                        (candidate.ia_score || 0) >= 70 
                                        ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' 
                                        : 'bg-rose-500/10 border-rose-500/20 text-rose-400'
                                    }`}>
                                        <span className="text-3xl font-bold">{candidate.ia_score || 0}</span>
                                        <span className="text-xs opacity-70">/100</span>
                                    </div>
                                </div>
                                <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${ (candidate.ia_score || 0) >= 70 ? 'bg-emerald-500' : 'bg-rose-500' }`} style={{ width: `${candidate.ia_score || 5}%` }}></div>
                                </div>
                                
                                {flags.length > 0 && (
                                    <div className="mt-6 pt-4 border-t border-slate-800">
                                        <p className="text-[10px] font-bold text-rose-500 uppercase mb-2 flex items-center gap-1"><AlertTriangle size={12}/> Alertas</p>
                                        <div className="flex flex-wrap gap-2">
                                            {flags.map((flag, i) => <span key={i} className="px-2 py-1 bg-rose-500/10 text-rose-400 border border-rose-500/20 text-[10px] font-bold rounded uppercase">{flag}</span>)}
                                        </div>
                                    </div>
                                )}
                            </Card>

                            {/* MATERIALES CARD (AQU√ç EST√Å LA MAGIA DEL LINK) */}
                            <Card className="p-6 bg-slate-900 border-slate-800">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Material</h3>
                                    {/* Bot√≥n L√°piz para Editar */}
                                    <button onClick={() => setIsEditingCv(!isEditingCv)} className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                        {isEditingCv ? '‚úï Cancelar' : '‚úèÔ∏è Editar Link'}
                                    </button>
                                </div>

                                <div className="space-y-3">
                                    {/* EDITOR DE LINK */}
                                    {isEditingCv && (
                                        <div className="p-3 bg-slate-950 rounded-lg border border-blue-500/30 mb-2 animate-in fade-in">
                                            <label className="text-[10px] text-blue-400 font-bold uppercase mb-1 block">Pegar Link de Drive:</label>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    value={newCvLink}
                                                    onChange={(e) => setNewCvLink(e.target.value)}
                                                    placeholder="https://drive.google.com/..."
                                                    className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-blue-500"
                                                />
                                                <button onClick={saveCvLink} className="bg-emerald-600 text-white px-3 rounded text-xs font-bold">üíæ</button>
                                            </div>
                                        </div>
                                    )}

                                    {/* BOT√ìN CV */}
                                    <a href={candidate.cv_url} target="_blank" className="flex items-center gap-4 p-4 rounded-xl border border-slate-800 bg-slate-950 hover:border-blue-500/50 hover:bg-slate-900 transition-all group cursor-pointer">
                                        <div className="w-10 h-10 rounded-full bg-blue-600/20 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform"><FileText size={20}/></div>
                                        <div>
                                            <h4 className="text-sm font-bold text-white">Curriculum Vitae</h4>
                                            <p className="text-xs text-blue-400 group-hover:underline">
                                                {candidate.cv_url && candidate.cv_url.length > 5 ? "Ver Documento" : "Link no disponible"}
                                            </p>
                                        </div>
                                    </a>

                                    {/* BOT√ìN VIDEO */}
                                    <a href={candidate.video_url || "#"} target="_blank" className={`flex items-center gap-4 p-4 rounded-xl border border-slate-800 bg-slate-950 transition-all group ${!candidate.video_url ? 'opacity-50 cursor-not-allowed' : 'hover:border-purple-500/50 hover:bg-slate-900 cursor-pointer'}`}>
                                        <div className="w-10 h-10 rounded-full bg-purple-600/20 flex items-center justify-center text-purple-500 group-hover:scale-110 transition-transform"><Video size={20}/></div>
                                        <div>
                                            <h4 className="text-sm font-bold text-white">Video Presentaci√≥n</h4>
                                            <p className="text-xs text-purple-400 group-hover:underline">{candidate.video_url ? 'Abrir Link Externo' : 'No disponible'}</p>
                                        </div>
                                    </a>
                                </div>
                            </Card>
                        </div>

                        {/* COLUMNA DERECHA */}
                        <div className="lg:col-span-8 space-y-6">
                            <Card className="p-8 bg-slate-900 border-slate-800 relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                                <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2 relative z-10"><Sparkles className="text-blue-400" size={20} /> An√°lisis del Perfil</h2>
                                <div className="bg-slate-950/50 rounded-xl p-6 border border-slate-800 mb-6 relative z-10">
                                    <p className="text-sm text-slate-300 leading-relaxed">{candidate.ia_motivos || candidate.motivo || "An√°lisis pendiente..."}</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                                    <div>
                                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2">Datos Clave</h3>
                                        <ul className="space-y-3">
                                            <li className="flex justify-between text-xs"><span className="text-slate-400">Salario:</span><span className={candidate.respuestas_filtro?.salario === 'S√≠' ? "text-emerald-400" : "text-white"}>{candidate.respuestas_filtro?.salario || "N/A"}</span></li>
                                            <li className="flex justify-between text-xs"><span className="text-slate-400">Monitoreo:</span><span className={candidate.respuestas_filtro?.monitoreo === 'S√≠' ? "text-emerald-400" : "text-white"}>{candidate.respuestas_filtro?.monitoreo || "N/A"}</span></li>
                                            <li className="flex justify-between text-xs"><span className="text-slate-400">Disponibilidad:</span><span className="text-white">{candidate.respuestas_filtro?.disponibilidad || "N/A"}</span></li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2">Skills</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {hardSkills.map((skill, i) => <span key={i} className="px-3 py-1 bg-slate-800 text-slate-300 text-[11px] rounded border border-slate-700">{skill}</span>)}
                                        </div>
                                    </div>
                                </div>
                            </Card>

                            <Card className="bg-slate-900 border-slate-800 flex flex-col overflow-hidden">
                                <div className="p-4 border-b border-slate-800 bg-slate-950/30"><h3 className="text-sm font-bold text-white">Tus Notas Personales</h3></div>
                                <textarea className="w-full h-32 bg-slate-900 p-4 text-slate-300 focus:outline-none placeholder-slate-600 resize-none text-sm" placeholder="Escribe aqu√≠..." value={noteInput} onChange={(e) => setNoteInput(e.target.value)} onBlur={() => onUpdate(candidate.id, { notes: noteInput })}></textarea>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        }
// --- APP CONTAINER ---
function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentReport, setCurrentReport] = useState(null);
            const [selectedCandidateId, setSelectedCandidateId] = useState(null);
            const [candidates, setCandidates] = useState([]);
            const [loading, setLoading] = useState(false);
            const [init, setInit] = useState(false);

            const LOGO_URL = "./GLOBAL.jpg";
            const CURRENT_USER = "Admin"; 

            const cargarDatos = async (forceRefresh = false) => {
    // Si ya carg√≥ y no forzamos, no hacemos nada
    if (init && !forceRefresh) return;
    
    setLoading(true);

    // Configuraci√≥n de la memoria (Cach√©)
    const CACHE_KEY = 'global_talent_cache_v1';
    const CACHE_TIME_KEY = 'global_talent_time';
    const VALIDEZ_MINUTOS = 15; // ‚è≥ Guarda los datos 15 minutos

    try {
        const now = new Date().getTime();
        const cachedRaw = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

        // 1. ESTRATEGIA DE AHORRO: Chequear si tenemos datos guardados recientes
        if (!forceRefresh && cachedRaw && cachedTime) {
            const edadMinutos = (now - parseInt(cachedTime)) / (1000 * 60);
            
            if (edadMinutos < VALIDEZ_MINUTOS) {
                console.log(`‚ö° Usando memoria local (Ahorro Firebase activo). Edad: ${edadMinutos.toFixed(1)} min`);
                setCandidates(JSON.parse(cachedRaw));
                setInit(true);
                setLoading(false);
                return; // üõë ¬°FRENAMOS AC√Å! No tocamos Firebase.
            }
        }

        // 2. SOLO SI ES NECESARIO: Vamos a Firebase
        console.log("üì° Datos viejos o inexistentes. Gastando lectura en Firebase...");
        const data = await api.candidates.list();

        // Guardamos lo nuevo en el bolsillo para la pr√≥xima
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIME_KEY, now.toString());

        setCandidates(data);
        setInit(true);

    } catch (error) {
        console.error("‚ùå Error cargando datos:", error);
    } finally {
        setLoading(false);
    }
};

            useEffect(() => { 
                cargarDatos(); 
            }, []);

            const handleUpdateCandidate = async (id, updates) => {
                let finalUpdates = { ...updates };
                
                if (updates.stage === 'stage_2') {
                    finalUpdates.assignedTo = CURRENT_USER; 
                    finalUpdates.status_interno = 'interview_pending';
                }

                if (updates.stage === 'trash' || updates.stage === 'stage_3') {
                    setSelectedCandidateId(null);
                }

                setCandidates(prev => prev.map(c => {
                    if (c.id === id) {
                        if (activeTab === 'stage_1' && c.status_interno === 'new' && !updates.stage) {
                            finalUpdates.status_interno = 'viewed';
                        }
                        return { ...c, ...finalUpdates };
                    }
                    return c;
                }));

                await api.candidates.update(id, finalUpdates);
            };

            const handleSelectCandidate = (id) => {
                setSelectedCandidateId(id);
                handleUpdateCandidate(id, {});
            };

            const renderContent = () => {
                if (currentReport) {
                    return <ProfessionalReport data={currentReport} onBack={() => setCurrentReport(null)} />;
                }

                if (selectedCandidateId) {
                    const cand = candidates.find(c => c.id === selectedCandidateId);
                    if (!cand) {
                        setSelectedCandidateId(null);
                        return null;
                    }
                    return (
                        <CandidateDetail 
                            key={cand.id} 
                            candidate={cand} 
                            onBack={() => setSelectedCandidateId(null)} 
                            onUpdate={handleUpdateCandidate} 
                            loading={loading}
                            currentUser={CURRENT_USER}
                        />
                    );
                }

                switch (activeTab) {
                    case 'dashboard': return <DashboardView candidates={candidates} onNavigate={setActiveTab} />;
                    case 'stage_1':   return <ExploreView candidates={candidates} onSelect={handleSelectCandidate} onUpdate={handleUpdateCandidate} loading={loading} />;
                    case 'stage_2':   return <ManageView candidates={candidates} onSelect={handleSelectCandidate} currentUser={CURRENT_USER} />;
                    case 'stage_3':   return <ReportView candidates={candidates} onUpdate={handleUpdateCandidate} setCurrentReport={setCurrentReport} />;
                    case 'search':    return <SearchView candidates={candidates} onSelect={handleSelectCandidate} />;
                    case 'trash':     return <TrashView candidates={candidates} onUpdate={handleUpdateCandidate} />;
                    default:          return <DashboardView candidates={candidates} onNavigate={setActiveTab} />;
                }
            };

            const menuItems = [
                { id: 'dashboard', label: 'Inicio', icon: LayoutDashboard },
                { type: 'divider', label: 'PIPELINE' },
                { id: 'stage_1', label: '1. Explorar', icon: UserPlus, sub: 'Nuevos Ingresos' },
                { id: 'stage_2', label: '2. Gesti√≥n', icon: Users, sub: 'En Entrevista' },
                { id: 'stage_3', label: '3. Generar Informe', icon: FileJson, sub: 'Listos para Asignar' },
                { type: 'divider', label: 'SISTEMA' },
                { id: 'search', label: 'B√∫squeda', icon: Search },
                { id: 'trash', label: 'Papelera', icon: Trash2 },
            ];

            return (
                <div className="flex h-screen bg-slate-950 font-sans text-slate-200 selection:bg-blue-500/30 overflow-hidden">
                    <aside className="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
                        <div className="h-24 flex items-center justify-center px-6 border-b border-slate-800">
                            <img src={LOGO_URL} alt="Logo" className="h-20 w-auto object-contain mix-blend-screen opacity-90 transition-all hover:scale-105" />
                        </div>
                        <nav className="flex-1 px-3 py-6 space-y-1 overflow-y-auto custom-scrollbar">
                            {menuItems.map((item, idx) => {
                                if (item.type === 'divider') return <div key={idx} className="px-3 pt-6 pb-2 text-[10px] font-bold text-slate-600 tracking-widest uppercase">{item.label}</div>;
                                const isActive = activeTab === item.id;
                                return (
                                    <button key={item.id} onClick={() => { setActiveTab(item.id); setSelectedCandidateId(null); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm transition-all group relative ${isActive ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20' : 'text-slate-400 hover:bg-slate-800 border border-transparent'}`}>
                                        <item.icon size={18} className={isActive ? 'text-blue-400' : 'text-slate-500 group-hover:text-slate-300'} />
                                        <div className="flex flex-col items-start text-left"><span className="font-medium leading-none">{item.label}</span>{item.sub && isActive && <span className="text-[10px] opacity-70 font-normal mt-1">{item.sub}</span>}</div>
                                        {isActive && <div className="absolute right-2 w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.8)]" />}
                                    </button>
                                );
                            })}
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <button className="flex items-center gap-3 w-full p-2 rounded-xl hover:bg-slate-800 transition-colors group border border-transparent hover:border-slate-700">
                                <Avatar name={CURRENT_USER} />
                                <div className="flex-col flex items-start overflow-hidden"><span className="text-xs font-bold text-slate-200 group-hover:text-white">{CURRENT_USER}</span><span className="text-[10px] text-emerald-400 flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"/> Online</span></div>
                                <Settings size={14} className="ml-auto text-slate-600 group-hover:text-slate-400 transition-colors"/>
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-auto p-6 relative bg-slate-950">
                        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-[0.03] pointer-events-none mix-blend-overlay"></div>
                        <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-900/10 to-transparent pointer-events-none"></div>
                        <div className="relative z-10 h-full">{renderContent()}</div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }
            /* Ocultar botones dentro del reporte al imprimir */
            button {
                display: none !important;
            }
        }
        </style>
</body>
</html>