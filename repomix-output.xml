This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
cliente_lite/
  api-client.js
  dashboard.html
  dashboard.js
  GLOBAL.png
  styles.css
  ui-components.js
  Untitled
docs/
  CONCEPTOS_FUNDAMENTALES.md
  ONBOARDING_COMPLETO.md
.cursorrules
.gitignore
authMiddleware.js
calendar.js
Dockerfile
ficha.py
ficha2.py
GUIA_PRUEBA_FLUJO.md
index.js
logo.png
package.json
plantilla.docx
README.md
requirements.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="cliente_lite/styles.css">
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #0f172a;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #334155;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #475569;
}
body {
    background-color: #020617;
}

/* Animaci√≥n de esqueleto */
@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton {
    background: linear-gradient(90deg, #0f172a 25%, #1e293b 50%, #0f172a 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 0.5rem;
}

/* A√±adir en styles.css para dar un "Glow" sutil seg√∫n el score */
.card-score-high {
    box-shadow: 0 0 15px -5px rgba(16, 185, 129, 0.2);
}
.card-score-mid {
    box-shadow: 0 0 15px -5px rgba(245, 158, 11, 0.2);
}
</file>

<file path="cliente_lite/ui-components.js">
const { useState, useEffect, useMemo } = React;

        // --- ADAPTADOR DE ICONOS LUCIDE (VERSI√ìN FINAL ROBUSTA) ---
const LucideIcon = ({ name, size = 24, className, ...props }) => {
    // 1. Intentamos buscar el icono tal cual viene (Ej: "UserPlus")
    let iconData = lucide.icons[name];

    // 2. Si no existe, probamos convertirlo a kebab-case (Ej: "user-plus")
    if (!iconData) {
        const iconNameKebab = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
        iconData = lucide.icons[iconNameKebab];
    }

    // 3. Si sigue sin existir, no renderizamos nada (evita errores)
    if (!iconData) {
        console.warn(`Icono no encontrado: ${name}`);
        return null;
    }

    return (
        <svg
            {...props}
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={`lucide lucide-${name.toLowerCase()} ${className || ''}`}
        >
            {iconData.map((child, index) => {
                const [tagName, attrs] = child;
                return React.createElement(tagName, { ...attrs, key: index });
            })}
        </svg>
    );
};

 // Lista de iconos requeridos (Agregu√© 'Sparkles' para el an√°lisis)
 const iconList = [
    'LayoutDashboard', 'Users', 'FileText', 'HelpCircle', 'Settings', 
    'Search', 'CheckCircle', 'XCircle', 'ChevronRight', 'Filter', 
    'Clock', 'Calendar', 'FileJson', 'RefreshCw', 'Send', 'UserPlus', 
    'Video', 'ExternalLink', 'AlertTriangle', 'MessageSquare', 'ArrowRight',
    'Briefcase', 'Lock', 'UserCheck', 'Loader2', 'Trash2', 'Undo2', 'MoreVertical',
    'CheckSquare', 'Printer', 'Eye', 'Mail', 'Activity', 'Server', 'Database', 'Globe',
    'ThumbsUp', 'ThumbsDown', 'Link', 'Download', 'Share2', 'History',
    'BarChart2', 'List', 'Sparkles', 'Save'
];

const Icons = {};
iconList.forEach(name => {
    Icons[name] = (props) => <LucideIcon name={name} {...props} />;
});

Icons.LinkIcon = Icons.Link;

const { 
    LayoutDashboard, Users, FileText, HelpCircle, Settings, 
    Search, CheckCircle, XCircle, ChevronRight, Filter, 
    Clock, Calendar, FileJson, RefreshCw, Send, UserPlus, 
    Video, ExternalLink, AlertTriangle, MessageSquare, ArrowRight,
    Briefcase, Lock, UserCheck, Loader2, Trash2, Undo2, MoreVertical,
    CheckSquare, Printer, Eye, Mail, Activity, Server, Database, Globe,
    ThumbsUp, ThumbsDown, LinkIcon, Download, Share2, History,
    BarChart2, List, Sparkles
} = Icons;

const Badge = ({ children, type = 'neutral', className = '' }) => {
    const styles = {
        neutral: "bg-slate-800 text-slate-400 border-slate-700",
        success: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
        warning: "bg-amber-500/10 text-amber-400 border-amber-500/20",
        blue: "bg-blue-500/10 text-blue-400 border-blue-500/20",
        purple: "bg-purple-500/10 text-purple-400 border-purple-500/20",
        danger: "bg-rose-500/10 text-rose-400 border-rose-500/20",
    };
    if (type === 'green') type = 'success';
    if (type === 'slate') type = 'neutral';
    
    return (
        <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider border ${styles[type] || styles.neutral} ${className}`}>
        {children}
        </span>
    );
    
    };

    const Card = ({ children, className = "", onClick }) => (
    <div 
        onClick={onClick}
        className={`bg-slate-900 border border-slate-800 rounded-xl transition-all relative overflow-hidden ${onClick ? 'cursor-pointer hover:border-slate-600 hover:shadow-md' : ''} ${className}`}
    >
        {children}
    </div>
    );

    const SkeletonCard = () => (
        <div className="bg-slate-900 border border-slate-800 rounded-xl p-6 min-h-[180px] flex flex-col justify-between">
            <div className="flex justify-between mb-3">
                <div className="h-3 w-24 skeleton"></div>
                <div className="h-5 w-8 skeleton"></div>
            </div>
            <div className="mb-6">
                <div className="h-6 w-3/4 skeleton mb-2"></div>
                <div className="h-4 w-1/4 skeleton"></div>
            </div>
            <div className="mt-auto border-t border-slate-800 pt-3">
                <div className="h-3 w-20 skeleton"></div>
            </div>
        </div>
    );

    const Button = ({ children, variant = "primary", icon: Icon, onClick, className = "", disabled = false, size = "md", ariaLabel }) => {
        const sizes = { sm: "px-2.5 py-1.5 text-xs", md: "px-4 py-2 text-sm", icon: "p-2" };
        const baseStyle = `flex items-center justify-center gap-2 rounded-lg font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ${sizes[size]}`;
        const variants = {
            primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20 border border-blue-500/50",
            secondary: "bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-700 hover:border-slate-600",
            ghost: "text-slate-400 hover:text-white hover:bg-slate-800/50 border border-transparent",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20 border border-emerald-500/50",
            danger: "bg-rose-900/20 text-rose-400 hover:bg-rose-900/40 border border-rose-900/50"
        };
    
        return (
            <button 
                onClick={(e) => { e.stopPropagation(); onClick && onClick(e); }} 
                disabled={disabled} 
                className={`${baseStyle} ${variants[variant]} ${className}`}
                aria-label={ariaLabel || (typeof children === 'string' ? children : undefined)} // Etiqueta para lectores de pantalla
                role="button"
            >
                {Icon && (disabled ? <Loader2 size={size === 'sm' ? 14 : 16} className="animate-spin"/> : <Icon size={size === 'sm' ? 14 : 16} />)}
                {children}
            </button>
        );
    };

    const Avatar = ({ name, url, size = "md" }) => {
        const dims = size === 'lg' ? 'w-10 h-10 text-sm' : 'w-8 h-8 text-xs';
        return (
            <div className={`${dims} rounded-full bg-gradient-to-tr from-slate-700 to-slate-600 flex items-center justify-center font-bold text-white border border-slate-500/50 shrink-0 overflow-hidden shadow-sm`}>
                {url ? <img src={url} alt={name} className="w-full h-full object-cover" /> : (name ? name.charAt(0) : '?')}
            </div>
        );
    };

    // --- COMPONENTE GRAFICO DE EMBUDO HORIZONTAL ---
    const HorizontalFunnel = ({ stats }) => {
        const maxVal = Math.max(stats.new, stats.interview, stats.ready) || 1;
        
        // Alerta de nuevos (Si hay status 'new' > 0)
        const newAlert = stats.newUnseen > 0;

        const steps = [
            { id: 'stage_1', label: 'Explorar', count: stats.new, color: 'bg-blue-600', width: 'w-full' },
            { id: 'stage_2', label: 'Gesti√≥n', count: stats.interview, color: 'bg-purple-600', width: 'w-2/3' },
            { id: 'stage_3', label: 'Informes', count: stats.ready, color: 'bg-emerald-600', width: 'w-1/3' },
        ];

        return (
            <div className="bg-slate-900 border border-slate-800 rounded-xl p-5 mb-6">
                <h3 className="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2">
                    <BarChart2 size={16}/> Flujo de Conversi√≥n Actual
                </h3>
                <div className="space-y-4">
                    {steps.map((step) => (
                        <div key={step.id} className="relative">
                            <div className="flex justify-between text-xs mb-1 font-medium">
                                <span className="text-white flex items-center gap-2">
                                    {step.label}
                                    {step.id === 'stage_1' && newAlert && (
                                        <span className="flex items-center gap-1 text-[9px] bg-blue-500 text-white px-1.5 py-0.5 rounded-full animate-pulse">
                                            +{stats.newUnseen} Nuevos
                                        </span>
                                    )}
                                </span>
                                <span className="text-slate-400">{step.count} Candidatos</span>
                            </div>
                            <div className="h-3 w-full bg-slate-950 rounded-full overflow-hidden border border-slate-800/50">
                                <div 
                                    className={`h-full rounded-full ${step.color} shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all duration-1000`} 
                                    style={{ width: `${(step.count / (stats.total || 1)) * 100}%`, minWidth: '5%' }}
                                ></div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    // --- HACER COMPONENTES GLOBALES PARA OTROS SCRIPTS ---
window.LucideIcon = LucideIcon;
window.Badge = Badge;
window.Card = Card;
window.SkeletonCard = SkeletonCard;
window.Button = Button;
window.Avatar = Avatar;
window.HorizontalFunnel = HorizontalFunnel;
// Exportamos todos los iconos desestructurados
Object.keys(Icons).forEach(iconName => {
    window[iconName] = Icons[iconName];
});
</file>

<file path="cliente_lite/Untitled">
// --- COMPONENTE LOGIN (PORTER√çA DE ACCESO) ---
const LoginView = ({ onLogin }) => {
    const team = [
        { name: "Gladymar", role: "Recursos Humanos" },
        { name: "Sandra", role: "Recursos Humanos" },
        { name: "Viviana (RRHH)", role: "Recursos Humanos" },
        { name: "Pilar (Closer)", role: "Ventas / Closer" },
        { name: "Norma (Calidad)", role: "Control de Calidad" },
        { name: "Daniel (CEO)", role: "Direcci√≥n" },
        { name: "Admin", role: "Superusuario" }
    ];
    
    return (
        <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden">
            <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 pointer-events-none"></div>
            <div className="relative z-10 w-full max-w-md p-8 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl animate-in fade-in zoom-in duration-300">
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">Global Talent</h1>
                    <p className="text-slate-400 text-sm italic">"Conectando talento, autom√°ticamente"</p>
                </div>

                <div className="space-y-3">
                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] text-center mb-4">Seleccion√° tu perfil de acceso</p>
                    {team.map(user => (
                        <button 
                            key={user.name}
                            onClick={() => onLogin(user.name)}
                            className="w-full p-4 rounded-xl bg-slate-800 hover:bg-blue-600 border border-slate-700 hover:border-blue-500 transition-all group flex items-center justify-between"
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-slate-700 group-hover:bg-white/20 flex items-center justify-center text-white font-bold text-sm shadow-inner">
                                    {user.name.charAt(0)}
                                </div>
                                <div className="text-left">
                                    <p className="font-bold text-slate-200 group-hover:text-white leading-none">{user.name}</p>
                                    <p className="text-[10px] text-slate-500 group-hover:text-blue-100 uppercase mt-1.5 font-medium tracking-wider">{user.role}</p>
                                </div>
                            </div>
                            <LucideIcon name="ChevronRight" size={16} className="text-slate-600 group-hover:text-white transition-transform group-hover:translate-x-1" />
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- APP CONTAINER ---
function App() {
    // 1. ESTADOS (HOOKS) - Siempre arriba de todo
    const [activeTab, setActiveTab] = useState('dashboard');
    const [currentReport, setCurrentReport] = useState(null);
    const [selectedCandidateId, setSelectedCandidateId] = useState(null);
    const [candidates, setCandidates] = useState([]);
    const [loading, setLoading] = useState(false);
    const [init, setInit] = useState(false);
    const [currentUser, setCurrentUser] = useState(null); 

    const LOGO_URL = "./GLOBAL.jpg";

    // 2. FUNCI√ìN DE CARGA
    const cargarDatos = async (forceRefresh = false) => {
        if (init && !forceRefresh) return;
        setLoading(true);
        const CACHE_KEY = 'global_talent_cache_v1';
        const CACHE_TIME_KEY = 'global_talent_time';
        const VALIDEZ_MINUTOS = 15;

        try {
            const now = new Date().getTime();
            const cachedRaw = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

            if (!forceRefresh && cachedRaw && cachedTime) {
                const edadMinutos = (now - parseInt(cachedTime)) / (1000 * 60);
                if (edadMinutos < VALIDEZ_MINUTOS) {
                    setCandidates(JSON.parse(cachedRaw));
                    setInit(true);
                    setLoading(false);
                    return;
                }
            }
            const data = await api.candidates.list();
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            localStorage.setItem(CACHE_TIME_KEY, now.toString());
            setCandidates(data);
            setInit(true);
        } catch (error) {
            console.error("‚ùå Error cargando datos:", error);
        } finally {
            setLoading(false);
        }
    };

    // 3. EFECTOS (HOOKS)
    useEffect(() => { 
        if (currentUser) cargarDatos(); 
    }, [currentUser]);

    // 4. LA PORTER√çA (RECI√âN AQU√ç EL IF)
    if (!currentUser) {
        return <LoginView onLogin={(name) => setCurrentUser(name)} />;
    }

    // 5. L√ìGICA DE ACTUALIZACI√ìN (USANDO EL USUARIO ACTUAL)
    const handleUpdateCandidate = async (id, updates) => {
        let finalUpdates = { ...updates };
        
        if (updates.stage === 'stage_2') {
            finalUpdates.assignedTo = currentUser; // Estampa autom√°tica
            finalUpdates.status_interno = 'interview_pending';
        }

        if (updates.stage === 'trash' || updates.stage === 'stage_3') {
            setSelectedCandidateId(null);
        }

        setCandidates(prev => prev.map(c => {
            if (c.id === id) {
                if (activeTab === 'stage_1' && c.status_interno === 'new' && !updates.stage) {
                    finalUpdates.status_interno = 'viewed';
                }
                return { ...c, ...finalUpdates };
            }
            return c;
        }));

        await api.candidates.update(id, finalUpdates);
    };

    const handleSelectCandidate = (id) => {
        setSelectedCandidateId(id);
        handleUpdateCandidate(id, {});
    };

    const renderContent = () => {
        if (currentReport) {
            return <ProfessionalReport data={currentReport} onBack={() => setCurrentReport(null)} />;
        }

        if (selectedCandidateId) {
            const cand = candidates.find(c => c.id === selectedCandidateId);
            if (!cand) {
                setSelectedCandidateId(null);
                return null;
            }
            return (
                <CandidateDetail 
                    key={cand.id} 
                    candidate={cand} 
                    onBack={() => setSelectedCandidateId(null)} 
                    onUpdate={handleUpdateCandidate} 
                    loading={loading}
                    currentUser={currentUser} // Pasamos el usuario logueado
                />
            );
        }
        // ... (contin√∫a el resto del switch que ten√≠as antes)
</file>

<file path="docs/CONCEPTOS_FUNDAMENTALES.md">
# üèõÔ∏è CONCEPTOS FUNDAMENTALES - ARQUITECTURA

> **Para Tech Leads y Developers.** Entendiendo el motor bajo el cap√≥.
>
> **Tiempo estimado de lectura:** 40 minutos
> **Nivel:** Avanzado

---

## üìç TABLA DE CONTENIDOS

1. [El Modelo de 3 Capas](#el-modelo-de-3-capas)
2. [Las 2 Funciones Cr√≠ticas de IA](#las-2-funciones-cr√≠ticas-de-ia)
3. [Flujo de Datos en Tiempo Real](#flujo-de-datos-en-tiempo-real)
4. [Modelo de Seguridad](#modelo-de-seguridad)

---

## üèóÔ∏è El Modelo de 3 Capas

Nuestro sistema no es monol√≠tico. Son 3 piezas independientes hablando entre s√≠:

### 1. CAPA DE PRESENTACI√ìN (Frontend)
*   **Tecnolog√≠as:** HTML5 + Vanilla JS + Tailwind CSS.
*   **Ubicaci√≥n:** `dashboard.html` + `Cliente_lite/`.
*   **Filosof√≠a:** "Tonta y bonita".
    *   No procesa datos complejos.
    *   No guarda estado localmente (stateless).
    *   Solo escucha eventos de Firestore y renderiza.
    *   Env√≠a √≥rdenes al backend mediante `fetch()` a endpoints protegidos.

### 2. CAPA L√ìGICA (Backend)
*   **Tecnolog√≠as:** Node.js (v18+) + Express.
*   **Ubicaci√≥n:** `index.js`.
*   **Filosof√≠a:** "El cerebro obrero".
    *   **Cron Jobs:** Ejecuta un bucle cada 2 minutos para leer Gmail.
    *   **Orquestador:** Conecta Gmail API <-> Gemini AI <-> Firestore.
    *   **Validaci√≥n:** Verifica que los datos sean coherentes antes de guardar.

### 3. CAPA DE DATOS (Persistencia)
*   **Tecnolog√≠as:** Firestore (NoSQL) + Google Cloud Storage.
*   **Filosof√≠a:** "La verdad √∫nica".
    *   Si un dato no est√° en Firestore, no existe.
    *   Estructura de colecciones:
        *   `candidatos`: Todos los perfiles activos.
        *   `papelera`: Perfiles descartados (TTL de 30 d√≠as opcional).
        *   `config`: Variables din√°micas del sistema.

---

## üß† Las 2 Funciones Cr√≠ticas de IA

El coraz√≥n del sistema son dos funciones as√≠ncronas que invocan a Google Gemini Pro.

### Funci√≥n 1: El Clasificador (`organizarCVconIA`)
Esta funci√≥n transforma el caos (texto crudo de un PDF) en orden (JSON).

*   **Input:** Texto plano extra√≠do del PDF.
*   **Prompt Engineering:**
    > "Act√∫a como un reclutador experto. Extrae: Nombre, Email, Skills (Array), Experiencia (Resumen), Idiomas. Asigna un Score del 1 al 10 basado en relevancia para [Puesto]."
*   **Output:** Objeto JSON estricto.
*   **Manejo de Errores:** Si el JSON viene mal formado, la funci√≥n tiene un mecanismo de "auto-repair" (reintenta pidiendo correcci√≥n a la IA).

### Funci√≥n 2: El Analista Profundo (`analisisIaProfundo`)
Esta es la funci√≥n m√°s costosa y potente. Se ejecuta solo bajo demanda (bot√≥n "Analizar").

*   **Inputs Cruzados:**
    1.  JSON del CV (Hard Skills).
    2.  Transcripci√≥n de la entrevista (Soft Skills & Comunicaci√≥n).
    3.  Notas del reclutador (Observaciones humanas).
*   **Misi√≥n:** Detectar inconsistencias. *¬øEl candidato dice saber ingl√©s pero en la entrevista titube√≥?*
*   **Output:** Texto Markdown listo para convertirse en DOCX.

---

## üîÑ Flujo de Datos en Tiempo Real

A diferencia de apps web tradicionales, aqu√≠ no necesitamos refrescar la p√°gina (`F5`).

1.  **Evento Externo:** Llega un email.
2.  **Backend:** Procesa y hace `db.collection('candidatos').add(data)`.
3.  **Firestore:** Detecta el cambio y emite un evento `onSnapshot`.
4.  **Frontend:** El listener `db.collection('candidatos').onSnapshot(...)` recibe el dato nuevo.
5.  **UI:** JavaScript inyecta el HTML del nuevo candidato en el DOM.

**Latencia promedio:** < 800ms desde que el backend guarda hasta que el reclutador lo ve.

---

## üîê Modelo de Seguridad

### Autenticaci√≥n
*   No usamos usuarios/contrase√±as propios. Delegamos todo a **Google Identity Platform**.
*   El backend verifica el token JWT en cada petici√≥n sensible (`authMiddleware.js`).

### Sanitizaci√≥n
*   Todos los inputs que van a generar el DOCX se limpian para evitar inyecciones que rompan el XML del documento Word.

### Backup & Recuperaci√≥n
*   **Soft Delete:** Cuando borras un candidato, en realidad solo cambiamos su campo `status` a `'papelera'`.
*   Solo el administrador de la base de datos puede hacer un "Hard Delete" definitivo.
</file>

<file path=".cursorrules">
# ü§ñ Ariel's Tech Lead & Pair Programmer Rules

## 1. ROL
Sos mi Tech Lead y compa√±ero de programaci√≥n.
- **Tu prioridad:** Que yo ENTIENDA, no solo que funcione.
- **Tu misi√≥n:** Mantenibilidad y aprendizaje.
- **Tu m√©todo:** Entender ‚Üí Planificar ‚Üí Cambios Chicos ‚Üí Probar.

## 2. TONO Y LENGUAJE
- **Idioma:** Espa√±ol Rioplatense/Argentino ("Che", "fijate", "mir√°").
- **Estilo:** Informal pero profesional.
- **Explicaciones:** "En criollo".
  - Prohibido usar jerga t√©cnica (endpoint, hook, props) sin explicarla con una analog√≠a simple.
  - *Ejemplo:* "Endpoint = La ventanilla donde el backend atiende los pedidos".

## 3. PROTOCOLO DE INICIO (OBLIGATORIO)
Antes de escribir una sola l√≠nea de c√≥digo:
1.  **Pide Contexto:** "¬øQu√© falla?", "¬øHay errores en consola?", "¬øQu√© archivo sospechas?".
2.  **Analiza:** Si te mando c√≥digo/logs/fotos, dame:
    - Resumen humano: Qu√© hace este pedazo de sistema y cu√°l es el problema.
    - Mapa mental: Backend ‚Üí Frontend ‚Üí Servicios (n8n, Zoho, Firebase, Render).
3.  **Plan de Debug:** Pasos l√≥gicos para investigar SIN tocar c√≥digo a√∫n.

## 4. ANTES DEL C√ìDIGO (LA REGLA DEL SEM√ÅFORO)
‚õî **STOP:** No escupas bloques de c√≥digo gigantes.
‚ö†Ô∏è **PRECAUCI√ìN:** Antes de la soluci√≥n, expl√≠came:
   - La idea conceptual.
   - D√≥nde va (archivo/l√≠nea).
   - Si toca algo cr√≠tico o viejo.
   - Si es un cambio chico o grande.
‚úÖ **GO:** Solo cuando yo diga "Dale, mostrame el c√≥digo", pasas a la acci√≥n.

## 5. FORMATO DE C√ìDIGO (QUIR√öRGICO)
- **Cero Copy-Paste Masivo:** Odio que reescribas archivos enteros.
- **C√≥mo presentar cambios:**
  1.  **Ubicaci√≥n:** "Busc√° con Cmd+F: `function handleInterviewSubmit` en `src/pages/dashboard.jsx`".
  2.  **Punto Exacto:** "Justo abajo de la l√≠nea `// Enviar mail`".
  3.  **Diff Claro:**
      - "Reemplaz√° ESTO:" `[c√≥digo viejo]`
      - "Por ESTO:" `[c√≥digo nuevo]`
  4.  **Aclaraciones:** Si es un bloque grande inevitable, justifica por qu√©.

## 6. REGLAS DE ORO (SEGURIDAD)
- **üé® DISE√ëO SAGRADO:** No rompas mi Dark Mode. Si tocas CSS, avisa qu√© impacta.
- **üß± MOCKUPS/HARDCODE:** Si ves datos fijos, asume que quiero hacerlos din√°micos, pero PREGUNTA antes de borrar. "¬øChe, conectamos esto a la API o lo dejamos fijo un rato m√°s?".
- **ü™ú PASO A PASO:** Primero visual, luego funcional, al final optimizaci√≥n. No mezcles todo.
- **üñºÔ∏è REFERENCIA VISUAL:** Mis screenshots son la ley de c√≥mo debe verse.

## 7. CONTEXTO T√âCNICO (STACK DE ARIEL)
- **Backend:** Python / Node.js.
- **Infra/Servicios:** Firebase (Firestore/Storage), Render, n8n (Automatizaciones).
- **Frontend:** React / Next.js / HTML+CSS simple.
- **Herramientas:** Cursor IDE.
- **Flujo Mental:** ZOHO ‚Üí Webhook ‚Üí Firebase ‚Üí Frontend.

## 8. PROTOCOLO DE RESPUESTA
Sigue siempre este orden mental:
1.  Entender (pedir info).
2.  Explicar en humano.
3.  Plan de acci√≥n.
4.  (Solo tras mi OK) C√≥digo quir√∫rgico.
5.  C√≥mo probar ("And√° a tal ruta y hac√© clic").
# Reglas de Ariel
- NUNCA modificar c√≥digo existente sin autorizaci√≥n expl√≠cita
- Solo agregar l√≠neas cuando se solicite expl√≠citamente
- Siempre avisar antes de hacer cambios que no sean solo agregar l√≠neas
- Preferir agregar bloques nuevos en vez de reemplazar c√≥digo existente
</file>

<file path="authMiddleware.js">
const admin = require("firebase-admin");

/* Extrae token Bearer */
function extractBearer(req) {
  const h = req.headers.authorization || req.headers.Authorization || "";
  const m = /^bearer\s+(.+)$/i.exec((h || "").trim());
  return m ? m[1].trim() : null;
}

module.exports = async function verifyToken(req, res, next) {
  // Permitir preflight sin verificar token
  if (req.method === "OPTIONS") {
    return res.status(204).send("");
  }

  const idToken = extractBearer(req) || (req.cookies && req.cookies.token);

  if (!idToken) {
    return res.status(401).json({ error: "Token no proporcionado." });
  }

  try {
    const decoded = await admin.auth().verifyIdToken(idToken, true);

    if (!decoded || !decoded.uid) {
      return res.status(401).json({ error: "Token inv√°lido." });
    }

    req.user = decoded;
    next();

  } catch (err) {
    console.error("üî• Error verifyToken:", err);

    let msg = "Token inv√°lido o expirado.";

    if (err.code === "auth/id-token-expired") msg = "Token expirado.";
    if (err.code === "auth/id-token-revoked") msg = "Token revocado.";

    return res.status(401).json({ error: msg });
  }
};
</file>

<file path="calendar.js">
const express = require("express");
const { google } = require("googleapis");

const router = express.Router();

function getAuth() {
  return new google.auth.GoogleAuth({
    credentials: {
      client_email: process.env.GOOGLE_CLIENT_EMAIL2,
      private_key: process.env.GOOGLE_PRIVATE_KEY2.replace(/\\n/g, "\n"),
    },
    projectId: process.env.GOOGLE_PROJECT_ID2,
    scopes: ["https://www.googleapis.com/auth/calendar"],
  });
}

// GET - Eventos
router.get("/eventos", async (req, res) => {
  try {
    const auth = await getAuth().getClient();
    const calendar = google.calendar({ version: "v3", auth });

    const resp = await calendar.events.list({
      calendarId: process.env.GOOGLE_CALENDAR_ID2,
      timeMin: new Date().toISOString(),
      singleEvents: true,
      orderBy: "startTime",
    });

    res.json(resp.data.items);
  } catch (e) {
    console.error("GET Error:", e);
    res.status(500).send("Error obteniendo eventos");
  }
});

// POST - Crear evento COMPLETO
router.post("/eventos", async (req, res) => {
  try {
    const { title, description, start, end, invitados, ubicacion, meet } =
      req.body;

    const auth = await getAuth().getClient();
    const calendar = google.calendar({ version: "v3", auth });

    const event = {
      summary: title,
      description,
      location: ubicacion || "",
      attendees: invitados?.map((email) => ({ email })) || [],
      start: { dateTime: start, timeZone: "America/Bogota" },
      end: { dateTime: end, timeZone: "America/Bogota" },
      conferenceData: meet
        ? {
            createRequest: { requestId: new Date().getTime().toString() },
          }
        : undefined,
    };

    const resp = await calendar.events.insert({
      calendarId: process.env.GOOGLE_CALENDAR_ID2,
      resource: event,
      conferenceDataVersion: 1,
    });

    res.json(resp.data);
  } catch (e) {
    console.error("POST Error:", e);
    res.status(500).send("Error creando evento");
  }
});

// DELETE - Eliminar
router.delete("/eventos/:id", async (req, res) => {
  try {
    const auth = await getAuth().getClient();
    const calendar = google.calendar({ version: "v3", auth });

    await calendar.events.delete({
      calendarId: process.env.GOOGLE_CALENDAR_ID2,
      eventId: req.params.id,
    });

    res.json({ success: true });
  } catch (e) {
    console.error("DELETE Error:", e);
    res.status(500).send("Error eliminando evento");
  }
});

module.exports = router;
</file>

<file path="Dockerfile">
# Base Node + Debian slim
FROM node:20-bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1

# 1) Sistema: Python + venv + LibreOffice + fuentes + ffmpeg
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-venv python3-pip \
    libreoffice libreoffice-writer \
    fonts-dejavu fonts-liberation fonts-noto \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 2) Crear y activar virtualenv para evitar el error "externally-managed"
RUN python3 -m venv /opt/venv
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

# 3) Python deps (aprovecha cache copiando solo requirements primero)
COPY requirements.txt .
RUN pip install --upgrade pip && pip install --no-cache-dir -r requirements.txt

# 4) Node deps (aprovecha cache)
COPY package*.json ./
RUN npm install --omit=dev
# 5) C√≥digo fuente completo
COPY . .

# 6) (Opcional) pasa la ruta del binario de Python a tu app Node
ENV PYTHON_BIN=python

# 7) Puerto expuesto y comando de arranque
EXPOSE 10000
CMD ["node", "index.js"]
</file>

<file path="ficha.py">
# -*- coding: utf-8 -*-
"""
ficha.py ‚Äî Genera Ficha de Evaluaci√≥n (DOCX/PDF) a partir de TXT + CV con un solo llamado a IA.
- La IA devuelve TODOS los campos (encabezado, info personal, resumen, √°reas t√©cnicas,
  blandas con justificaci√≥n, herramientas con %, compatibilidad, potencial, formativas,
  recomendaci√≥n final).
- Herramientas: SOLO desde el TXT con % (regex). La IA no puede inventarlas.
- Profesi√≥n: prioriza lo que est√© en el CV.
- Contabilidad: criterio de compatibilidad m√°s estricto.
- Secciones/filas vac√≠as NO se muestran.
- Validador PERMISIVO: no corta la ejecuci√≥n; solo advierte en stderr.

üî∏ Personalizaci√≥n pedida:
Si en el texto (extra_file / extra) aparece una l√≠nea:
  "Tipo asistente: <texto libre>"  o  "Tipo de asistente: <texto libre>"
ese valor se usa literalmente en el t√≠tulo:
  Ficha de Evaluaci√≥n de Perfil ‚Äì Asistente virtual de "<texto libre>"
"""

import os, re, json, argparse, subprocess
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Tuple, Any

# --- Forzar stdout/stderr a UTF-8 en Windows ---
import sys, io
try:
    # Python 3.7+ soporta reconfigure
    sys.stdout.reconfigure(encoding="utf-8", errors="strict")
    sys.stderr.reconfigure(encoding="utf-8", errors="replace")
except Exception:
    # Fallback por si el stream no permite reconfigure
    if hasattr(sys.stdout, "buffer"):
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8", errors="strict")
    if hasattr(sys.stderr, "buffer"):
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding="utf-8", errors="replace")


# === Opcional: cargar .env ===
try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass

# === OpenAI ===
_HAS_OPENAI = True
try:
    from openai import OpenAI
except Exception:
    _HAS_OPENAI = False

# === Lectura CV/TXT y DOCX ===
from docx import Document
from docx.shared import Pt, Cm, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH, WD_BREAK
from docx.enum.table import WD_TABLE_ALIGNMENT
from docx.oxml import OxmlElement
from docx.oxml.ns import qn

try:
    from docx2pdf import convert as docx2pdf_convert
except Exception:
    docx2pdf_convert = None

try:
    from pdfminer.high_level import extract_text as pdf_extract_text
    PDFMINER_AVAILABLE = True
except Exception:
    PDFMINER_AVAILABLE = False

try:
    import docx2txt
    DOCTXTXT_AVAILABLE = True
except Exception:
    DOCTXTXT_AVAILABLE = False


# =========================
#   Config
# =========================
PLACE = {"areas": 10, "competencias": 5, "herrs": 12, "pots": 5, "recs": 5}
_CATEGORIES = ["Contabilidad","Administraci√≥n","IA","Recursos humanos","Dise√±o",
               "Marketing","Econom√≠a","Comunicaci√≥n","Calidad","Arquitectura"]

# Usos conocidos (ampliado)
TOOLS_USAGE = {
    "autocad": "Dise√±o y planos arquitect√≥nicos",
    "revit": "Modelado BIM y coordinaci√≥n",
    "sketchup": "Modelado 3D y visualizaci√≥n",
    "archicad": "Modelado BIM y documentaci√≥n",
    "photoshop": "Edici√≥n y retoque de im√°genes",
    "illustrator": "Gr√°ficos vectoriales y piezas",
    "microsoft project": "Planificaci√≥n y seguimiento",
    "microsoft office": "Documentaci√≥n y presentaciones",
    "microsoft excel": "Modelado y an√°lisis de datos en hojas de c√°lculo",
    "excel": "Modelado y an√°lisis de datos en hojas de c√°lculo",
    "google workspace": "Colaboraci√≥n y productividad",
    "google calendar": "Gesti√≥n de agenda, eventos y reuniones",
    "calendar": "Gesti√≥n de agenda, eventos y reuniones",
    "asana": "Gesti√≥n y priorizaci√≥n de tareas",
    "trello": "Tableros kanban y seguimiento",
    "notion": "Documentaci√≥n de procesos",
    "metricool": "Anal√≠tica y programaci√≥n social",
    "mailchimp": "Email marketing y automatizaci√≥n",
    "pipedrive": "Gesti√≥n de ventas y CRM",
    "canva": "Dise√±o r√°pido de piezas",
    "meta ads": "Gesti√≥n de campa√±as en Meta",
    "google ads": "Publicidad y performance",
    "odoo": "ERP y procesos contables",
    "sap": "ERP corporativo",
    "profit": "Contabilidad y finanzas",
    "slack": "Mensajer√≠a y colaboraci√≥n en equipos",
    "discord": "Comunicaci√≥n por canales y comunidades",
}

# Colores y fuente
COLOR_BANNER = "0B2A5B"
COLOR_HDR = "E7EEF8"
COLOR_SECTION_BAR = "F2F2F2"
FONT_NAME = "Arial"
FS_BASE = 10
FS_TITLE = 11

SIDE_PADDING_CM = 1.3
W_TECH = [2.5, 1.2]
W_SOFT = [2.2, 5.5]
W_TOOLS = [3, 4, 1.5]
W_COMPAT = [3, 2, 4]


# =========================
#   Utilidades
# =========================
def read_text(path: Path) -> str:
    try:
        return path.read_text(encoding="utf-8", errors="ignore")
    except Exception:
        return ""

def read_cv_any(path: Path) -> str:
    if not path or not path.exists():
        return ""
    suf = path.suffix.lower()
    try:
        if suf == ".docx" and DOCTXTXT_AVAILABLE:
            return docx2txt.process(str(path)) or ""
        if suf == ".pdf" and PDFMINER_AVAILABLE:
            return pdf_extract_text(str(path)) or ""
        return read_text(path)
    except Exception:
        return ""

def sanitize_short_field(s: str, max_chars=48, max_words=6) -> str:
    s = (s or "").strip()
    s = re.sub(r"\s+", " ", s)
    words = re.findall(r"\S+", s)
    if len(s) > max_chars or len(words) > max_words:
        return ""
    return s

def pct_int(s: str) -> int:
    m = re.search(r"(\d{1,3})", (s or ""))
    return int(m.group(1)) if m else -1

def normalize_tool(name: str) -> str:
    """
    Limpia frases tipo 'He utilizado slack', 'uso de Calendar', etc. y
    normaliza sin√≥nimos a la marca correcta.
    """
    s = (name or "").strip()
    s = re.sub(r"^[^A-Za-z√Å-√ø]+", "", s)
    s = re.sub(
        r"(?i)\b(he\s+utilizado|he\s+usado|he\s+manejado|utilizo|uso|manejo|maneja|manejar|"
        r"conocimiento\s+de|experiencia\s+en|trabajo\s+con|he\s+trabajado\s+con|uso\s+de|"
        r"herramientas?\s+de)\b[:\-]?\s*",
        "",
        s,
    )
    s = re.sub(r"\s+", " ", s).strip()

    sl = s.lower()
    syn = {
        "project": "Microsoft Project",
        "ms project": "Microsoft Project",
        "office": "Microsoft Office",
        "excel": "Microsoft Excel",
        "g suite": "Google Workspace",
        "google suite": "Google Workspace",
        "calendar": "Google Calendar",
        "google calendar": "Google Calendar",
        "autocad": "AutoCAD",
        "sketchup": "SketchUp",
        "adwords": "Google Ads",
        "facebook ads": "Meta Ads",
        "slack": "Slack",
        "discord": "Discord",
    }
    norm = syn.get(sl, s)
    if norm and norm[0].islower():
        norm = norm[0].upper() + norm[1:]
    return norm

def tool_usage_guess(name: str) -> str:
    """
    Devuelve un uso claro y espec√≠fico; nunca 'Uso relacionado al rol'.
    """
    key = (name or "").strip().lower()
    if key in TOOLS_USAGE:
        return TOOLS_USAGE[key]

    # Heur√≠sticas por familia
    if "excel" in key or "sheet" in key:
        return "Modelado y an√°lisis de datos en hojas de c√°lculo"
    if "calendar" in key or "agenda" in key:
        return "Gesti√≥n de agenda, eventos y reuniones"
    if any(w in key for w in ["slack", "discord", "teams", "whatsapp", "telegram"]):
        return "Mensajer√≠a y colaboraci√≥n en equipos"
    if any(w in key for w in ["ads", "sem", "seo", "mailchimp", "metricool"]):
        return "Gesti√≥n y optimizaci√≥n de campa√±as de marketing digital"
    if any(w in key for w in ["crm", "pipedrive", "hubspot", "salesforce"]):
        return "Gesti√≥n de oportunidades comerciales en CRM"
    if any(w in key for w in ["project", "asana", "trello", "notion", "jira"]):
        return "Planificaci√≥n y seguimiento de proyectos y tareas"
    if any(w in key for w in ["autocad", "revit", "archicad", "sketchup"]):
        return "Modelado y documentaci√≥n t√©cnica"
    if any(w in key for w in ["photoshop", "illustrator", "canva", "figma"]):
        return "Dise√±o y edici√≥n de piezas visuales"
    if any(w in key for w in ["odoo", "sap", "profit"]):
        return "Soporte a procesos contables y de gesti√≥n en ERP"

    return "Aplicaci√≥n pr√°ctica de herramientas del √°rea"

def infer_years_experience(main_txt: str, cv_txt: str) -> int:
    # expl√≠cito
    def _explicit_years(t: str) -> int:
        t = (t or "").lower()
        cands = []
        for m in re.finditer(r"(?:con\s+)?(\d{1,2})\s+a√±os\s+de\s+experiencia", t): cands.append(int(m.group(1)))
        for m in re.finditer(r"experiencia\s+de\s+(\d{1,2})\s+a√±os", t): cands.append(int(m.group(1)))
        for m in re.finditer(r"(?:m[a√°]s\s+de|over)\s+(\d{1,2})\s+a√±os", t): cands.append(int(m.group(1))+1)
        return max(cands) if cands else -1
    for source in [main_txt, cv_txt]:
        y = _explicit_years(source)
        if y >= 0:
            return y

    # inferencia por rango de a√±os en experiencia
    text = (cv_txt or "") + "\n" + (main_txt or "")
    lines = [ln.strip() for ln in text.splitlines() if ln.strip()]
    YEAR_RE  = re.compile(r"\b(19\d{2}|20\d{2})\b")
    IN_EXP_RE = re.compile(r"(?i)(experiencia|laboral|trayectoria|work\s*experience|employment)")
    BAD_NEAR = re.compile(r"(?i)(nacim|nacimiento|edad|fecha|dd|mm|aaaa)")
    in_exp = False
    years: List[int] = []
    curr = datetime.now().year
    for ln in lines:
        if IN_EXP_RE.search(ln): in_exp = True; continue
        if re.search(r"(?i)(educaci[o√≥]n|formaci[o√≥]n|estudios|referencias|datos|perfil|sobre m[i√≠])", ln):
            in_exp = False
        if not in_exp: continue
        if BAD_NEAR.search(ln): continue
        for m in YEAR_RE.findall(ln):
            y = int(m)
            if 1980 <= y <= curr:
                years.append(y)
    if years:
        start = min(years)
        est = max(0, curr - start)
        if est <= 45: return est
    return 0


# =========================
#   Herramientas (solo con %)
# =========================
TOOLS_ANCHOR_RE = re.compile(
    r"(?is)para\s+el\s+√°rea\s+que\s+est[√°a]s?\s+aplicando.*?(herramientas|programas).*?(utilizado|utilizas|has utilizado)"
)
NEXT_SECTION_RE = re.compile(
    r"(?im)^\s*(secci[o√≥]n|compatibilidad|dudas|inquietudes|disponibilidad|expectativas|observaci[o√≥]n|categor[i√≠]a|notas)\b.*$"
)

def _slice_tools_block(full_text: str) -> str:
    s = full_text.replace("\r", "")
    m = TOOLS_ANCHOR_RE.search(s)
    if not m:
        return ""
    start = m.start()
    tail = s[start:]
    end_match = NEXT_SECTION_RE.search(tail)
    return tail[:end_match.start()] if end_match else tail

def extract_tools_with_percent_from_text(full_text: str, maxn: int = 40) -> List[Dict[str, str]]:
    """
    Extrae SOLO herramientas con % expl√≠cito desde el texto.
    Soporta:
      - "Asana ‚Äì 100%"  /  "Asana - 100%"  /  "Asana 100%"
      - Nombre en una l√≠nea y % en la siguiente.
    """
    text = (full_text or "").replace("\r", "")
    block = _slice_tools_block(text)
    candidates: List[Tuple[str, str]] = []

    def harvest(lines: List[str]) -> None:
        nonlocal candidates
        pat_inline = re.compile(r"([A-Za-z√Å-√ø][A-Za-z√Å-√ø0-9 .+/_()-]{1,}?)\s*[:\-‚Äì‚Äî]?\s*(\d{1,3})\s*%", re.I)
        pat_name = re.compile(r"([A-Za-z√Å-√ø][A-Za-z√Å-√ø0-9 .+/_()-]{1,})$")
        buffer = None
        for raw in lines:
            ln = raw.strip()
            if not ln: continue
            hits = pat_inline.findall(ln)
            if hits:
                for n, p in hits:
                    n = normalize_tool(n)
                    if len(re.sub(r"[^A-Za-z√Å-√ø]", "", n)) >= 3:
                        candidates.append((n, f"{min(max(int(p),0),100)}%"))
                buffer = None
                continue
            if buffer is None:
                m = pat_name.search(ln)
                if m:
                    cand = normalize_tool(m.group(1))
                    if len(re.sub(r"[^A-Za-z√Å-√ø]", "", cand)) >= 3:
                        buffer = cand
                continue
            else:
                m2 = re.search(r"(\d{1,3})\s*%", ln)
                if m2:
                    candidates.append((buffer, f"{min(max(int(m2.group(1)),0),100)}%"))
                    buffer = None

    if block:
        harvest(block.splitlines())
    if not candidates:
        harvest(text.splitlines())

    merged: Dict[str, Dict[str, str]] = {}
    for name, dom in candidates:
        key = name.lower()
        if key in merged:
            if pct_int(dom) > pct_int(merged[key]["dom"]):
                merged[key]["dom"] = dom
        else:
            merged[key] = {"herr": name, "dom": dom, "uso": tool_usage_guess(name)}
    out = list(merged.values())
    out.sort(key=lambda x: pct_int(x.get("dom","")), reverse=True)
    return out[:maxn]


# =========================
#   IA: un solo llamado para TODO
# =========================
def _ai_enabled() -> bool:
    return _HAS_OPENAI and bool(os.environ.get("OPENAI_API_KEY"))

def ai_extract_all_fields(full_text: str, cv_text: str,
                          pre_tools: List[Dict[str, str]],
                          model: str = "gpt-4o-mini",
                          temperature: float = 0.2) -> Dict[str, Any]:
    """
    Un solo llamado a la IA con TXT + CV. Devuelve todos los campos para la ficha.
    Herramientas se pasan desde regex (pre_tools) y la IA debe usarlas tal cual.
    """
    if not _ai_enabled():
        raise RuntimeError("OPENAI_API_KEY no configurada o SDK no disponible.")

    client = OpenAI()
    fuente = ((full_text or "") + "\n\n---CV---\n\n" + (cv_text or "")).strip()
    years_rules = infer_years_experience(full_text, cv_text)

    # Cantidades como GU√çA (no bloqueante). La validaci√≥n es permisiva.
    system = (
        "Eres un analista de RR.HH. Devuelve EXCLUSIVAMENTE un JSON v√°lido UTF-8, "
        "SIN texto extra ni fences, siguiendo este esquema. "
        "No inventes datos: deben salir del TXT o del CV. Profesi√≥n prioriza CV. Pa√≠s literal. "
        f"√Årea del t√≠tulo debe ser UNA de: {', '.join(_CATEGORIES)}. "
        "Edad: infi√©rela de la fecha de nacimiento si no est√° expl√≠cita. "
        "Resumen ejecutivo (gu√≠a 52‚Äì56 palabras): tercera persona, tono corporativo; "
        "menciona a√±os de experiencia; si no est√°n expl√≠citos, infi√©relos y decl√°ralo. "
        "Competencias t√©cnicas (gu√≠a 6‚Äì10): no blandas ni herramientas, puedes inferir las competencias tecnicas clave de las herrmientas ydel contexto general  para completar las 6 competencias minimas; cada una con evaluaci√≥n Alta/Media/B√°sica. "
        "Siempre listar m√≠nimo 6 competencias, sin repeticiones ni sin√≥nimos"
        "NO incluir competencias blandas, actitudes ni nombres de herramientas. "
        "Cada competencia debe redactarse en formato gen√©rico, t√©cnico y conciso. "
        "Competencias blandas (gu√≠a 3‚Äì5): cada una con justificaci√≥n ‚â§25 palabras. "
        "HERRAMIENTAS (estricto): Usa EXACTAMENTE la lista recibida en 'tools_regex' "
        "(misma cantidad y mismo 'dom' en %). Para cada elemento: "
        "1) Normaliza el nombre para que sea √∫nicamente el software/plataforma/aplicaci√≥n (p.ej., "
        "'He utilizado slack' -> 'Slack', 'excel' -> 'Microsoft Excel'). "
        "2) PROHIBIDO usar frases, verbos u oraciones como nombre; solo el nombre real de la herramienta. "
        "3) Escribe 'uso' como una frase breve y concreta del uso GENERAL de la herramienta "
        "(p.ej., 'Modelado y an√°lisis de datos en hojas de c√°lculo' para Microsoft Excel; "
        "'Gesti√≥n de agenda, eventos y reuniones' para Google Calendar; "
        "'Comunicaci√≥n por canales y comunidades' para Discord; "
        "'Mensajer√≠a y colaboraci√≥n en equipos' para Slack). "
        "4) No uses descripciones gen√©ricas como 'Uso relacionado al rol'. "
        "Para cada herramienta incluye 'uso' (descripci√≥n breve del uso general) y 'dom' (NN%). "
        "Compatibilidad: cuatro categor√≠as (Marketing Digital, Ventas y E-commerce, Gesti√≥n y Control, Contabilidad). "
        "Califica 1‚Äì5 estrellas con criterios estrictos basados en evidencia textual; incluye 'obs' breve y 'evid' con citas literales. "
        "Potencial: cinco bullets.describiendo el ptencial de aporte auna empresa que presenta el aplicante"
        "Recomendaciones Formativas: hasta cinco bullets.mencionar areas de mejora o que debe fortalecer tanto tecnicas como blandas para que el aplicante mejore como asistente "
        "Recomendaci√≥n final (gu√≠a 56‚Äì60 palabras). "
        "Aunque alguna secci√≥n tenga poca evidencia, SIEMPRE devuelve el esquema completo."
    )

    expected = {
        "area_titulo": "string (una de la lista; p.ej., Arquitectura)",
        "info_personal": {
            "nombre": "string",
            "edad": "string",
            "region": "string (pa√≠s literal)",
            "profesion": "string (prioriza CV; vac√≠o si no hay)",
            "categoria": "string (igual a area_titulo, si aplica)"
        },
        "resumen": "string",
        "tech_areas": [{"area": "string", "eval": "Alta|Media|B√°sica"}],
        "soft_skills": [{"comp":"string", "just":"string <=25 palabras"}],
        "tools": [{"herr":"string","uso":"string breve","dom":"NN%"}],  # EXACTAS a pre_tools
        "compat": {
            "Marketing Digital":{"rating":1,"obs":"string","evid":["frag1","frag2"]},
            "Ventas y E-commerce":{"rating":1,"obs":"string","evid":["frag1","frag2"]},
            "Gesti√≥n y Control":{"rating":1,"obs":"string","evid":["frag1","frag2"]},
            "Contabilidad":{"rating":1,"obs":"string","evid":["frag1","frag2"]},
        },
        "potencial": ["bullet1","bullet2","bullet3","bullet4","bullet5"],
        "formativas": ["bullet","bullet","bullet","bullet","bullet (m√°x)"],
        "recomendacion_final": "string"
    }

    user = {
        "texto_fuente": fuente,
        "a√±os_experiencia_reglas": years_rules,
        "categorias_validas": _CATEGORIES,
        "tools_regex": pre_tools,  # La IA debe usarlas tal cual
        "schema": expected
    }

    resp = client.responses.create(
        model=model,
        temperature=temperature,
        input=[
            {"role":"system","content": system},
            {"role":"user","content": json.dumps(user, ensure_ascii=False)}
        ]
    )

    raw = (resp.output_text or "").strip()
    raw = re.sub(r"^```(json)?\s*|\s*```$", "", raw).strip()
    data = json.loads(raw)

    # Forzar herramientas desde regex (mantiene 'uso' si la IA lo dio; si no, se infiere)
    fixed = []
    usage_map = { (t.get("herr","").strip().lower(), t.get("dom","").strip()): None for t in pre_tools }
    for t in (data.get("tools") or []):
        key = ((t.get("herr","").strip().lower()), (t.get("dom","").strip()))
        if key in usage_map:
            usage_map[key] = (t.get("uso") or "").strip() or tool_usage_guess(t.get("herr"))
    for pt in pre_tools:
        k = (pt["herr"].strip().lower(), pt["dom"].strip())
        use = usage_map.get(k) or tool_usage_guess(pt["herr"])
        fixed.append({"herr": pt["herr"], "dom": pt["dom"], "uso": use})
    data["tools"] = fixed

    return data


# =========================
#   Validador PERMISIVO (no aborta)
# =========================
def _soft_validate_ai_payload(data: dict, pre_tools: List[Dict[str, str]]) -> list[str]:
    warnings: list[str] = []

    def w(msg: str):
        clean = (msg or "").replace("\u2013", "-").replace("\u2014", "-").replace("\u2019","'")
        warnings.append(clean)

    # Estructura b√°sica
    required_keys = ["area_titulo","info_personal","resumen","tech_areas","soft_skills",
                     "tools","compat","potencial","formativas","recomendacion_final"]
    for k in required_keys:
        if k not in data:
            w(f"falta clave '{k}' en el JSON de la IA")

    ip = (data.get("info_personal") or {})
    for k in ["nombre","edad","region","profesion","categoria"]:
        if k not in ip:
            w(f"info_personal.{k} ausente")

    # Herramientas: coherencia con regex (nombre + %)
    tools = data.get("tools") or []
    def _key(t): return ((t.get("herr","").strip().lower()), (t.get("dom","").strip()))
    pre_set = {_key(t) for t in (pre_tools or [])}
    got_set = {_key(t) for t in tools}
    if pre_set != got_set:
        w("tools de la IA no coincide exactamente con tools_regex (nombre y %). Se forzar√°n desde regex en post-proceso.")

    # Compat: presencia de 4 categor√≠as y forma general
    compat = data.get("compat") or {}
    for cat in ["Marketing Digital","Ventas y E-commerce","Gesti√≥n y Control","Contabilidad"]:
        if cat not in compat:
            w(f"compat.{cat} ausente")
        else:
            c = compat.get(cat) or {}
            if "rating" not in c: w(f"compat.{cat}.rating ausente")
            if "obs" not in c:    w(f"compat.{cat}.obs ausente")
            if "evid" not in c or not isinstance(c.get("evid"), list):
                w(f"compat.{cat}.evid ausente o no es lista")

    # Vac√≠os: solo aviso
    if not (data.get("resumen") or "").strip():
        warnings.append("resumen vac√≠o")
    if not (data.get("recomendacion_final") or "").strip():
        warnings.append("recomendacion_final vac√≠a")
    if not (data.get("tech_areas") or []):
        warnings.append("tech_areas viene vac√≠o")
    if not (data.get("soft_skills") or []):
        warnings.append("soft_skills viene vac√≠o")
    if not (data.get("potencial") or []):
        warnings.append("potencial viene vac√≠o")
    if not (data.get("formativas") or []):
        warnings.append("formativas viene vac√≠o")

    return warnings


# =========================
#   Render helpers (DOCX)
# =========================
def _clean_val(x: str) -> str:
    return (x or "").replace("\u00A0", " ").strip()

def _apply_cell_shading(cell, color_hex):
    tcPr = cell._tc.get_or_add_tcPr()
    shd = OxmlElement('w:shd')
    shd.set(qn('w:val'), 'clear')
    shd.set(qn('w:color'), 'auto')
    shd.set(qn('w:fill'), color_hex)
    tcPr.append(shd)

def _set_run_font(run, bold=False, size_pt=FS_BASE, color_hex=None):
    run.bold = bold
    run.font.name = FONT_NAME
    run.font.size = Pt(size_pt)
    if color_hex:
        run.font.color.rgb = RGBColor.from_string(color_hex)

def _set_paragraph_compact(p, align=WD_ALIGN_PARAGRAPH.JUSTIFY):
    fmt = p.paragraph_format
    fmt.space_before = Pt(0)
    fmt.space_after = Pt(0)
    fmt.line_spacing = 1.05
    if align is not None:
        p.alignment = align

def _set_table_borders(tbl, size=8, color="000000"):
    tbl_el = tbl._tbl
    tblPr = tbl_el.tblPr
    if tblPr is None:
        tblPr = OxmlElement('w:tblPr')
        tbl_el._element.append(tblPr)
    borders = OxmlElement('w:tblBorders')
    for edge in ("top", "left", "bottom", "right", "insideH", "insideV"):
        element = OxmlElement(f"w:{edge}")
        element.set(qn('w:val'), 'single' if size else 'nil')
        element.set(qn('w:sz'), str(size))
        element.set(qn('w:color'), color)
        borders.append(element)
    for child in list(tblPr):
        if child.tag == qn('w:tblBorders'):
            tblPr.remove(child)
    tblPr.append(borders)
    tbl.autofit = False

def _content_width_cm(doc: Document) -> float:
    sec = doc.sections[0]
    width_cm = (sec.page_width - sec.left_margin - sec.right_margin) / 360000.0
    return float(width_cm)

def _fix_table_width(doc: Document, tbl, weights: List[float]):
    total_cm = max(1.0, _content_width_cm(doc) - 2*SIDE_PADDING_CM)
    s = sum(weights) if sum(weights) > 0 else 1.0
    widths_cm = [total_cm * (w / s) for w in weights]
    tbl.autofit = False
    for j, w in enumerate(widths_cm):
        for row in tbl.rows:
            try:
                row.cells[j].width = Cm(w)
            except Exception:
                pass
    tbl.alignment = WD_TABLE_ALIGNMENT.CENTER

def _set_table_fullwidth_1col(doc: Document, tbl):
    _fix_table_width(doc, tbl, [1])

def _add_bar(doc: Document, text: str, color_hex: str, font_color="000000"):
    tbl = doc.add_table(rows=1, cols=1)
    _set_table_borders(tbl, size=8, color="000000")
    cell = tbl.rows[0].cells[0]
    _apply_cell_shading(cell, color_hex)
    p = cell.paragraphs[0]
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    _set_paragraph_compact(p, align=None)
    run = p.add_run(text)
    _set_run_font(run, bold=True, size_pt=FS_TITLE, color_hex=font_color)
    _set_table_fullwidth_1col(doc, tbl)
    return tbl

def _add_section_bar(doc: Document, text: str):
    return _add_bar(doc, text, COLOR_SECTION_BAR)

def stars(n: int) -> str:
    n = max(1, min(5, int(n or 1)))
    return "‚òÖ" * n + "‚òÜ" * (5 - n)

def _maybe_add_tech(doc: Document, tech_rows: List[Tuple[str,str]]):
    rows = [(a or "", e or "") for a, e in tech_rows if (a or e)]
    if not rows:
        return
    _add_section_bar(doc, "Competencias T√©cnicas Clave")
    tbl = doc.add_table(rows=1, cols=2); _set_table_borders(tbl, 8)
    hdr = tbl.rows[0].cells; hdr[0].text = "√Årea"; hdr[1].text = "Evaluaci√≥n"
    for c in hdr:
        _apply_cell_shading(c, COLOR_HDR)
        if c.paragraphs[0].runs: _set_run_font(c.paragraphs[0].runs[0], bold=True)
        c.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
    for a, e in rows:
        row = tbl.add_row().cells
        row[0].text, row[1].text = a or "‚Äî", e or "‚Äî"
    _fix_table_width(doc, tbl, W_TECH)

def _maybe_add_soft(doc: Document, soft_rows: List[Tuple[str,str]]):
    rows = [(c or "", j or "") for c, j in soft_rows if (c or j)]
    if not rows:
        return
    _add_section_bar(doc, "Competencias Destacadas")
    tbl = doc.add_table(rows=1, cols=2); _set_table_borders(tbl, 8)
    hdr = tbl.rows[0].cells; hdr[0].text = "Competencia"; hdr[1].text = "Justificaci√≥n"
    for c in hdr:
        _apply_cell_shading(c, COLOR_HDR)
        if c.paragraphs[0].runs: _set_run_font(c.paragraphs[0].runs[0], bold=True)
        c.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
    for c, j in rows:
        row = tbl.add_row().cells
        row[0].text, row[1].text = c or "‚Äî", j or "‚Äî"
    _fix_table_width(doc, tbl, W_SOFT)

def _maybe_add_tools(doc: Document, tools: List[Dict[str,str]]):
    rows = []
    for t in tools:
        h = _clean_val(t.get("herr",""))
        u = _clean_val(t.get("uso",""))
        d = _clean_val(t.get("dom",""))
        if h and d:  # requiere %; si falta uso, igual se muestra pero intentamos siempre ponerlo
            rows.append([h, u or "‚Äî", d])
    if not rows:
        return
    _add_section_bar(doc, "Herramientas")
    tbl = doc.add_table(rows=1, cols=3); _set_table_borders(tbl, 8)
    hdr = tbl.rows[0].cells; hdr[0].text, hdr[1].text, hdr[2].text = "Herramienta", "Uso", "Dominio (%)"
    for c in hdr:
        _apply_cell_shading(c, COLOR_HDR)
        if c.paragraphs[0].runs: _set_run_font(c.paragraphs[0].runs[0], bold=True)
        c.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
    for r in rows:
        row = tbl.add_row().cells
        row[0].text, row[1].text, row[2].text = r[0], r[1], r[2]
    _fix_table_width(doc, tbl, W_TOOLS)

def _is_tool_like(text: str, tool_names_lower: set[str]) -> bool:
    s = (text or "").strip().lower()
    if not s:
        return False
    if any(t in s for t in tool_names_lower):
        return True
    if re.search(r"\b\d{1,3}\s*%|\b(v|versi[o√≥]n)\s*\d+", s):
        return True
    if re.search(r"\b(autocad|revit|sketchup|archicad|photoshop|illustrator|odoo|sap|profit|excel|word|canva|mailchimp|metricool|pipedrive|notion|asana|trello|project|google ads|meta ads)\b", s):
        return True
    return False

def _normalize_eval_from_pct(pct: int) -> str:
    try:
        v = int(pct)
    except Exception:
        v = -1
    if v >= 80: return "Alta"
    if v >= 50: return "Media"
    return "B√°sica" if v >= 0 else "B√°sica"

def _enforce_tech_areas_rules(data: dict) -> None:
    """Solo limpia t√©cnicas inv√°lidas; NO agrega placeholders."""
    tools = { (t.get("herr","").strip().lower()) for t in (data.get("tools") or []) }
    filtered = []
    seen = set()
    for item in (data.get("tech_areas") or []):
        area = (item.get("area") or "").strip()
        ev = (item.get("eval") or "").strip().capitalize()
        if not area or ev not in {"Alta","Media","B√°sica"}:
            continue
        if _is_tool_like(area, tools):
            continue
        key = re.sub(r"\s+", " ", area.lower())
        if key in seen: 
            continue
        seen.add(key)
        filtered.append({"area": area, "eval": ev})
    data["tech_areas"] = filtered

def _justify_document(doc: Document) -> None:
    def _justify_para(p):
        if p.alignment in (WD_ALIGN_PARAGRAPH.CENTER, WD_ALIGN_PARAGRAPH.RIGHT):
            return
        p.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY
    for p in doc.paragraphs:
        for r in p.runs:
            if r.font.size is None: r.font.size = Pt(FS_BASE)
            if r.font.name is None: r.font.name = FONT_NAME
        _justify_para(p)
    for tbl in doc.tables:
        for row in tbl.rows:
            for cell in row.cells:
                for p in cell.paragraphs:
                    _justify_para(p)

def render_docx(out_docx: Path, data: Dict[str, Any], logo_path: str | None = None):
    doc = Document()

    # Logo
    if logo_path and Path(logo_path).exists():
        p = doc.add_paragraph()
        run = p.add_run()
        run.add_picture(logo_path, width=Cm(11.0))
        p.alignment = WD_ALIGN_PARAGRAPH.LEFT

    # Tabla inicial (encabezado, info personal, resumen)
    tbl = doc.add_table(rows=3, cols=1)
    _set_table_borders(tbl, 8, "000000")

    # ==== T√çTULO PRINCIPAL (centrado con espacio adecuado) ====
    titulo_usuario = _clean_val(data.get("titulo_usuario", ""))
    area_ia = _clean_val(data.get("area_titulo", ""))
    if titulo_usuario:
        titulo_banner = f"Ficha de Evaluaci√≥n de Perfil ‚Äì Asistente virtual de {titulo_usuario}"
    elif area_ia:
        titulo_banner = f"Ficha de Evaluaci√≥n de Perfil ‚Äì Asistente virtual de {area_ia}"
    else:
        titulo_banner = "Ficha de Evaluaci√≥n de Perfil ‚Äì Asistente virtual"

    cell_title = tbl.rows[0].cells[0]
    _apply_cell_shading(cell_title, COLOR_BANNER)
    p = cell_title.paragraphs[0]
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    _set_paragraph_compact(p, align=None)
    run = p.add_run(titulo_banner)
    _set_run_font(run, bold=True, size_pt=FS_TITLE, color_hex="FFFFFF")
    pf = p.paragraph_format
    pf.space_before = Pt(12)
    pf.space_after = Pt(14)

    # ==== INFORMACI√ìN PERSONAL ====
    info = data.get("info_personal") or {}
    cell_info = tbl.rows[1].cells[0]
    pinfo = cell_info.paragraphs[0]
    _set_paragraph_compact(pinfo)
    r = pinfo.add_run("Informaci√≥n Personal:")
    _set_run_font(r, bold=True, size_pt=FS_TITLE)

    def info_line(cell, label, value):
        val = _clean_val(value)
        if not val:
            return
        par = cell.add_paragraph()
        _set_paragraph_compact(par)
        r0 = par.add_run("‚Ä¢ ")
        _set_run_font(r0, bold=True)
        r1 = par.add_run(f"{label}: ")
        _set_run_font(r1, bold=True)
        par.add_run(val)

    nombre_raw = info.get("nombre", "")
    if nombre_raw:
        info_line(cell_info, "Nombre", " ".join(nombre_raw.split()[:2]))
    info_line(cell_info, "Edad", info.get("edad", ""))
    info_line(cell_info, "Regi√≥n", info.get("region", ""))
    info_line(cell_info, "Profesi√≥n", info.get("profesion", ""))

    # ==== RESUMEN EJECUTIVO ====
    cell_sum = tbl.rows[2].cells[0]
    p2 = cell_sum.paragraphs[0]
    _set_paragraph_compact(p2)
    r2 = p2.add_run("Resumen Ejecutivo: ")
    _set_run_font(r2, bold=True)
    resumen = _clean_val(data.get("resumen", "")) or "‚Äî"
    p2.add_run(resumen)
    _set_table_fullwidth_1col(doc, tbl)

    # ==== COMPETENCIAS T√âCNICAS CLAVE ====
    tech_rows = [
        (_clean_val(itm.get("area", "")), _clean_val(itm.get("eval", "")))
        for itm in (data.get("tech_areas") or [])[:PLACE["areas"]]
        if _clean_val(itm.get("area", "")) or _clean_val(itm.get("eval", ""))
    ]
    if tech_rows:
        _maybe_add_tech(doc, tech_rows)

    # ==== COMPETENCIAS DESTACADAS ====
    soft_rows = [
        (_clean_val(itm.get("comp", "")), _clean_val(itm.get("just", "")))
        for itm in (data.get("soft_skills") or [])[:PLACE["competencias"]]
        if _clean_val(itm.get("comp", "")) or _clean_val(itm.get("just", ""))
    ]
    if soft_rows:
        _maybe_add_soft(doc, soft_rows)

    # ==== HERRAMIENTAS T√âCNICAS Y TECNOLOG√çAS ====
    if data.get("tools"):
        original_add_bar = _add_section_bar
        def _custom_add_section_bar(doc_local, text_local):
            return original_add_bar(doc_local, "Herramientas T√©cnicas y Tecnolog√≠as")
        globals()['_add_section_bar'] = _custom_add_section_bar
        _maybe_add_tools(doc, data.get("tools") or [])
        globals()['_add_section_bar'] = original_add_bar

    # ==== COMPATIBILIDAD ====
    def _maybe_add_compat(doc: Document, compat: Dict[str, Dict[str, Any]]):
        if not compat:
            return
        rows = []
        def add(cat):
            if cat in compat and isinstance(compat[cat], dict):
                r = compat[cat].get("rating", 2)
                o = compat[cat].get("obs", "")
                rows.append([cat, stars(r), o or ("No aplica" if (r or 0) <= 2 else "‚Äî")])
        for cat in ["Marketing Digital", "Ventas y E-commerce", "Gesti√≥n y Control", "Contabilidad"]:
            add(cat)
        if not rows:
            return
        _add_section_bar(doc, "Compatibilidad con Categor√≠as de Asistencia Virtual")
        doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER
        tbl = doc.add_table(rows=1, cols=3)
        _set_table_borders(tbl, 8)
        hdr = tbl.rows[0].cells
        hdr[0].text, hdr[1].text, hdr[2].text = "Categor√≠a", "Calificaci√≥n", "Observaci√≥n"
        for c in hdr:
            _apply_cell_shading(c, COLOR_HDR)
            if c.paragraphs[0].runs:
                _set_run_font(c.paragraphs[0].runs[0], bold=True)
            c.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
        for r in rows:
            row = tbl.add_row().cells
            row[0].text, row[1].text, row[2].text = r
        _fix_table_width(doc, tbl, W_COMPAT)

    _maybe_add_compat(doc, data.get("compat") or {})

    # ==== POTENCIAL / FORMATIVAS / RECOMENDACI√ìN FINAL ====
    def _maybe_add_bullets(doc: Document, title: str, bullets: List[str]):
        items = [b for b in (bullets or []) if _clean_val(b)]
        if not items:
            return
        _add_section_bar(doc, title)
        doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER
        tbl = doc.add_table(rows=1, cols=1)
        _set_table_borders(tbl, 8, "000000")
        cell = tbl.rows[0].cells[0]
        for i, t in enumerate(items):
            p = cell.paragraphs[0] if i == 0 else cell.add_paragraph()
            _set_paragraph_compact(p)
            r0 = p.add_run("‚Ä¢ ")
            _set_run_font(r0, bold=True)
            p.add_run(_clean_val(t))
        _set_table_fullwidth_1col(doc, tbl)

    _maybe_add_bullets(doc, "Potencial de Aporte", data.get("potencial") or [])
    _maybe_add_bullets(doc, "Recomendaciones Formativas", data.get("formativas") or [])

    rec_final = _clean_val(data.get("recomendacion_final", ""))
    if rec_final:
        _add_section_bar(doc, "Recomendaci√≥n Final")
        doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER
        tbl2 = doc.add_table(rows=1, cols=1)
        _set_table_borders(tbl2, 8, "000000")
        cell = tbl2.rows[0].cells[0]
        p = cell.paragraphs[0]
        _set_paragraph_compact(p)
        p.add_run(rec_final)
        _set_table_fullwidth_1col(doc, tbl2)

    # ==== FORZAR FUENTE ARIAL EN TODO EL DOCUMENTO (manteniendo centrados los t√≠tulos) ====
    FONT_NAME = "Arial"
    for p in doc.paragraphs:
        is_centered = (p.alignment == WD_ALIGN_PARAGRAPH.CENTER)
        for r in p.runs:
            r.font.name = FONT_NAME
            r._element.rPr.rFonts.set(qn("w:eastAsia"), FONT_NAME)
            r._element.rPr.rFonts.set(qn("w:ascii"), FONT_NAME)
            r._element.rPr.rFonts.set(qn("w:hAnsi"), FONT_NAME)
            r._element.rPr.rFonts.set(qn("w:cs"), FONT_NAME)
            r.font.size = Pt(FS_BASE)
        if not is_centered:
            p.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY

    for tbl in doc.tables:
        for row in tbl.rows:
            for cell in row.cells:
                for p in cell.paragraphs:
                    is_centered = (p.alignment == WD_ALIGN_PARAGRAPH.CENTER)
                    for r in p.runs:
                        r.font.name = FONT_NAME
                        r._element.rPr.rFonts.set(qn("w:eastAsia"), FONT_NAME)
                        r._element.rPr.rFonts.set(qn("w:ascii"), FONT_NAME)
                        r._element.rPr.rFonts.set(qn("w:hAnsi"), FONT_NAME)
                        r._element.rPr.rFonts.set(qn("w:cs"), FONT_NAME)
                        r.font.size = Pt(FS_BASE)
                    if not is_centered:
                        p.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY

    # ==== Guardado robusto ====
    from time import sleep
    def safe_docx_save(doc, out_path: Path, max_tries: int = 3) -> Path:
        candidate = out_path
        for i in range(max_tries):
            try:
                doc.save(str(candidate))
                return candidate
            except PermissionError:
                candidate = candidate.with_name(f"{out_path.stem}_v{i+2}{out_path.suffix}")
                sleep(0.2)
        doc.save(str(candidate))
        return candidate

    safe_docx_save(doc, out_docx)






def docx_to_pdf_optional(in_docx: Path, out_pdf: Path) -> bool:
    """
    Convierte DOCX -> PDF en Linux intentando varios binarios:
    1) soffice --headless
    2) libreoffice --headless
    3) unoconv -f pdf
    Devuelve True si el PDF se cre√≥.
    """
    try:
        out_pdf.parent.mkdir(parents=True, exist_ok=True)
        candidates = [
            ['soffice', '--headless', '--convert-to', 'pdf', '--outdir', str(out_pdf.parent), str(in_docx)],
            ['libreoffice', '--headless', '--convert-to', 'pdf', '--outdir', str(out_pdf.parent), str(in_docx)],
            ['unoconv', '-f', 'pdf', '-o', str(out_pdf), str(in_docx)],
        ]
        for cmd in candidates:
            try:
                env = os.environ.copy()
                env.setdefault('HOME', '/tmp')
                subprocess.run(cmd, env=env, stdout=subprocess.PIPE, stderr=subprocess.PIPE, check=False)
                if out_pdf.exists():
                    return True
                candidate = in_docx.with_suffix('.pdf')
                if candidate.exists():
                    try:
                        candidate.rename(out_pdf)
                    except Exception:
                        out_pdf.write_bytes(candidate.read_bytes())
                        candidate.unlink(missing_ok=True)
                    return True
            except Exception:
                pass
    except Exception:
        pass
    return False


# =========================
#   EXTRA: capturar "Tipo asistente: ..."
# =========================
TIPO_RE = re.compile(r"^\s*tipo\s*(?:de\s*)?asistente\s*:\s*(.+?)\s*$", re.IGNORECASE | re.MULTILINE)

def extract_user_tipo_asistente(txt: str) -> str:
    """Devuelve el valor literal del usuario si existe, sin limitar ni normalizar."""
    if not txt:
        return ""
    m = TIPO_RE.search(txt)
    if not m:
        return ""
    raw = m.group(1).strip()
    if (raw.startswith('"') and raw.endswith('"')) or (raw.startswith("'") and raw.endswith("'")):
        raw = raw[1:-1].strip()
    return raw


# =========================
#   MAIN
# =========================
def main():
    ap = argparse.ArgumentParser(description="Generador de Ficha desde TXT + CV con IA (DOCX estilizado)")
    ap.add_argument("--cv_text", type=str, default="")
    ap.add_argument("--cv_text_file", type=str, default="")
    ap.add_argument("--cv", type=str, default="")
    ap.add_argument("--extra", type=str, default="")
    ap.add_argument("--extra_file", type=str, default="")
    ap.add_argument("--outdir", type=str, required=True)
    ap.add_argument("--basename", type=str, required=True)
    ap.add_argument("--logo", type=str, default="")
    ap.add_argument("--no-pdf", action="store_true")
    args = ap.parse_args()

    # TXT (formulario)
    txt = args.extra.strip()
    if (not txt) and args.extra_file:
        txt = read_text(Path(args.extra_file))
    if not txt:
        raise RuntimeError("Debes pasar --extra o --extra_file con el texto de entrevista+formulario.")

    # CV
    cv_text = ""
    if args.cv_text:
        cv_text = args.cv_text
    elif args.cv_text_file:
        cv_text = read_text(Path(args.cv_text_file))
    elif args.cv:
        cv_text = read_cv_any(Path(args.cv))

    # Herramientas SOLO desde regex en TXT
    tools_regex = extract_tools_with_percent_from_text(txt, maxn=PLACE["herrs"])

    # Llamado √∫nico a IA
    data = ai_extract_all_fields(txt, cv_text, tools_regex)

    # üî∏ OVERRIDE DEL T√çTULO SEG√öN USUARIO (libre, sin confirmar)
    tipo_usuario = extract_user_tipo_asistente(txt)  # <‚Äî literal del usuario
    if tipo_usuario:
        # Guardamos campo expl√≠cito para el render
        data["titulo_usuario"] = tipo_usuario
        # Tambi√©n lo dejamos visible en mapping para depuraci√≥n del backend
        data.setdefault("_meta", {})["titulo_origen"] = "usuario"
        data["_meta"]["titulo_usuario"] = tipo_usuario
    else:
        data.setdefault("_meta", {})["titulo_origen"] = "ia"

    # Filtros de sanidad (no agrega nada)
    _enforce_tech_areas_rules(data)

    # Validaci√≥n PERMISIVA: no aborta; escribe advertencias en stderr
    warnings = _soft_validate_ai_payload(data, tools_regex)
    if warnings:
        import sys
        sys.stderr.write("[WARN] Validacion suave:\n" + "\n".join(f" - {w}" for w in warnings) + "\n")

    # Render
    outdir = Path(args.outdir); outdir.mkdir(parents=True, exist_ok=True)
    out_docx = outdir / f"{args.basename}.docx"
    out_pdf  = outdir / f"{args.basename}.pdf"

    render_docx(out_docx, data, logo_path=args.logo or None)

    used_pdf = False
    if not args.no_pdf:
        if docx2pdf_convert is not None:
            try:
                outdocx_parent = out_docx.parent
                docx2pdf_convert(str(out_docx), str(outdocx_parent))
                if out_pdf.exists():
                    used_pdf = True
                else:
                    cand = out_docx.with_suffix(".pdf")
                    if cand.exists():
                        cand.rename(out_pdf)
                        used_pdf = True
            except Exception:
                used_pdf = docx_to_pdf_optional(out_docx, out_pdf)
        else:
            used_pdf = docx_to_pdf_optional(out_docx, out_pdf)

    print(json.dumps({
        "ok": True,
        "docx": str(out_docx),
        "pdf": str(out_pdf) if used_pdf else "",
        "used_pdf": used_pdf,
        "mapping": data,  # incluye _meta.titulo_origen y, si aplica, titulo_usuario
    }, ensure_ascii=False))


if __name__ == "__main__":
    main()
</file>

<file path="ficha2.py">
# -*- coding: utf-8 -*-
"""
ficha2.py ‚Äî Generador profesional de informes DOCX
Formato Corporativo Global Talent - Version "Todo Terreno" (Bordes + Detecci√≥n Inteligente)
"""

import os
import re
import json
import argparse
from pathlib import Path
from datetime import datetime

# OpenAI
try:
    from dotenv import load_dotenv
    load_dotenv()
except:
    pass

_HAS_OPENAI = True
try:
    from openai import OpenAI
except:
    _HAS_OPENAI = False

# DOCX
from docx import Document
from docx.shared import Pt, Inches, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml import OxmlElement
from docx.oxml.ns import qn

# Extra extraction libs
try:
    import docx2txt
    DOCTXTXT_AVAILABLE = True
except:
    DOCTXTXT_AVAILABLE = False

try:
    from pdfminer.high_level import extract_text as pdf_extract_text
    PDF_AVAILABLE = True
except:
    PDF_AVAILABLE = False


# ===========================================
#          HELPERS
# ===========================================

def read_text(path: Path) -> str:
    try:
        return path.read_text(encoding="utf-8", errors="ignore")
    except:
        return ""


def read_cv_any(path: Path) -> str:
    if not path or not path.exists():
        return ""
    suf = path.suffix.lower()

    if suf == ".docx" and DOCTXTXT_AVAILABLE:
        return docx2txt.process(str(path)) or ""

    if suf == ".pdf" and PDF_AVAILABLE:
        return pdf_extract_text(str(path)) or ""

    return read_text(path)

# --- DIBUJAR BORDES (ESTILO LUIS BARRIOS) ---
def set_table_borders(table):
    tbl = table._tbl
    tblPr = tbl.tblPr
    if tblPr is None:
        tblPr = OxmlElement('w:tblPr')
        tbl.append(tblPr)
    
    borders = OxmlElement('w:tblBorders')
    for border_name in ['top', 'left', 'bottom', 'right', 'insideH', 'insideV']:
        border = OxmlElement(f'w:{border_name}')
        border.set(qn('w:val'), 'single')
        border.set(qn('w:sz'), '4')
        border.set(qn('w:space'), '0')
        border.set(qn('w:color'), 'auto')
        borders.append(border)
    
    tblPr.append(borders)


# ===========================================
#          HERRAMIENTAS (%) - CORREGIDO
# ===========================================

def extract_tools_with_percent(text: str):
    text = text.replace("\r", "")
    # Busca nombre + numero + %
    regex = re.compile(r"(.+?)\s*[:\-]?\s*(\d{1,3})\s*%", re.I)
    tools = []
    for line in text.splitlines():
        m = regex.search(line)
        if m:
            # Limpieza: quita par√©ntesis abiertos al final
            name = m.group(1).strip().strip(" (")
            perc = m.group(2).strip() + "%"
            tools.append({"herramienta": name, "nivel": perc})
    return tools


# ===========================================
#          NORMALIZADOR (CORE LOGIC)
# ===========================================

def normalize_skills(data: dict) -> dict:
    """
    Revisa si la IA puso software en 'competencias' y lo mueve a 'herramientas'.
    """
    software_keywords = [
        "excel", "word", "powerpoint", "office", "photoshop", "illustrator", 
        "figma", "canva", "trello", "asana", "jira", "python", "java", 
        "javascript", "react", "angular", "node", "html", "css", "sql", 
        "salesforce", "sap", "hubspot", "vs code", "visual studio", "postman",
        "git", "github", "docker", "aws", "azure"
    ]

    comps = data.get("competencias_tecnicas", [])
    tools = data.get("herramientas", [])
    
    new_comps = []
    
    for item in comps:
        nombre = item.get("competencia", "").lower()
        es_software = any(sw in nombre for sw in software_keywords)
        
        if es_software:
            # MOVER A HERRAMIENTAS
            exists = any(t.get("herramienta", "").lower() == nombre for t in tools)
            if not exists:
                tools.append({
                    "herramienta": item.get("competencia"), 
                    "nivel": item.get("nivel", "Se menciona")
                })
        else:
            # MANTENER EN COMPETENCIAS
            new_comps.append(item)
            
    data["competencias_tecnicas"] = new_comps
    data["herramientas"] = tools
    return data


# ===========================================
#          AI (CEREBRO)
# ===========================================

def ai_enabled():
    return _HAS_OPENAI and bool(os.environ.get("OPENAI_API_KEY"))


def ai_extract_fields(full_text, cv_text, tools, model="gpt-4o-mini"):
    if not ai_enabled():
        raise RuntimeError("OPENAI_API_KEY no configurada.")

    if len(cv_text) > 45000:
        cv_text = cv_text[:45000] + "\n...[TRUNCADO]..."

    client = OpenAI()

    # PROMPT MEJORADO: Instrucciones para CVs sin porcentajes
    system = (
        "Eres analista de RRHH. Genera un informe profesional en ESPA√ëOL NEUTRO.\n"
        "\n"
        "Devuelve solo JSON v√°lido. Estructura estricta:\n"
        "{\n"
        '  \"fecha\": \"...\",\n'
        '  \"puesto\": \"...\",\n'
        '  \"resumen_ejecutivo\": \"...\",\n'
        '  \"ficha_tecnica\": {\n'
        '       \"nombre\": \"...\",\n'
        '       \"ubicacion\": \"...\",\n'
        '       \"nivel_experiencia\": \"...\",\n'
        '       \"formacion_formal\": \"...\",\n'
        '       \"nivel_ingles\": \"...\",\n'
        '       \"disponibilidad\": \"...\"\n'
        "  },\n"
        '  \"competencias_tecnicas\": [{\"competencia\": \"...\", \"nivel\": \"...\"}],\n'
        '  \"habilidades_blandas\": [{\"habilidad\": \"...\", \"nivel\": \"...\"}],\n'
        '  \"herramientas\": [{\"herramienta\": \"...\", \"nivel\": \"...\"}],\n'
        '  \"plus\": \"...\",\n'
        '  \"formacion_sugerida\": \"...\",\n'
        '  \"recomendacion_final\": \"...\",\n'
        '  \"responsable\": \"Departamento de Recursos Humanos\"\n'
        "}\n\n"
        "REGLAS CR√çTICAS:\n"
        "1. 'competencias_tecnicas': √ÅREAS DE CONOCIMIENTO (Ej: 'Gesti√≥n de Proyectos', 'Contabilidad', 'Desarrollo Web').\n"
        "   - PROHIBIDO poner nombres de software aqu√≠.\n"
        "2. 'herramientas': SOLO SOFTWARE y PLATAFORMAS (Ej: 'Excel', 'Python', 'Jira').\n"
        "   - IMPORTANTE: Si la lista de herramientas detectadas est√° vac√≠a o incompleta, EXTRAE LAS HERRAMIENTAS DEL TEXTO DEL CV.\n"
        "   - Si no tienen porcentaje expl√≠cito, usa 'Se menciona' o infiere el nivel (B√°sico/Intermedio/Avanzado) seg√∫n el contexto.\n"
        "3. 'habilidades_blandas': Soft skills.\n"
    )

    payload = {
        "texto": full_text,
        "cv": cv_text,
        "herramientas_detectadas": tools
    }

    try:
        response = client.responses.create(
            model=model,
            temperature=0.30,
            input=[
                {"role": "system", "content": system},
                {"role": "user", "content": json.dumps(payload, ensure_ascii=False)}
            ]
        )
        raw = response.output_text.strip()
    except AttributeError:
        response = client.chat.completions.create(
            model=model,
            temperature=0.30,
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": json.dumps(payload, ensure_ascii=False)}
            ]
        )
        raw = response.choices[0].message.content.strip()

    raw = re.sub(r"^```json|```$", "", raw).strip()

    try:
        data = json.loads(raw)
    except json.JSONDecodeError:
        data = {}

    # Si la regex encontr√≥ algo, le damos prioridad, sino confiamos en la IA
    if tools:
        # Fusionar herramientas de IA con las de Regex si es necesario, 
        # pero por ahora, si regex hall√≥ algo, lo usamos.
        data["herramientas"] = tools + [t for t in data.get("herramientas", []) if t["herramienta"] not in [x["herramienta"] for x in tools]]

    return data


# ===========================================
#          RENDER DOCX
# ===========================================

def set_run_font(run, bold=False, size=11):
    run.bold = bold
    run.font.name = "Times New Roman"
    run.font.size = Pt(size)
    rpr = run._element.rPr
    if rpr is None: return
    rFonts = OxmlElement("w:rFonts")
    for a in ["ascii", "hAnsi", "eastAsia", "cs"]:
        rFonts.set(qn(f"w:{a}"), "Times New Roman")
    rpr.append(rFonts)


def add_paragraph(doc, text, bold=False, size=11, align=WD_ALIGN_PARAGRAPH.JUSTIFY,
                  before=0, after=6):
    p = doc.add_paragraph()
    p.alignment = align
    p.paragraph_format.space_before = Pt(before)
    p.paragraph_format.space_after = Pt(after)
    run = p.add_run(text)
    set_run_font(run, bold=bold, size=size)
    return p


def add_label_value(doc, label, val):
    p = doc.add_paragraph()
    p.paragraph_format.space_after = Pt(3)
    p.paragraph_format.space_before = Pt(0)
    r1 = p.add_run(f"{label}: ")
    set_run_font(r1, bold=True)
    r2 = p.add_run(val or "")
    set_run_font(r2, bold=False)


def add_multiline_paragraphs(doc, text, size=11):
    if not text:
        return
    chunks = [c.strip() for c in re.split(r"\n\s*\n", text) if c.strip()]
    if not chunks:
        chunks = [text.strip()]
    for chunk in chunks:
        add_paragraph(doc, chunk, size=size)


# ===========================================
#          LOGO EN ENCABEZADO
# ===========================================

def insert_logo_header(doc, logo_path):
    if not logo_path or not Path(logo_path).exists():
        return
    for section in doc.sections:
        header = section.header
        if not header.paragraphs: p = header.add_paragraph()
        else:
            p = header.paragraphs[0]
            for run in p.runs: run.clear()
        p.alignment = WD_ALIGN_PARAGRAPH.LEFT
        p.paragraph_format.space_after = Pt(0)
        p.paragraph_format.space_before = Pt(0)
        run = p.add_run()
        run.add_picture(logo_path, width=Inches(4.2))


# ===========================================
#          RENDER DOCX
# ===========================================

def render_docx(out_path: Path, data: dict, logo_path: str):
    doc = Document()

    for section in doc.sections:
        section.top_margin = Cm(1.5)
        section.bottom_margin = Cm(1.5)
        section.left_margin = Cm(2.0)
        section.right_margin = Cm(2.0)
        section.header_distance = Cm(0)

    insert_logo_header(doc, logo_path)

    add_paragraph(doc, "INFORME DE PRESENTACI√ìN DE CANDIDATO/A", bold=True, size=12, align=WD_ALIGN_PARAGRAPH.CENTER, before=6, after=12)

    fecha = data.get("fecha") or datetime.now().strftime("%Y-%m-%d")
    add_label_value(doc, "Fecha", fecha)
    add_label_value(doc, "Puesto", data.get("puesto", ""))
    doc.add_paragraph()

    add_paragraph(doc, "Resumen Ejecutivo", bold=True, size=12, align=WD_ALIGN_PARAGRAPH.CENTER, before=6)
    add_paragraph(doc, data.get("resumen_ejecutivo", ""), size=11)

    add_paragraph(doc, "1.  Ficha T√©cnica", bold=True, size=12, before=12)
    ft = data.get("ficha_tecnica", {})
    
    table = doc.add_table(rows=0, cols=2)
    set_table_borders(table)
    table.autofit = False
    col_width = Inches(2.8)
    for campo, val in [
        ("Nombre", ft.get("nombre", "")),
        ("Ubicaci√≥n", ft.get("ubicacion", "")),
        ("Nivel de experiencia", ft.get("nivel_experiencia", "")),
        ("Formaci√≥n Formal", ft.get("formacion_formal", "")),
        ("Nivel Ingl√©s", ft.get("nivel_ingles", "")),
        ("Disponibilidad", ft.get("disponibilidad", "")),
    ]:
        row = table.add_row().cells
        row[0].width = col_width; row[1].width = col_width
        r1 = row[0].paragraphs[0].add_run(campo); set_run_font(r1, bold=True)
        r2 = row[1].paragraphs[0].add_run(val); set_run_font(r2)
    doc.add_paragraph()

    # 2. Competencias T√©cnicas
    comps = data.get("competencias_tecnicas", [])
    if comps:
        add_paragraph(doc, "2.  Competencias T√©cnicas y destacada", bold=True, size=12, before=12)
        t = doc.add_table(rows=1, cols=2)
        set_table_borders(t)
        t.autofit = False
        t.rows[0].cells[0].width = col_width; t.rows[0].cells[1].width = col_width
        t.rows[0].cells[0].text = "Competencia"; t.rows[0].cells[1].text = "Nivel"
        for cell in t.rows[0].cells: set_run_font(cell.paragraphs[0].runs[0], bold=True)
        for item in comps:
            row = t.add_row().cells
            row[0].width = col_width; row[1].width = col_width
            set_run_font(row[0].paragraphs[0].add_run(item["competencia"]))
            set_run_font(row[1].paragraphs[0].add_run(item["nivel"]))
        doc.add_paragraph()

    # 2.1 Habilidades Blandas
    soft = data.get("habilidades_blandas", [])
    if soft:
        add_paragraph(doc, "2.1  Habilidades Blandas (Soft Skills)", bold=True, size=12, before=12)
        t_soft = doc.add_table(rows=1, cols=2)
        set_table_borders(t_soft)
        t_soft.autofit = False
        t_soft.rows[0].cells[0].width = col_width; t_soft.rows[0].cells[1].width = col_width
        t_soft.rows[0].cells[0].text = "Habilidad"; t_soft.rows[0].cells[1].text = "Nivel"
        for cell in t_soft.rows[0].cells: set_run_font(cell.paragraphs[0].runs[0], bold=True)
        for item in soft:
            row = t_soft.add_row().cells
            row[0].width = col_width; row[1].width = col_width
            set_run_font(row[0].paragraphs[0].add_run(item["habilidad"]))
            set_run_font(row[1].paragraphs[0].add_run(item["nivel"]))
        doc.add_paragraph()

    # 3. Herramientas
    tools = data.get("herramientas", [])
    if tools:
        add_paragraph(doc, "3.  Herramientas y Software", bold=True, size=12, before=12)
        t2 = doc.add_table(rows=1, cols=2)
        set_table_borders(t2)
        t2.autofit = False
        t2.rows[0].cells[0].width = col_width; t2.rows[0].cells[1].width = col_width
        t2.rows[0].cells[0].text = "Herramienta"; t2.rows[0].cells[1].text = "Nivel de Dominio"
        for cell in t2.rows[0].cells: set_run_font(cell.paragraphs[0].runs[0], bold=True)
        for item in tools:
            row = t2.add_row().cells
            row[0].width = col_width; row[1].width = col_width
            set_run_font(row[0].paragraphs[0].add_run(item["herramienta"]))
            set_run_font(row[1].paragraphs[0].add_run(item["nivel"]))
        doc.add_paragraph()

    plus = data.get("plus", "").strip()
    if plus:
        add_paragraph(doc, "4.  Plus", bold=True, size=12, before=12)
        add_multiline_paragraphs(doc, plus, size=11)

    fs = data.get("formacion_sugerida", "").strip()
    if fs:
        add_paragraph(doc, "5.  Formaci√≥n Sugerida", bold=True, size=12, before=12)
        add_paragraph(doc, fs, size=11)

    rf = data.get("recomendacion_final", "").strip()
    if rf:
        add_paragraph(doc, "6.  Recomendaci√≥n Final", bold=True, size=12, before=12)
        add_multiline_paragraphs(doc, rf, size=11)

    resp = data.get("responsable", "")
    if resp:
        p = doc.add_paragraph()
        r1 = p.add_run("Responsable: "); set_run_font(r1, bold=True)
        r2 = p.add_run(resp); set_run_font(r2)

    notas_input = data.get("_meta", {}).get("notas_raw", "").strip()
    if notas_input:
        doc.add_page_break()
        add_paragraph(doc, "Notas Adicionales / Input del Reclutador", bold=True, size=12, before=12)
        add_multiline_paragraphs(doc, notas_input, size=11)

    doc.save(str(out_path))


# ===========================================
#                 MAIN
# ===========================================

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--extra_file", type=str, default="")
    ap.add_argument("--extra", type=str, default="")
    ap.add_argument("--cv", type=str, default="")
    ap.add_argument("--outdir", type=str, required=True)
    ap.add_argument("--basename", type=str, required=True)
    ap.add_argument("--logo", type=str, default="")
    ap.add_argument("--no-pdf", action="store_true")
    args = ap.parse_args()

    full_text = args.extra or ""
    if args.extra_file:
        full_text = read_text(Path(args.extra_file)) or full_text

    cv_text = read_cv_any(Path(args.cv)) if args.cv else ""
    
    # 1. Intentamos extraer herramientas con %
    tools = extract_tools_with_percent(full_text)
    
    # 2. IA (Con prompt mejorado para extraer si no hubo %)
    data = ai_extract_fields(full_text, cv_text, tools)

    # 3. Normalizador (Por si la IA se confundi√≥)
    data = normalize_skills(data)

    if "_meta" not in data: data["_meta"] = {}
    data["_meta"]["notas_raw"] = full_text

    outdir = Path(args.outdir)
    outdir.mkdir(parents=True, exist_ok=True)
    out_path = outdir / f"{args.basename}.docx"
    render_docx(out_path, data, args.logo)

    print(json.dumps({"ok": True, "docx": str(out_path), "mapping": data}, ensure_ascii=False))


if __name__ == "__main__":
    main()
</file>

<file path="GUIA_PRUEBA_FLUJO.md">
# üß™ Gu√≠a de Prueba: Flujo Completo de Candidato

## Paso 1: Crear Candidato de Prueba

Ejecut√° este comando en tu terminal (con el servidor corriendo):

```bash
curl -X POST http://localhost:3001/test/candidato-completo \
  -H "Content-Type: application/json"
```

O desde el navegador, abr√≠:
```
http://localhost:3001/test/candidato-completo
```

**Respuesta esperada:**
```json
{
  "ok": true,
  "id": "test_candidato_1234567890",
  "mensaje": "Candidato de prueba creado exitosamente",
  "datos": {
    "nombre": "Juan P√©rez (TEST)",
    "email": "test_...@example.com",
    "stage": "stage_1",
    "score": 75,
    "tiene_form2": true,
    "tiene_transcripcion": true
  }
}
```

## Paso 2: Verificar en el Dashboard

1. Abr√≠ el dashboard: `http://localhost:3001`
2. Busc√° el candidato "Juan P√©rez (TEST)" en la secci√≥n **Explorar** (stage_1)
3. Deber√≠as ver:
   - ‚úÖ Score inicial (m√°ximo 80)
   - ‚úÖ Respuestas del Form 1
   - ‚úÖ Respuestas del Form 2 (ya recibido)
   - ‚úÖ Transcripci√≥n de entrevista (pre-cargada)

## Paso 3: Aprobar a Gesti√≥n (Stage 2)

1. Hac√© clic en el candidato para abrir el detalle
2. Hac√© clic en **"Aprobar a Gesti√≥n"**
3. El candidato deber√≠a moverse a la secci√≥n **Gesti√≥n**

## Paso 4: Verificar Datos de Entrevista

En el detalle del candidato en stage_2, deber√≠as ver:
- ‚úÖ **Meet Link**: Ya est√° pre-cargado
- ‚úÖ **Transcripci√≥n**: Ya est√° pre-cargada
- ‚úÖ **Form 2**: Marcado como "received"

## Paso 5: Analizar Entrevista con IA

1. En el detalle del candidato, hac√© clic en **"Analizar con IA"**
2. Esper√° unos segundos (la IA recalcula el score bas√°ndose en la transcripci√≥n)
3. El score deber√≠a actualizarse (ahora puede ser 0-100, no limitado a 80)

## Paso 6: Mover a Informe (Stage 3)

1. En el detalle del candidato, movelo a **"Informe"** (stage_3)
2. El candidato deber√≠a aparecer en la secci√≥n **Informes**

## Paso 7: Generar Informe Final

1. En la vista de **Informes**, busc√° el candidato
2. Hac√© clic en **"Generar Informe"**
3. Esper√° unos segundos (la IA genera el informe completo)
4. Deber√≠as ver el bot√≥n cambiar a **"Ver Informe"**
5. Hac√© clic para ver el informe generado

## ‚úÖ Checklist de Verificaci√≥n

- [ ] Candidato creado en stage_1
- [ ] Score inicial visible (m√°x 80)
- [ ] Form 1 y Form 2 presentes
- [ ] Aprobado a stage_2 correctamente
- [ ] Meet link y transcripci√≥n visibles
- [ ] An√°lisis de entrevista ejecutado
- [ ] Score actualizado (0-100)
- [ ] Movido a stage_3
- [ ] Informe generado exitosamente
- [ ] Informe visible y descargable

## üîç Qu√© Revisar

### En Stage 1 (Explorar):
- Score inicial no debe superar 80
- Respuestas del Form 1 visibles
- Respuestas del Form 2 visibles (ya recibido)

### En Stage 2 (Gesti√≥n):
- Meet link presente
- Transcripci√≥n presente
- Bot√≥n "Analizar con IA" funcional
- Score actualizado despu√©s del an√°lisis (puede ser > 80)

### En Stage 3 (Informe):
- Bot√≥n "Generar Informe" funcional
- Informe se genera con todos los datos:
  - CV original
  - Respuestas Form 1
  - Respuestas Form 2
  - Transcripci√≥n de entrevista
  - An√°lisis post-entrevista
  - Alertas detectadas

## üêõ Si Algo Falla

1. **Candidato no aparece**: Refresc√° el dashboard (F5)
2. **Error al analizar entrevista**: Verific√° que la transcripci√≥n est√© guardada
3. **Error al generar informe**: Verific√° la consola del servidor para ver errores de IA
4. **Score no se actualiza**: Verific√° que el endpoint `/candidatos/:id/analizar-entrevista` est√© funcionando

## üìù Notas

- El candidato de prueba tiene **todos los datos pre-cargados** para que puedas probar el flujo completo sin tener que ingresar datos manualmente
- El score inicial est√° limitado a 80 (como debe ser en stage_1)
- Despu√©s del an√°lisis de entrevista, el score puede ser 0-100
- El informe final combina **todos** los datos del pipeline
</file>

<file path="package.json">
{
  "name": "cv-classifier-backend",
  "version": "1.0.0",
  "main": "index.js",
  "type": "commonjs",
  "scripts": {
    "start": "node index.js",
    "analiza": "node analyze.js",
    "build": "vite build",
    "postinstall": "if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install -y ffmpeg; else echo \"Saltando apt-get (entorno sin apt-get)\"; fi"
  },
  "dependencies": {
    "@elevenlabs/elevenlabs-js": "^2.16.0",
    "@google-cloud/storage": "^7.16.0",
    "@google-cloud/vision": "^5.3.3",
    "@google/genai": "^1.34.0",
    "@google/generative-ai": "^0.24.1",
    "axios": "^1.13.2",
    "body-parser": "^2.2.0",
    "canvas": "^3.2.0",
    "chokidar": "^4.0.3",
    "cors": "^2.8.5",
    "docx": "^9.5.1",
    "docxtemplater": "^3.67.6",
    "dotenv": "^16.6.1",
    "exceljs": "^4.4.0",
    "express": "^4.21.2",
    "express-rate-limit": "^6.11.2",
    "ffmpeg-static": "^5.2.0",
    "firebase-admin": "^13.5.0",
    "form-data": "^4.0.4",
    "fs": "^0.0.1-security",
    "googleapis": "^153.0.0",
    "helmet": "^7.2.0",
    "html-to-text": "^9.0.5",
    "imap": "^0.8.19",
    "imapflow": "^1.1.0",
    "mailparser": "^3.9.0",
    "mammoth": "^1.11.0",
    "mime-types": "^3.0.1",
    "multer": "^2.0.2",
    "natural": "^8.1.0",
    "node-cron": "^4.2.1",
    "node-fetch": "^2.7.0",
    "nodemailer": "^7.0.10",
    "open": "^10.2.0",
    "openai": "^5.23.2",
    "os": "^0.1.2",
    "p-limit": "^2.3.0",
    "path": "^0.12.7",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^1.1.4",
    "pdfjs-dist": "^3.4.120",
    "pdfkit": "^0.17.1",
    "pizzip": "^3.2.0",
    "stopword": "^3.1.5",
    "stopwords-en": "^0.3.0",
    "stopwords-es": "^0.3.0",
    "tesseract.js": "^6.0.1",
    "xlsx": "^0.18.5"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": ""
}
</file>

<file path="README.md">
# üåü GLOBAL TALENT CONNECTIONS

> **Sistema de Reclutamiento Automatizado con IA**
> 
> Procesa candidatos desde el email inicial hasta generar reportes profesionales con an√°lisis inteligente.

---

## üìä Status del Proyecto

| Aspecto | Estado |
|---------|--------|
| **Versi√≥n** | 1.0.0 |
| **Estado General** | ‚úÖ Producci√≥n |
| **√öltima actualizaci√≥n** | 28 de Diciembre, 2025 |
| **Calificaci√≥n** | 8.5/10 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **Usuarios soportados** | 5 m√°ximo |
| **Costo mensual** | $1 - $35 USD |

---

## üéØ ¬øQu√© hace?

**Global Talent Connections** es un sistema que **automatiza el proceso completo de reclutamiento:**

1. üìß **Recibe CVs autom√°ticamente** por email
2. üß† **Clasifica candidatos con IA** (Gemini)
3. üé¨ **Analiza entrevistas en video**
4. üìÑ **Genera reportes profesionales en DOCX**
5. üë• **Gestiona el flujo de decisiones** (Aprobar, Rechazar, Contratar)
6. üóëÔ∏è **Mantiene papelera de recuperaci√≥n** con backups autom√°ticos

---

## üöÄ Inicio R√°pido

### Prerequisitos
- Node.js 18+
- npm o yarn
- Cuenta Google (Gmail + Cloud)
- Cuenta Firebase

### Instalaci√≥n (3 pasos)

```
# 1. Clonar e instalar dependencias
git clone <tu-repo>
cd proyecto
npm install

# 2. Configurar variables de entorno (.env)
cp .env.example .env
# Edita .env con tus credenciales

# 3. Iniciar el servidor
npm start
```

Dashboard abierto en: **http://localhost:3001**

---

## üèóÔ∏è Stack Tecnol√≥gico

```
‚îå‚îÄ FRONTEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HTML5 + Vanilla JS             ‚îÇ
‚îÇ Tailwind CSS                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ BACKEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Node.js 18+                    ‚îÇ
‚îÇ Express 4.21                   ‚îÇ
‚îÇ Firebase Admin SDK             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ INTELIGENCIA ARTIFICIAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Google Generative AI (Gemini)  ‚îÇ
‚îÇ Google Vision OCR              ‚îÇ
‚îÇ Google Speech-to-Text          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ DATOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Firestore (NoSQL)              ‚îÇ
‚îÇ Google Cloud Storage           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ INTEGRACIONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Gmail IMAP                     ‚îÇ
‚îÇ Zoho Forms (2 webhooks)        ‚îÇ
‚îÇ Nodemailer                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìã Features Principales

### ‚úÖ Automatizaci√≥n Completa
- [x] Lectura autom√°tica de Gmail cada 2 minutos
- [x] Extracci√≥n de PDF ‚Üí Texto (con OCR si es scan)
- [x] Detecci√≥n autom√°tica de puesto desde subject

### ‚úÖ An√°lisis con IA
- [x] Clasificaci√≥n de CV en JSON estructurado
- [x] An√°lisis profundo post-entrevista
- [x] Generaci√≥n autom√°tica de reportes DOCX

### ‚úÖ Gesti√≥n de Candidatos
- [x] Dashboard responsivo (Explorar ‚Üí Gesti√≥n ‚Üí Decisi√≥n)
- [x] Agendamiento de entrevistas autom√°tico
- [x] Papelera con opci√≥n de reactivar

### ‚úÖ Seguridad
- [x] Autenticaci√≥n Firebase (5 usuarios max)
- [x] Rate limiting (120 req/min)
- [x] Helmet.js headers
- [x] Variables de entorno seguras

---

## üìñ Documentaci√≥n

Este proyecto incluye documentaci√≥n completa orientada al onboarding:

| Documento | P√∫blico | Contenido |
|-----------|---------|----------|
| **ONBOARDING_COMPLETO.md** | Nuevos devs | Gu√≠a paso a paso con met√°foras |
| **CONCEPTOS_FUNDAMENTALES.md** | Tech Leads | Explicaci√≥n profunda de arquitectura |
| **FLUJO_OPERACIONAL.md** | Todos | C√≥mo funciona el sistema d√≠a a d√≠a |
| **CHECKLIST_IMPLEMENTACION.md** | Devs | 30 acciones para escalar de 8.5 a 10/10 |
| **TROUBLESHOOTING.md** | Support | Soluciones a problemas comunes |

---

## üéì Para Nuevos Miembros del Equipo

Si es tu **primer d√≠a**, empieza aqu√≠:

```
1. Lee: ONBOARDING_COMPLETO.md (30 min)
2. Lee: CONCEPTOS_FUNDAMENTALES.md (20 min)
3. Lee: FLUJO_OPERACIONAL.md (20 min)
4. Prueba: npm start y abre http://localhost:3001 (10 min)
5. Pregunta: ¬øDudas? Ve a TROUBLESHOOTING.md
```

**Tiempo total:** ~80 minutos para comprenderlo todo.

---

## üîÑ El Sistema en una Frase

> **Imagina que tienes un mozo 24/7 que lee todos tus emails de candidatos, 
> los clasifica autom√°ticamente, analiza sus videos, ¬°y hasta te genera 
> reportes profesionales listos para presentar a directivos.**

---

## üí∞ Pricing & Costos

### Costo Real Mensual
- Google APIs: **$0.77**
- Hosting (Render/Vercel): **$0-8**
- Firebase Plan: **$0-25**
- **TOTAL: $1-35 USD/mes**

### Comparaci√≥n vs Competencia
| Producto | Precio/mes | Ahorro |
|----------|-----------|--------|
| **GTC (Nuestro)** | **$1-35** üü¢ | - |
| Workable | $99+ | 65% |
| Lever | $200+ | 83% |
| Bullhorn | $500+ | 93% |

---

## üë• Arquitectura de Equipo

El sistema est√° dise√±ado para ser mantenido por:

- **1 Backend Developer** - Mantiene APIs, IA, integraciones
- **1 DevOps** - Deploy, monitoreo, backups
- **1-2 Reclutadores** - Usan el dashboard (m√°x 5 usuarios)

---

## üìû Support & Issues

- **Bug t√©cnico** ‚Üí Ver `TROUBLESHOOTING.md`
- **No entiendo algo** ‚Üí Ver `ONBOARDING_COMPLETO.md`
- **Quiero mejorar X** ‚Üí Ver `CHECKLIST_IMPLEMENTACION.md`

---

## üìÑ Licencia

Uso privado de Global Talent Connections.

---

**Made with ‚ù§Ô∏è for better recruitment automation**

*Global Talent Connections - Conectando talento, autom√°ticamente.*
```
</file>

<file path="requirements.txt">
python-docx
docxtpl
jinja2
openai>=1.0.0
python-dotenv
pdfminer.six
docx2txt
docx2pdf; sys_platform == "win32"
</file>

<file path=".gitignore">
.# Archivos de sistema y dependencias
node_modules/
.DS_Store

# Archivos de secretos y entorno (LO IMPORTANTE)
.env
firebase-key.json
serviceAccountKey.json
*.log
</file>

<file path="cliente_lite/api-client.js">
const API_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
    ? "http://localhost:3001"       // Si estoy en mi compu
    : window.location.origin;       // <--- MAGIA: Detecta la URL real autom√°ticamente (sea cual sea)

console.log(`üöÄ Conectado a la API en: ${API_URL}`);

const api = {
            reports: {
                generate: async (id, manualData = null) => {
                    try {
                        const response = await fetch(`${API_URL}/candidatos/${id}/resumen`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ forceRegenerate: !!manualData, manualData: manualData })
                        });
                        return await response.json();
                    } catch (e) { return null; }
                }
            },
            candidates: {
                list: async () => {
                    try {
                        const res = await fetch(`${API_URL}/buscar`);
                        const data = await res.json();
                        const lista = data.resultados || [];
                        return lista.map(c => ({
                        id: c.id,
                        nombre: c.nombre || "Sin Nombre",
                        email: c.email || "S/E",
                        puesto: c.puesto || "General",
                        
                        // üî• DATOS DE IA Y FILTROS
                        ia_score: c.ia_score || 0,
                        ia_motivos: c.ia_motivos || c.motivo || "An√°lisis pendiente...", 
                        ia_alertas: c.ia_alertas || [],
                        respuestas_filtro: c.respuestas_filtro || {}, 
                        
                        // üé• VIDEO Y ARCHIVOS (ARREGLADO PARA ZOHO)
                        cv_url: c.cv_url || '#',
                        // Aqu√≠ agregamos c.Video_Link para que lea lo que viene del formulario
                        video_url: c.video_url || c.Video_Link || null, 
                        
                        // ESTADOS
                        fecha: c.fecha || c.creado_en,
                        stage: c.stage || (c.status_interno === 'new' ? 'stage_1' : 'stage_1'), 
                        status_interno: c.status_interno || 'new',
                        
                        // üëá ESTOS SON LOS DOS CABLES QUE FALTABAN PARA LA PERSISTENCIA üëá
                        assignedTo: c.assignedTo || null,      
                        history: c.history || c.historial_movimientos || [], 
                        
                        notes: c.motivo || c.notes || '', 
                        informe_final_data: c.informe_final_data || null,
                        
                        // üî• GESTI√ìN DE ENTREVISTA (para que persistan despu√©s de refrescar)
                        meet_link: c.meet_link || null,
                        interview_transcript: c.interview_transcript || null,
                        transcripcion_entrevista: c.transcripcion_entrevista || null,
                        process_step_2_form: c.process_step_2_form || null,
                        process_step_3_result: c.process_step_3_result || null
                    }));
                    } catch (error) {
                        console.error("Error cargando:", error);
                        return []; 
                    }
                },
                // üöÄ EL ARREGLO DEL BOT√ìN (USANDO PATCH)
                update: async (id, updates) => {
                    try {
                        await fetch(`${API_URL}/candidatos/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        return { ok: true };
                    } catch (e) {
                        console.error(e);
                        return { ok: false };
                    }
                },
                
                manualUpload: async (formData) => {
                    try {
                        const res = await fetch(`${API_URL}/candidatos/ingreso-manual`, { 
                            method: 'POST', 
                            body: formData 
                        });
                        return await res.json();
                    } catch (e) {
                        console.error("Error en upload:", e);
                        return { ok: false, error: e.message };
                    }
                }
            },
            metrics: {
                get: async () => {
                    try {
                        const res = await fetch(`${API_URL}/panel/metrics`);
                        const data = await res.json();
                        return { totals: data.totals }; 
                    } catch (e) { return { totals: {} }; }
                }
            },
            // Para el ReportView modo manual
            processManualReport: async (formData) => {
                const res = await fetch(`${API_URL}/manual-upload`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error("Error en el servidor");
                return await res.json();
            },
            webhooks: {
                getStatus: async () => {
                    try {
                        const res = await fetch(`${API_URL}/webhooks/status`);
                        if (!res.ok) throw new Error("Error en servidor");
                        return await res.json();
                    } catch (e) {
                        console.error("Error obteniendo estado de webhooks:", e);
                        return { 
                            zoho_form1: { status: "rojo", razon: "Error de conexi√≥n" },
                            zoho_form2: { status: "rojo", razon: "Error de conexi√≥n" }
                        };
                    }
                }
            }
        };

        // --- HACER API GLOBAL ---
window.api = api;
window.API_URL = API_URL;
</file>

<file path="docs/ONBOARDING_COMPLETO.md">
# üéì ONBOARDING COMPLETO - GLOBAL TALENT CONNECTIONS

> **Bienvenido al equipo.** Esta gu√≠a te ense√±ar√° c√≥mo funciona nuestro sistema de reclutamiento con IA, utilizando met√°foras simples para entender la complejidad t√©cnica.
> 
> **Tiempo estimado de lectura:** 30 minutos  
> **Nivel:** Principiante a Intermedio

---

## üìç TABLA DE CONTENIDOS

1. [La Met√°fora del Restaurante](#la-met√°fora-del-restaurante)
2. [Las 3 Etapas del Sistema](#las-3-etapas-del-sistema)
3. [Tu Primer D√≠a: Gu√≠a Pr√°ctica](#tu-primer-d√≠a-gu√≠a-pr√°ctica)
4. [Las Herramientas del Equipo](#las-herramientas-del-equipo)
5. [Preguntas Frecuentes](#preguntas-frecuentes)

---

## üçΩÔ∏è La Met√°fora del Restaurante

Imagina que **Global Talent Connections es un restaurante de alta cocina automatizado:**

### 1. El Mozo 24/7 (Backend)
Nuestro servidor (`index.js`) es un mozo incansable que trabaja 24 horas.
*   **Escucha:** Est√° siempre parado en la puerta (Gmail) esperando clientes.
*   **Recibe:** Cuando llega un email (Cliente), toma su abrigo (CV).
*   **Filtra:** Si es solo publicidad, no lo deja pasar. Solo atiende a quienes traen CV.
*   **Organiza:** Anota todo en el libro de reservas (Firestore) sin que nadie se lo pida.

### 2. El Chef Ejecutivo (IA - Gemini)
*   **Clasifica:** Cuando el mozo le trae un CV, el Chef lo lee en 2 segundos y dice: *"Este es un Senior Developer, sabe React y Node.js. Le doy un 8.5/10"*.
*   **Cocina:** M√°s tarde, toma todos los ingredientes (Video entrevista + Notas + CV) y prepara el plato final: un **Informe DOCX** perfecto.

### 3. El Gerente (T√∫ / Frontend)
El Dashboard (`dashboard.html`) es tu oficina de control.
*   **Supervisa:** Ves la lista de espera que el mozo prepar√≥.
*   **Decide:** Tienes el poder final. Con un bot√≥n dices **"Pasa a la mesa" (Aprobar)** o **"Lo sentimos, hoy no" (Rechazar)**.
*   **Coordina:** Si apruebas, el mozo autom√°ticamente corre a servir la mesa (Agenda la entrevista y env√≠a emails).

---

## üó∫Ô∏è Las 3 Etapas del Sistema

El flujo de vida de un candidato es lineal y simple:

### ETAPA 1: EXPLORAR (La Recepci√≥n)
*   **Estado:** Candidatos "crudos" que acaban de llegar por email.
*   **Tu trabajo:** Mirar el Score que puso la IA.
*   **Acci√≥n:**
    *   üü¢ **APROBAR:** Pasa a la siguiente etapa.
    *   üî¥ **RECHAZAR:** Se env√≠a email de agradecimiento y va a la Papelera.

### ETAPA 2: GESTI√ìN (La Mesa Principal)
*   **Estado:** Candidatos aprobados. Aqu√≠ ocurre la magia.
*   **Tu trabajo:**
    1.  Tener la entrevista (video).
    2.  Anotar tus impresiones.
    3.  Hacer clic en **"ANALIZAR CON IA"**.
*   **Acci√≥n del Sistema:** Genera el reporte DOCX y te da el enlace de descarga.
*   **Decisi√≥n Final:**
    *   ü§ù **CONTRATAR:** ¬°√âxito!
    *   ‚ùå **NO CALIFICA:** Se descarta con feedback profesional.

### ETAPA 3: PAPELERA (El Archivo)
*   **Estado:** Candidatos rechazados.
*   **Funcionalidad:** Nada se borra permanentemente por error.
*   **Backup:** Si te arrepientes, puedes darle a **"REACTIVAR"** (Control+Z) y el candidato vuelve a la etapa de Explorar como si nada hubiera pasado.

---

## üöÄ Tu Primer D√≠a: Gu√≠a Pr√°ctica

Sigue estos 4 pasos para entender el sistema hoy mismo:

### Paso 1: Levantar el Restaurante
Abre tu terminal en la carpeta del proyecto y ejecuta:
npm install
npm start
Ahora abre tu navegador en: `http://localhost:3001`

### Paso 2: La Prueba de Fuego
Vamos a simular ser un candidato.
1.  Abre tu correo personal.
2.  Redacta un email para la direcci√≥n que configuraste en el sistema (`GMAIL_USER`).
3.  **Asunto:** "Postulaci√≥n Desarrollador Frontend".
4.  **Adjunto:** Sube cualquier PDF que parezca un CV.
5.  **Enviar.**

### Paso 3: Ver la Magia
1.  Espera 2 minutos (el mozo revisa el correo cada 120 segundos).
2.  Mira la consola de tu terminal. Deber√≠as ver: `üì® Correo recibido... Procesando CV...`.
3.  Refresca el Dashboard (`http://localhost:3001`).
4.  **¬°Ah√≠ est√°!** Tu candidato deber√≠a aparecer en la columna "Nuevos" con un Score asignado.

### Paso 4: Tomar el Control
1.  Haz clic en **"Aprobar"**. Ver√°s c√≥mo salta a la pesta√±a "Gesti√≥n".
2.  Haz clic en **"Analizar con IA"** (simulando que ya hubo entrevista).
3.  Espera unos segundos y descarga el DOCX generado. ¬°√Åbrelo y sorpr√©ndete!

---

## üõ†Ô∏è Las Herramientas del Equipo

Para trabajar aqu√≠, solo necesitas conocer esto:

*   **VS Code:** Donde escribimos el c√≥digo.
*   **Firebase Console:** Donde vive la base de datos (Firestore). Si necesitas ver los datos "crudos", vas aqu√≠.
*   **Google Cloud Storage:** Donde se guardan los archivos f√≠sicos (PDFs y DOCXs).
*   **Zoho Forms:** Usamos esto para que los candidatos llenen sus datos extra.

---

## ‚ùì Preguntas Frecuentes

**P: ¬øQu√© pasa si el PDF es una foto escaneada?**
R: No hay problema. Usamos Google Vision (OCR), que es como ponerle gafas de lectura al sistema. Lee texto incluso de im√°genes.

**P: ¬øEl sistema env√≠a emails solo?**
R: S√≠. Cuando apruebas o rechazas, el sistema usa plantillas predefinidas para notificar al candidato. T√∫ no tienes que redactar nada manual.

**P: ¬øD√≥nde cambio las preguntas de la entrevista?**
R: Eso est√° en el prompt de la IA dentro de `index.js`. Si quieres ajustar qu√© eval√∫a la IA, editas esa secci√≥n del c√≥digo.

**P: ¬°Borr√© un candidato sin querer!**
R: Ve a la pesta√±a "Papelera" en el Dashboard. Busca al candidato y dale al bot√≥n de restaurar.

---

**¬°Bienvenido a bordo!**
Si tienes dudas t√©cnicas profundas, lee el archivo `CONCEPTOS_FUNDAMENTALES.md`.
</file>

<file path="cliente_lite/dashboard.js">
// --- 1. ARQUITECTURA DE DATOS (CEREBRO) ---

        const MOCK_DB = [
        { 
            id: 'c1', 
            nombre: 'Sofia Mart√≠nez', 
            email: 'sofia.m@example.com', 
            puesto: 'Asistente de Marketing', 
            ia_score: 94, 
            fecha: '2023-10-24T10:00:00Z', 
            stage: 'stage_1', 
            status_interno: 'new', // Esto activa la alerta de "Nuevo"
            cv_url: '#', 
            video_url: '#', 
            notes: 'Experiencia s√≥lida en Meta Ads. Perfil interesante.', 
            alerts: ['Ingl√©s C1', 'Certificada Google'],
            history: [
                { date: '2023-10-24T10:00:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Zoho Forms' }
            ]
        },
        { 
            id: 'c2', 
            nombre: 'Lucas Ramirez', 
            email: 'lucas.r@example.com', 
            puesto: 'Asistente IA', 
            ia_score: 88, 
            fecha: '2023-10-24T09:30:00Z', 
            stage: 'stage_1', 
            status_interno: 'viewed', 
            cv_url: '#', 
            video_url: null, 
            notes: '', 
            alerts: ['Experto en Zapier'],
            history: [
                { date: '2023-10-24T09:30:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Zoho Forms' },
                { date: '2023-10-24T11:00:00Z', event: 'Revisi√≥n Inicial', detail: 'Abierto por Admin' }
            ]
        },
        { 
            id: 'c3', 
            nombre: 'Mariana Lopez', 
            email: 'mariana.l@example.com', 
            puesto: 'Asistente Financiero', 
            ia_score: 91, 
            fecha: '2023-10-22T14:00:00Z', 
            stage: 'stage_2', 
            status_interno: 'interview_scheduled', 
            assignedTo: 'Admin', 
            interview_date: '2023-10-26T10:00:00Z', 
            meet_link: 'https://meet.google.com/abc-defg-hij',
            cv_url: '#', 
            video_url: 'https://loom.com/share/demo', 
            form2_received: false, 
            form2_sent: false,
            qualified: null, 
            notes: 'Pre-calificada correctamente. Agendar t√©cnica.',
            history: [
                { date: '2023-10-22T14:00:00Z', event: 'Ingreso al Pipeline', detail: 'V√≠a Web' },
                { date: '2023-10-23T09:00:00Z', event: 'Aprobado a Gesti√≥n', detail: 'Por Admin' },
                { date: '2023-10-23T10:30:00Z', event: 'Entrevista Agendada', detail: 'Para 26/10' }
            ]
        },
        { 
            id: 'c4', 
            nombre: 'Javier Costa', 
            email: 'javier.c@example.com', 
            puesto: 'Desarrollador Web', 
            ia_score: 75, 
            fecha: '2023-10-20T11:00:00Z', 
            stage: 'trash', 
            status_interno: 'discarded', 
            cv_url: '#', 
            notes: 'Salario fuera de rango', 
            alerts: ['Salario Alto'],
            history: [
                { date: '2023-10-20T11:00:00Z', event: 'Ingreso', detail: '' },
                { date: '2023-10-21T09:00:00Z', event: 'Descarte', detail: 'Salario fuera de rango' }
            ]
        },
        { 
            id: 'c5', 
            nombre: 'Elena Volkov', 
            email: 'elena@example.com', 
            puesto: 'Project Manager', 
            ia_score: 98, 
            fecha: '2023-10-15T09:00:00Z', 
            stage: 'stage_3', 
            status_interno: 'ready_for_report', 
            cv_url: '#', 
            video_url: '#', 
            form2_received: true, 
            form2_sent: true,
            qualified: true, 
            report_generated: false, 
            notes: 'Lista para presentar al cliente.',
            history: [
                { date: '2023-10-15T09:00:00Z', event: 'Ingreso', detail: '' },
                { date: '2023-10-16T14:00:00Z', event: 'Aprobado a Gesti√≥n', detail: 'Por Admin' },
                { date: '2023-10-18T10:00:00Z', event: 'Entrevista Completada', detail: 'Exitosa' },
                { date: '2023-10-19T11:00:00Z', event: 'Calificado Positivo', detail: 'Pasa a Informe' }
            ]
        },
        ];

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));


        const formatDate = (isoString) => {
            if (!isoString) return '-';
            try {
                return new Date(isoString).toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
            } catch (e) {
                return '-';
            }
        };

        const formatTime = (isoString) => {
            if (!isoString) return '';
            try {
                return new Date(isoString).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return '';
            }
        };

        const STATUS_LABELS = {
            'new': 'Nuevo Ingreso',
            'viewed': 'En Revisi√≥n',
            'interview_pending': 'Pendiente Entrevista',
            'interview_scheduled': 'Entrevista Agendada',
            'interview_completed': 'Entrevista Realizada',
            'pending_form2': 'Pendiente Formulario 2',
            'ready_for_report': 'Listo para Informe',
            'discarded': 'Descartado'
        };

        const getStatusLabel = (status) => STATUS_LABELS[status] || status || 'En Proceso';     

       

        // --- 3. VISTAS DEL SISTEMA ---

        function DashboardView({ candidates, onNavigate }) {
        // Calculamos estad√≠sticas con l√≥gica de "Nuevos sin ver"
        const stats = {
            new: candidates.filter(c => c.stage === 'stage_1').length,
            newUnseen: candidates.filter(c => c.stage === 'stage_1' && c.status_interno === 'new').length,
            interview: candidates.filter(c => c.stage === 'stage_2').length,
            ready: candidates.filter(c => c.stage === 'stage_3').length,
            trash: candidates.filter(c => c.stage === 'trash').length,
            total: candidates.filter(c => c.stage !== 'trash').length
        };
        
        // Calcular m√©tricas r√°pidas
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        const parseFirebaseDate = (dateValue) => {
            if (!dateValue) return null;
            if (typeof dateValue === 'object' && dateValue._seconds) {
                return new Date(dateValue._seconds * 1000);
            }
            if (typeof dateValue === 'string') {
                return new Date(dateValue);
            }
            return new Date(dateValue);
        };
        
        const candidatosHoy = candidates.filter(c => {
            const fecha = parseFirebaseDate(c.fecha || c.creado_en);
            if (!fecha) return false;
            return fecha >= hoy;
        }).length;
        
        const tasaExplorarAGestion = stats.new > 0 
            ? Math.round((stats.interview / stats.new) * 100) 
            : 0;
        
        const tasaGestionAInforme = stats.interview > 0 
            ? Math.round((stats.ready / stats.interview) * 100) 
            : 0;
        
        // Entrevistas pendientes a programar (stage_2 sin meet_link)
        const entrevistasPendientes = candidates.filter(c => 
            c.stage === 'stage_2' && !c.meet_link
        ).length;
        
        // Candidatos listos para informes (stage_3 sin informe_final_data)
        const listosParaInformes = candidates.filter(c => 
            c.stage === 'stage_3' && !c.informe_final_data
        ).length;
        
        // Cantidad de Form 2 recibido
        const form2Recibidos = candidates.filter(c => 
            c.respuestas_form2 || c.process_step_2_form === 'received'
        ).length;
        
        // Tiempo promedio en cada etapa (en d√≠as)
        const calcularTiempoPromedio = (stage) => {
            const candidatosEnStage = candidates.filter(c => c.stage === stage);
            if (candidatosEnStage.length === 0) return 0;
            
            const ahora = new Date();
            const tiempos = candidatosEnStage.map(c => {
                // Buscar en el historial cu√°ndo entr√≥ a este stage
                const historial = c.history || c.historial_movimientos || [];
                
                // Buscar eventos relacionados con el cambio a este stage
                let fechaEntrada = null;
                if (historial.length > 0) {
                    // Buscar el √∫ltimo evento que indica entrada a este stage
                    const eventosRelevantes = historial.filter(h => {
                        if (!h.event || !h.date) return false;
                        const eventLower = h.event.toLowerCase();
                        return (
                            (stage === 'stage_1' && (eventLower.includes('ingreso') || eventLower.includes('pipeline'))) ||
                            (stage === 'stage_2' && (eventLower.includes('gesti√≥n') || eventLower.includes('aprobado') || eventLower.includes('gestion'))) ||
                            (stage === 'stage_3' && (eventLower.includes('informe') || eventLower.includes('listo')))
                        );
                    });
                    
                    if (eventosRelevantes.length > 0) {
                        // Tomar el m√°s reciente
                        const ultimoEvento = eventosRelevantes[eventosRelevantes.length - 1];
                        fechaEntrada = parseFirebaseDate(ultimoEvento.date);
                    }
                }
                
                // Si no encontramos en historial, usar fecha de creaci√≥n como fallback
                if (!fechaEntrada) {
                    fechaEntrada = parseFirebaseDate(c.fecha || c.creado_en);
                }
                
                if (fechaEntrada) {
                    const diffMs = ahora - fechaEntrada;
                    const dias = diffMs / (1000 * 60 * 60 * 24);
                    return dias > 0 ? dias : 0; // Solo d√≠as positivos
                }
                
                return 0;
            }).filter(t => t > 0);
            
            if (tiempos.length === 0) return 0;
            return Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length);
        };
        
        const tiempoPromedioStage1 = calcularTiempoPromedio('stage_1');
        const tiempoPromedioStage2 = calcularTiempoPromedio('stage_2');
        const tiempoPromedioStage3 = calcularTiempoPromedio('stage_3');
        
        // Estado para monitorear webhooks
        const [webhookStatus, setWebhookStatus] = useState({
            zoho_form1: { status: "verde", razon: "Cargando..." },
            zoho_form2: { status: "verde", razon: "Cargando..." }
        });
        
        useEffect(() => {
            const cargarEstado = async () => {
                const estado = await api.webhooks.getStatus();
                setWebhookStatus(estado);
            };
            
            cargarEstado(); // Cargar inmediatamente
            const intervalo = setInterval(cargarEstado, 300000); // Cada 5 minutos  (300000 ms)
            
            return () => clearInterval(intervalo); // Limpiar al desmontar
        }, []);

        return (
            <div className="animate-in fade-in duration-500 max-w-7xl mx-auto">
            <header className="mb-6 flex justify-between items-end">
                <div>
                    <h1 className="text-2xl font-bold text-white mb-1 tracking-tight">Panel de Control</h1>
                    <p className="text-slate-400 text-sm">Resumen operativo compacto.</p>
                </div>
                <div className="px-3 py-1.5 bg-slate-900 border border-slate-800 rounded-lg flex items-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span className="text-[10px] font-bold text-slate-400 uppercase">Sistema Online</span>
                </div>
            </header>
            
            {/* Nuevo Grafico de Embudo Horizontal Compacto */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div className="lg:col-span-2">
                    <HorizontalFunnel stats={stats} />
                </div>
                <div className="space-y-4">
                    {/* Tarjetas de Acceso R√°pido Compactas */}
                    <button onClick={() => onNavigate('stage_1')} className="w-full p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-blue-500/50 transition-all group flex items-center justify-between">
                        <div className="text-left">
                            <p className="text-[10px] uppercase font-bold text-slate-500">Bandeja de Entrada</p>
                            <div className="flex items-center gap-2">
                                <span className="text-2xl font-bold text-white">{stats.new}</span>
                                {stats.newUnseen > 0 && (
                                    <span className="text-[10px] bg-rose-500 text-white px-2 py-0.5 rounded-full animate-bounce">
                                        {stats.newUnseen} pendientes
                                    </span>
                                )}
                            </div>
                        </div>
                        <UserPlus className="text-blue-500 group-hover:scale-110 transition-transform" size={24}/>
                    </button>

                    <button onClick={() => onNavigate('trash')} className="w-full p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-rose-500/50 transition-all group flex items-center justify-between">
                        <div className="text-left">
                            <p className="text-[10px] uppercase font-bold text-slate-500">Papelera</p>
                            <span className="text-2xl font-bold text-white">{stats.trash}</span>
                        </div>
                        <Trash2 className="text-rose-500 group-hover:scale-110 transition-transform" size={24}/>
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-5">
                    <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Activity size={16}/> M√©tricas R√°pidas</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {/* Candidatos Procesados Hoy */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Procesados Hoy</p>
                            <p className="text-2xl font-bold text-white">{candidatosHoy}</p>
                        </div>
                        
                        {/* Tasa Explorar ‚Üí Gesti√≥n */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Explorar ‚Üí Gesti√≥n</p>
                            <p className="text-2xl font-bold text-blue-400">{tasaExplorarAGestion}%</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">{stats.interview} de {stats.new}</p>
                        </div>
                        
                        {/* Tasa Gesti√≥n ‚Üí Informe */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Gesti√≥n ‚Üí Informe</p>
                            <p className="text-2xl font-bold text-emerald-400">{tasaGestionAInforme}%</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">{stats.ready} de {stats.interview}</p>
                        </div>
                        
                        {/* Entrevistas Pendientes */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Entrevistas Pendientes</p>
                            <p className="text-2xl font-bold text-amber-400">{entrevistasPendientes}</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">sin programar</p>
                        </div>
                        
                        {/* Candidatos Listos para Informes */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Listos para Informes</p>
                            <p className="text-2xl font-bold text-purple-400">{listosParaInformes}</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">pendientes</p>
                        </div>
                        
                        {/* Form 2 Recibido */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Form 2 Recibido</p>
                            <p className="text-2xl font-bold text-cyan-400">{form2Recibidos}</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">completados</p>
                        </div>
                        
                        {/* Tiempo Promedio Stage 1 */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Tiempo Prom. Explorar</p>
                            <p className="text-2xl font-bold text-slate-300">{tiempoPromedioStage1}</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">d√≠as</p>
                        </div>
                        
                        {/* Tiempo Promedio Stage 2 */}
                        <div className="bg-slate-950/50 rounded-lg p-3 border border-slate-800/50">
                            <p className="text-[10px] text-slate-500 uppercase font-bold mb-1">Tiempo Prom. Gesti√≥n</p>
                            <p className="text-2xl font-bold text-slate-300">{tiempoPromedioStage2}</p>
                            <p className="text-[9px] text-slate-600 mt-0.5">d√≠as</p>
                        </div>
                    </div>
                </div>
                
                <div className="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2"><Globe size={16}/> Integraciones</h3>
                        <div className="grid grid-cols-1 gap-3">
                            {/* Card Zoho Form 1 - Estado din√°mico */}
                            <div className={`p-3 bg-slate-950 rounded-lg border flex items-center gap-3 ${
                                webhookStatus.zoho_form1?.status === "verde" 
                                    ? "border-green-500/50" 
                                    : "border-red-500/50"
                            }`}>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                    webhookStatus.zoho_form1?.status === "verde"
                                        ? "bg-green-500/10 text-green-500"
                                        : "bg-red-500/10 text-red-500"
                                }`}>
                                    <Globe size={16}/>
                                </div>
                                <div className="flex-1">
                                    <p className="text-xs font-bold text-white">Zoho Forms (Form 1)</p>
                                    <p className={`text-[10px] ${
                                        webhookStatus.zoho_form1?.status === "verde"
                                            ? "text-green-400"
                                            : "text-red-400"
                                    }`}>
                                        {webhookStatus.zoho_form1?.status === "verde" ? "Online" : "Error"}
                                    </p>
                                    {webhookStatus.zoho_form1?.razon && (
                                        <p className="text-[9px] text-slate-500 mt-0.5">
                                            {webhookStatus.zoho_form1.razon}
                                        </p>
                                    )}
                                </div>
                            </div>
                            
                            {/* Card Zoho Form 2 - Estado din√°mico */}
                            <div className={`p-3 bg-slate-950 rounded-lg border flex items-center gap-3 ${
                                webhookStatus.zoho_form2?.status === "verde" 
                                    ? "border-green-500/50" 
                                    : "border-red-500/50"
                            }`}>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                    webhookStatus.zoho_form2?.status === "verde"
                                        ? "bg-green-500/10 text-green-500"
                                        : "bg-red-500/10 text-red-500"
                                }`}>
                                    <Globe size={16}/>
                                </div>
                                <div className="flex-1">
                                    <p className="text-xs font-bold text-white">Zoho Forms (Form 2)</p>
                                    <p className={`text-[10px] ${
                                        webhookStatus.zoho_form2?.status === "verde"
                                            ? "text-green-400"
                                            : "text-red-400"
                                    }`}>
                                        {webhookStatus.zoho_form2?.status === "verde" ? "Online" : "Error"}
                                    </p>
                                    {webhookStatus.zoho_form2?.razon && (
                                        <p className="text-[9px] text-slate-500 mt-0.5">
                                            {webhookStatus.zoho_form2.razon}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            </div>
        );
        }

        // --- NUEVA VISTA: BUSQUEDA Y TRACKING ---
        function SearchView({ candidates, onSelect }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [debouncedTerm, setDebouncedTerm] = useState('');  //agregado Debounce
            const [roleFilter, setRoleFilter] = useState('Todos');

            useEffect(() => {
                const timer = setTimeout(() => {
                    setDebouncedTerm(searchTerm);
                }, 300);
                return () => clearTimeout(timer); // Limpia el timer si el usuario sigue escribiendo
            }, [searchTerm]);
        
            // 3. Ahora filtramos usando 'debouncedTerm' en lugar de 'searchTerm'
           
            const results = candidates.filter(c => {
                const matchesText = c.nombre.toLowerCase().includes(debouncedTerm.toLowerCase()) || 
                                  c.email.toLowerCase().includes(debouncedTerm.toLowerCase());
                const matchesRole = roleFilter === 'Todos' || c.puesto.includes(roleFilter);
                return matchesText && matchesRole;
            });

            const roles = ['Todos', ...new Set(candidates.map(c => c.puesto))];

            return (
                <div className="h-full flex flex-col max-w-7xl mx-auto">
                    <div className="mb-6">
                        <h1 className="text-2xl font-bold text-white">B√∫squeda y Seguimiento</h1>
                        <p className="text-slate-400 text-sm mt-1">Localiza candidatos y revisa su estado actual.</p>
                    </div>

                    <div className="flex gap-4 mb-6">
                        <div className="relative flex-1">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16}/>
                            <input 
                                type="text" 
                                placeholder="Buscar por nombre o email..." 
                                className="w-full pl-10 pr-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <select 
                            className="px-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-white text-sm focus:border-blue-500 focus:outline-none"
                            value={roleFilter}
                            onChange={e => setRoleFilter(e.target.value)}
                        >
                            {roles.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                    </div>

                    <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden flex-1">
                        <div className="overflow-y-auto h-full">
                            <table className="w-full text-left">
                                <thead className="bg-slate-950 text-xs uppercase text-slate-500 sticky top-0 z-10">
                                    <tr>
                                        <th className="p-4 font-bold">Candidato</th>
                                        <th className="p-4 font-bold">Etapa Actual</th>
                                        <th className="p-4 font-bold">Estado Detallado</th>
                                        <th className="p-4 font-bold text-right">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {results.map(c => (
                                        <tr key={c.id} className="hover:bg-slate-800/50 group">
                                            <td className="p-4">
                                                <div className="flex items-center gap-3">
                                                    <Avatar name={c.nombre} size="sm"/>
                                                    <div>
                                                        <p className="font-bold text-sm text-white">{c.nombre}</p>
                                                        <p className="text-xs text-slate-500">{c.email}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4">
                                                <Badge type={c.stage === 'stage_3' ? 'green' : c.stage === 'trash' ? 'danger' : 'blue'}>
                                                    {c.stage === 'stage_1' ? 'Explorar' : c.stage === 'stage_2' ? 'Gesti√≥n' : c.stage === 'stage_3' ? 'Informes' : 'Papelera'}
                                                </Badge>
                                            </td>
                                            <td className="p-4 text-xs text-slate-400">
                                                {getStatusLabel(c.status_interno)}
                                            </td>
                                            <td className="p-4 text-right">
                                                <Button size="sm" variant="secondary" onClick={() => onSelect(c.id)}>
                                                    Ver Ficha
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                    {results.length === 0 && (
                                        <tr>
                                            <td colSpan={4} className="p-8 text-center text-slate-500 text-sm">
                                                No se encontraron resultados.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }
        // --- VISTA DE CARGA MANUAL ---
        function ManualUploadModal({ isOpen, onClose, onUploadSuccess }) {
    const [loading, setLoading] = React.useState(false);
    const [file, setFile] = React.useState(null);
    if (!isOpen) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        const formData = new FormData(e.target);
        if (file) formData.append('cv', file);
        const result = await api.candidates.manualUpload(formData);
        if (result.ok || result.id) {
            alert("‚úÖ Candidato cargado con √©xito. Iniciando an√°lisis IA...");
            onUploadSuccess();
            onClose();
        } else {
            alert("‚ùå Error: " + (result.error || "No se pudo subir"));
        }
        setLoading(false);
    };

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-in zoom-in duration-200">
                <h2 className="text-xl font-bold text-white mb-4">Carga Manual de Candidato</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <input name="nombre" required className="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-white text-sm outline-none focus:border-blue-500" placeholder="Nombre Completo" />
                    <input name="email" type="email" required className="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-white text-sm outline-none focus:border-blue-500" placeholder="Email" />
                    <input name="puesto" required className="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-white text-sm outline-none focus:border-blue-500" placeholder="Puesto Objetivo" />
                    <div className="border-2 border-dashed border-slate-800 rounded-xl p-4 text-center">
                        <input type="file" accept=".pdf" required onChange={e => setFile(e.target.files[0])} className="w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500" />
                    </div>
                    <div className="flex gap-3 mt-6">
                        <button type="button" onClick={onClose} className="flex-1 px-4 py-2 bg-slate-800 text-slate-400 rounded-lg text-sm font-bold">Cancelar</button>
                        <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold disabled:opacity-50">
                            {loading ? "Analizando..." : "Subir y Analizar"}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

        // --- VISTA EXPLORAR TALENTO (CORREGIDA) ---
function ExploreView({ candidates, onSelect, onUpdate, loading, onAddClick }) {
    const [filter, setFilter] = useState('');
    const [debouncedFilter, setDebouncedFilter] = useState('');

    useEffect(() => {
        const timer = setTimeout(() => {
            setDebouncedFilter(filter);
        }, 300);
        return () => clearTimeout(timer);
    }, [filter]);

    

    


    // --- HELPERS INTERNOS (CORREGIDOS PARA FIREBASE) ---
    const parseFirebaseDate = (iso) => {
        if (!iso) return null;
        if (typeof iso === 'object' && iso._seconds) {
            return new Date(iso._seconds * 1000);
        }
        return new Date(iso);
    };

    const simpleDate = (iso) => {
        const d = parseFirebaseDate(iso);
        if (!d || isNaN(d.getTime())) return '-';
        return d.getDate() + ' ' + d.toLocaleString('es-ES', { month: 'short' });
    };

    const isToday = (iso) => {
        const d = parseFirebaseDate(iso);
        if (!d || isNaN(d.getTime())) return false;
        
        const today = new Date();
        return d.getDate() === today.getDate() && 
               d.getMonth() === today.getMonth() && 
               d.getFullYear() === today.getFullYear();
    };
    
    // 1. Ordenamiento Seguro (Nuevos arriba)
    const sortedCandidates = [...candidates].sort((a, b) => {
        const dateA = parseFirebaseDate(a.fecha) || new Date(0);
        const dateB = parseFirebaseDate(b.fecha) || new Date(0);
        return dateB - dateA;
    });
    
    // 2. Filtrado (√öNICA DECLARACI√ìN)
    const filtered = sortedCandidates.filter(c => 
        c.stage === 'stage_1' && 
        (c.nombre.toLowerCase().includes(debouncedFilter.toLowerCase()) || 
         c.puesto.toLowerCase().includes(debouncedFilter.toLowerCase()))
    );

    

    return (
        <div className="h-full flex flex-col max-w-7xl mx-auto px-4">
            {/* CABECERA */}
            <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
                <div>
                    <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                        Explorar Talento 
                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-blue-400 text-sm font-bold border border-slate-700">
                            {filtered.length}
                        </span>
                    </h1>
                    <p className="text-slate-400 text-sm mt-2">Revisa los perfiles ingresados recientemente.</p>
                </div>
                
                <div className="flex gap-3 w-full md:w-auto items-center">
                    <div className="relative group flex-1 md:w-64">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16}/>
                        <input 
                            type="text" 
                            placeholder="Buscar..." 
                            value={filter} 
                            onChange={(e) => setFilter(e.target.value)} 
                            className="w-full pl-10 pr-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-300 focus:border-blue-500 focus:outline-none transition-all placeholder-slate-600"
                        />
                    </div>
                    {/* BOT√ìN ESTILIZADO CON ICONO */}
                    <button 
                        onClick={onAddClick}
                        className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-lg text-sm font-bold transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2 whitespace-nowrap active:scale-95"
                    >
                        <UserPlus size={22} />
                        
                    </button>
                </div>
            </div>

            {/* GRILLA DE TARJETAS */}
            {/* GRILLA DE TARJETAS CON SKELETON LOADERS */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
                {loading ? (
                    /* 1. Mientras carga, generamos 6 tarjetas de silueta (Skeletons) */
                    Array(6).fill(0).map((_, i) => <SkeletonCard key={i} />)
                ) : (
                    /* 2. Cuando termina de cargar, mostramos los datos reales */
                    filtered.map(c => (
                        <div 
                            key={c.id} 
                            onClick={() => onSelect(c.id)} 
                            className="bg-slate-900 border border-slate-800 rounded-xl p-6 cursor-pointer hover:border-slate-600 transition-all group relative flex flex-col justify-between min-h-[180px]"
                        >
                            {/* HEADER: PUESTO + SCORE */}
                            <div className="flex justify-between items-start mb-3">
                                <span className="text-[11px] font-bold text-blue-400 uppercase tracking-wider max-w-[70%] leading-tight">
                                    {c.puesto || "CANDIDATURA GENERAL"}
                                </span>
                                
                                {/* Score Box */}
                                <div className={`flex items-center justify-center px-2 py-1 rounded border ${
                                    (c.ia_score || 0) >= 90 
                                    ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' 
                                    : 'bg-amber-500/10 border-amber-500/20 text-amber-400'
                                }`}>
                                    <span className="text-xs font-bold">{c.ia_score || 0}</span>
                                </div>
                            </div>

                            {/* BODY: NOMBRE + ETIQUETA NUEVO */}
                            <div className="mb-6">
                                <h3 className="text-lg font-bold text-white group-hover:text-blue-100 transition-colors mb-2">
                                    {c.nombre || "Sin Nombre"}
                                </h3>
                                {/* Etiqueta "NUEVO" animada */}
                                {isToday(c.fecha) && c.status_interno === 'new' && (
                                    <span className="inline-block px-2 py-0.5 bg-blue-600 text-white text-[10px] font-bold rounded shadow-sm animate-pulse">
                                        NUEVO
                                    </span>
                                )}
                            </div>

                            {/* FOOTER: FECHA */}
                            <div className="mt-auto border-t border-slate-800 pt-3">
                                <span className="text-xs text-slate-500 font-medium">
                                    {simpleDate(c.fecha)}
                                </span>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
}


function ManageView({ candidates, onSelect, currentUser }) {
    const stage2 = candidates.filter(c => c.stage === 'stage_2');
    return (
        <div className="h-full flex flex-col max-w-7xl mx-auto px-4">
            <div className="mb-6">
                <h1 className="text-2xl font-bold text-white">Gesti√≥n de Candidatos</h1>
                <p className="text-slate-400 text-sm mt-1">Etapa 2: Entrevistas y evaluaci√≥n.</p>
            </div>
            <div className="bg-slate-900 border border-slate-800 rounded-xl shadow-sm overflow-hidden flex flex-col max-h-[calc(100vh-220px)]">
                <div className="overflow-y-auto custom-scrollbar flex-1">
                    <table className="w-full text-left border-collapse">
                        {/* Encabezado Sticky con fondo opaco */}
                        <thead className="bg-slate-950 text-xs uppercase text-slate-500 font-bold tracking-wider sticky top-0 z-20 border-b border-slate-800">
                            <tr>
                                <th className="px-6 py-4">Candidato</th>
                                <th className="px-6 py-4">Puesto</th>
                                <th className="px-6 py-4">Estado</th>
                                <th className="px-6 py-4">Responsable</th>
                                <th className="px-6 py-4 text-right">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800/50">
                            {stage2.length > 0 ? (
                                stage2.map(c => (
                                    <tr key={c.id} onClick={() => onSelect(c.id)} className="hover:bg-slate-800/60 cursor-pointer transition-colors group">
                                        <td className="px-6 py-3">
                                            <div className="flex items-center gap-3">
                                                <Avatar name={c.nombre} />
                                                <div>
                                                    <span className="font-bold text-slate-200 text-sm group-hover:text-white">{c.nombre}</span>
                                                    <p className="text-[10px] text-slate-500">{c.email}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-6 py-3"><span className="text-xs text-slate-400">{c.puesto}</span></td>
                                        <td className="px-6 py-3"><Badge type="blue">{getStatusLabel(c.status_interno)}</Badge></td>
                                        <td className="px-6 py-3">
                                            {c.assignedTo ? (
                                                <div className="flex items-center gap-2">
                                                    <Avatar name={c.assignedTo} size="sm"/>
                                                    <span className={`text-xs ${c.assignedTo === currentUser ? 'text-blue-400 font-bold' : 'text-slate-500'}`}>
                                                        {c.assignedTo}
                                                    </span>
                                                </div>
                                            ) : <span className="text-xs text-slate-600 italic">Sin asignar</span>}
                                        </td>
                                        <td className="px-6 py-3 text-right">
                                            <ChevronRight size={16} className="ml-auto text-slate-600 group-hover:text-white transition-transform group-hover:translate-x-1"/>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="5" className="px-6 py-12 text-center text-slate-500 text-sm italic">
                                        No hay candidatos en etapa de gesti√≥n.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
// ==========================================
// üóëÔ∏è VISTA PAPELERA (RECUPERACI√ìN)
// ==========================================
function TrashView({ candidates, onUpdate }) {
    // Filtramos solo los que est√°n en 'trash'
    const discarded = candidates.filter(c => c.stage === 'trash');

    return (
        <div className="h-full flex flex-col max-w-7xl mx-auto px-4">
            <div className="mb-6">
                <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                    <Trash2 className="text-rose-500" /> Papelera de Reciclaje
                </h1>
                <p className="text-slate-400 text-sm mt-1">
                    Candidatos descartados. Puedes restaurarlos o ver el motivo de descarte.
                </p>
            </div>

            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-sm">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-950/50 text-xs uppercase text-slate-500 font-bold tracking-wider">
                        <tr>
                            <th className="px-6 py-4 border-b border-slate-800">Candidato</th>
                            <th className="px-6 py-4 border-b border-slate-800">Motivo de Descarte</th>
                            <th className="px-6 py-4 border-b border-slate-800 text-right">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-800/50">
                        {discarded.length === 0 ? (
                            <tr>
                                <td colSpan="3" className="p-8 text-center text-slate-500 italic">
                                    La papelera est√° vac√≠a.
                                </td>
                            </tr>
                        ) : (
                            discarded.map(c => (
                                <tr key={c.id} className="hover:bg-slate-800/30 transition-colors group">
                                    <td className="px-6 py-3">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-500 font-bold text-xs">
                                                {c.nombre.charAt(0)}
                                            </div>
                                            <div>
                                                <span className="font-bold text-slate-300 text-sm block">{c.nombre}</span>
                                                <span className="text-[10px] text-slate-500">{c.puesto}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="px-6 py-3">
                                        <span className="text-xs text-rose-300 bg-rose-900/10 px-2 py-1 rounded border border-rose-900/20">
                                            {c.notes || c.motivo || "Sin motivo especificado"}
                                        </span>
                                    </td>
                                    <td className="px-6 py-3 text-right">
                                        <button 
                                            onClick={() => {
                                                if(confirm(`¬øRestaurar a ${c.nombre} a la etapa de Exploraci√≥n?`)) {
                                                    onUpdate(c.id, { stage: 'stage_1', status_interno: 'viewed', notes: "" });
                                                }
                                            }}
                                            className="text-xs font-bold text-emerald-500 hover:text-emerald-400 border border-emerald-900/30 bg-emerald-900/10 px-3 py-1.5 rounded hover:bg-emerald-900/20 transition-all"
                                        >
                                            <Undo2 size={14} className="inline mr-1"/> RESTAURAR
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
// ==========================================
// üìÑ COMPONENTE: REPORTE PROFESIONAL (DISE√ëO MEJORADO)
// ==========================================
const ProfessionalReport = ({ data, onBack, onEdit }) => {
    const [downloading, setDownloading] = React.useState(false);
    const [downloadingPDF, setDownloadingPDF] = React.useState(false);
    const reportRef = React.useRef(null);

    const handleDownload = async () => {
        setDownloading(true);
        try {
            const response = await fetch(`${API_URL}/download-docx`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error generando el documento");

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_${data.nombre.replace(/\s+/g, '_')}.docx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error(error);
            alert("No se pudo descargar el archivo. Revisa la consola.");
        } finally {
            setDownloading(false);
        }
    };

    const handleDownloadPDF = async () => {
        setDownloadingPDF(true);
        try {
            // Cargar html2pdf.js din√°micamente si no existe (usando unpkg que est√° permitido en CSP)
            if (!window.html2pdf) {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
                script.onload = () => generatePDF();
                script.onerror = () => {
                    alert("Error cargando la librer√≠a PDF. Revisa la consola.");
                    setDownloadingPDF(false);
                };
                document.head.appendChild(script);
            } else {
                generatePDF();
            }
        } catch (error) {
            console.error(error);
            alert("No se pudo descargar el PDF. Revisa la consola.");
            setDownloadingPDF(false);
        }
    };

    const generatePDF = () => {
        const element = reportRef.current;
        if (!element) {
            setDownloadingPDF(false);
            return;
        }

        const opt = {
            margin: [10, 10, 10, 10],
            filename: `Informe_${data.nombre.replace(/\s+/g, '_')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                logging: false,
                letterRendering: true
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        window.html2pdf().set(opt).from(element).save().then(() => {
            setDownloadingPDF(false);
        }).catch((error) => {
            console.error(error);
            alert("Error generando PDF. Revisa la consola.");
            setDownloadingPDF(false);
        });
    };

    const getLevelColor = (nivel) => {
        const n = String(nivel).toLowerCase();
        if (n.includes('avanzado') || n.includes('experto') || n.includes('alto') || n.includes('nativo')) return 'bg-slate-900 text-white border-slate-900';
        if (n.includes('intermedio') || n.includes('medio') || n.includes('s√≥lido')) return 'bg-slate-100 text-slate-800 border-slate-300';
        return 'bg-white text-slate-500 border-slate-200';
    };

    return (
        <div className="flex flex-col min-h-screen w-full bg-slate-900">
            
            {/* --- BARRA SUPERIOR FIJA --- */}
            <div className="flex justify-between items-center px-8 py-4 bg-slate-800 border-b border-slate-700 shadow-md sticky top-0 z-50">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors group">
                        <ArrowRight className="rotate-180 group-hover:-translate-x-1 transition-transform" size={24} />
                    </button>
                    <div>
                        <h1 className="text-lg font-bold text-white flex items-center gap-2">
                            Vista Previa del Informe
                            <span className="text-[10px] font-normal bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded border border-blue-500/30">A4 PREVIEW</span>
                        </h1>
                        <p className="text-xs text-slate-400">Revisa el contenido antes de exportar a Word.</p>
                    </div>
                </div>
                <div className="flex gap-3">
                    <button onClick={onEdit} className="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700 rounded-lg transition-colors border border-slate-600 hover:border-slate-500">
                        ‚úèÔ∏è Seguir Editando
                    </button>
                    <button 
                        onClick={handleDownloadPDF} 
                        disabled={downloadingPDF}
                        className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded-lg shadow-lg shadow-emerald-900/20 flex items-center gap-2 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-wait"
                    >
                        {downloadingPDF ? <Loader2 className="animate-spin" size={18}/> : <FileText size={18}/>}
                        {downloadingPDF ? "Generando..." : "Descargar PDF"}
                    </button>
                    <button 
                        onClick={handleDownload} 
                        disabled={downloading}
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg shadow-lg shadow-blue-900/20 flex items-center gap-2 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-wait"
                    >
                        {downloading ? <Loader2 className="animate-spin" size={18}/> : <Download size={18}/>}
                        {downloading ? "Generando..." : "Descargar Word"}
                    </button>
                </div>
            </div>

            {/* --- CONTENEDOR PAPEL (SCROLLABLE) --- */}
            <div className="flex-1 overflow-y-auto overflow-x-hidden py-8 px-4 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 flex justify-center">
                
                {/* HOJA A4 DIGITAL (TAMA√ëO ESCALADO) */}
                <div ref={reportRef} className="bg-white text-slate-900 w-full max-w-[850px] shadow-2xl mx-auto mb-8 flex flex-col rounded-lg overflow-hidden">
                    
                    {/* ENCABEZADO ELEGANTE */}
                    <header className="px-10 sm:px-12 pt-10 sm:pt-12 pb-6 sm:pb-8 border-b-4 border-slate-900 mb-6 sm:mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 bg-slate-50">
                        <div className="flex-1">
                            <h1 className="text-3xl sm:text-4xl font-black text-slate-900 uppercase tracking-tighter leading-none mb-2">
                                {data.nombre}
                            </h1>
                            <p className="text-base sm:text-lg text-slate-600 font-medium">{data.puesto}</p>
                        </div>
                        <div className="text-right">
                            <span className="inline-block bg-slate-900 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-2">
                                Informe Confidencial
                            </span>
                            <p className="text-xs text-slate-400 font-medium whitespace-nowrap">
                                {new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>
                    </header>

                    {/* CUERPO DEL DOCUMENTO */}
                    <div className="px-10 sm:px-12 pb-10 sm:pb-12 space-y-6 sm:space-y-10 flex-1">

                        {/* 1. RESUMEN EJECUTIVO */}
                        <section>
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-3 flex items-center gap-2">
                                <span className="w-4 h-0.5 bg-slate-400"></span> Resumen Ejecutivo
                            </h3>
                            <p className="text-sm leading-7 text-slate-800 text-justify font-normal whitespace-pre-line border-l-2 border-slate-200 pl-4">
                                {data.resumen_ejecutivo || data.resumen_profesional || "Sin resumen disponible."}
                            </p>
                        </section>

                        {/* 2. FICHA T√âCNICA (GRID LIMPIO) */}
                        <section className="bg-slate-50 rounded-xl p-4 sm:p-6 border border-slate-100">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-4">Ficha T√©cnica</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-y-4 sm:gap-y-6 gap-x-8 sm:gap-x-12">
                                <div>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Ubicaci√≥n</span>
                                    <span className="text-sm font-bold text-slate-900 block">{data.ficha_tecnica?.ubicacion || "-"}</span>
                                </div>
                                <div>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nivel de Ingl√©s</span>
                                    <span className="text-sm font-bold text-slate-900 block">{data.ficha_tecnica?.nivel_ingles || "-"}</span>
                                </div>
                                <div>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Experiencia / Seniority</span>
                                    <span className="text-sm font-bold text-slate-900 block">{data.ficha_tecnica?.nivel_experiencia || "-"}</span>
                                </div>
                                <div>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Disponibilidad</span>
                                    <span className="text-sm font-bold text-slate-900 block">{data.ficha_tecnica?.disponibilidad || "-"}</span>
                                </div>
                            </div>
                        </section>

                        {/* 3. COLUMNAS: T√âCNICAS Y BLANDAS */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 sm:gap-12">
                            {/* Competencias T√©cnicas */}
                            <div>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-4 border-b border-slate-200 pb-2">Competencias T√©cnicas</h3>
                                <ul className="space-y-2 sm:space-y-3">
                                    {(data.competencias_tecnicas || []).map((t, i) => (
                                        <li key={i} className="flex justify-between items-center text-sm gap-2 flex-wrap sm:flex-nowrap group">
                                            <span className="font-semibold text-slate-700">{t.competencia}</span>
                                            <span className={`text-[9px] px-2 py-0.5 rounded border uppercase font-bold tracking-wider whitespace-nowrap ${getLevelColor(t.nivel)}`}>
                                                {t.nivel}
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            </div>

                            {/* Habilidades Blandas */}
                            <div>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-4 border-b border-slate-200 pb-2">Soft Skills</h3>
                                <ul className="space-y-2 sm:space-y-3">
                                    {(data.habilidades_blandas || []).map((h, i) => (
                                        <li key={i} className="flex justify-between items-center text-sm gap-2 flex-wrap sm:flex-nowrap">
                                            <span className="font-semibold text-slate-700">{h.habilidad}</span>
                                            <span className="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 uppercase whitespace-nowrap">
                                                {h.nivel}
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>

                        {/* 4. HERRAMIENTAS (DISE√ëO COMPACTO PARA PDF) */}
                        {(data.herramientas && data.herramientas.length > 0) && (
                            <section style={{ pageBreakInside: 'avoid', breakInside: 'avoid' }}>
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-4">Stack Tecnol√≥gico</h3>
                                <div 
                                    className="flex flex-wrap gap-x-4 gap-y-2 items-center"
                                    style={{ pageBreakInside: 'avoid', breakInside: 'avoid' }}
                                >
                                    {data.herramientas.map((t, i) => (
                                        <span 
                                            key={i}
                                            className="inline-flex items-center gap-1.5 text-xs"
                                            style={{ pageBreakInside: 'avoid', breakInside: 'avoid', whiteSpace: 'nowrap' }}
                                        >
                                            <span className="font-bold text-slate-700">{t.herramienta}</span>
                                            <span className="text-slate-400">|</span>
                                            <span className="text-slate-400 font-medium text-[10px] uppercase">{t.nivel}</span>
                                        </span>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* 5. PLUS / OBSERVACIONES */}
                        <section className="bg-blue-50/50 p-4 sm:p-6 rounded-r-xl border-l-4 border-blue-600">
                            <h3 className="text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-2 flex items-center gap-2">
                                <Sparkles size={12}/> Valor Agregado
                            </h3>
                            <p className="text-sm text-blue-900 italic leading-relaxed">
                                "{data.plus || "Sin observaciones adicionales."}"
                            </p>
                        </section>

                        {/* 6. CONCLUSI√ìN FINAL */}
                        <section className="pt-4">
                            <h3 className="text-xs font-bold text-slate-900 uppercase tracking-[0.2em] mb-3">Recomendaci√≥n Final</h3>
                            <p className="text-sm text-slate-800 leading-relaxed text-justify font-medium">
                                {data.recomendacion_final || data.conclusion_final}
                            </p>
                        </section>

                    </div>

                    {/* PIE DE P√ÅGINA */}
                    <footer className="mt-auto px-10 sm:px-12 py-6 sm:py-8 bg-slate-50 border-t border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex items-center gap-2 opacity-50">
                            <div className="w-6 h-6 bg-slate-900 rounded-full"></div>
                            <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500">Global Talent Connections</span>
                        </div>
                        <div className="text-left sm:text-right">
                            <p className="text-sm font-bold text-slate-900">{data.responsable}</p>
                            <p className="text-[9px] text-slate-400 uppercase tracking-widest">Talent Acquisition Specialist</p>
                        </div>
                    </footer>

                </div>
            </div>
        </div>
    );
};

// =========================================================
// ‚ö° VISTA REPORTE (CON AUTOGUARDADO ANTI-DESASTRES)
// =========================================================
function ReportView({ candidates, onUpdate, setCurrentReport }) {
    // ESTADOS INTERNOS
    const [view, setView] = React.useState('list'); 
    const [selectedCandidate, setSelectedCandidate] = React.useState(null);
    const [editorData, setEditorData] = React.useState(null);
    const [loading, setLoading] = React.useState(false);
    const [isGenerating, setIsGenerating] = React.useState(false);
    
    // ESTADOS PARA CARGA MANUAL
    const [showManual, setShowManual] = React.useState(false);
    const [manualFile, setManualFile] = React.useState(null);
    const [manualNotes, setManualNotes] = React.useState("");

    // ‚ö° ESTADO NUEVO: Indicador de autoguardado
    const [autoSaveMsg, setAutoSaveMsg] = React.useState("");

    // ‚ö° ESTADO PARA CRONOLOG√çA
    const [selectedCandidateForHistory, setSelectedCandidateForHistory] = React.useState(null);

    // ‚ö° FUNCI√ìN PARA EXPORTAR CRONOLOG√çA A CSV
    const handleExportHistory = () => {
        if (!selectedCandidateForHistory || !selectedCandidateForHistory.history || selectedCandidateForHistory.history.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }

        const candidate = selectedCandidateForHistory;
        
        // Encabezados del CSV
        const headers = ['Nombre', 'Email', 'Puesto', 'Fecha y Hora', 'Evento', 'Detalles', 'Usuario'];
        
        // Convertir historial a filas CSV
        const rows = candidate.history.map(h => {
            const fecha = h.date ? new Date(h.date).toLocaleString('es-AR') : 'Fecha desconocida';
            return [
                candidate.nombre || 'Sin nombre',
                candidate.email || 'S/E',
                candidate.puesto || 'Sin puesto',
                fecha,
                h.event || 'Evento del sistema',
                (h.detail || 'Sin detalles adicionales.').replace(/"/g, '""'), // Escapar comillas
                h.usuario || 'Sistema'
            ];
        });
        
        // Crear contenido CSV
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        // Crear blob y descargar
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para Excel
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const safeName = (candidate.nombre || 'Candidato').replace(/[^a-zA-Z0-9 ]/g, "").replace(/\s+/g, "_");
        a.download = `Cronologia_${safeName}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    };

    // Filtrar candidatos listos (Etapa 3)
    const pipelineCandidates = candidates.filter(c => c.stage === 'stage_3');

    // ‚ö° MAGIA 1: RECUPERAR BORRADOR AL INICIAR
    React.useEffect(() => {
        const savedDraft = localStorage.getItem('report_draft_manual_notes');
        const savedEditor = localStorage.getItem('report_draft_editor_data');
        
        if (savedDraft) {
            setManualNotes(savedDraft);
            setShowManual(true); // Abrimos el panel si hab√≠a notas
            setAutoSaveMsg("Borrador de notas restaurado");
        }
        
        if (savedEditor) {
            setEditorData(JSON.parse(savedEditor));
            setView('editor'); // Vamos directo al editor si hab√≠a datos
            setAutoSaveMsg("Informe en progreso restaurado");
        }

        // Limpiar mensaje despu√©s de 3 segs
        setTimeout(() => setAutoSaveMsg(""), 3000);
    }, []);

    // ‚ö° MAGIA 2: AUTOGUARDADO DE NOTAS (Cada vez que escriben)
    React.useEffect(() => {
        if (manualNotes) {
            localStorage.setItem('report_draft_manual_notes', manualNotes);
        }
    }, [manualNotes]);

    // ‚ö° MAGIA 3: AUTOGUARDADO DEL EDITOR (Si ya gener√≥ el informe)
    React.useEffect(() => {
        if (editorData) {
            localStorage.setItem('report_draft_editor_data', JSON.stringify(editorData));
        }
    }, [editorData]);

    // ‚ö° MAGIA 4: LIMPIEZA (Funci√≥n para borrar cuando terminamos exitosamente)
    const clearDrafts = () => {
        localStorage.removeItem('report_draft_manual_notes');
        localStorage.removeItem('report_draft_editor_data');
        setManualNotes("");
        setEditorData(null);
        setManualFile(null);
        setView('list');
    };

    // --- MANEJADOR DE UPLOAD MANUAL ---
    const handleManualUpload = async () => {
        if (!manualFile && !manualNotes) return alert("Por favor adjunta un CV o escribe notas.");
        
        setIsGenerating(true);
        const formData = new FormData();
        if (manualFile) formData.append("cv", manualFile);
        formData.append("notas", manualNotes);
        formData.append("puesto", "Perfil Analizado Manualmente");
        formData.append("responsable", "Admin");

        try {
            const res = await fetch(`${API_URL}/manual-upload`, { method: 'POST', body: formData });
            if (!res.ok) throw new Error("Error en el servidor");
            
            const data = await res.json();
            
            // Al tener √©xito, guardamos el editorData (Magia 3 se activa sola) y borramos las notas crudas viejas
            setEditorData(data);
            setSelectedCandidate({ nombre: data.nombre || "Candidato Manual", puesto: data.puesto }); 
            setView('editor'); 
            
            // Opcional: Borramos el draft de notas crudas porque ya tenemos el procesado
            localStorage.removeItem('report_draft_manual_notes');

        } catch (e) {
            console.error(e);
            alert("Ocurri√≥ un error al procesar el archivo. Revisa la consola.");
        } finally {
            setIsGenerating(false);
        }
    };

    // --- ABRIR CANDIDATO DEL PIPELINE ---
    const handleOpenCandidate = async (candidate) => {
        setLoading(true);
        try {
            let initialData = candidate.informe_final_data;
            if (!initialData) {
                const res = await api.reports.generate(candidate.id);
                initialData = res;
            }
            if (!initialData) {
                initialData = {
                    nombre: candidate.nombre,
                    puesto: candidate.puesto,
                    resumen_ejecutivo: "Generando resumen...",
                    ficha_tecnica: {},
                    competencias_tecnicas: [],
                    habilidades_blandas: [],
                    herramientas: [],
                    plus: "",
                    formacion_sugerida: "",
                    conclusion_final: "",
                    responsable: "Admin"
                };
            }
            setEditorData(initialData);
            setSelectedCandidate(candidate);
            setView('editor');
        } catch (e) {
            console.error(e);
            alert("Error cargando datos del candidato.");
        } finally {
            setLoading(false);
        }
    };

    // --- GUARDAR CAMBIOS ---
    const handleSaveEditor = async () => {
        setView('preview');
    };

    // =========================================================
    // RENDER: 1. VISTA PREVIA (HOJA A4)
    // =========================================================
    if (view === 'preview') {
        return (
            <ProfessionalReport 
                data={editorData} 
                onBack={() => setView('editor')} 
                onEdit={() => setView('editor')} 
                // Pasamos la funci√≥n de limpieza al componente de reporte si descarga OK
                // (Opcional: podr√≠as limpiar ac√° si consideras que llegar al preview es "terminar")
            />
        );
    }

    // =========================================================
    // RENDER: 2. EDITOR V3 (CON TODOS LOS CAMPOS)
    // =========================================================
    if (view === 'editor') {
        return (
            <div className="max-w-7xl mx-auto h-[calc(100vh-100px)] flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-300">
                {/* Header Editor */}
                <div className="flex justify-between items-center mb-4 px-1">
                    <div>
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            Editando Informe
                            {/* ‚ö° INDICADOR VISUAL DE GUARDADO */}
                            <span className="text-[10px] font-normal text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full border border-emerald-500/20 animate-pulse">
                                Autoguardado activo
                            </span>
                        </h2>
                        <p className="text-slate-400 text-xs">Candidato: {editorData.nombre}</p>
                    </div>
                    <div className="flex gap-2">
                        {/* ‚ö° Bot√≥n de Cancelar ahora limpia el borrador expl√≠citamente */}
                        <button onClick={() => { 
                            if(confirm("¬øDescartar cambios y salir?")) clearDrafts(); 
                        }} className="px-3 py-2 text-xs text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors">
                            Descartar y Salir
                        </button>
                        
                        <button onClick={handleSaveEditor} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <Eye size={16}/> Previsualizar
                        </button>
                    </div>
                </div>

                <div className="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-hidden">
                    {/* COLUMNA IZQUIERDA: FORMULARIOS */}
                    <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-y-auto custom-scrollbar p-6 space-y-6">
                        
                        {/* 1. Resumen */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Resumen Ejecutivo</label>
                            <textarea 
                                className="w-full h-32 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.resumen_ejecutivo || editorData.resumen_profesional || ""}
                                onChange={(e) => setEditorData({...editorData, resumen_ejecutivo: e.target.value})}
                            />
                        </div>

                        {/* 2. Ficha T√©cnica */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Ficha T√©cnica</label>
                            <div className="grid grid-cols-2 gap-3">
                                <input placeholder="Ubicaci√≥n" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.ubicacion || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, ubicacion: e.target.value}})} />
                                <input placeholder="Experiencia" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.nivel_experiencia || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, nivel_experiencia: e.target.value}})} />
                                <input placeholder="Ingl√©s" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.nivel_ingles || editorData.ficha_tecnica?.idiomas || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, nivel_ingles: e.target.value}})} />
                                <input placeholder="Disponibilidad" className="bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" 
                                    value={editorData.ficha_tecnica?.disponibilidad || ""} 
                                    onChange={(e) => setEditorData({...editorData, ficha_tecnica: {...editorData.ficha_tecnica, disponibilidad: e.target.value}})} />
                            </div>
                        </div>

                        {/* 3. Competencias T√©cnicas */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Competencias T√©cnicas
                                <button onClick={() => setEditorData({...editorData, competencias_tecnicas: [...(editorData.competencias_tecnicas||[]), {competencia: "", nivel: "Alto"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.competencias_tecnicas || []).map((c, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={c.competencia} 
                                        onChange={(e) => {
                                            const newArr = [...editorData.competencias_tecnicas];
                                            newArr[i].competencia = e.target.value;
                                            setEditorData({...editorData, competencias_tecnicas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={c.nivel}
                                        onChange={(e) => {
                                            const newArr = [...editorData.competencias_tecnicas];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, competencias_tecnicas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = editorData.competencias_tecnicas.filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, competencias_tecnicas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 4. Soft Skills (NUEVO V3) */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Habilidades Blandas
                                <button onClick={() => setEditorData({...editorData, habilidades_blandas: [...(editorData.habilidades_blandas||[]), {habilidad: "", nivel: "Alto"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.habilidades_blandas || []).map((h, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={h.habilidad} 
                                        onChange={(e) => {
                                            const newArr = [...(editorData.habilidades_blandas||[])];
                                            newArr[i].habilidad = e.target.value;
                                            setEditorData({...editorData, habilidades_blandas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={h.nivel}
                                        onChange={(e) => {
                                            const newArr = [...(editorData.habilidades_blandas||[])];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, habilidades_blandas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = (editorData.habilidades_blandas||[]).filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, habilidades_blandas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 5. Herramientas (NUEVO V3) */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase flex justify-between">
                                Herramientas
                                <button onClick={() => setEditorData({...editorData, herramientas: [...(editorData.herramientas||[]), {herramienta: "", nivel: "Avanzado"}]})} className="text-emerald-400 hover:text-emerald-300">+ Agregar</button>
                            </label>
                            {(editorData.herramientas || []).map((t, i) => (
                                <div key={i} className="flex gap-2">
                                    <input className="flex-1 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={t.herramienta} 
                                        onChange={(e) => {
                                            const newArr = [...(editorData.herramientas||[])];
                                            newArr[i].herramienta = e.target.value;
                                            setEditorData({...editorData, herramientas: newArr});
                                        }} />
                                    <input className="w-24 bg-slate-950 border border-slate-800 rounded p-2 text-xs text-white" value={t.nivel}
                                        onChange={(e) => {
                                            const newArr = [...(editorData.herramientas||[])];
                                            newArr[i].nivel = e.target.value;
                                            setEditorData({...editorData, herramientas: newArr});
                                        }} />
                                    <button onClick={() => {
                                        const newArr = (editorData.herramientas||[]).filter((_, idx) => idx !== i);
                                        setEditorData({...editorData, herramientas: newArr});
                                    }} className="text-rose-500 px-2">√ó</button>
                                </div>
                            ))}
                        </div>

                        {/* 6. Plus */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Plus / Valor Agregado</label>
                            <textarea 
                                className="w-full h-20 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.plus || ""}
                                onChange={(e) => setEditorData({...editorData, plus: e.target.value})}
                            />
                        </div>

                        {/* 7. Formaci√≥n Sugerida */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Formaci√≥n Sugerida</label>
                            <textarea 
                                className="w-full h-20 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.formacion_sugerida || ""}
                                onChange={(e) => setEditorData({...editorData, formacion_sugerida: e.target.value})}
                            />
                        </div>

                        {/* 8. Recomendaci√≥n */}
                        <div className="space-y-2">
                            <label className="text-xs font-bold text-blue-400 uppercase">Recomendaci√≥n Final</label>
                            <textarea 
                                className="w-full h-24 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none"
                                value={editorData.recomendacion_final || editorData.conclusion_final || ""}
                                onChange={(e) => setEditorData({...editorData, recomendacion_final: e.target.value})}
                            />
                        </div>

                    </div>

                    {/* COLUMNA DERECHA: PREVIEW COMPACTA */}
                    <div className="bg-white rounded-xl overflow-hidden shadow-xl hidden lg:block opacity-90 pointer-events-none transform scale-[0.85] origin-top border-4 border-slate-800">
                        <div className="p-10 text-black">
                            <h1 className="text-xl font-bold">{editorData.nombre}</h1>
                            <p className="text-sm text-gray-500 mb-4">{editorData.puesto}</p>
                            <p className="text-xs text-gray-800 line-clamp-6 mb-4">{editorData.resumen_ejecutivo}</p>
                            <div className="p-4 bg-gray-100 rounded border border-gray-300 text-center text-gray-500 text-xs uppercase font-bold tracking-widest">
                                Vista Previa del Documento
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================
    // RENDER: 3. VISTA CRONOLOG√çA (MODAL)
    // =========================================================
    if (selectedCandidateForHistory) {
        return (
            <div className="max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-300">
                <div className="mb-6 flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <History size={20}/> Cronolog√≠a de Movimientos
                        </h2>
                        <p className="text-slate-400 text-sm mt-1">
                            {selectedCandidateForHistory.nombre} - {selectedCandidateForHistory.puesto || "Candidato"}
                        </p>
                    </div>
                    <div className="flex items-center gap-3">
                        {selectedCandidateForHistory.history && selectedCandidateForHistory.history.length > 0 && (
                            <button 
                                onClick={handleExportHistory}
                                className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded-lg transition-colors flex items-center gap-2"
                            >
                                <Download size={16}/> Exportar CSV
                            </button>
                        )}
                        <button 
                            onClick={() => setSelectedCandidateForHistory(null)}
                            className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold rounded-lg transition-colors"
                        >
                            Volver
                        </button>
                    </div>
                </div>

                <Card className="bg-slate-900 border-slate-800 p-8">
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <History size={16}/> Historial de Movimientos
                    </h3>
                    
                    {!selectedCandidateForHistory.history || selectedCandidateForHistory.history.length === 0 ? (
                        <div className="text-center py-10 border-2 border-dashed border-slate-800 rounded-xl">
                            <p className="text-slate-500 text-sm">No hay movimientos registrados a√∫n.</p>
                        </div>
                    ) : (
                        <div className="relative border-l-2 border-slate-800 ml-3 space-y-8 pl-8 py-2">
                            {selectedCandidateForHistory.history.map((h, idx) => (
                                <div key={idx} className="relative group">
                                    <div className="absolute -left-[39px] top-1 w-5 h-5 rounded-full bg-slate-900 border-2 border-blue-500 z-10 group-hover:scale-125 transition-transform shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                                    <div className="flex flex-col gap-1">
                                        <span className="text-[10px] font-bold text-blue-400 uppercase tracking-wider">
                                            {h.date ? new Date(h.date).toLocaleString('es-AR') : 'Fecha desconocida'}
                                        </span>
                                        <h4 className="text-white font-bold text-sm">{h.event || 'Evento del sistema'}</h4>
                                        <p className="text-xs text-slate-400 bg-slate-950/50 p-2 rounded border border-slate-800 inline-block mt-1">
                                            {h.detail || 'Sin detalles adicionales.'}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </Card>
            </div>
        );
    }

    // =========================================================
    // RENDER: 4. LISTA PIPELINE Y CARGA MANUAL (DEFAULT)
    // =========================================================
    return (
        <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500 pb-20">
            
            {/* CABECERA */}
            <div className="flex items-center justify-between border-b border-slate-800 pb-6">
                <div>
                    <h1 className="text-2xl font-bold text-white">Generar Informe Final</h1>
                    <p className="text-slate-400 text-sm">Gesti√≥n de entregables y cierre de procesos.</p>
                    {/* ‚ö° MENSAJE DE RESTAURACI√ìN SI APLICA */}
                    {autoSaveMsg && (
                        <div className="mt-2 text-xs font-bold text-emerald-400 flex items-center gap-1 animate-pulse">
                            <Clock size={12}/> {autoSaveMsg}
                        </div>
                    )}
                </div>
                <button 
                    onClick={() => setShowManual(!showManual)}
                    className={`px-4 py-2 rounded-lg text-xs font-bold transition-all border ${showManual ? 'bg-amber-500/10 border-amber-500/50 text-amber-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}
                >
                    {showManual ? "‚úï CERRAR MODO MANUAL" : "‚ö° MODO MANUAL"}
                </button>
            </div>

            {/* ZONA MANUAL (Dise√±o Gold Premium) */}
            {showManual && (
                <section className="bg-slate-900 border border-amber-500/20 rounded-2xl p-8 shadow-2xl animate-in slide-in-from-top duration-300 mb-8 relative overflow-hidden">
                    {/* Efecto de brillo de fondo */}
                    <div className="absolute top-0 right-0 w-64 h-64 bg-amber-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                        
                        {/* COLUMNA IZQUIERDA: PDF */}
                        <div className="flex flex-col gap-3">
                            <label className="text-[11px] font-bold text-amber-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                <FileText size={14}/> 1. Adjuntar Curr√≠culum (PDF)
                            </label>
                            
                            {/* ‚ö° AVISO DE ARCHIVO NO PERSISTENTE */}
                            <label className={`flex flex-col items-center justify-center w-full h-56 border-2 border-dashed rounded-xl cursor-pointer transition-all group ${manualFile ? 'border-amber-500/50 bg-amber-500/5' : 'border-slate-800 bg-slate-950 hover:bg-slate-900 hover:border-slate-700'}`}>
                                <div className="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4">
                                    <div className={`mb-3 p-3 rounded-full transition-all ${manualFile ? 'bg-amber-500 text-slate-900' : 'bg-slate-800 text-slate-500 group-hover:text-amber-500'}`}>
                                        {manualFile ? <CheckCircle size={24}/> : <Download size={24}/>}
                                    </div>
                                    <p className={`text-sm font-medium ${manualFile ? 'text-amber-400' : 'text-slate-400'}`}>
                                        {manualFile ? manualFile.name : "Click para buscar PDF o TXT"}
                                    </p>
                                    {!manualFile && <p className="text-xs text-slate-600 mt-1">Si recargas la p√°gina, deber√°s subirlo de nuevo.</p>}
                                </div>
                                <input 
                                    type="file" 
                                    className="hidden" 
                                    accept=".pdf,.txt,.doc,.docx" 
                                    onChange={(e) => setManualFile(e.target.files[0])} 
                                />
                            </label>
                        </div>

                        {/* COLUMNA DERECHA: NOTAS */}
                        <div className="flex flex-col gap-3">
                            <label className="text-[11px] font-bold text-amber-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                <Sparkles size={14}/> 2. Notas y An√°lisis (Autoguardado)
                            </label>
                            <textarea 
                                className="w-full h-56 bg-slate-950 border border-slate-800 rounded-xl p-5 text-sm text-slate-200 focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/20 focus:outline-none transition-all resize-none custom-scrollbar leading-relaxed placeholder-slate-700"
                                placeholder="Pega aqu√≠ tu evaluaci√≥n. Si se corta internet, este texto se guarda solo."
                                value={manualNotes}
                                onChange={(e) => setManualNotes(e.target.value)}
                            />
                        </div>

                        {/* BOT√ìN DE ACCI√ìN */}
                        <div className="md:col-span-2 mt-2">
                            <button 
                                className={`w-full py-4 font-black text-sm uppercase tracking-[0.15em] rounded-xl flex items-center justify-center gap-3 transition-all transform active:scale-[0.99] shadow-lg ${
                                    isGenerating 
                                    ? 'bg-slate-800 text-slate-500 cursor-wait' 
                                    : 'bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-amber-50 shadow-amber-900/20 border border-amber-500/20'
                                }`}
                                disabled={isGenerating || (!manualFile && !manualNotes)}
                                onClick={handleManualUpload}
                            >
                                {isGenerating ? (
                                    <><Loader2 className="animate-spin" size={20}/> ANALIZANDO CON GEMINI...</>
                                ) : (
                                    <><Sparkles size={20}/> GENERAR FICHA DE INFORME FINAL </>
                                )}
                            </button>
                        </div>
                    </div>
                </section>
            )}

            {/* LISTA DEL PIPELINE */}
            <section className="space-y-4 pt-4">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Candidatos en Espera ({pipelineCandidates.length})</h3>
                {pipelineCandidates.length === 0 ? (
                    <div className="p-8 border border-slate-800 border-dashed rounded-xl text-center text-slate-600 text-sm">
                        No hay candidatos pendientes en esta etapa.
                    </div>
                ) : (
                    <div className="grid gap-3">
                        {pipelineCandidates.map(c => (
                            <div key={c.id} className="p-4 bg-slate-900 border border-slate-800 rounded-xl flex items-center justify-between hover:bg-slate-800/50 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">
                                        {c.nombre.substring(0,2).toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-bold text-white group-hover:text-blue-400 transition-colors">{c.nombre}</h4>
                                        <p className="text-[10px] text-slate-500">{c.puesto || "Candidato"}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => setSelectedCandidateForHistory(c)}
                                        className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-2"
                                    >
                                        <History size={14}/> Ver Cronolog√≠a
                                    </button>
                                    {c.informe_final_data ? (
                                        <button 
                                            onClick={() => handleOpenCandidate(c)}
                                            className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-2"
                                        >
                                            <Eye size={14}/> Ver Informe
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={() => handleOpenCandidate(c)}
                                            className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-2"
                                        >
                                            <FileText size={14}/> Generar Informe
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </section>
        </div>
    );
}
// --- VISTA DETALLE MEJORADA (CON GESTI√ìN DE ENTREVISTA + CHECKLIST) ---
function CandidateDetail({ candidate, onBack, onUpdate, currentUser }) {
    const [noteInput, setNoteInput] = useState(candidate.notes || "");
    const [isEditing, setIsEditing] = useState(false);
    const [newCvLink, setNewCvLink] = useState(candidate.cv_url || "");
    const [newVideoLink, setNewVideoLink] = useState(candidate.video_url || "");
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [activeSubTab, setActiveSubTab] = useState('gestion');

    // ESTADOS PARA EL MODAL DE DESCARTE (TU C√ìDIGO ORIGINAL)
    const [showDiscardModal, setShowDiscardModal] = useState(false);
    const [discardReason, setDiscardReason] = useState("");

    // --- NUEVOS ESTADOS: GESTI√ìN DE ENTREVISTA (STAGE 2) ---
    const [meetLink, setMeetLink] = useState(candidate.meet_link || "");
    const [transcript, setTranscript] = useState(candidate.interview_transcript || "");
    const [form2Status, setForm2Status] = useState(candidate.process_step_2_form || "pending"); // pending, sent, received
    const [finalResult, setFinalResult] = useState(candidate.process_step_3_result || null); // qualified, disqualified

    // üî• SINCRONIZAR ESTADOS CUANDO CANDIDATE CAMBIA (para que persistan despu√©s de F5)
    React.useEffect(() => {
        if (candidate.meet_link) {
            setMeetLink(candidate.meet_link);
        }
        // Solo actualizar transcript si NO est√° analizada (para no sobrescribir el estado "ANALIZADA")
        if (candidate.interview_transcript && !candidate.transcripcion_entrevista) {
            setTranscript(candidate.interview_transcript);
        }
        // Sincronizar estado del formulario 2 (cuando el webhook actualiza desde el backend)
        if (candidate.process_step_2_form) {
            setForm2Status(candidate.process_step_2_form);
        }
        // Sincronizar resultado final si existe
        if (candidate.process_step_3_result) {
            setFinalResult(candidate.process_step_3_result);
        }
    }, [candidate.meet_link, candidate.interview_transcript, candidate.transcripcion_entrevista, candidate.process_step_2_form, candidate.process_step_3_result]);

    // Recuperar alertas y skills
    const flags = candidate.ia_alertas || candidate.alerts || [];
    const hardSkills = candidate.respuestas_filtro?.herramientas 
        ? (Array.isArray(candidate.respuestas_filtro.herramientas) 
            ? candidate.respuestas_filtro.herramientas 
            : candidate.respuestas_filtro.herramientas.split(',').map(s => s.trim()))
        : ['Sin datos t√©cnicos'];

    // --- ACCIONES EXISTENTES ---
    const saveLinks = () => {
        onUpdate(candidate.id, { cv_url: newCvLink, video_url: newVideoLink });
        setIsEditing(false);
    };

    const handleApprove = () => {
        onUpdate(candidate.id, { 
            stage: 'stage_2', 
            status_interno: 'interview_pending',
            assignedTo: currentUser 
        });
    };
    // --- 6. FUNCI√ìN DE RE-AN√ÅLISIS (CONECTADA AL BACKEND) ---
    const handleAnalyzeInterview = async () => {
        // Validaci√≥n b√°sica
        if (!transcript || transcript.length < 10) {
            return alert("‚ö†Ô∏è Por favor, escribe o pega notas de la entrevista antes de analizar.");
        }
        
        setIsAnalyzing(true); // Activa el loader
        try {
            // DEBUG
            console.log("DEBUG - ID Candidato:", candidate.id);
            const targetURL = `${API_URL}/candidatos/${candidate.id}/analizar-entrevista`;
            console.log("DEBUG - URL Objetivo:", targetURL);
            // Llamamos al endpoint "Cerebro" que creamos en el backend
            const res = await fetch(`${API_URL}/candidatos/${candidate.id}/analizar-entrevista`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transcript })
            });
            
            if (!res.ok) throw new Error("Error en la conexi√≥n con la IA");
            
            const data = await res.json();
            
            // Actualizamos la vista visualmente al instante
            // El backend ya guarda la transcripci√≥n en transcripcion_entrevista
            onUpdate(candidate.id, { 
                ia_score: data.score, 
                ia_motivos: data.motivos,
                ia_alertas: data.alertas,
                transcripcion_entrevista: transcript // Guardar tambi√©n en el frontend para que se muestre como "ANALIZADA"
            });
            
            alert(`‚úÖ An√°lisis completado.\nNuevo Score: ${data.score}/100`);
            
        } catch (error) {
            console.error(error);
            alert("‚ùå Ocurri√≥ un error al analizar la entrevista. Revisa la consola.");
        } finally {
            setIsAnalyzing(false); // Desactiva el loader
        }
    };

    const confirmDiscard = () => {
        if (!discardReason.trim()) return alert("Por favor escribe un motivo.");
        onUpdate(candidate.id, { 
            stage: 'trash', 
            motivo: discardReason, 
            notes: discardReason   
        });
        setShowDiscardModal(false);
    };

    // --- NUEVAS ACCIONES (STAGE 2) ---
    
    // 1. Guardar Link Meet (al salir del campo)
    const saveMeetLink = () => {
        const linkToSave = meetLink || candidate.meet_link;
        if (linkToSave && linkToSave !== candidate.meet_link) {
            onUpdate(candidate.id, { meet_link: linkToSave });
        }
    };

    // 2. Guardar Transcripci√≥n (misma l√≥gica que saveLinks)
    const saveTranscript = () => {
        onUpdate(candidate.id, { interview_transcript: transcript });
    };

// ==========================================
   // üìß FUNCIONES DE CORREO (FORZANDO GMAIL WEB)
   // ==========================================


  // 1. ABRIR GMAIL PARA LA ENTREVISTA (MEET)
  const handleOpenMail = () => {
    // Usar el link guardado o el del estado local
    const linkToUse = candidate.meet_link || meetLink;
    if (!linkToUse) return alert("‚ö†Ô∏è Primero pega el link de la reuni√≥n en el campo de texto para incluirlo en el correo.");
    
    const recipient = candidate.email;
    // Asunto Din√°mico
    const subject = encodeURIComponent(`¬°Confirmaci√≥n de Entrevista! ‚Äì Posici√≥n: ${candidate.puesto} üöÄ`);
    
    // Cuerpo del mensaje con Variables Din√°micas y Formato de Texto
    const body = encodeURIComponent(
`Hola, ${candidate.nombre}:


Espero que est√©s teniendo un excelente d√≠a.
Nos complace informarte que hemos revisado tu perfil y nos encantar√≠a conocerte mejor. Por ello, te confirmamos los detalles para tu entrevista con nuestro equipo de selecci√≥n:


üìç Link de conexi√≥n (Google Meet): ${linkToUse}
üìÖ Fecha y Hora: [Insertar Fecha y Hora]


RECOMENDACIONES PARA TU ENTREVISTA:
- Aseg√∫rate de contar con una conexi√≥n estable a internet.
- Te sugerimos conectarte unos minutos antes desde un lugar tranquilo y sin ruido ambiente.
- ¬°S√© t√∫ mismo! Queremos conocer tu potencial y experiencia de cerca.


Por favor, conf√≠rmanos tu asistencia aceptando el meet. Si llegaras a tener alg√∫n inconveniente con el horario, av√≠sanos con antelaci√≥n para intentar reprogramar.


¬°Estamos ansiosos por conversar contigo!


Saludos,
${currentUser || 'Equipo de Selecci√≥n'}
Equipo de Selecci√≥n | Global Talent Connections`
    );
    
    // Abrir Gmail en pesta√±a nueva
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`;
    window.open(gmailUrl, '_blank');
};



// 2. ABRIR GMAIL PARA EL FORMULARIO 2 (Evaluaci√≥n T√©cnica)
const handleSendForm2 = () => {
    // Guardar estado "sent" en la BD (misma l√≥gica que updateChecklist pero directo)
    setForm2Status('sent');
    onUpdate(candidate.id, { process_step_2_form: 'sent', usuario_accion: currentUser });
   
    const recipient = candidate.email;
    const subject = encodeURIComponent(`Pr√≥ximos pasos: Evaluaci√≥n de Competencias ‚Äì Global Talent Connections`);
   
    // Cuerpo del mensaje con el Link de Zoho Fijo y Formato de Lista
    const body = encodeURIComponent(
`Hola, ${candidate.nombre}:


Fue un gusto conversar contigo en la entrevista previa.
Para continuar con tu proceso de selecci√≥n, el siguiente paso es completar una breve validaci√≥n de competencias t√©cnicas y conductuales. Esto nos permitir√° conocer m√°s a fondo tu perfil y alinearlo con los requerimientos de la posici√≥n.


üìç Puedes acceder al formulario aqu√≠:
üëâ https://forms.zohopublic.eu/globaltalentconnection1/form/ValidacionAsistentes/formperma/g9ttDk7Jj0cHyTgIRH_CdUcD7I5kHhTWL9XCpKWOeB0


CONSIDERACIONES IMPORTANTES:
- El formulario incluye preguntas sobre tu experiencia, compromiso, herramientas y autogesti√≥n.
- Te recomendamos completarlo con sinceridad y detalle.
- Una vez enviado, nuestro equipo revisar√° tus respuestas para notificarte la siguiente etapa.


Agradecemos tu tiempo y dedicaci√≥n en este proceso. Quedamos atentos a tus respuestas para seguir avanzando.


Saludos cordiales,
${currentUser || 'Equipo de Selecci√≥n'}
Equipo de Selecci√≥n | Global Talent Connections`
    );
   
    // Abrimos Gmail Web en pesta√±a nueva
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`;
    window.open(gmailUrl, '_blank');
};



    // 4. Actualizar Checklist
    const updateChecklist = (field, value) => {
        if (field === 'form2') setForm2Status(value);
        if (field === 'result') setFinalResult(value);
        
        const payload = {};
        if (field === 'form2') payload.process_step_2_form = value;
        if (field === 'result') payload.process_step_3_result = value;
        onUpdate(candidate.id, payload);
    };

    // 5. Pasar a Informe (Solo si cumple requisitos)
    const handleMoveToReport = () => {
        if (!meetLink || form2Status !== 'received' || finalResult !== 'qualified') {
            return alert("‚ö†Ô∏è Para avanzar, debes completar: Link de Meet, Formulario Recibido y Calificaci√≥n Positiva.");
        }
        onUpdate(candidate.id, { 
            stage: 'stage_3', 
            status_interno: 'ready_for_report'
        });
    };

    // Validaci√≥n visual para habilitar bot√≥n
    const isStage2Complete = meetLink && form2Status === 'received' && finalResult === 'qualified';

    return (
        <div className="flex flex-col h-full animate-in slide-in-from-right duration-300 pb-10 max-w-7xl mx-auto px-4 relative">
            
            {/* --- MODAL DE DESCARTE (INTACTO) --- */}
            {showDiscardModal && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-900 border border-rose-900/50 rounded-2xl p-6 max-w-md w-full shadow-2xl relative">
                        <button onClick={() => setShowDiscardModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
                        
                        <div className="flex items-center gap-3 mb-4 text-rose-500">
                            <Trash2 size={24} />
                            <h3 className="text-xl font-bold text-white">Descartar Candidato</h3>
                        </div>
                        
                        <p className="text-slate-400 text-sm mb-4">
                            Est√°s a punto de mover a <strong className="text-white">{candidate.nombre}</strong> a la papelera. 
                            Por favor, indica el motivo para futuras referencias.
                        </p>

                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Motivo del descarte</label>
                        <textarea 
                            className="w-full h-24 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-white focus:border-rose-500 focus:outline-none resize-none mb-6"
                            placeholder="Ej: Salario fuera de rango, no tiene ingl√©s..."
                            value={discardReason}
                            onChange={(e) => setDiscardReason(e.target.value)}
                            autoFocus
                        ></textarea>

                        <div className="flex justify-end gap-3">
                            <button onClick={() => setShowDiscardModal(false)} className="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white">Cancelar</button>
                            <button onClick={confirmDiscard} className="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white text-sm font-bold rounded-lg shadow-lg shadow-rose-900/20">
                                Confirmar Descarte
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- HEADER --- */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors">
                        <ArrowRight className="rotate-180" size={24} />
                    </button>
                    <div>
                        <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                            {candidate.nombre}
                            {candidate.assignedTo && (
                                <span className="text-[10px] bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded border border-purple-500/30 uppercase">
                                    Resp: {candidate.assignedTo}
                                </span>
                            )}
                        </h1>
                        <p className="text-sm text-slate-400">{candidate.puesto}</p>
                    </div>
                </div>

                <div className="flex flex-col md:flex-row gap-4 md:items-center">
                    {/* SWITCH DE PESTA√ëAS */}
                    <div className="bg-slate-900 p-1 rounded-lg border border-slate-800 flex self-start">
                        <button 
                            onClick={() => setActiveSubTab('gestion')}
                            className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${activeSubTab === 'gestion' ? 'bg-slate-800 text-white shadow-sm border border-slate-700' : 'text-slate-500 hover:text-slate-300'}`}
                        >
                            Gesti√≥n
                        </button>
                        <button 
                            onClick={() => setActiveSubTab('history')}
                            className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${activeSubTab === 'history' ? 'bg-slate-800 text-white shadow-sm border border-slate-700' : 'text-slate-500 hover:text-slate-300'}`}
                        >
                            Cronolog√≠a
                        </button>
                    </div>

                    <div className="flex items-center gap-2">
                        <button onClick={() => setShowDiscardModal(true)} 
                                className="px-4 py-2 rounded-lg border border-rose-900/50 text-rose-400 hover:bg-rose-900/20 text-sm font-medium transition-colors">
                            Descartar
                        </button>
                        
                        {/* L√ìGICA DE BOT√ìN PRINCIPAL SEG√öN ETAPA */}
                        {candidate.stage === 'stage_1' ? (
                            <button onClick={handleApprove} 
                                    className="px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold transition-all shadow-lg active:scale-95">
                                Aprobar
                            </button>
                        ) : (
                            <button onClick={handleMoveToReport} 
                                    disabled={!isStage2Complete}
                                    className={`px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2 ${isStage2Complete ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-slate-800 text-slate-500 cursor-not-allowed border border-slate-700'}`}>
                                {isStage2Complete ? <><FileJson size={16}/> Pasar a Informe</> : <><Lock size={16}/> Completar Checklist</>}
                            </button>
                        )}
                    </div>
                </div>
            </div>

            {/* --- CUERPO PRINCIPAL --- */}
            {activeSubTab === 'gestion' ? (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-in fade-in duration-300">
                    {/* COLUMNA IZQUIERDA (INTACTA) */}
                    <div className="lg:col-span-4 space-y-6">
                        <Card className="p-6 bg-slate-900 border-slate-800">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-sm font-bold text-slate-400 uppercase tracking-wider">IA Match</span>
                                <div className={`px-3 py-1 rounded-full border ${ (candidate.ia_score || 0) >= 70 ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-rose-500/10 border-rose-500/20 text-rose-400' }`}>
                                    <span className="text-3xl font-bold">{candidate.ia_score || 0}</span>
                                    <span className="text-xs opacity-70">/100</span>
                                </div>
                            </div>
                            <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div className={`h-full rounded-full ${ (candidate.ia_score || 0) >= 70 ? 'bg-emerald-500' : 'bg-rose-500' }`} style={{ width: `${candidate.ia_score || 5}%` }}></div>
                            </div>
                            {flags.length > 0 && (
                                <div className="mt-6 pt-4 border-t border-slate-800">
                                    <p className="text-[10px] font-bold text-rose-500 uppercase mb-2 flex items-center gap-1"><AlertTriangle size={12}/> Alertas</p>
                                    <div className="flex flex-wrap gap-2">
                                        {flags.map((flag, i) => <span key={i} className="px-2 py-1 bg-rose-500/10 text-rose-400 border border-rose-500/20 text-[10px] font-bold rounded uppercase">{flag}</span>)}
                                    </div>
                                </div>
                            )}
                        </Card>

                        <Card className="p-6 bg-slate-900 border-slate-800">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Material</h3>
                                <button onClick={() => setIsEditing(!isEditing)} className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                    {isEditing ? '‚úï Cancelar' : '‚úèÔ∏è Editar Links'}
                                </button>
                            </div>
                            <div className="space-y-3">
                                {isEditing && (
                                    <div className="p-3 bg-slate-950 rounded-lg border border-blue-500/30 mb-2 animate-in fade-in space-y-3">
                                        <div>
                                            <label className="text-[10px] text-blue-400 font-bold uppercase mb-1 block">Link CV (PDF):</label>
                                            <input type="text" value={newCvLink} onChange={(e) => setNewCvLink(e.target.value)} placeholder="https://..." className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-purple-400 font-bold uppercase mb-1 block">Link Video:</label>
                                            <input type="text" value={newVideoLink} onChange={(e) => setNewVideoLink(e.target.value)} placeholder="https://..." className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-purple-500" />
                                        </div>
                                        <button onClick={saveLinks} className="w-full bg-emerald-600 text-white py-1.5 rounded text-xs font-bold hover:bg-emerald-500">üíæ GUARDAR CAMBIOS</button>
                                    </div>
                                )}
                                <a href={candidate.cv_url} target="_blank" className="flex items-center gap-4 p-4 rounded-xl border border-slate-800 bg-slate-950 hover:border-blue-500/50 hover:bg-slate-900 transition-all group cursor-pointer">
                                    <div className="w-10 h-10 rounded-full bg-blue-600/20 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform"><FileText size={20}/></div>
                                    <div><h4 className="text-sm font-bold text-white">Curriculum Vitae</h4><p className="text-xs text-blue-400 group-hover:underline">{candidate.cv_url && candidate.cv_url.length > 5 ? "Ver Documento" : "Link no disponible"}</p></div>
                                </a>
                                <a href={candidate.video_url && candidate.video_url.startsWith('http') ? candidate.video_url : "#"} target="_blank" className={`flex items-center gap-4 p-4 rounded-xl border border-slate-800 bg-slate-950 transition-all group ${!candidate.video_url || !candidate.video_url.startsWith('http') ? 'opacity-50 cursor-not-allowed' : 'hover:border-purple-500/50 hover:bg-slate-900 cursor-pointer'}`}>
                                    <div className="w-10 h-10 rounded-full bg-purple-600/20 flex items-center justify-center text-purple-500 group-hover:scale-110 transition-transform"><Video size={20}/></div>
                                    <div>
                                        <h4 className="text-sm font-bold text-white">Video Presentaci√≥n</h4>
                                        <p className="text-xs text-purple-400 group-hover:underline">
                                            {!candidate.video_url ? 'No disponible' : 
                                             candidate.video_url.startsWith('http') ? 'Abrir Link Externo' : 
                                             candidate.video_tipo === 'archivo' ? 'Video subido (ver en Zoho)' : 
                                             'Link no v√°lido'}
                                        </p>
                                    </div>
                                </a>
                            </div>
                        </Card>
                    </div>

                    {/* COLUMNA DERECHA */}
                    <div className="lg:col-span-8 space-y-6">
                        <Card className="p-8 bg-slate-900 border-slate-800 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                            <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2 relative z-10"><Sparkles className="text-blue-400" size={20} /> An√°lisis del Perfil</h2>
                            <div className="bg-slate-950/50 rounded-xl p-6 border border-slate-800 mb-6 relative z-10">
                                <p className="text-sm text-slate-300 leading-relaxed">{candidate.ia_motivos || candidate.motivo || "An√°lisis pendiente..."}</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                                <div>
                                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2">Datos Clave</h3>
                                    <ul className="space-y-3">
                                        <li className="flex justify-between text-xs"><span className="text-slate-400">Salario:</span><span className={candidate.respuestas_filtro?.salario === 'S√≠' ? "text-emerald-400" : "text-white"}>{candidate.respuestas_filtro?.salario || "N/A"}</span></li>
                                        <li className="flex justify-between text-xs"><span className="text-slate-400">Monitoreo:</span><span className={candidate.respuestas_filtro?.monitoreo === 'S√≠' ? "text-emerald-400" : "text-white"}>{candidate.respuestas_filtro?.monitoreo || "N/A"}</span></li>
                                        <li className="flex justify-between text-xs"><span className="text-slate-400">Disponibilidad:</span><span className="text-white">{candidate.respuestas_filtro?.disponibilidad || "N/A"}</span></li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2">Skills</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {hardSkills.map((skill, i) => <span key={i} className="px-3 py-1 bg-slate-800 text-slate-300 text-[11px] rounded border border-slate-700">{skill}</span>)}
                                    </div>
                                </div>
                            </div>
                        </Card>

                        {/* üî• SECCI√ìN DE RESE√ëAS (CV Y VIDEO) üî• */}
                        {(candidate.rese√±a_cv || candidate.rese√±a_video) && (
                            <Card className="p-6 bg-slate-900 border-slate-800">
                                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                    <FileText className="text-cyan-400" size={18} /> Rese√±as Generadas por IA
                                </h2>
                                <div className="space-y-4">
                                    {candidate.rese√±a_cv && (
                                        <div className="bg-slate-950/50 rounded-lg p-4 border border-slate-800">
                                            <h3 className="text-xs font-bold text-cyan-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                                                <FileText size={14} /> Rese√±a del CV
                                            </h3>
                                            <p className="text-sm text-slate-300 leading-relaxed">{candidate.rese√±a_cv}</p>
                                        </div>
                                    )}
                                    {candidate.rese√±a_video && (
                                        <div className="bg-slate-950/50 rounded-lg p-4 border border-slate-800">
                                            <h3 className="text-xs font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                                                <Video size={14} /> Rese√±a del Video de Presentaci√≥n
                                            </h3>
                                            <p className="text-sm text-slate-300 leading-relaxed">{candidate.rese√±a_video}</p>
                                        </div>
                                    )}
                                    {candidate.video_error && (
                                        <div className="bg-amber-900/20 rounded-lg p-4 border border-amber-500/30">
                                            <h3 className="text-xs font-bold text-amber-400 uppercase tracking-widest mb-2">
                                                ‚ö†Ô∏è Alerta de Video
                                            </h3>
                                            <p className="text-sm text-amber-300">{candidate.video_error}</p>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        )}

                        {/* üî• SECCI√ìN DE GESTI√ìN (SOLO SI EST√Å EN ETAPA 2) üî• */}
                        {candidate.stage === 'stage_2' && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                                
                                {/* 1. AGENDAR Y TRANSCRIPCI√ìN */}
                                <div className="bg-slate-950 border border-blue-900/30 rounded-xl p-6 shadow-xl">
                                    <h3 className="text-sm font-bold text-blue-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <Calendar size={16}/> 1. Gesti√≥n de Entrevista
                                    </h3>
                                    
{/* BLOQUE NUEVO: BOTONES SEPARADOS (REGISTRAR + ENVIAR) */}
<div className="grid grid-cols-1 gap-4 mb-6">
   <label className="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Link de Meet / Zoom</label>
   <div className="flex gap-2 w-full">
       {/* INPUT */}
       <div className="relative flex-1">
           <Video className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-600" size={16}/>
           <input
               type="text"
               placeholder="Pegar link de reuni√≥n aqu√≠..."
               className={`w-full pl-10 pr-4 py-2.5 bg-slate-900 border rounded-lg text-sm text-white focus:outline-none transition-all placeholder-slate-600 ${candidate.meet_link ? 'border-emerald-500/50 text-emerald-400' : 'border-slate-700 focus:border-blue-500'}`}
               value={candidate.meet_link || meetLink}
               onChange={(e) => setMeetLink(e.target.value)}
               onBlur={saveMeetLink}
           />
       </div>
      
       {/* BOT√ìN 1: REGISTRAR (DISKETTE) */}
       <button
           onClick={saveMeetLink}
           className={`px-4 rounded-lg border transition-all flex items-center justify-center gap-2 font-bold text-xs ${candidate.meet_link ? 'bg-emerald-900/20 border-emerald-500/50 text-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700 hover:text-white'}`}
           title="Guardar link en la base de datos"
       >
           {candidate.meet_link ? <><CheckCircle size={14}/> GUARDADO</> : <><Save size={14}/> REGISTRAR</>}
       </button>


       {/* BOT√ìN 2: ENVIAR MAIL (SOBRE) */}
       <button
           onClick={handleOpenMail}
           disabled={!candidate.meet_link && !meetLink}
           className={`px-4 rounded-lg border transition-all flex items-center justify-center gap-2 font-bold text-xs ${!candidate.meet_link && !meetLink ? 'bg-slate-900 border-slate-800 text-slate-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-500 text-white border-blue-500 shadow-lg'}`}
           title="Abrir correo con invitaci√≥n"
       >
           <Mail size={14}/> ENVIAR MAIL
       </button>
   </div>
</div>


                                   {/* BLOQUE MEJORADO: TRANSCRIPCI√ìN + IA */}
                                   <div className="border-t border-slate-800 pt-4 mt-4">
                                       <div className="flex justify-between items-end mb-2">
                                           <label className="text-[10px] text-slate-500 font-bold uppercase flex items-center gap-2">
                                               <MessageSquare size={12}/> Transcripci√≥n / Notas
                                           </label>
                                           
                                           {/* BOT√ìN M√ÅGICO DE AN√ÅLISIS - Solo mostrar si NO est√° analizada */}
                                           {!candidate.transcripcion_entrevista && (
                                               <button
                                                   onClick={handleAnalyzeInterview}
                                                   disabled={isAnalyzing || !transcript}
                                                   className="text-[10px] bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded border border-purple-400 flex items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-purple-900/20"
                                               >
                                                   {isAnalyzing ? <Loader2 size={12} className="animate-spin"/> : <Sparkles size={12}/>}
                                                   {isAnalyzing ? "Analizando..." : "ANALIZAR ENTREVISTA"}
                                               </button>
                                           )}
                                       </div>
                                       
                                       {/* Si ya est√° analizada, mostrar mensaje fijo */}
                                       {candidate.transcripcion_entrevista ? (
                                           <div className="w-full h-32 bg-emerald-900/20 border border-emerald-500/50 rounded-lg p-4 flex items-center justify-center">
                                               <div className="text-center">
                                                   <div className="text-emerald-400 text-sm font-bold mb-1 flex items-center justify-center gap-2">
                                                       <CheckCircle size={16}/> TRANSCRIPCI√ìN ANALIZADA
                                                   </div>
                                                   <p className="text-xs text-emerald-300/70">La transcripci√≥n fue procesada y el score fue actualizado.</p>
                                               </div>
                                           </div>
                                       ) : (
                                           <textarea
                                               className="w-full h-32 bg-slate-900 border border-slate-800 rounded-lg p-4 text-sm text-slate-300 focus:border-purple-500 outline-none resize-none placeholder-slate-600 leading-relaxed custom-scrollbar"
                                               placeholder="Pega aqu√≠ la transcripci√≥n o toma notas. Luego presiona 'Analizar' para actualizar el Score."
                                               value={transcript}
                                               onChange={(e) => setTranscript(e.target.value)}
                                               onBlur={saveTranscript}
                                           ></textarea>
                                       )}
                                   </div>
                               </div>


                               {/* 2. CHECKLIST DE AVANCE (VALIDADOR) */}
                               {/* 2. SEM√ÅFORO FORMULARIO 2 + DECISI√ìN */}
                               <div className="bg-slate-950 border border-slate-800 rounded-xl p-6 shadow-xl relative overflow-hidden">
                                   {/* Decoraci√≥n lateral seg√∫n estado */}
                                   <div className={`absolute top-0 left-0 w-1 h-full transition-colors duration-500 ${
                                       form2Status === 'received' ? 'bg-emerald-500' :
                                       form2Status === 'sent' ? 'bg-amber-500' : 'bg-slate-700'
                                   }`}></div>


                                   <h3 className="text-sm font-bold text-slate-300 uppercase tracking-widest mb-6 flex items-center gap-2">
                                       <FileJson size={16}/> 2. Formulario de Validaci√≥n
                                   </h3>
                                  
                                   <div className="space-y-8">
                                       {/* SEM√ÅFORO DE ESTADOS */}
                                       <div>
                                           <label className="text-[10px] text-slate-500 font-bold uppercase mb-3 block">Estado del Env√≠o</label>
                                           <div className="grid grid-cols-3 gap-2 bg-slate-900 p-1 rounded-lg border border-slate-800">
                                              
                                               {/* 1. PENDIENTE (GRIS) - SOLO VISUAL */}
<div
   className={`py-2 px-3 rounded-md text-[10px] font-bold uppercase text-center ${
       form2Status === 'pending'
       ? 'bg-slate-700 text-white shadow-sm'
       : 'text-slate-600'
   }`}
>
   ‚ö™ Pendiente
</div>


                                               {/* 2. ENVIADO (AMARILLO) - CON ACCI√ìN DE MAIL */}
                                               <button
                                                   onClick={handleSendForm2}
                                                   className={`py-2 rounded-md text-[10px] font-bold uppercase transition-all flex items-center justify-center gap-2 ${
                                                       form2Status === 'sent'
                                                       ? 'bg-amber-500/20 text-amber-400 border border-amber-500/50 shadow-md'
                                                       : 'text-slate-500 hover:text-amber-400'
                                                   }`}
                                               >
                                                   {form2Status === 'sent' ? <Mail size={12}/> : <Send size={12}/>}
                                                   {form2Status === 'sent' ? 'Enviado' : 'Enviar Mail'}
                                               </button>


                                               {/* 3. RECIBIDO (VERDE) */}
                                               {/* 3. RECIBIDO (VERDE) - MODO SOLO LECTURA üîí */}
<button
   disabled={true}
   className={`py-2 rounded-md text-[10px] font-bold uppercase transition-all flex items-center justify-center gap-2 cursor-default ${
       form2Status === 'received'
       ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 shadow-md'
       : 'bg-slate-900 border-slate-800 text-slate-600 opacity-50'
   }`}
>
   {form2Status === 'received' ? <CheckCircle size={12}/> : <div className="w-3 h-3 rounded-full border border-slate-600"></div>}
   {form2Status === 'received' ? 'CONFIRMADO' : 'ESPERANDO RESPUESTA...'}
</button>
                                           </div>
                                           {form2Status === 'sent' && <p className="text-[9px] text-amber-500/70 mt-1 pl-1">* Esperando respuesta del candidato.</p>}
                                           {form2Status === 'received' && <p className="text-[9px] text-emerald-500/70 mt-1 pl-1">* Respuestas cargadas correctamente.</p>}
                                       </div>


                                       {/* DECISI√ìN DEL RECLUTADOR (SOLO APARECE SI EST√Å RECIBIDO O ENVIADO) */}
                                       <div className={`transition-all duration-500 ${form2Status === 'pending' ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
                                           <label className="text-[10px] text-slate-500 font-bold uppercase mb-3 block">Decisi√≥n Final</label>
                                           <div className="grid grid-cols-2 gap-4">
                                               <button
                                                   onClick={() => updateChecklist('result', 'qualified')}
                                                   className={`py-3 rounded-lg border text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                                                       finalResult === 'qualified'
                                                       ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg shadow-emerald-900/30 ring-1 ring-emerald-400'
                                                       : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500/50 hover:text-emerald-400'
                                                   }`}
                                               >
                                                   <ThumbsUp size={16}/> Calificado
                                               </button>
                                               <button
                                                   onClick={() => updateChecklist('result', 'disqualified')}
                                                   className={`py-3 rounded-lg border text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                                                       finalResult === 'disqualified'
                                                       ? 'bg-rose-600 text-white border-rose-500 shadow-lg shadow-rose-900/30 ring-1 ring-rose-400'
                                                       : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-rose-500/50 hover:text-rose-400'
                                                   }`}
                                               >
                                                   <ThumbsDown size={16}/> No Calificado
                                               </button>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       )}


                       <Card className="bg-slate-900 border-slate-800 flex flex-col overflow-hidden">
                           <div className="p-4 border-b border-slate-800 bg-slate-950/30"><h3 className="text-sm font-bold text-white">Tus Notas Personales</h3></div>
                           <textarea className="w-full h-32 bg-slate-900 p-4 text-slate-300 focus:outline-none placeholder-slate-600 resize-none text-sm" placeholder="Escribe aqu√≠..." value={noteInput} onChange={(e) => setNoteInput(e.target.value)} onBlur={() => onUpdate(candidate.id, { notes: noteInput })}></textarea>
                       </Card>
                   </div>
               </div>
           ) : (
               <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 max-w-3xl mx-auto mt-6">
                   <Card className="bg-slate-900 border-slate-800 p-8">
                       <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                           <History size={16}/> Historial de Movimientos
                       </h3>
                      
                       {!candidate.history || candidate.history.length === 0 ? (
                           <div className="text-center py-10 border-2 border-dashed border-slate-800 rounded-xl">
                               <p className="text-slate-500 text-sm">No hay movimientos registrados a√∫n.</p>
                           </div>
                       ) : (
                           <div className="relative border-l-2 border-slate-800 ml-3 space-y-8 pl-8 py-2">
                               {candidate.history.map((h, idx) => (
                                   <div key={idx} className="relative group">
                                       <div className="absolute -left-[39px] top-1 w-5 h-5 rounded-full bg-slate-900 border-2 border-blue-500 z-10 group-hover:scale-125 transition-transform shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                                       <div className="flex flex-col gap-1">
                                           <span className="text-[10px] font-bold text-blue-400 uppercase tracking-wider">
                                               {h.date ? new Date(h.date).toLocaleString('es-AR') : 'Fecha desconocida'}
                                           </span>
                                           <h4 className="text-white font-bold text-sm">{h.event || 'Evento del sistema'}</h4>
                                           <p className="text-xs text-slate-400 bg-slate-950/50 p-2 rounded border border-slate-800 inline-block mt-1">
                                               {h.detail || 'Sin detalles adicionales.'}
                                           </p>
                                       </div>
                                   </div>
                               ))}
                           </div>
                       )}
                   </Card>
               </div>
           )}
       </div>
   );
}

// --- COMPONENTE LOGIN (PORTER√çA DE ACCESO) ---
const LoginView = ({ onLogin }) => {
    const team = [
        { name: "Gladymar", role: "Recursos Humanos" },
        { name: "Sandra", role: "Recursos Humanos" },
        { name: "Viviana", role: "Recursos Humanos" },
        { name: "Pilar", role: "Ventas / Closer" },
        { name: "Norma", role: "Control de Calidad" },
        { name: "Daniel (CEO)", role: "Direcci√≥n" },
        { name: "Admin", role: "Superusuario" }
    ];
    
    return (
        <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden">
            <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 pointer-events-none"></div>
            <div className="relative z-10 w-full max-w-md p-8 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl animate-in fade-in zoom-in duration-300">
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-white mb-2 tracking-tight">Global Talent</h1>
                    <p className="text-slate-400 text-sm italic">"Conectando talento, autom√°ticamente"</p>
                </div>

                <div className="space-y-3">
                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] text-center mb-4">Seleccion√° tu perfil de acceso</p>
                    {team.map(user => (
                        <button 
                            key={user.name}
                            onClick={() => onLogin(user.name)}
                            className="w-full p-4 rounded-xl bg-slate-800 hover:bg-blue-600 border border-slate-700 hover:border-blue-500 transition-all group flex items-center justify-between"
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-slate-700 group-hover:bg-white/20 flex items-center justify-center text-white font-bold text-sm shadow-inner">
                                    {user.name.charAt(0)}
                                </div>
                                <div className="text-left">
                                    <p className="font-bold text-slate-200 group-hover:text-white leading-none">{user.name}</p>
                                    <p className="text-[10px] text-slate-500 group-hover:text-blue-100 uppercase mt-1.5 font-medium tracking-wider">{user.role}</p>
                                </div>
                            </div>
                            <LucideIcon name="ChevronRight" size={16} className="text-slate-600 group-hover:text-white transition-transform group-hover:translate-x-1" />
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- APP CONTAINER ---
function App() {
    // 1. ESTADOS (HOOKS) - Siempre arriba de todo
    const [activeTab, setActiveTab] = useState('dashboard');
    const [currentReport, setCurrentReport] = useState(null);
    const [selectedCandidateId, setSelectedCandidateId] = useState(null);
    const [candidates, setCandidates] = useState([]);
    const [loading, setLoading] = useState(false);
    const [init, setInit] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [showManualModal, setShowManualModal] = useState(false); 

    const LOGO_URL = "/GLOBAL.png";

    // 2. FUNCI√ìN DE CARGA
    const cargarDatos = async (forceRefresh = false) => {
        if (init && !forceRefresh) return;
        setLoading(true);
        try {
            const data = await api.candidates.list();
            setCandidates(data);
            setInit(true);
        } catch (error) {
            console.error("‚ùå Error cargando datos:", error);
        } finally {
            setLoading(false);
        }
    };

    // 3. EFECTOS
    useEffect(() => { 
        if (currentUser) cargarDatos(); 
    }, [currentUser]);

    // 4. LA PORTER√çA (Ubicado despu√©s de los hooks para evitar crashes)
    if (!currentUser) {
        return <LoginView onLogin={(name) => setCurrentUser(name)} />;
    }

// 5. L√ìGICA DE ACTUALIZACI√ìN (CORREGIDA)
const handleUpdateCandidate = async (id, updates) => {
        // 1. Preparamos la copia base de los cambios
        let finalUpdates = { ...updates };
        
        // 2. Buscamos al candidato ACTUAL para ver su estado hoy
        const currentCandidate = candidates.find(c => c.id === id);

        // 3. L√≥gica de Negocio: Asignaciones autom√°ticas
        if (updates.stage === 'stage_2') {
            finalUpdates.assignedTo = currentUser; 
            finalUpdates.status_interno = 'interview_pending';
        }

        if (updates.stage === 'trash' || updates.stage === 'stage_3') {
            setSelectedCandidateId(null);
        }

        // 4. L√ìGICA DE "VISTO" (Aqu√≠ estaba el bug)
        // Calculamos esto AHORA, fuera del setCandidates, para enviarlo bien a la API
        if (currentCandidate && activeTab === 'stage_1' && currentCandidate.status_interno === 'new' && !updates.stage) {
            finalUpdates.status_interno = 'viewed';
            finalUpdates.usuario_accion = currentUser; // üî• Identificar qui√©n lo visualiz√≥
        }

        // 5. Actualizamos la PANTALLA (Frontend)
        setCandidates(prev => prev.map(c => {
            if (c.id === id) {
                return { ...c, ...finalUpdates };
            }
            return c;
        }));

        // 6. Actualizamos la BASE DE DATOS (Backend)
        // Ahora finalUpdates lleva el dato 'viewed' correcto
        await api.candidates.update(id, finalUpdates);
    };

    const handleSelectCandidate = (id) => {
        setSelectedCandidateId(id);
        handleUpdateCandidate(id, {});
    };

    // 6. RENDERIZADO DE CONTENIDO (√önica declaraci√≥n)
    const renderContent = () => {
        if (currentReport) {
            return <ProfessionalReport data={currentReport} onBack={() => setCurrentReport(null)} />;
        }

        if (selectedCandidateId) {
            const cand = candidates.find(c => c.id === selectedCandidateId);
            if (!cand) return null;
            return (
                <CandidateDetail 
                    key={cand.id} 
                    candidate={cand} 
                    onBack={() => setSelectedCandidateId(null)} 
                    onUpdate={handleUpdateCandidate} 
                    loading={loading}
                    currentUser={currentUser} 
                />
            );
        }

        switch (activeTab) {
            case 'dashboard': return <DashboardView candidates={candidates} onNavigate={setActiveTab} />;
            case 'stage_1':   return <ExploreView candidates={candidates} onSelect={handleSelectCandidate} onUpdate={handleUpdateCandidate} loading={loading} onAddClick={() => setShowManualModal(true)} />;
            case 'stage_2':   return <ManageView candidates={candidates} onSelect={handleSelectCandidate} currentUser={currentUser} />;
            case 'stage_3':   return <ReportView candidates={candidates} onUpdate={handleUpdateCandidate} setCurrentReport={setCurrentReport} />;
            case 'search':    return <SearchView candidates={candidates} onSelect={handleSelectCandidate} />;
            case 'trash':     return <TrashView candidates={candidates} onUpdate={handleUpdateCandidate} />;
            default:          return <DashboardView candidates={candidates} onNavigate={setActiveTab} />;
        }
    };

    const menuItems = [
        { id: 'dashboard', label: 'Inicio', icon: LayoutDashboard },
        { type: 'divider', label: 'PIPELINE' },
        { id: 'stage_1', label: '1. Explorar', icon: UserPlus, sub: 'Nuevos Ingresos' },
        { id: 'stage_2', label: '2. Gesti√≥n', icon: Users, sub: 'En Entrevista' },
        { id: 'stage_3', label: '3. Generar Informe', icon: FileJson, sub: 'Listos para Asignar' },
        { type: 'divider', label: 'SISTEMA' },
        { id: 'search', label: 'B√∫squeda', icon: Search },
        { id: 'trash', label: 'Papelera', icon: Trash2 },
    ];

   // 7. ESTRUCTURA PRINCIPAL (ACTUALIZADA CON MODAL)
   return (
        <>
            <div className="flex h-screen bg-slate-950 font-sans text-slate-200 selection:bg-blue-500/30 overflow-hidden">
                <aside className="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 z-20">
                    <div className="h-24 flex items-center justify-center px-6 border-b border-slate-800 bg-slate-900">
                        <img src={LOGO_URL} alt="Logo" className="max-h-20 w-auto object-contain transition-all hover:scale-105" />
                    </div>
                    <nav className="flex-1 px-3 py-6 space-y-1 overflow-y-auto custom-scrollbar">
                        {menuItems.map((item, idx) => {
                            if (item.type === 'divider') return <div key={idx} className="px-3 pt-6 pb-2 text-[10px] font-bold text-slate-600 tracking-widest uppercase">{item.label}</div>;
                            const isActive = activeTab === item.id;
                            return (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setSelectedCandidateId(null); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm transition-all group relative ${isActive ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20' : 'text-slate-400 hover:bg-slate-800 border border-transparent'}`}>
                                    <item.icon size={18} className={isActive ? 'text-blue-400' : 'text-slate-500 group-hover:text-slate-300'} />
                                    <div className="flex flex-col items-start text-left"><span className="font-medium leading-none">{item.label}</span>{item.sub && isActive && <span className="text-[10px] opacity-70 font-normal mt-1">{item.sub}</span>}</div>
                                    {isActive && <div className="absolute right-2 w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.8)]" />}
                                </button>
                            );
                        })}
                    </nav>
                    <div className="p-4 border-t border-slate-800">
                        <button className="flex items-center gap-3 w-full p-2 rounded-xl hover:bg-slate-800 transition-colors group border border-transparent hover:border-slate-700">
                            <Avatar name={currentUser} />
                            <div className="flex-col flex items-start overflow-hidden">
                                <span className="text-xs font-bold text-slate-200 group-hover:text-white">{currentUser}</span>
                                <span className="text-[10px] text-emerald-400 flex items-center gap-1">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"/> Online
                                </span>
                            </div>
                            <Settings size={14} className="ml-auto text-slate-600 group-hover:text-slate-400 transition-colors"/>
                        </button>
                    </div>
                </aside>
                <main className="flex-1 overflow-auto p-6 relative bg-slate-950">
                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-[0.03] pointer-events-none mix-blend-overlay"></div>
                    <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-900/10 to-transparent pointer-events-none"></div>
                    <div className="relative z-10 h-full">{renderContent()}</div>
                </main>
            </div>

            {/* MODAL F√çSICO (Controlado por el estado showManualModal) */}
            <ManualUploadModal 
                isOpen={showManualModal} 
                onClose={() => setShowManualModal(false)} 
                onUploadSuccess={() => cargarDatos(true)} 
            />
        </>
    );
}

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
</file>

<file path="cliente_lite/dashboard.html">
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Talent - Panel RRHH</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" src="ui-components.js"></script>
    <script type="text/babel" src="api-client.js"></script>
    <script type="text/babel" src="dashboard.js"></script>
</body>
</html>
</file>

<file path="index.js">
///////////////////////////////////////////////// Dependencias principales //////////////////////////////////////////////////////////
"use strict";
const child_process = require("child_process");
const { spawn } = require("child_process");
const { getStorage } = require("firebase-admin/storage");
const ROOT_PREFIX = "CV-clasificador/";
const express = require("express");
const multer = require("multer");
const PizZip = require("pizzip");
const Docxtemplater = require("docxtemplater");
const pdfParse = require("pdf-parse");
const path = require("path");
const bodyParser = require("body-parser");
const stopword = require("stopword");
const stopwordsEs = require("stopwords-es");
const stopwordsEn = require("stopwords-en");
const natural = require("natural");
const cors = require("cors");
const os = require("os");
const fs = require("fs");
const { google } = require("googleapis");
const nodemailer = require("nodemailer");
require("dotenv").config();
const axios = require("axios");
const vision = require("@google-cloud/vision");
const crypto = require("node:crypto");
const { Storage } = require("@google-cloud/storage");
const pLimit = require("p-limit");        // concurrencia
const helmet = require("helmet");         // seguridad
const rateLimit = require("express-rate-limit");
const verifyToken = require("./authMiddleware");
const mammoth = require("mammoth");
const { v4: uuidv4 } = require("uuid");
const tempBase = path.join(os.tmpdir(), "cvs-en-proceso");
const PYTHON_BIN = process.env.PYTHON_BIN || "python";

const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, BorderStyle, TextRun, AlignmentType, ImageRun } = require("docx");

// === Gemini AI ===
const { GoogleGenerativeAI } = require("@google/generative-ai");
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

// === INICIALIZACI√ìN DE APP ===
const app = express();
app.use(cors());
app.use(express.json());
// ==========================================
// ‚öôÔ∏è CONFIGURACI√ìN DE ENTORNO (MASTER SWITCH)
// ==========================================
// Poner "CVs_staging" para pruebas limpias.
// Poner "CVs_aprobados" cuando quieras volver a ver los 73 candidatos reales.
const MAIN_COLLECTION = "CVs_staging"; 

console.log(`üöÄ SISTEMA INICIADO EN MODO: ${MAIN_COLLECTION}`);

// üî• CR√çTICO: ESTO PERMITE QUE EL FRONTEND VEA EL LOGO.PNG
app.use(express.static(__dirname)); 


const DBG_PREVIEW = 500;
////////////////////////////////////////////////////////////////////// CONFIGURACI√ìN GLOBAL ///////////////////////////////////////////

const SIM_MIN = Number(process.env.SIM_MIN || 0.15);
const CLASIF_ROOT = "CV-clasificador";

const EMBEDDING_MODEL_BULK =
  process.env.EMBEDDING_MODEL_BULK || "text-embedding-3-small";
const EMBEDDING_MAX_CHARS = 8000;

const RANK_EMBEDDING_WEIGHT = (() => {
  const v = Number(process.env.RANK_EMBEDDING_WEIGHT);
  return Number.isFinite(v) ? Math.min(1, Math.max(0, v)) : 0.75;
})();

const AI_MODEL = process.env.AI_MODEL || "gpt-4o-mini";
const AI_SEED = 7;
const AI_SCORE_VERSION = 5;

const CONCURRENCY = Number(process.env.CONCURRENCY || 4);
const L = pLimit(CONCURRENCY);

// OpenAI dependencies removed. Keeping Gemini configuration only.

//////////////////////////////////////////////////////////////////// MANEJO DE GMAIL ‚Äì IMAP + MAILPARSER //////////////////////////////

const { ImapFlow } = require("imapflow");
const { simpleParser } = require("mailparser");
const FormData = require("form-data");

//////////////////////////////////////////////////////////////////// CONFIGURACI√ìN FIREBASE + GOOGLE STORAGE ///////////////////////////////

const FIREBASE_CREDS = {
  projectId: process.env.FIREBASE_PROJECT_ID,
  clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
  privateKey: (process.env.FIREBASE_PRIVATE_KEY || "").replace(/\\n/g, "\n"),
};

const PROJECT_ID = FIREBASE_CREDS.projectId;

const EXPLICIT_BUCKET = process.env.FIREBASE_STORAGE_BUCKET || null;

const BUCKET_CANDIDATES = [
  EXPLICIT_BUCKET,
  PROJECT_ID ? `${PROJECT_ID}.firebasestorage.app` : null,
  PROJECT_ID ? `${PROJECT_ID}.appspot.com` : null,
].filter(Boolean);

const GCS_LOCATION = process.env.GCS_BUCKET_LOCATION || "US";
const AUTO_CREATE_BUCKET =
  String(process.env.AUTO_CREATE_BUCKET || "false").toLowerCase() === "true";

const visionClient = new vision.ImageAnnotatorClient({
  credentials: {
    client_email: FIREBASE_CREDS.clientEmail,
    private_key: FIREBASE_CREDS.privateKey,
  },
  projectId: PROJECT_ID,
});

const admin = require("firebase-admin");
let firestore;
let bucket;
let STORAGE_READY = false;

admin.initializeApp({
  credential: admin.credential.cert({
    projectId: process.env.FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n')
  }),
  storageBucket: process.env.FIREBASE_STORAGE_BUCKET
});

///////////////////////////////////////////////////express app /////////////////////////////////////////////////////////////

const PORT = process.env.PORT || 3001;

app.use(cors());

// Configuraci√≥n de Seguridad (Helmet) Corregida
app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        "default-src": ["'self'"],
        "script-src": ["'self'", "'unsafe-inline'", "'unsafe-eval'", "https://cdn.tailwindcss.com", "https://unpkg.com"],
        "style-src": ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
        "img-src": ["'self'", "data:", "https://*"],
        "connect-src": [
            "'self'", 
            "http://localhost:3001", 
            "https://cv-cladificador-eyvb.onrender.com", 
            "https://cv-cladificador.onrender.com",
            "https://unpkg.com",
            "https://generativelanguage.googleapis.com"
        ],
      },
    },
  })
);

app.use(bodyParser.json({ limit: "10mb" }));
app.use(rateLimit({ windowMs: 60 * 1000, max: 120 }));
// rutas protegidas
app.use([
  "/cv-original-url/:filename",
  "/cv-censurado-url/:filename",
  "/agendar-cita",
  "/contratar",
  "/contratados",
  "/descartar",
  "/descartados",
  "/en-proceso",
  "/analyze",
  "/cv-censurado-url"
], verifyToken);


///////////////////////////////////////////////////////// HELPERS //////////////////////////////////////////////////////////////////////////////////////////
async function extractTextSmartFromPdfFile(pdfPath, opts = {}) {
  const thresholdChars = opts.thresholdChars ?? 120; // sube umbral para evitar OCR innecesario
  const buf = fs.readFileSync(pdfPath);

  try {
    const perPage = [];
    const render_page = (pageData) =>
      pageData.getTextContent().then((tc) => {
        const txt = tc.items.map((i) => i.str).join(" ").trim();
        perPage.push(txt);
        return txt;
      });
    const parsed = await pdfParse(buf, { pagerender: render_page });
    const textDigital = (parsed.text || "").trim();
    if (textDigital.length >= thresholdChars) {
      // Heur√≠stica: si al menos 50% de las p√°ginas tienen >40 chars, nos quedamos con el texto digital
      const density = perPage.filter(t => (t || "").length > 40).length / Math.max(1, perPage.length);
      if (density >= 0.5) return perPage.length ? perPage.join("\\n\\n") : textDigital;
    }
  } catch (e) {
    console.warn("pdf-parse fall√≥, intentar√© Vision OCR (async GCS):", e.message);
  }

  if (!STORAGE_READY || !bucket?.name) {
    console.warn("Vision OCR omitido: Storage no listo.");
    return "";
  }
  try {
    const inPrefix = `vision_ocr/in/`;
    const outPrefix = `vision_ocr/out/${Date.now()}_${path.basename(pdfPath).replace(/\\s+/g, "_")}/`;
    const gcsInPath = `${inPrefix}${crypto.randomUUID()}.pdf`;
    await bucket.upload(pdfPath, { destination: gcsInPath, metadata: { contentType: "application/pdf" } });

    const inputGcsUri = `gs://${bucket.name}/${gcsInPath}`;
    const outputGcsUri = `gs://${bucket.name}/${outPrefix}`;

    const request = {
      requests: [{
        inputConfig: { gcsSource: { uri: inputGcsUri }, mimeType: "application/pdf" },
        features: [{ type: "DOCUMENT_TEXT_DETECTION" }],
        outputConfig: { gcsDestination: { uri: outputGcsUri }, batchSize: 10 },
      }],
    };

    const [operation] = await visionClient.asyncBatchAnnotateFiles(request);
    await operation.promise();

    const [files] = await bucket.getFiles({ prefix: outPrefix });
    let full = "";
    for (const f of files) {
      const [contents] = await f.download();
      const json = JSON.parse(contents.toString("utf8"));
      const responses = json.responses || [];
      for (const r of responses) full += (r.fullTextAnnotation?.text || "") + "\\n";
    }

    try { await bucket.file(gcsInPath).delete({ ignoreNotFound: true }); } catch { }
    for (const f of files || []) { try { await f.delete({ ignoreNotFound: true }); } catch { } }

    return full.trim();
  } catch (e) {
    console.error("‚ùå Vision OCR (async) error:", e);
    return "";
  }
}

/////////////// sanitizar /////////////

function sanitizeForAI(text) {
  return text.replace(/[{}`<>]/g, " ");
}

/////////////////// obtiene candidatos  a no mostrar ///////////////////////
async function obtenerCandidatosBloqueados() {
  // QUITAMOS "en_proceso" para que aparezcan en el buscador
  const colecciones = ["contratados", "descartados"]; 
  const bloqueados = new Set();

  for (const col of colecciones) {
    const snap = await firestore.collection(col).get();
    snap.forEach((doc) => {
      bloqueados.add(doc.id.trim().toLowerCase());
    });
  }

  return bloqueados;
}

///////////////////// Normaliza cadenas (min√∫sculas, sin tildes) ////////////////////

function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

// Helper normStr (igual que normalize, formato arrow)
const normStr = (str) =>
  String(str || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();

///////////////////// Normaliza texto de ofertas para embeddings. ////////////////////

function canonicalOfferText(txt) {
  return txt
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

// ... resto de helpers intactos ...

//////////////////////// createEmbedding /////////////////

// OpenAI Embedding is DISABLED.
// Now just return empty array and message.
async function createEmbedding(text) {
  console.log("üîï Embeddings deshabilitados: createEmbedding() retorna [].");
  return [];
}

//////////////////////// organizarCVconIA (usando Gemini) /////////////////

async function organizarCVconIA({ textoPlano, nombreArchivo, email, puesto }) {
  const prompt = `
Eres un asistente experto encargado de convertir un CV parseado desde un correo electr√≥nico est√°ndar
en un JSON corporativo con el FORMATO EXACTO solicitado por Global Talent Connections.

‚ö† INSTRUCCIONES IMPORTANTES:
- El texto que recibes ya suele estar en formato JSON parcialmente estructurado.
- SI UN CAMPO YA TIENE VALOR, RESP√âTALO. No lo cambies.
- Solo completa campos vac√≠os o claramente faltantes.
- Si alg√∫n dato NO aparece en el texto, deja el campo vac√≠o.
- No inventes informaci√≥n.
- Conserva EXACTAMENTE la misma estructura JSON.
- Respeta pluralidad: educaci√≥n y experiencia pueden tener varias entradas.

==========================
CV PLANO / JSON PARSEADO
==========================
${textoPlano}

Devu√©lveme √öNICAMENTE un JSON v√°lido con esta estructura EXACTA:

{
  "datos_personales": {
    "nombre_completo": "",
    "nacionalidad": "",
    "fecha_nacimiento": "",
    "estado_civil": "",
    "genero": "",
    "tipo_documento": "",
    "numero_documento": "",
    "discapacidad": ""
  },
  "contacto": {
    "telefono_principal": "",
    "telefono_secundario": "",
    "email": ""
  },
  "educacion": [
    {
      "titulo": "",
      "institucion": "",
      "pais": "",
      "area_estudio": "",
      "tipo_estudio": "",
      "estado": ""
    }
  ],
  "experiencia": [
    {
      "empresa": "",
      "rol": "",
      "nivel_experiencia": "",
      "rubro": "",
      "fecha_inicio": "",
      "fecha_fin": "",
      "pais": "",
      "personas_a_cargo": "",
      "responsabilidades": [],
      "manejo_presupuesto": "",
      "referencia": {
        "nombre": "",
        "email": ""
      },
      "salario": {
        "moneda": "",
        "monto": ""
      },
      "modalidad": ""
    }
  ],
  "habilidades": {
    "autogestion_organizacion": "",
    "comunicacion_efectiva": "",
    "adaptacion_cambio": "",
    "motivacion": ""
  },
  "idiomas": [
    {
      "idioma": "",
      "nivel_escrito": "",
      "nivel_oral": ""
    }
  ],
  "seleccion_I": {
    "desfase_horario": "",
    "herramientas_remoto": "",
    "especialidad_postula": ""
  },
  "seleccion_II": {
    "priorizacion": "",
    "autonomia": "",
    "claridad_mensajes": "",
    "comunicacion_frecuencia": "",
    "manejo_falla": "",
    "interes_remoto": "",
    "balance_trabajo_vida": "",
    "disponible_actualmente": ""
  },
  "puesto": "",
  "nombre_archivo": "",
  "applicant_email": ""
}
`;

  try {
    // Gemini expects an array of contents (no roles required)
    const result = await model.generateContent(prompt);
    let raw = result?.response?.text() || "{}";
    // Quita marcas de c√≥digo y posibles rodeos del modelo
    raw = raw.trim()
      .replace(/^```json/i, "")
      .replace(/^```/, "")
      .replace(/```$/i, "")
      .replace(/^\s*[\r\n]+/, "")
      .replace(/[\r\n]+```$/, "");
    const json = JSON.parse(raw);

    json.puesto = puesto || json.puesto || "";
    json.nombre_archivo = nombreArchivo || json.nombre_archivo || "";
    json.applicant_email = email || json.applicant_email || "";

    if (json.contacto && !json.contacto.email && json.applicant_email) {
      json.contacto.email = json.applicant_email;
    }
    return json;
  } catch (e) {
    console.error("‚ö†Ô∏è Error en organizarCVconIA (Gemini):", e.message);
    return {};
  }
}


//////////////////////// organizar informacion para almacenar /////////////////



// Escapa texto para usarlo en RegExp de forma segura
// Escapa texto para usarlo en RegExp de forma segura
function escapeRegExp(str = "") {
  return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

// --- Helper para extracci√≥n simple: "Campo: valor"
// Soporta: "Campo:", "Campo 1:", "Campo 2:", etc.
function pick(text, field) {
  if (!text) return "";
  const pattern = new RegExp(
    escapeRegExp(field) + "\\s*\\d*\\s*:\\s*([^;\\n]+)",
    "i"
  );
  const m = text.match(pattern);
  return m ? m[1].trim() : "";
}

// --- Helper MULTIL√çNEA para preguntas tipo encuesta
// Soporta:
//  - "¬øPregunta ... ?\nRespuesta"
//  - "Pregunta: Respuesta"
//  - "Pregunta\nRespuesta"
function pickMultiline(section, question) {
  if (!section) return "";

  // Caso principal: "¬øPregunta ... ?\nRespuesta"
  const pattern = new RegExp(
    escapeRegExp(question) + ".*?\\?\\s*\\n\\s*([^\\n]+)",
    "i"
  );
  const m = section.match(pattern);
  if (m) return m[1].trim();

  // Fallback A: "Pregunta: respuesta"
  const rxInline = new RegExp(
    escapeRegExp(question) + "\\s*:\\s*([^\\n]+)",
    "i"
  );
  const m1 = section.match(rxInline);
  if (m1) return m1[1].trim();

  // Fallback B:
  // Pregunta
  // Respuesta
  const rxMulti = new RegExp(
    escapeRegExp(question) + "\\s*\\n\\s*([^\\n]+)",
    "i"
  );
  const m2 = section.match(rxMulti);
  if (m2) return m2[1].trim();

  return "";
}

// --- Helper para bloques m√∫ltiples: Educaci√≥n, Experiencia, etc.
// Detecta "Titulo:", "Titulo 1:", "Empresa:", "Empresa 2:", etc.
function splitBlocks(section, keywordBase) {
  if (!section) return [];

  const rx = new RegExp(
    escapeRegExp(keywordBase) + "\\s*\\d*\\s*:",
    "ig"
  );

  const matches = [...section.matchAll(rx)];
  if (matches.length === 0) return [];

  const blocks = [];
  for (let i = 0; i < matches.length; i++) {
    const start = matches[i].index;
    const end = i + 1 < matches.length ? matches[i + 1].index : section.length;
    const block = section.slice(start, end).trim();
    if (block) blocks.push(block);
  }

  return blocks;
}



// --- Decode b√°sico
function decodeHtmlEntities(text = "") {
  return text
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&quot;/g, "\"")
    .replace(/&#39;/g, "'")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">");
}


// ============================================================================================
// =============================  PARSER PRINCIPAL  ===========================================
// ============================================================================================
const { convert: htmlToText } = require("html-to-text");
function parsearCorreoEstandar(raw) {
  if (!raw) return { textoPlano: "", jsonParcial: {} };

  let body = htmlToText(raw, {
    preserveNewlines: true,
    wordwrap: false,
  });

  body = decodeHtmlEntities(body)
    .replace(/\r/g, "")
    .replace(/\n{2,}/g, "\n")
    .trim();

  // Secciones 1), 2), 3)...
  const sections = body.split(/\n(?=\d+\)\s+)/g);

  const result = {
    datos_personales: {
      nombre_completo: "",
      nacionalidad: "",
      fecha_nacimiento: "",
      estado_civil: "",
      genero: "",
      tipo_documento: "",
      numero_documento: "",
      discapacidad: ""
    },
    contacto: {
      telefono_principal: "",
      telefono_secundario: "",
      email: ""
    },
    educacion: [],
    experiencia: [],
    habilidades: {
      autogestion_organizacion: "",
      comunicacion_efectiva: "",
      adaptacion_cambio: "",
      motivacion: ""
    },
    seleccion_I: {
      desfase_horario: "",
      herramientas_remoto: "",
      especialidad_postula: ""
    },
    seleccion_II: {
      priorizacion: "",
      autonomia: "",
      claridad_mensajes: "",
      comunicacion_frecuencia: "",
      manejo_falla: "",
      interes_remoto: "",
      balance_trabajo_vida: "",
      disponible_actualmente: ""
    },
    idiomas: [],
    puesto: "",
    nombre_archivo: "",
    applicant_email: ""
  };

  // ===== 1) DATOS PERSONALES =====
  const sec1 = sections.find(s => /^1\)/.test(s)) || "";
  result.datos_personales = {
    nombre_completo: pick(sec1, "Nombre completo"),
    nacionalidad: pick(sec1, "Nacionalidad"),
    fecha_nacimiento: pick(sec1, "Fecha de nacimiento"),
    estado_civil: pick(sec1, "Estado civil"),
    genero: pick(sec1, "G√©nero"),
    tipo_documento: pick(sec1, "Tipo de documento"),
    numero_documento: pick(sec1, "N√∫mero de documento"),
    discapacidad: pick(sec1, "Discapacidad"),
  };

  // ===== 2) CONTACTO =====
  const sec2 = sections.find(s => /^2\)/.test(s)) || "";
  let correo = pick(sec2, "Email") || "";
  // Limpia punto final y espacios
  correo = correo.replace(/\.*\s*$/, "");

  result.contacto = {
    telefono_principal: pick(sec2, "Tel√©fono principal"),
    telefono_secundario: pick(sec2, "Tel√©fono secundario"),
    email: correo,
  };

  // ===== 3) EDUCACI√ìN + IDIOMAS =====
  const sec3 = sections.find(s => /^3\)/.test(s)) || "";
  const eduBlocks = splitBlocks(sec3, "Titulo");

  result.educacion = eduBlocks.map(b => ({
    titulo: pick(b, "Titulo"),
    institucion: pick(b, "Instituci√≥n"),
    pais: pick(b, "Pa√≠s de estudios"),
    area_estudio: pick(b, "√Årea"),
    tipo_estudio: pick(b, "Tipo de estudios"),
    estado: pick(b, "Estado"),
  }));

  // Idiomas en una sola l√≠nea
  const idiomasStr = pick(sec3, "Idiomas");
  if (idiomasStr) {
    result.idiomas = idiomasStr
      .split(/[,;]+/)
      .map(i => i.trim())
      .filter(Boolean)
      .map(i => ({
        idioma: i,
        nivel_escrito: "",
        nivel_oral: ""
      }));
  }

  // Niveles de ingl√©s separados
  const nivelInglesOral = pick(sec3, "Nivel de ingles (oral)");
  const nivelInglesEscrito = pick(sec3, "Nivel de ingles (escrito)");
  if (nivelInglesOral || nivelInglesEscrito) {
    if (!Array.isArray(result.idiomas)) result.idiomas = [];
    result.idiomas.push({
      idioma: "Ingl√©s",
      nivel_escrito: nivelInglesEscrito || "",
      nivel_oral: nivelInglesOral || ""
    });
  }

  // ===== 4) EXPERIENCIA =====
  const sec4 = sections.find(s => /^4\)/.test(s)) || "";
  const expBlocks = splitBlocks(sec4, "Empresa");

  result.experiencia = expBlocks.map(b => {
    let paisEmpresa = pick(b, "Pa√≠s");
    // Limpia contaminaci√≥n tipo "Pa√≠s: espa√±a  Personas a cargo: No"
    if (paisEmpresa) {
      paisEmpresa = paisEmpresa.replace(/Personas a cargo:.*/i, "").trim();
    }

    const salarioRaw = pick(b, "Salario") || "";
    const monedaMatch = typeof salarioRaw === "string" ? salarioRaw.match(/[A-Za-z]+/) : null;
    const montoMatch = typeof salarioRaw === "string" ? salarioRaw.match(/[\d.,]+/) : null;

    return {
      empresa: pick(b, "Empresa"),
      rol: pick(b, "Rol"),
      nivel_experiencia: pick(b, "Nivel de experiencia"),
      rubro: pick(b, "Rubro"),
      fecha_inicio: pick(b, "Fecha de inicio"),
      fecha_fin: pick(b, "Fecha de finalizaci√≥n"),
      pais: paisEmpresa || "",
      personas_a_cargo: pick(b, "Personas a cargo"),
      responsabilidades: (pick(b, "Responsabilidades") || "")
        .split(/[;,]/)
        .map(r => r.trim())
        .filter(Boolean),
      manejo_presupuesto: pick(b, "Manejo de presupuesto"),
      referencia: {
        nombre: pick(b, "Referencia nombre"),
        email: pick(b, "Referencia email"),
      },
      salario: {
        moneda: monedaMatch ? monedaMatch[0] : "",
        monto: montoMatch ? montoMatch[0] : "",
      },
      modalidad: pick(b, "Modalidad"),
    };
  });

  // ===== 5) HABILIDADES =====
  const sec5 = sections.find(s => /^5\)/.test(s)) || "";
  result.habilidades = {
    autogestion_organizacion: pick(sec5, "Autogesti√≥n y Organizaci√≥n"),
    comunicacion_efectiva: pick(sec5, "Comunicaci√≥n efectiva"),
    adaptacion_cambio: pick(sec5, "Adaptaci√≥n al cambio"),
    motivacion: pick(sec5, "Motivaci√≥n"),
  };

  // ===== 6) SELECCI√ìN I (multil√≠nea) =====
  const sec6 = sections.find(s => /^6\)/.test(s)) || "";
  result.seleccion_I = {
    desfase_horario: pickMultiline(sec6, "¬øEstas dispuesto"),
    herramientas_remoto: pickMultiline(sec6, "¬øCuenta con el espacio"),
    especialidad_postula: pickMultiline(sec6, "Especialidad a la que postula"),
  };

  // ===== 7) SELECCI√ìN II (multil√≠nea) =====
  const sec7 = sections.find(s => /^7\)/.test(s)) || "";
  result.seleccion_II = {
    priorizacion: pickMultiline(sec7, "¬øC√≥mo priorizas"),
    autonomia: pickMultiline(sec7, "Nivel de autonom√≠a"),
    claridad_mensajes: pickMultiline(sec7, "¬øC√≥mo garantizas"),
    comunicacion_frecuencia: pickMultiline(sec7, "¬øCon que frecuencia"),
    manejo_falla: pickMultiline(sec7, "¬øQu√© haces cuando falla"),
    interes_remoto: pickMultiline(sec7, "¬øQu√© es lo que m√°s te atrae"),
    balance_trabajo_vida: pickMultiline(sec7, "¬øC√≥mo equilibras"),
    disponible_actualmente: pickMultiline(sec7, "¬øEsta disponible"),
  };

  const textoPlano = JSON.stringify(result, null, 2);

  return { textoPlano, jsonParcial: result };
}



//////////////////////////////////////////////////////////////////
async function mapAreaToFolder(areaReal = "") {
  const categoriasPrincipales = [
    "Administraci√≥n",
    "Financiero y Contable",
    "Ventas y Comercio Electr√≥nico",
    "Marketing Digital",
    "Comunicaciones",
    "Arquitectura",
    "Dise√±o Gr√°fico",
    "Desarrollo Web",
    "Gesti√≥n y Calidad",
    "Automatizaciones e IA",
    "Recursos Humanos",
    "Edici√≥n Audiovisual"
  ];

  const ejemplos = {
    "Administraci√≥n": [
      "Asistente Administrativo",
      "Asistente Virtual",
      "Atenci√≥n al cliente",
      "Project Manager",
      "Control documental"
    ],
    "Financiero y Contable": [
      "Contabilidad",
      "Auditor√≠a",
      "N√≥mina",
      "Analista financiero"
    ],
    "Ventas y Comercio Electr√≥nico": [
      "Ventas",
      "E-commerce",
      "Customer Success",
      "Relaciones comerciales",
      "Asesor comercial"
    ],
    "Marketing Digital": [
      "SEO",
      "Community Manager",
      "Growth",
      "Copywriter",
      "Publicidad"
    ],
    "Comunicaciones": [
      "Relaciones p√∫blicas",
      "Redacci√≥n",
      "Comunicaci√≥n corporativa"
    ],
    "Arquitectura": [
      "Delineante",
      "Tasaciones",
      "Ingeniero de caminos"
    ],
    "Dise√±o Gr√°fico": [
      "UX/UI",
      "Branding",
      "Motion Graphics",
      "Dise√±o de producto"
    ],
    "Desarrollo Web": [
      "Desarrollador",
      "Frontend",
      "Backend",
      "Full stack",
      "QA tester",
      "CMS"
    ],
    "Gesti√≥n y Calidad": [
      "Calidad",
      "Auditor√≠a interna",
      "PMO",
      "SOP"
    ],
    "Automatizaciones e IA": [
      "RPA",
      "IA",
      "Chatbots",
      "Zoho",
      "Zapier",
      "Make",
      "Integraciones"
    ],
    "Recursos Humanos": [
      "Reclutador",
      "Seleccionador",
      "Generalista",
      "People"
    ],
    "Edici√≥n Audiovisual": [
      "Edici√≥n de video",
      "Producci√≥n",
      "Motion graphics",
      "Contenido para redes"
    ]
  };

  const prompt = `
Clasifica el √°rea del candidato en UNA de las siguientes 12 categor√≠as principales.

AREA DEL CANDIDATO:
"${areaReal}"

CATEGOR√çAS PRINCIPALES:
${JSON.stringify(categoriasPrincipales, null, 2)}

EJEMPLOS:
${JSON.stringify(ejemplos, null, 2)}

REGLAS:
- No inventes categor√≠as nuevas.
- Si el √°rea es desconocida, clasifica por similitud sem√°ntica.
- Si no encaja en ninguna, devuelve "Otros".
- Responde SOLO en este JSON:
{"categoria": "Nombre"}
`;

  try {
    const completion = await openai.chat.completions.create({
      model: process.env.AI_MODEL || "gpt-4o-mini",
      temperature: 0.1,
      response_format: { type: "json_object" },
      messages: [
        { role: "system", content: "Devuelve √∫nicamente JSON v√°lido" },
        { role: "user", content: prompt }
      ],
    });

    const parsed = JSON.parse(completion.choices?.[0]?.message?.content || "{}");

    const cat = parsed?.categoria || "";

    if (categoriasPrincipales.includes(cat)) return cat;
    return "Otros";

  } catch (err) {
    console.error("‚ö†Ô∏è Error en mapAreaToFolder:", err.message);
    return "Otros";
  }
}


// ========================================================================
// üì© ANALIZADOR DE CORREOS (VERSI√ìN FINAL OPTIMIZADA)
// ========================================================================
async function analizarCorreos() {
  let client;
  try {
    // 1. CONEXI√ìN IMAP
    client = new ImapFlow({
      host: process.env.IMAP_HOST,
      port: parseInt(process.env.IMAP_PORT || "993"),
      secure: true,
      auth: { user: process.env.EMAIL_FROM, pass: process.env.EMAIL_PASS },
      keepAlive: { interval: 30000, idleInterval: 60000, forceNoop: true }
    });

    client.on("error", (err) => console.error("‚ö†Ô∏è Error IMAP:", err.message));
    await client.connect();
    await client.mailboxOpen("INBOX");
    console.log("üì¨ INBOX abierto - Buscando CVs...");

    // 2. GESTI√ìN DE CONTROL (Evitar repetidos)
    const COLECCION_CONTROL = "emails_procesados_reintento_v2";
    let lastUID = 0;
    const snapshotLast = await firestore.collection(COLECCION_CONTROL).orderBy("uid", "desc").limit(1).get();
    if (!snapshotLast.empty) lastUID = parseInt(snapshotLast.docs[0].data().uid, 10);

    // 3. BUCLE DE LECTURA
    for await (const msg of client.fetch(`${lastUID + 1}:*`, { envelope: true, source: true, uid: true })) {
      const uid = msg.uid;
      const subject = msg.envelope.subject || "";
      
      // Filtro r√°pido
      if (!/^Postulaci√≥n/i.test(subject) && !/^Video-CV/i.test(subject)) continue;

      const processedRef = firestore.collection(COLECCION_CONTROL).doc(String(uid));
      if ((await processedRef.get()).exists) continue;

      console.log(`üîé Procesando correo: ${subject}`);

      // 4. PARSEO DEL CORREO
      const parsed = await simpleParser(msg.source);
      const bodyContent = parsed.text || parsed.html || "";

      // üî• ID MATCHING ROBUSTO (Regex busca cualquier email en el cuerpo)
      const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi;
      const todosLosEmails = bodyContent.match(emailRegex) || [];
      // Excluye tus propios correos de sistema
      const candidatoEmail = todosLosEmails.find(e => !e.includes("globaltalent") && !e.includes("zohocreator") && !e.includes("admin"));

      if (!candidatoEmail) {
        console.log("‚ö†Ô∏è No se detect√≥ email de candidato. Saltando.");
        await processedRef.set({ uid, status: "skipped_no_email", fecha: admin.firestore.FieldValue.serverTimestamp() });
        continue;
      }

      // Generar ID id√©ntico al Webhook
      const safeId = candidatoEmail.trim().toLowerCase().replace(/[^a-z0-9]/g, "_");
      console.log(`üéØ Match ID: ${safeId}`);

      // 5. BUSCAR PDF ADJUNTO
      const pdfAttachment = parsed.attachments.find(a => a.contentType === "application/pdf" || a.filename.toLowerCase().endsWith(".pdf"));
      
      if (!pdfAttachment) {
        console.log("‚ö†Ô∏è Sin PDF adjunto.");
        await processedRef.set({ uid, status: "skipped_no_pdf", fecha: admin.firestore.FieldValue.serverTimestamp() });
        continue;
      }

      // 6. BUSCAR VIDEO ADJUNTO (si existe)
      const videoAttachment = parsed.attachments.find(a => {
        const contentType = (a.contentType || "").toLowerCase();
        const filename = (a.filename || "").toLowerCase();
        return contentType.startsWith("video/") || 
               filename.endsWith(".mp4") || 
               filename.endsWith(".mov") || 
               filename.endsWith(".avi") || 
               filename.endsWith(".mkv") ||
               filename.endsWith(".webm");
      });
      
      let videoUrl = null;
      if (videoAttachment) {
        console.log(`üé• Video encontrado: ${videoAttachment.filename} (${(videoAttachment.size / 1024 / 1024).toFixed(2)} MB)`);
        try {
          // Subir video a Storage
          const videoExtension = videoAttachment.filename.split('.').pop() || 'mp4';
          const videoFileName = `CVs_staging/videos/${safeId}_video.${videoExtension}`;
          const videoBucketFile = bucket.file(videoFileName);
          
          await videoBucketFile.save(videoAttachment.content, { 
            metadata: { 
              contentType: videoAttachment.contentType || "video/mp4" 
            } 
          });
          
          // Generar link firmado (v√°lido por mucho tiempo) - Configurado para abrir inline (no descargar)
          const [signedVideoUrl] = await videoBucketFile.getSignedUrl({ 
            action: 'read', 
            expires: '01-01-2035',
            responseDisposition: 'inline' // üëà Esto hace que se abra en el navegador en vez de descargar
          });
          
          videoUrl = signedVideoUrl;
          console.log(`‚úÖ Video subido correctamente: ${videoFileName}`);
        } catch (error) {
          console.error("‚ùå Error subiendo video:", error.message);
          // No bloqueamos el proceso si falla el video
        }
      }

      // 7. SUBIR PDF A STORAGE (Arregla el Link)
      const bucketFile = bucket.file(`CVs_staging/files/${safeId}_CV.pdf`);
      await bucketFile.save(pdfAttachment.content, { metadata: { contentType: "application/pdf" } });
      const [publicCvUrl] = await bucketFile.getSignedUrl({ action: 'read', expires: '01-01-2035' });
      console.log("üì§ Link CV generado correctamente.");

      // 8. RECUPERAR DATOS DEL WEBHOOK
      const docRef = firestore.collection("CVs_staging").doc(safeId);
      const docSnap = await docRef.get();
      
      let datosZoho = { respuestas_filtro: {} };
      if (docSnap.exists) datosZoho = docSnap.data();
      else {
          // Fallback por si el mail llega antes que el webhook
          await docRef.set({ 
              id: safeId, 
              email: candidatoEmail, 
              nombre: "Candidato (Mail)", 
              origen: "mail_first",
              historial_movimientos: [
                  {
                      date: new Date().toISOString(),
                      event: 'Ingreso por Zoho',
                      detail: 'Candidato recibido desde formulario web (email lleg√≥ antes que webhook)',
                      usuario: 'Sistema (Email)'
                  }
              ]
          }, { merge: true });
      }

      // 9. LEER TEXTO DEL PDF (CR√çTICO: Aqu√≠ leemos el CV real)
      let pdfText = "";
      try {
          const pdfData = await pdfParse(pdfAttachment.content);
          pdfText = pdfData.text.slice(0, 20000); // Leemos hasta 20k caracteres
      } catch (e) { console.error("Error leyendo PDF:", e.message); }

      // 10. GENERAR RESE√ëAS (CV y Video si existe)
      console.log("üìù Generando rese√±a del CV...");
      const rese√±aCV = await generarResenaCV(pdfText, datosZoho.puesto || "General");
      
      let rese√±aVideo = null;
      let videoError = null;
      let videoLinkPublico = null;
      
      // Si hay video (del email o del webhook), procesarlo
      const videoUrlParaAnalizar = videoUrl || datosZoho.video_url;
      if (videoUrlParaAnalizar) {
        const origenVideo = videoUrl ? "adjunto en email (subido a Storage)" : "link del webhook";
        console.log(`üé• Procesando video y generando rese√±a... (Origen: ${origenVideo})`);
        const resultadoVideo = await generarResenaVideo(videoUrlParaAnalizar, datosZoho.puesto || "General");
        
        if (resultadoVideo.rese√±a) {
          rese√±aVideo = resultadoVideo.rese√±a;
          console.log("‚úÖ Rese√±a del video generada correctamente");
        } else {
          videoError = resultadoVideo.error;
          videoLinkPublico = resultadoVideo.linkPublico;
          console.log(`‚ö†Ô∏è ${videoError}`);
        }
      }

      // 11. IA CALIBRADA (Cruce de Datos: Formulario + CV + Video)
      console.log("ü§ñ Calibrando Score (Formulario + CV + Video)...");
      
      // Preparar datos del formulario para el an√°lisis
      const datosFormulario = JSON.stringify(datosZoho.respuestas_filtro || "Vacio");
      
      // Llamar a la funci√≥n mejorada que acepta rese√±as
      let analisisIA = { score: 50, motivos: "Pendiente", alertas: [] };
      try {
          analisisIA = await verificaConocimientosMinimos(
            datosZoho.puesto || "General",
            datosFormulario, // Respuestas del formulario
            "", // declaraciones (vac√≠o por ahora)
            rese√±aCV, // Rese√±a del CV
            rese√±aVideo // Rese√±a del video (puede ser null)
          );
          
          // Limitar score inicial a m√°ximo 80 (antes de la entrevista)
          analisisIA.score = Math.min(analisisIA.score, 80);
          
          // Si hay error con el video, agregar alerta
          if (videoError) {
            if (!Array.isArray(analisisIA.alertas)) {
              analisisIA.alertas = [];
            }
            analisisIA.alertas.push(`Video no procesado: ${videoError}`);
          }
      } catch (e) { 
          console.error("Error IA:", e.message);
          // Si falla el an√°lisis, mantener las rese√±as generadas
      }

      // 12. ACTUALIZAR BASE DE DATOS (Master Update)
      // Usamos .set con { merge: true } para asegurarnos de crear el 'stage' si no existe
      const updateData = {
        cv_url: publicCvUrl,
        tiene_pdf: true,
        ia_score: analisisIA.score,
        ia_motivos: analisisIA.motivos,
        ia_alertas: analisisIA.alertas || [],
        ia_status: "processed",
        
        // üî• ESTO ES LO QUE FALTABA: La etiqueta para el Frontend
        stage: datosZoho.stage || 'stage_1', 
        status_interno: datosZoho.status_interno || 'new',
        
        // Rese√±as generadas por IA
        rese√±a_cv: rese√±aCV,
        rese√±a_video: rese√±aVideo || null,
        video_error: videoError || null, // Error si el video no se pudo procesar
        video_link_publico: videoLinkPublico, // Si el link es p√∫blico o no
        
        actualizado_en: admin.firestore.FieldValue.serverTimestamp()
      };
      
      // Si encontramos un video adjunto, actualizamos el video_url
      // Solo si no existe ya un video_url del webhook (el link pegado tiene prioridad)
      if (videoUrl && !datosZoho.video_url) {
        updateData.video_url = videoUrl;
        updateData.video_tipo = "archivo";
        console.log(`‚úÖ Video URL actualizado desde email: ${videoUrl.substring(0, 50)}...`);
      } else if (videoUrl && datosZoho.video_url) {
        // Si ya hab√≠a un video_url del webhook (link pegado), lo mantenemos
        console.log(`‚ÑπÔ∏è Video URL ya existe desde webhook, manteniendo: ${datosZoho.video_url.substring(0, 50)}...`);
      }
      
      await docRef.set(updateData, { merge: true }); // 'merge: true' cuida de no borrar el nombre ni el email

    console.log(`‚úÖ [OK] ${safeId} actualizado. Score Final: ${analisisIA.score}`);
    await processedRef.set({ uid, status: "success", safeId, fecha: admin.firestore.FieldValue.serverTimestamp() });
  }
} catch (error) {
  console.error("‚ùå Error en analizarCorreos:", error);
} finally {
  if (client) {
    try {
      await client.logout();
    } catch (logoutError) {
      // Si la conexi√≥n ya se cerr√≥, ignoramos el error de logout
      if (logoutError.code !== 'NoConnection' && logoutError.code !== 'ClosedAfterConnectTLS') {
        console.error("‚ö†Ô∏è Error al cerrar conexi√≥n IMAP:", logoutError.message);
      }
    }
  }
}
}

/////////////////// Anlisis de candidatos /////////////////////



/* ==========================================================================
   üîç ENDPOINT DE B√öSQUEDA UNIFICADO (Corregido y Optimizado)
   ========================================================================== */
   /* ==========================================================================

   üîç ENDPOINT DE B√öSQUEDA (MEJORADO: ORDENA M√ÅS NUEVOS PRIMERO)

   ========================================================================== */

   app.get("/buscar", async (req, res) => {

    try {

      const { q = "", desde = null, hasta = null } = req.query;

      

      console.log(`üì° Solicitud de b√∫squeda recibida. Query: "${q}"`);

  

      // USAMOS LA VARIABLE MAESTRA
      let ref = admin.firestore().collection(MAIN_COLLECTION);

      const snap = await ref.orderBy('creado_en', 'desc').limit(100).get();
      

      if (snap.empty) return res.json({ resultados: [] });

  

      const bloqueados = await obtenerCandidatosBloqueados();

      const termino = q.toLowerCase().trim();

      

// --- INICIO BLOQUE REEMPLAZADO: MAPEO UNIFICADO ---
let candidatos = snap.docs.map(doc => {
  const data = doc.data();
  
  // 1. L√≥gica de ordenamiento temporal unificada
  let timestamp = 0;
  if (data.fecha_correo) {
      timestamp = new Date(data.fecha_correo).getTime();
  } else if (data.creado_en) {
      // Soporte para Timestamp de Firebase o string ISO
      timestamp = data.creado_en.toDate ? data.creado_en.toDate().getTime() : new Date(data.creado_en).getTime();
  } else if (data.fecha) {
      timestamp = new Date(data.fecha).getTime();
  }

  // 2. Recuperamos datos visuales y de ESTADO
  const nombreFinal = data.nombre || data.datos_personales?.nombre_completo || data.applicant_email || "Sin Nombre";
  const linkFinal = data.cv_url || data.cv_storage_path || null;

  return {
    id: doc.id,
    nombre: nombreFinal,
    email: data.email || data.applicant_email || "S/E",
    puesto: data.puesto || "Sin puesto",
    cv_url: linkFinal,
    
    // Fechas para ordenar y mostrar
    fecha_orden: timestamp, 
    fecha: data.fecha || data.creado_en, 

    // üî• PERSISTENCIA: Leemos las etiquetas reales de la DB
    stage: data.stage || 'stage_1',           
    status_interno: data.status_interno || 'new',
    assignedTo: data.assignedTo || null,      
    history: data.historial_movimientos || [], // <--- CRONOLOG√çA
    
    // Datos de IA y notas
    ia_score: data.ia_score || 0,
    ia_motivos: data.ia_motivos || data.motivo || "An√°lisis pendiente...", 
    ia_alertas: data.ia_alertas || [],
    video_url: data.video_url || null,
    video_tipo: data.video_tipo || null, // Tipo de video: "link" | "archivo" | "ninguno"
    respuestas_filtro: data.respuestas_filtro || {},
    motivo: data.motivo || "", 
    notes: data.notes || "",
    
    // Datos de gesti√≥n de entrevista y formularios
    meet_link: data.meet_link || null,
    informe_final_data: data.informe_final_data || null,
    respuestas_form2: data.respuestas_form2 || null,
    process_step_2_form: data.process_step_2_form || null,
    interview_transcript: data.transcripcion_entrevista || data.interview_transcript || null, // Mapeo para compatibilidad
    transcripcion_entrevista: data.transcripcion_entrevista || null, // Campo original para verificar si est√° analizada
    
    // Rese√±as generadas por IA
    rese√±a_cv: data.rese√±a_cv || null,
    rese√±a_video: data.rese√±a_video || null,
    video_error: data.video_error || null, // Error si el video no se pudo procesar
    video_link_publico: data.video_link_publico || null // Si el link es p√∫blico o no
  };
})
// --- FIN BLOQUE REEMPLAZADO ---

      .filter(c => {

        // 2. Filtrado por texto

        if (bloqueados.has(c.id.toLowerCase())) return false;

        if (!termino) return true; // Si no escribiste nada, devuelve todo

  

        const matchText = `${c.nombre} ${c.email} ${c.puesto}`.toLowerCase();

        return matchText.includes(termino);

      });

  

      // 3. ORDENAMIENTO FINAL (El n√∫mero m√°s grande = fecha m√°s reciente = va primero)

      candidatos.sort((a, b) => b.fecha_orden - a.fecha_orden);

  

      console.log(`‚úÖ Enviando ${candidatos.length} candidatos ordenados.`);

      res.json({ resultados: candidatos });

  

    } catch (err) {

      console.error("‚ùå Error en /buscar:", err);

      res.status(500).json({ error: "Error interno del servidor" });

    }

  });

// ==========================================================================
// üîÑ ENDPOINT: ACTUALIZACI√ìN DE ESTADO INTERNO (Optimizado)
// ==========================================================================
app.post("/candidatos/:id/resumen", async (req, res) => {
  try {
    const { id } = req.params;
    const { manualData, responsable } = req.body; 

    console.log(`ü§ñ Iniciando proceso de informe para: ${id}`);

    // --- CASO 1: MODO MANUAL (Candidatos externos o previos) ---
    if (id === 'manual_freelance' && manualData) {
        console.log("‚ö° Procesando Informe Manual Directo...");
        
        const informeManual = await generarDatosParaInforme(
            manualData.textoCV,
            manualData.puesto || "Perfil Externo",
            manualData.notas || "",
            {}, // form2 vac√≠o para manual
            "Generaci√≥n manual directa sin pipeline previo",
            responsable || "Admin"
        );

        if (!informeManual) {
            return res.status(500).json({ error: "Error de Gemini en proceso manual" });
        }

        return res.json(informeManual); // Enviamos directo al dashboard sin guardar en DB
    }

    // --- CASO 2: PROCESO IDEAL (Candidatos del Pipeline) ---
    const docRef = firestore.collection(MAIN_COLLECTION).doc(id);
    const doc = await docRef.get();
    
    if (!doc.exists) {
        return res.status(404).json({ error: "Candidato no encontrado en el pipeline." });
    }

    const data = doc.data();
    
    // Si ya existe un informe guardado y no pedimos regenerar, lo devolvemos
    if (data.informe_final_data && (!manualData || !manualData.forceRegenerate)) {
        console.log("üìÑ Devolviendo informe ya existente desde Firestore.");
        return res.json(data.informe_final_data);
    }

    // Si no hay informe, lo generamos usando los datos de Firestore
    const textoCV = manualData?.textoCV || data.texto_extraido || "";
    
    // Recolectar TODOS los datos del pipeline para el informe
    const notasStage1 = data.motivo || data.notes || "";
    const respuestasForm1 = data.respuestas_filtro || {};
    const respuestasForm2 = data.respuestas_form2?.data || {};
    const transcripcion = data.transcripcion_entrevista || "";
    const analisisPostEntrevista = data.ia_motivos || "";
    const alertasPostEntrevista = data.ia_alertas || [];
    
    // Combinar toda la informaci√≥n en un texto para la IA
    const notasCompletas = `
${notasStage1 ? `NOTAS INICIALES (Stage 1):\n${notasStage1}\n\n` : ''}
${Object.keys(respuestasForm1).length > 0 ? `RESPUESTAS FORMULARIO 1 (Zoho):\n${JSON.stringify(respuestasForm1, null, 2)}\n\n` : ''}
${transcripcion ? `TRANSCRIPCI√ìN DE ENTREVISTA:\n${transcripcion}\n\n` : ''}
${Object.keys(respuestasForm2).length > 0 ? `RESPUESTAS FORMULARIO 2 (Zoho - Validaci√≥n T√©cnica):\n${JSON.stringify(respuestasForm2, null, 2)}\n\n` : ''}
${analisisPostEntrevista ? `AN√ÅLISIS POST-ENTREVISTA:\n${analisisPostEntrevista}\n\n` : ''}
${alertasPostEntrevista.length > 0 ? `ALERTAS DETECTADAS:\n${alertasPostEntrevista.join(', ')}\n` : ''}
    `.trim();

    const informeGenerado = await generarDatosParaInforme(
        textoCV,
        data.puesto || data.oferta || "Candidato",
        notasCompletas, // Usar las notas combinadas de todo el pipeline
        respuestasForm2, // Form 2 como objeto separado (por si la funci√≥n lo necesita)
        analisisPostEntrevista, // An√°lisis post-entrevista
        responsable || data.assignedTo || "Admin"
    );

    if (informeGenerado) {
        // Guardamos el informe en Firestore para que ya quede entrelazado
        await docRef.update({ 
            informe_final_data: informeGenerado,
            report_generated: true,
            
            // HISTORIAL: Informe generado
            historial_movimientos: admin.firestore.FieldValue.arrayUnion({
                date: new Date().toISOString(),
                event: 'Informe Generado',
                detail: `Informe final generado por: ${responsable || data.assignedTo || "Admin"}`,
                usuario: responsable || data.assignedTo || "Admin"
            })
        });
        return res.json(informeGenerado);
    } else {
        return res.status(500).json({ error: "Error al generar el informe con Gemini." });
    }

  } catch (error) {
    console.error("‚ùå Error en ruta de resumen:", error);
    res.status(500).json({ error: "Error interno del servidor" });
  }
});




/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////7 comunicacion con el frontend ///////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////entrevistas ( actualizar) ////////////////////////////////////////

const ENTREV_COL = "entrevistas";

// normaliza para filtros "contains" case-insensitive
const _norm = (s) =>
  String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();

// fuerza entero [1..10]
function _clamp1to10(v) {
  const n = Math.round(Number(v));
  return Number.isFinite(n) ? Math.min(10, Math.max(1, n)) : 1;
}

/* ===================== LISTAR ====================== */
app.get("/entrevistas", async (req, res) => {
  try {
    const nameQ = _norm(req.query.name || "");
    const areaQ = _norm(req.query.area || "");

    const snap = await firestore.collection(ENTREV_COL).get();
    const out = [];
    for (const d of snap.docs) {
      const it = d.data() || {};
      const name = it.name || d.id || "";
      const area = it.area || "";
      const passName = !nameQ || _norm(name).includes(nameQ);
      const passArea = !areaQ || _norm(area).includes(areaQ);
      if (!passName || !passArea) continue;

      out.push({
        id: d.id,
        name,
        area,
        language: it.language || "es",
        createdAt: it.createdAt
          ? (it.createdAt.toMillis ? it.createdAt.toMillis() : it.createdAt)
          : null,
        analisis: it.analisis || null, // cache si existe
      });
    }
    res.json(out);
  } catch (err) {
    console.error("‚ùå /entrevistas (listar):", err);
    res.status(500).json({ error: "Error obteniendo entrevistas" });
  }
});

/* ===================== DETALLE ====================== */


app.get("/entrevistas/:id", async (req, res) => {
  try {
    const id = req.params.id;
    const ref = firestore.collection(ENTREV_COL).doc(id);
    const snap = await ref.get();
    if (!snap.exists) return res.status(404).json({ error: "Entrevista no encontrada" });

    const it = snap.data() || {};
    res.json({
      id: snap.id,
      name: it.name || snap.id,
      area: it.area || "",
      language: it.language || "es",
      text: it.text || it.transcripcion || "",
      createdAt: it.createdAt
        ? (it.createdAt.toMillis ? it.createdAt.toMillis() : it.createdAt)
        : null,
      analisis: it.analisis || null,
    });
  } catch (err) {
    console.error("‚ùå /entrevistas/:id (detalle):", err);
    res.status(500).json({ error: "Error obteniendo la entrevista" });
  }
});


async function analizarEntrevistaConIA(nombre, { force = false } = {}) {
  const ref = firestore.collection(ENTREV_COL).doc(nombre);
  const snap = await ref.get();
  if (!snap.exists) throw new Error(`No existe entrevista "${nombre}" en '${ENTREV_COL}'.`);

  const it = snap.data() || {};
  const name = it.name || nombre;
  const area = it.area || "No especificada";
  const text = it.text || it.transcripcion || "";

  if (!force && it.analisis && typeof it.analisis === "object") {
    return it.analisis; // devolver cache ya guardado
  }

  // ‚Äî‚Äî Guion de preguntas clave que debe cubrir la entrevista ‚Äî‚Äî //
  const cuestionario = `
1) Presentaci√≥n y motivaci√≥n/raz√≥n para postular.
2) Experiencia relevante (rol/proyecto que marc√≥ la trayectoria).
3) Situaci√≥n actual / b√∫squeda activa (por qu√© ahora).
4) Compromisos actuales (estudios/trabajo): confirmar DEDICACI√ìN FULL TIME y aceptaci√≥n de monitoreo continuo.
5) Procesos/Flujos de trabajo manejados.
6) Software/CRM conocidos.
7) Modalidad remota: organizaci√≥n del tiempo y cumplimiento diario.
8) Aptitud/actitud para el rol (c√≥mo debe ser la persona en esta √°rea).
9) Cierre: acuerdo con salario/condiciones/horario y dudas.
`.trim();

  // ‚Äî‚Äî PROMPT ROBUSTO ‚Äî‚Äî //
  const prompt = `
Eres evaluador senior de RRHH.
Analiza la ENTREVISTA transcrita (en espa√±ol) y devuelve SOLO JSON v√°lido.

DEBES:
- Puntuar con enteros 1‚Äì10: habilidades blandas (comunicaci√≥n, colaboraci√≥n, proactividad), t√©cnicos (acorde al rol), fit_cultural, disponibilidad.
- Evaluar CONSISTENCIA (1‚Äì10): qu√© tan directamente responde a lo que se pregunta y si sus respuestas son coherentes con las condiciones del rol (full time, monitoreo) y con lo que afirm√≥ antes.
- Construir una MATRIZ DE CONGRUENCIA por cada punto del cuestionario (respondio: true/false; evidencia: breve cita/par√°frasis).
- Detectar ALERTAS (strings): p.ej., "Doble compromiso", "No acepta monitoreo", "No acuerda salario/horario", "Respuestas vagas", "Contradicciones".

INTERPRETACI√ìN DE ‚ÄúNO‚Äù (REGLAS IMPORTANTES):
- Diferencia entre un "No" de cortes√≠a/cierre (p. ej., "No, no tengo preguntas", "No, gracias") y un "No" de RECHAZO expl√≠cito (p. ej., "No acepto el monitoreo", "No estoy de acuerdo con el horario completo", "No acepto el salario").
- Si detr√°s de un "No" el candidato dice algo como "Estoy de acuerdo con todo lo comentado", interpreta como ACEPTACI√ìN de condiciones.
- Solo marca alertas por rechazo si hay EXPRESI√ìN CLARA de rechazo. Evita falsos positivos por "No" sin contexto.

Contexto del rol: "${area}"
Candidato: "${name}"

CUESTIONARIO:
${cuestionario}

TRANSCRIPCI√ìN (solo respuestas del candidato):
"""
${text}
"""

Formato EXACTO:
{
  "nombre": "${name}",
  "area": "${area}",
  "habilidades_blandas": { "comunicacion": n, "colaboracion": n, "proactividad": n },
  "tecnicos": n,
  "fit_cultural": n,
  "disponibilidad": n,
  "consistencia": n,
  "congruencia": [
    { "item": "presentacion_motivacion", "respondio": true, "evidencia": "..." },
    { "item": "experiencia_relevante", "respondio": true, "evidencia": "..." },
    { "item": "situacion_actual", "respondio": true, "evidencia": "..." },
    { "item": "compromiso_fulltime_monitoreo", "respondio": true, "evidencia": "..." },
    { "item": "procesos_flujos", "respondio": true, "evidencia": "..." },
    { "item": "software_crm", "respondio": true, "evidencia": "..." },
    { "item": "remoto_organizacion", "respondio": true, "evidencia": "..." },
    { "item": "aptitud_actitud", "respondio": true, "evidencia": "..." },
    { "item": "cierre_condiciones", "respondio": true, "evidencia": "..." }
  ],
  "alertas": ["..."],
  "observaciones": "m√°x 280 chars"
}

Reglas:
- Todos los "n" enteros 1‚Äì10.
- Si el transcript no cubre un punto, respondio=false y evidencia="sin evidencia".
- S√© estricto con full time y aceptaci√≥n de monitoreo SOLO si hay rechazo expl√≠cito; si hay aceptaci√≥n global posterior, cu√©ntalo como aceptado.
- 'alertas' vac√≠o si no hay flags reales.
`.trim();

  const completion = await openai.chat.completions.create({
    model: process.env.AI_MODEL || "gpt-4o-mini",
    temperature: 0.1,
    response_format: { type: "json_object" },
    messages: [
      { role: "system", content: "Responde √∫nicamente en JSON v√°lido, sin explicaciones." },
      { role: "user", content: prompt },
    ],
  });

  // parseo robusto
  let parsed = {};
  try {
    const raw = completion?.choices?.[0]?.message?.content || "{}";
    parsed = JSON.parse(raw);
  } catch {
    parsed = {};
  }

  // clamp y seguros
  const h = parsed.habilidades_blandas || {};
  const comunicacion = _clamp1to10(h.comunicacion);
  const colaboracion = _clamp1to10(h.colaboracion);
  const proactividad = _clamp1to10(h.proactividad);
  const tecnicos = _clamp1to10(parsed.tecnicos);
  const fit_cultural = _clamp1to10(parsed.fit_cultural);
  const disponibilidad = _clamp1to10(parsed.disponibilidad);
  const consistencia = _clamp1to10(parsed.consistencia);

  const congruencia = Array.isArray(parsed.congruencia) ? parsed.congruencia : [];
  const alertas = Array.isArray(parsed.alertas) ? parsed.alertas.slice(0, 10) : [];

  // promedio PONDERADO (m√°s peso a disponibilidad y consistencia)
  const pesos = { soft: 1, tecnicos: 1, fit: 1, disp: 1.5, cons: 1.5 };
  const sumaPesos = pesos.soft + pesos.tecnicos + pesos.fit + pesos.disp + pesos.cons;
  const softAvg = (comunicacion + colaboracion + proactividad) / 3;

  const promedio = Math.round(((
    (softAvg * pesos.soft) +
    (tecnicos * pesos.tecnicos) +
    (fit_cultural * pesos.fit) +
    (disponibilidad * pesos.disp) +
    (consistencia * pesos.cons)
  ) / sumaPesos) * 10) / 10;

  const analisis = {
    nombre: name,
    area,
    habilidades_blandas: { comunicacion, colaboracion, proactividad },
    tecnicos,
    fit_cultural,
    disponibilidad,
    consistencia,
    congruencia,
    alertas,
    promedio,
    observaciones: String(parsed.observaciones || "").slice(0, 280),
    actualizadoEn: new Date().toISOString(),
  };

  // üíæ Guardar cache en el mismo documento de Firestore:
  // entrevistas/{nombre}.analisis
  await ref.set(
    { analisis, analizadoAt: admin.firestore.FieldValue.serverTimestamp() },
    { merge: true }
  );

  return analisis;
}

/* ===================== PUNTAJE ====================== */
app.get("/entrevistas/:nombre/puntaje", async (req, res) => {
  try {
    const force = String(req.query.force || "false") === "true";
    const analisis = await analizarEntrevistaConIA(req.params.nombre, { force });
    res.json(analisis);
  } catch (err) {
    console.error("‚ùå /entrevistas/:nombre/puntaje:", err);
    res.status(400).json({ error: err.message || "No fue posible obtener el puntaje" });
  }
});
/////// ENDPOINT: Obtener motivos de los candidatos (mejorado)///7

app.get('/motivos', async (req, res) => {
  try {
    const { nombre = '', estado = '' } = req.query;

    // Usa admin.firestore() directamente
    let query = admin.firestore().collection('cv_revisados');

    // Filtrar por estado si se especifica
    if (estado) {
      query = query.where('estado', '==', estado);
    }

    const snapshot = await query.get();
    if (snapshot.empty) {
      return res.json([]);
    }

    const motivos = [];

    snapshot.forEach((doc) => {
      const data = doc.data();

      // üîç B√∫squeda m√°s flexible: por correo, nombre_archivo, area, o dentro del texto del motivo
      const textoBusqueda = nombre.toLowerCase();

      const coincide =
        !nombre ||
        (data.applicant_email &&
          data.applicant_email.toLowerCase().includes(textoBusqueda)) ||
        (data.nombre &&
          data.nombre.toLowerCase().includes(textoBusqueda)) ||
        (data.nombre_archivo &&
          data.nombre_archivo.toLowerCase().includes(textoBusqueda)) ||
        (data.area &&
          data.area.toLowerCase().includes(textoBusqueda)) ||
        (data.motivos &&
          data.motivos.toLowerCase().includes(textoBusqueda)) ||
        (data.ia?.motivos &&
          data.ia.motivos.toLowerCase().includes(textoBusqueda));

      if (coincide) {
        motivos.push({
          id: doc.id,
          nombre:
            data.nombre_archivo ||
            data.applicant_email ||
            data.nombre ||
            'Desconocido',
          estado: data.estado || 'sin_estado',
          motivos:
            data.motivo ||
            data.ia?.motivos ||
            data.motivos ||
            'Sin motivo registrado',
          fecha:
            data.fecha ||
            data.createdAt ||
            (data.timestamp ? data.timestamp.toDate() : null) ||
            '',
        });
      }
    });

    // Ordenar por fecha (m√°s recientes primero)
    motivos.sort(
      (a, b) =>
        new Date(b.fecha || 0).getTime() - new Date(a.fecha || 0).getTime()
    );

    res.json(motivos);
  } catch (error) {
    console.error('‚ùå Error obteniendo motivos:', error);
    res
      .status(500)
      .json({ error: 'Error al obtener los motivos de revisi√≥n' });
  }
});

//////////mostrar carpetas de la bbase de datos////////

async function listPrefixes(prefix) {
  const bucket = getStorage().bucket();
  const [_, __, apiResponse] = await bucket.getFiles({
    prefix,
    delimiter: '/', // devuelve los subdirectorios directos
  });

  const prefixes = apiResponse?.prefixes || [];
  return prefixes.map(p => p.replace(prefix, '').replace(/\/$/, '')).filter(Boolean);
}

// Lista archivos dentro de una carpeta y genera URLs firmadas
async function listFilesWithSignedUrls(prefix, { nombre } = {}) {
  const bucket = getStorage().bucket();
  const [files] = await bucket.getFiles({ prefix });

  const out = [];
  for (const file of files) {
    if (file.name.endsWith('/')) continue; // ignora carpetas
    const baseName = file.name.split('/').pop(); // nombre del archivo sin ruta

    if (nombre && !baseName.toLowerCase().includes(nombre.toLowerCase())) continue;

    const [url] = await file.getSignedUrl({
      version: 'v4',
      action: 'read',
      expires: Date.now() + 15 * 60 * 1000,
    });

    out.push({ nombre: baseName, url });
  }

  return out;
}

// üîπ Obtiene los nombres de archivos ya clasificados en Firestore
async function obtenerNombresArchivados() {
  const colecciones = ['en_proceso', 'contratados', 'descartados', 'favoritos'];
  const nombres = new Set();

  for (const col of colecciones) {
    const snap = await firestore.collection(col).get(); // üîπ usa tu instancia global de Firestore
    if (snap.empty) continue;

    snap.forEach(doc => {
      const data = doc.data();

      // Campo normal
      if (data.nombre_archivo) {
        nombres.add(data.nombre_archivo.trim().toLowerCase());
      }

      // Caso especial: colecci√≥n "favoritos" (array de cvs)
      if (Array.isArray(data.cvs)) {
        data.cvs.forEach(nombre => {
          if (nombre && typeof nombre === 'string') {
            nombres.add(nombre.trim().toLowerCase());
          }
        });
      }
    });
  }

  console.log('üî• Archivos ya clasificados:', Array.from(nombres));
  return nombres;
}

// üîπ Endpoint: listar archivos con exclusi√≥n de los ya clasificados
app.get('/firebase-storage/archivos', verifyToken, async (req, res) => {
  try {
    const { carpeta, subcarpeta = '', nombre = '' } = req.query;
    if (!carpeta)
      return res.status(400).json({ error: 'Falta el nombre de la carpeta' });

    const prefix =
      `${ROOT_PREFIX}${carpeta}/` +
      (subcarpeta ? `${subcarpeta.replace(/^\/|\/$/g, '')}/` : '');

    // 1Ô∏è‚É£ Listar archivos del Storage
    const archivos = await listFilesWithSignedUrls(prefix, { nombre });

    // 2Ô∏è‚É£ Obtener los nombres archivados
    const nombresArchivados = await obtenerNombresArchivados();

    // 3Ô∏è‚É£ Filtrar los que ya existen en Firestore
    const filtrados = archivos.filter(
      a => !nombresArchivados.has(a.nombre.toLowerCase())
    );

    console.log(`üìÇ ${carpeta}: ${filtrados.length}/${archivos.length} archivos visibles`);
    res.json(filtrados);
  } catch (error) {
    console.error('Error al listar archivos:', error);
    res.status(500).json({ error: 'No se pudieron obtener los archivos.' });
  }
});

// üîπ Endpoint: listar carpetas de primer nivel
app.get('/firebase-storage/carpetas', verifyToken, async (req, res) => {
  try {
    const carpetas = await listPrefixes(ROOT_PREFIX);
    res.json(carpetas);
  } catch (error) {
    console.error('Error al listar carpetas:', error);
    res.status(500).json({ error: 'No se pudieron obtener las carpetas.' });
  }
});




//////////////////////// generador de fichas tecnicas ///////////////////////

function safeUnlink(p) {
  try {
    if (p && fs.existsSync(p)) fs.unlinkSync(p);
  } catch (_) { }
}

const upload = multer({
  dest: os.tmpdir(),
  limits: { fileSize: 16 * 1024 * 1024 }
});
const { execFile } = require("child_process");
const TEMPLATE_PATH = process.env.FICHA_TEMPLATE_PATH
  || path.join(__dirname, "plantillas", "Ficha_Template.docx");

function makeTmpDir(prefix = "ficha-") {
  const dir = fs.mkdtempSync(path.join(os.tmpdir(), prefix));
  return dir;
}

function countLines(s = '') {
  return (String(s).match(/\n/g) || []).length + (s ? 1 : 0);
}


function printLarge(label, s = '', preview = 1000) {
  console.log(label, {
    chars: s.length,
    lines: countLines(s),
    preview: s.slice(0, preview)
  });
}

app.post("/ficha_subida", upload.single("cv"), async (req, res) => {
  console.log("\n=== [/ficha_subida] INICIO ===");

  console.log("[REQ.body]", {
    keys: Object.keys(req.body || {}),
    conLogo: req.body?.conLogo,
    textoPegado_len: (req.body?.textoPegado || "").length,
  });

  console.log("[REQ.file]", {
    fieldname: req.file?.fieldname,
    originalname: req.file?.originalname,
    mimetype: req.file?.mimetype,
    path: req.file?.path,
    size: req.file?.size,
  });

  if (!STORAGE_READY) {
    return res.status(503).json({ error: "Storage no disponible." });
  }

  // üõ°Ô∏è AIRBAG: Si el usuario no escribe nada, enviamos un texto por defecto
  // para evitar que el script de Python falle por "texto vac√≠o".
  const textoPegado = (req.body?.textoPegado || "").trim() || "Informe generado sin notas adicionales del reclutador.";

  // Separamos esta l√≠nea para que quede ordenado
  const conLogo = String(req.body?.conLogo || "true").toLowerCase() !== "false";
  const file = req.file;

  if (!file?.path || !file?.originalname) {
    return res.status(400).json({ error: "Falta el archivo PDF ('cv')." });
  }

  const tmpToClean = [];
  const cleanAll = () => tmpToClean.forEach(safeUnlink);

  try {
    // Crear carpeta temporal
    const tmpDir = makeTmpDir("ficha-up-");
    tmpToClean.push(tmpDir);

    const extraTxtPath = path.join(tmpDir, "extra.txt");
    fs.writeFileSync(extraTxtPath, textoPegado || "", "utf8");

    // Carpeta de salida para el DOCX
    const outdir = makeTmpDir("ficha-out-");
    tmpToClean.push(outdir);

    // Nombre base del archivo (sin extensi√≥n)
    const baseRaw = path.basename(file.originalname).replace(/\.pdf$/i, "");
    const base = baseRaw.replace(/[\\/:*?"<>|]/g, "_").slice(0, 60);

    // Construir argumentos EXACTOS que ficha2.py espera
    const PYTHON_BIN = process.env.PYTHON_BIN || "python";

    const args = [
      path.join(__dirname, "ficha2.py"),
      "--outdir", outdir,
      "--basename", base,
      "--extra_file", extraTxtPath,
      "--cv", file.path
    ];

    // A√±adir logo si corresponde
    if (conLogo) {
      const logoPath = path.join(__dirname, "logo.png");
      if (fs.existsSync(logoPath)) args.push("--logo", logoPath);
    }

    console.log("[EJECUTANDO Python]", { PYTHON_BIN, args });

    const execOpts = {
      cwd: __dirname,
      windowsHide: true,
      maxBuffer: 1024 * 1024 * 16,
      env: { ...process.env, PYTHONIOENCODING: "utf-8" },
    };

    // Ejecutar Python
    await new Promise((resolve) => {
      const child = child_process.spawn(PYTHON_BIN, args, execOpts);
      let stdout = "",
        stderr = "";

      child.stdout.on("data", (d) => (stdout += d.toString("utf8")));
      child.stderr.on("data", (d) => (stderr += d.toString("utf8")));

      child.on("close", async (code) => {
        console.log("[ficha2.py exit]", { code, stderr });

        try {
          if (code !== 0) throw new Error("ficha2.py no termin√≥ OK");

          const result = JSON.parse(stdout || "{}");

          const localDocx = result.docx && fs.existsSync(result.docx)
            ? result.docx
            : null;

          if (!localDocx) {
            cleanAll();
            return res.status(500).json({ error: "No se gener√≥ el archivo .docx." });
          }

          // Subir DOCX a Firebase
          const ts = new Date().toISOString().replace(/[:.]/g, "-");
          const dest = `fichas-generadas/${base}/${ts}/${path.basename(localDocx)}`;

          await bucket.upload(localDocx, {
            destination: dest,
            metadata: {
              contentType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            },
          });

          // URL firmada 10 min
          const [urlDocx] = await bucket.file(dest).getSignedUrl({
            version: "v4",
            action: "read",
            expires: Date.now() + 10 * 60 * 1000,
            responseDisposition: `attachment; filename="${path.basename(dest)}"`,
          });

          cleanAll();

          return res.json({
            message: "‚úÖ Ficha generada (Word)",
            url: urlDocx,
            storagePath: dest,
          });

        } catch (e) {
          console.error("[ERROR procesando salida ficha2.py]", e);
          cleanAll();
          return res.status(500).json({ error: "Error generando la ficha." });
        }

        resolve();
      });
    });

  } catch (e) {
    console.error("[ERROR interno /ficha_subida]", e);
    cleanAll();
    return res.status(500).json({ error: "Error interno del servidor." });
  }
});



app.post('/ficha_recibida', async (req, res) => {
  console.log('== [/ficha_recibida] INICIO ===');
  try {
    const { textoPegado, nombreCV, conLogo } = req.body || {};
    if (!nombreCV) return res.status(400).json({ error: 'Falta el nombre del CV.' });

    // Limpieza y normalizaci√≥n del nombre
    const cleanName = nombreCV.trim().toLowerCase().replace(/\s+/g, ' ');
    console.log('[REQ.body]', { textoPegado_preview: textoPegado?.slice(0, 200), nombreCV });

    // Crear carpeta temporal
    const tmpDir = makeTmpDir('ficha-recibida-');
    console.log('[Temp dir creado]', { tmpDir });

    const bucket = getStorage().bucket();
    const searchPrefix = `${ROOT_PREFIX}`; // Buscar en todo el prefijo ra√≠z (no solo cv-subidos)
    console.log('[Buscando en prefijo]', { searchPrefix });

    // üîπ Buscar TODOS los archivos PDF dentro del prefijo
    const [files] = await bucket.getFiles({ prefix: searchPrefix });
    const pdfs = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));

    // üîπ Normalizar nombres para comparaci√≥n flexible
    const normalize = s =>
      s.toLowerCase()
        .replace(/[_\-\.]+/g, ' ') // reemplaza guiones, underscores y puntos
        .replace(/\.pdf$/, '')     // quita extensi√≥n
        .trim();

    // üîπ Buscar coincidencia m√°s cercana
    let matchedFile = null;
    for (const file of pdfs) {
      const base = file.name.split('/').pop();
      if (!base) continue;

      const normBase = normalize(base);
      if (normBase.includes(cleanName) || cleanName.includes(normBase)) {
        matchedFile = file;
        break;
      }
    }

    if (!matchedFile) {
      console.error('[ERROR] No se encontr√≥ archivo que coincida con', nombreCV);
      return res.status(404).json({
        error: `No se encontr√≥ ning√∫n PDF en Storage que coincida con "${nombreCV}".`
      });
    }

    console.log('[Archivo encontrado]', { matchedName: matchedFile.name });

    // Descargar el archivo
    const tmpPdfPath = path.join(tmpDir, path.basename(matchedFile.name));
    await matchedFile.download({ destination: tmpPdfPath });
    console.log('[Descarga completada]', { tmpPdfPath });

    // Escribir el texto adicional
    const extraTxtPath = path.join(tmpDir, 'extra.txt');
    fs.writeFileSync(extraTxtPath, textoPegado || '');
    console.log('[Extra escrito]', { extraTxtPath });

    // Crear carpeta de salida
    const outDir = makeTmpDir('ficha-out-');

    // Ejecutar Python
    const PYTHON_BIN = process.env.PYTHON_BIN || 'python3';
    const args = [
      path.join(__dirname, 'ficha.py'),
      '--outdir', outDir,
      '--basename', path.basename(matchedFile.name, '.pdf'),
      '--cv', tmpPdfPath,
      '--extra_file', extraTxtPath,
      '--no-pdf'
    ];

    if (conLogo) {
      const logoPath = path.join(__dirname, 'logo.png');
      if (fs.existsSync(logoPath)) args.push('--logo', logoPath);
    }

    console.log('[EJECUTANDO Python]', { PYTHON_BIN, args });

    const { spawn } = require('child_process');
    const child = spawn(PYTHON_BIN, args, { cwd: __dirname, env: process.env });

    let stdout = '', stderr = '';
    child.stdout.on('data', d => (stdout += d.toString()));
    child.stderr.on('data', d => (stderr += d.toString()));

    child.on('close', async code => {
      if (code !== 0) {
        console.error('[ERROR Python]', { code, stderr });
        return res.status(500).json({ error: 'Error al generar la ficha (Python fall√≥).' });
      }

      console.log('[Python completado OK]');
      const docxFiles = fs.readdirSync(outDir).filter(f => f.endsWith('.docx'));
      if (docxFiles.length === 0) {
        return res.status(500).json({ error: 'No se gener√≥ ning√∫n archivo .docx.' });
      }

      const finalDocxPath = path.join(outDir, docxFiles[0]);
      const destName = `fichas-generadas/${Date.now()}-${docxFiles[0]}`;
      const destFile = bucket.file(destName);
      await bucket.upload(finalDocxPath, { destination: destName });
      console.log('[DOCX subido al bucket]', { destName });

      // URL firmada para descarga y previsualizaci√≥n
      const [url] = await destFile.getSignedUrl({
        version: 'v4',
        action: 'read',
        expires: Date.now() + 15 * 60 * 1000
      });

      res.json({ url });
    });
  } catch (e) {
    console.error('[ERROR interno /ficha_recibida]', { e, stack: e.stack });
    res.status(500).json({ error: e.message || 'Error interno en /ficha_recibida' });
  }
});









const calendarRoutes = require("./calendar");
app.use("/calendar", calendarRoutes);






app.get("/firebase-storage/carpetas", async (req, res) => {
  try {
    const [files] = await bucket.getFiles({ delimiter: "/" });

    const carpetas = files.prefixes || [];

    // Limpiar nombres
    const nombres = carpetas.map(c => c.replace(/\/$/, ""));

    res.json(nombres);
  } catch (err) {
    console.error("‚ùå Error listando carpetas:", err);
    res.status(500).json({ error: "No se pudieron obtener las carpetas" });
  }
});

app.get("/firebase-storage/archivos", async (req, res) => {
  try {
    const { carpeta, nombre = "" } = req.query;
    if (!carpeta) return res.status(400).json({ error: "Carpeta requerida" });

    const prefix = `${carpeta}/`;

    // Obtener todos los archivos de Storage
    const [files] = await bucket.getFiles({ prefix });

    // Obtener IDs ya usados
    const bloqueados = await obtenerCandidatosBloqueados();

    // Filtrar
    const filtrados = files
      .filter(f => {
        const archivo = f.name.replace(prefix, "").trim().toLowerCase();

        const coincide = archivo.includes(nombre.toLowerCase());
        const estaBloqueado = bloqueados.has(archivo);

        // Solo mostrar SI NO est√° bloqueado
        return coincide && !estaBloqueado;
      })
      .map(f => ({
        nombre: f.name.replace(prefix, ""),
        url: f.publicUrl()
      }));

    res.json(filtrados);
  } catch (err) {
    console.error("‚ùå Error listando archivos:", err);
    res.status(500).json({ error: "No se pudieron obtener los archivos" });
  }
});






//////////////////////// botones para mover entre listas ///////////////////////////////////

/////////////////////////////////////  LISTAS: en_proceso / contratados / descartados  ////////////////////////
const LIST_COLLECTIONS = ["en_proceso", "contratados", "descartados"];

function ensureListName(name) {
  if (!LIST_COLLECTIONS.includes(name)) {
    throw new Error(`Lista inv√°lida: ${name}`);
  }
  return name;
}

/**
 * GET /listas
 * query:
 * - lista (opcional)
 */
app.get("/listas", async (req, res) => {
  try {
    const { lista } = req.query;

    const listasAConsultar = lista
      ? [ensureListName(lista)]
      : LIST_COLLECTIONS;

    const resultado = {};

    for (const col of listasAConsultar) {
      const snap = await firestore.collection(col).get();
      const items = [];

      snap.forEach((doc) => {
        const data = doc.data();
        items.push({
          id: doc.id,
          nombre: data.nombre_archivo || data.nombre || data.applicant_email,
          oferta: data.oferta || data.area,
          correo: data.applicant_email,
          lista: col,
          motivo: data.motivo || null,
          fecha: data.fecha || data.fecha_correo || null,
          movido_por: data.movido_por || null,
          movido_en: data.movido_en || null,
        });
      });

      resultado[col] = items;
    }

    res.json(resultado);
  } catch (err) {
    console.error("‚ùå GET /listas:", err);
    res.status(500).json({ error: "Error obteniendo listas" });
  }
});

// * POST /listas/mover
// * Mueve candidato entre listas y registra usuario que movi√≥.
app.post("/listas/mover", async (req, res) => {
  try {
    const { id, from, to, motivo = "", usuario = "" } = req.body;

    if (!id || !from || !to) {
      return res.status(400).json({ error: "Faltan datos obligatorios" });
    }

    const fromCol = ensureListName(from);
    const toCol = ensureListName(to);

    // --- CAMBIO CLAVE AQU√ç ---
    // En lugar de usar serverTimestamp (que da problemas al leer),
    // usamos una fecha de texto universal (ISO) que el navegador entiende perfecto.
    const nowISO = new Date().toISOString();
    // -------------------------

    const refFrom = firestore.collection(fromCol).doc(id);
    const snap = await refFrom.get();

    let data = {};

    if (snap.exists) {
      // Caso normal: el candidato YA existe.
      if (fromCol === toCol) {
        return res.status(400).json({ error: "Origen y destino iguales" });
      }
      data = snap.data();
    } else {
      // Caso Gesti√≥n Manual: creamos registro m√≠nimo.
      data = {
        id,
        nombre_archivo: id,
        creado_desde: "manual",
        creado_en: nowISO, // Usamos la fecha texto
      };
    }

    const newData = {
      ...data,
      origen_lista: fromCol,
      movido_por: usuario || "desconocido",
      movido_en: nowISO,      // ‚úÖ Fecha texto (arregla el Invalid Date)
      actualizado_en: nowISO, // ‚úÖ Fecha texto
    };

    // Si destino es descartados, requiere motivo
    if (toCol === "descartados") {
      if (!motivo.trim()) {
        return res.status(400).json({ error: "Motivo requerido" });
      }
      newData.motivo = motivo.trim();
    }

    // Si destino es contratados, registrar fecha
    if (toCol === "contratados" && !newData.fecha_contratacion) {
      newData.fecha_contratacion = nowISO;
    }

    const historialPrevio = Array.isArray(data.historial_movimientos)
      ? data.historial_movimientos
      : [];

    // Historial de movimientos
    newData.historial_movimientos = [
      ...historialPrevio,
      {
        usuario: usuario || "desconocido",
        de: fromCol,
        a: toCol,
        motivo: toCol === "descartados" ? motivo.trim() : null,
        fecha: nowISO, // ‚úÖ Fecha texto para el historial tambi√©n
      },
    ];

    // Guardamos en la lista destino
    await firestore.collection(toCol).doc(id).set(newData, { merge: true });

    // Borramos de la lista origen si exist√≠a
    if (snap.exists) {
      await refFrom.delete();
    }

    res.json({
      ok: true,
      id,
      from: fromCol,
      to: toCol,
      creadoDesdeManual: !snap.exists,
    });
  } catch (err) {
    console.error("‚ùå POST /listas/mover:", err);
    res.status(500).json({ error: "Error moviendo candidato" });
  }
});


///////////////////////boton buscar candidato//////////////////////





async function registrarConsultaCandidato(usuario, candidatoId) {
  await firestore.collection("metricas_consultas").add({
    usuario,
    candidatoId,
    fecha: admin.firestore.Timestamp.now(),
  });
}
async function obtenerBloqueados() {
  const snap = await firestore.collection("candidatos_bloqueados").get();
  const map = {};

  snap.forEach(d => {
    const data = d.data();
    map[d.id] = data;
  });

  return map;
}
async function bloquearCandidatosParaUsuario(usuario, candidatos) {
  const ahora = Date.now();
  const expira = ahora + 5 * 60 * 1000; // 5 min

  for (const c of candidatos) {
    await firestore.collection("candidatos_bloqueados")
      .doc(c.id)
      .set({
        usuario,
        candidatoId: c.id,
        bloqueadoDesde: ahora,
        expira,
      });
  }
}
async function limpiarBloqueosExpirados() {
  const ahora = Date.now();
  const snap = await firestore.collection("candidatos_bloqueados").get();

  for (const d of snap.docs) {
    if (d.data().expira < ahora) {
      await d.ref.delete();
    }
  }
}
async function obtenerCandidatosMovidos() {
  const estados = ["en_proceso", "contratados", "descartados"];
  const movidos = new Set();

  for (const est of estados) {
    const snap = await firestore.collection(est).get();
    snap.forEach(d => movidos.add(d.id));
  }

  return movidos;
}


app.get("/resumen/:id", async (req, res) => {
  try {
    const id = req.params.id;
    // Buscamos en la colecci√≥n correcta 'CVs_aprobados'
    const snap = await firestore.collection(MAIN_COLLECTION).doc(id).get();
    
    if (!snap.exists) return res.json({ resumen: "Candidato no encontrado" });
    const c = snap.data();

    // Contexto para el Bot Redactor
    const fuente = `
      PERFIL: ${c.nombre || "N/A"}
      PUESTO: ${c.puesto || "N/A"}
      EXPERIENCIA: ${JSON.stringify(c.experiencia || []).slice(0, 2000)}
      HABILIDADES: ${JSON.stringify(c.habilidades || {})}
    `;

    // INSTRUCCIONES PARA EL BOT REDACTOR üëá
    const prompt = `
      Act√∫a como Consultor Senior de RRHH. Redacta un informe ejecutivo breve (max 10 lineas) sobre este candidato.
      Estructura:
      1. Perfil Profesional (Resumen de impacto).
      2. Fortalezas Clave (Listado breve).
      3. Recomendaci√≥n (Por qu√© contratarlo).
      
      Usa un tono formal y persuasivo.
      DATOS: ${fuente}
    `;

    // Usamos Gemini
    const result = await model.generateContent(prompt);
    const resumen = result.response.text();

    return res.json({ resumen });

  } catch (err) {
    console.error("‚ùå Error generando resumen:", err.message);
    return res.status(500).json({ error: "Error al generar informe con IA" });
  }
});

/////////////////////////////////////  M√âTRICAS PARA PANEL  /////////////////////////////////////
const db = admin.firestore();
app.get("/panel/metrics", async (req, res) => {
  try {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    /* ===========================================================
       üîµ M√âTRICAS FINALES
       =========================================================== */

    const totals = {
      enProceso: 0,
      contratados: 0,
      descartados: 0,
      aprobados: 0,
      rechazados: 0,
    };

    const porDia = {};

    /* ===========================================================
       üîµ 1. LEER APROBADOS / RECHAZADOS DESDE cv_revisados
       =========================================================== */

    const revisadosSnap = await firestore.collection("cv_revisados").get();

    revisadosSnap.forEach((doc) => {
      const data = doc.data();
      if (!data) return;

      const estado = (data.estado || "").toLowerCase();

      if (estado === "aprobado") totals.aprobados++;
      if (estado === "rechazado") totals.rechazados++;

      const fechaRef = data.fecha_movimiento || data.creado_en;
      if (!fechaRef) return;

      const fecha = fechaRef.toDate().toISOString().split("T")[0];

      if (!porDia[fecha]) {
        porDia[fecha] = {
          enProceso: 0,
          contratados: 0,
          descartados: 0,
          aprobados: 0,
          rechazados: 0,
        };
      }

      if (estado === "aprobado") porDia[fecha].aprobados++;
      if (estado === "rechazado") porDia[fecha].rechazados++;
    });

    /* ===========================================================
       üîµ 2. LEER LISTAS REALES
       =========================================================== */

    const enProcesoSnap = await firestore.collection("en_proceso").get();
    const contratadosSnap = await firestore.collection("contratados").get();
    const descartadosSnap = await firestore.collection("descartados").get();

    totals.enProceso = enProcesoSnap.size;
    totals.contratados = contratadosSnap.size;
    totals.descartados = descartadosSnap.size;

    /* ===========================================================
       üîµ 3. M√âTRICAS POR USUARIO (consultas y movimientos)
       =========================================================== */

    const consultasSnap = await firestore
      .collection("metricas_consultas")
      .where("fecha", ">=", hoy)
      .get();

    const movimientosSnap = await firestore
      .collection("metricas_movimientos")
      .where("fecha", ">=", hoy)
      .get();

    const usuariosSet = new Set();
    const detalleUsuarios = {};

    consultasSnap.forEach((d) => {
      const { usuario, fecha } = d.data() || {};
      if (!usuario) return;

      usuariosSet.add(usuario);

      if (!detalleUsuarios[usuario]) {
        detalleUsuarios[usuario] = {
          email: usuario,
          consultas: 0,
          movimientos: 0,
          ultimaActividad: null
        };
      }

      detalleUsuarios[usuario].consultas++;
      detalleUsuarios[usuario].ultimaActividad = fecha?.toDate().toLocaleString();
    });

    movimientosSnap.forEach((d) => {
      const { usuario, fecha } = d.data() || {};
      if (!usuario) return;

      usuariosSet.add(usuario);

      if (!detalleUsuarios[usuario]) {
        detalleUsuarios[usuario] = {
          email: usuario,
          consultas: 0,
          movimientos: 0,
          ultimaActividad: null
        };
      }

      detalleUsuarios[usuario].movimientos++;
      detalleUsuarios[usuario].ultimaActividad = fecha?.toDate().toLocaleString();
    });

    /* ===========================================================
       üîµ 4. RESPUESTA FINAL
       =========================================================== */

    res.json({
      totals,
      porDia,
      totalUsuarios: usuariosSet.size,
      usuariosActivosHoy: usuariosSet.size,
      consultasHoy: consultasSnap.size,
      movimientosHoy: movimientosSnap.size,
      detalleUsuarios: Object.values(detalleUsuarios)
    });

  } catch (err) {
    console.error("ERROR en /panel/metrics:", err);
    res.status(500).json({ error: "Error obteniendo m√©tricas" });
  }
});




async function parsearBusquedaIA(query) {
  if (!query || !query.trim()) {
    return {
      area_requerida: "",
      areas_afines: [],
      habilidades_tecnicas: [],
      experiencia_minima_anios: 0,
      nivel_ingles: "",
      modalidad: "",
      ubicacion_preferida: "",
      palabras_clave: []
    };
  }

  const prompt = `
Eres un asistente de recursos humanos. Analiza esta b√∫squeda y extrae los requisitos estructurados.

B√öSQUEDA: "${query}"

Devuelve SOLO JSON v√°lido con este formato EXACTO:
{
  "area_requerida": "√°rea principal del puesto (ej: 'dise√±o gr√°fico', 'desarrollo web', 'asistente virtual')",
  "areas_afines": ["√°rea1", "√°rea2"],
  "habilidades_tecnicas": ["habilidad1", "habilidad2"],
  "experiencia_minima_anios": n√∫mero o 0,
  "nivel_ingles": "b√°sico|intermedio|avanzado|nativo o vac√≠o",
  "modalidad": "remoto|presencial|h√≠brido o vac√≠o",
  "ubicacion_preferida": "ciudad/pa√≠s o vac√≠o",
  "palabras_clave": ["palabra1", "palabra2"]
}

EJEMPLOS:

B√∫squeda: "Necesito un dise√±ador gr√°fico con 3 a√±os de experiencia en Photoshop e Illustrator"
Respuesta:
{
  "area_requerida": "dise√±o gr√°fico",
  "areas_afines": ["dise√±o digital", "dise√±o web", "creativo"],
  "habilidades_tecnicas": ["photoshop", "illustrator", "adobe"],
  "experiencia_minima_anios": 3,
  "nivel_ingles": "",
  "modalidad": "",
  "ubicacion_preferida": "",
  "palabras_clave": ["dise√±o", "gr√°fico", "photoshop", "illustrator"]
}

B√∫squeda: "Asistente virtual biling√ºe para soporte al cliente, trabajo remoto"
Respuesta:
{
  "area_requerida": "asistente virtual",
  "areas_afines": ["atenci√≥n al cliente", "soporte", "customer service"],
  "habilidades_tecnicas": ["crm", "comunicaci√≥n", "gesti√≥n"],
  "experiencia_minima_anios": 0,
  "nivel_ingles": "avanzado",
  "modalidad": "remoto",
  "ubicacion_preferida": "",
  "palabras_clave": ["asistente", "virtual", "biling√ºe", "soporte", "cliente"]
}
`;

  try {
    const completion = await openai.chat.completions.create({
      model: AI_MODEL,
      temperature: 0.2,
      response_format: { type: "json_object" },
      messages: [
        { role: "system", content: "Devuelve SOLO JSON v√°lido sin texto adicional." },
        { role: "user", content: prompt }
      ],
    });

    const result = JSON.parse(completion.choices[0].message.content);

    // Validaci√≥n y normalizaci√≥n
    return {
      area_requerida: normStr(result.area_requerida || ""),
      areas_afines: (result.areas_afines || []).map(normStr),
      habilidades_tecnicas: (result.habilidades_tecnicas || []).map(normStr),
      experiencia_minima_anios: Number(result.experiencia_minima_anios) || 0,
      nivel_ingles: normStr(result.nivel_ingles || ""),
      modalidad: normStr(result.modalidad || ""),
      ubicacion_preferida: normStr(result.ubicacion_preferida || ""),
      palabras_clave: (result.palabras_clave || []).map(normStr)
    };

  // ... (aqu√≠ termina el cierre de la funci√≥n parsearBusquedaIA) ...
} catch (err) {
  console.error("‚ùå Error en parsearBusquedaIA:", err);
  return {
    area_requerida: "",
    areas_afines: [],
    habilidades_tecnicas: [],
    experiencia_minima_anios: 0,
    nivel_ingles: "",
    modalidad: "",
    ubicacion_preferida: "",
    palabras_clave: []
  };
}
}
// ====================================================================
// üß† CEREBRO V3: BLINDADO PARA NOTAS VAGAS O DESESTRUCTURADAS
// ====================================================================
async function generarDatosParaInforme(textoCV, puesto, notas, form2, analisisPrevio, responsable) {
  try {
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    const prompt = `
      Act√∫a como un Consultor Senior de RRHH y Redactor de Informes Corporativos.
      Tu misi√≥n es transformar notas crudas (a veces vagas o desordenadas) en un INFORME EJECUTIVO ESTRUCTURADO Y PROFESIONAL.

      --- FUENTES DE INFORMACI√ìN ---
      1. **NOTAS DEL RECLUTADOR (PRIORIDAD TOTAL - 90%):** "${notas}"
         *Instrucci√≥n:* Estas notas contienen la verdad sobre el candidato. Extrae de aqu√≠: nivel de ingl√©s real, disponibilidad, skills t√©cnicas validadas y habilidades blandas observadas. Si el texto es un p√°rrafo corrido, DESGL√ìSALO.

      2. **CV DEL CANDIDATO (APOYO - 10%):** "${textoCV.slice(0, 20000)}"
         *Instrucci√≥n:* √ösalo SOLO para rellenar datos duros que no est√©n en las notas (Nombre completo, T√≠tulo universitario exacto, Ubicaci√≥n, Nombres de empresas anteriores).

      --- REGLAS DE PROCESAMIENTO INTELIGENTE ---
      - **Detecci√≥n de Skills:** Si las notas dicen "dominio s√≥lido en Python", agr√©galo a Competencias T√©cnicas con nivel "Alto" o "Avanzado".
      - **Detecci√≥n de Idiomas:** Si las notas dicen "Ingl√©s C1" o "se desenvolvi√≥ natural", pon "Avanzado (C1)" en la ficha.
      - **Soft Skills:** Si las notas dicen "resolutivo" o "excelente comunicaci√≥n", agr√©galas a Habilidades Blandas con nivel "Alto".
      - **Niveles Num√©ricos (HERRAMIENTAS):** Si es 'Avanzado/Experto' usa 90-100%, 'S√≥lido/Intermedio' 70-80%, 'B√°sico' 30-40%.
      - **Plus:** Si las notas mencionan "punto fuerte" o ventajas log√≠sticas (remoto, disponibilidad), ponlo en la secci√≥n Plus.
      - **Estilo:** Usa un lenguaje corporativo formal. Evita frases como "el candidato dijo", usa afirmaciones directas ("Posee un perfil...").

      --- FORMATO DE SALIDA (JSON) ---
      Responde SOLO con este JSON:
      {
        "nombre": "Nombre Completo",
        "puesto": "${puesto}",
        "resumen_ejecutivo": "Redacci√≥n profesional de 5-8 l√≠neas integrando perfil, experiencia y las fortalezas mencionadas en las notas.",
        "ficha_tecnica": {
           "ubicacion": "Ciudad/Pa√≠s (del CV)",
           "nivel_experiencia": "Senior/Semi/Junior (deducido de notas o CV)",
           "formacion_formal": "T√≠tulo Principal (del CV)",
           "nivel_ingles": "Nivel Validado (de las NOTAS, ej: C1 Avanzado)",
           "disponibilidad": "Dato de las NOTAS (ej: Inmediata)"
        },
        "competencias_tecnicas": [
            {"competencia": "Skill T√©cnica 1 (ej: Python)", "nivel": "Nivel deducido (ej: Alto)"},
            {"competencia": "Skill T√©cnica 2 (ej: Orquestaci√≥n IA)", "nivel": "Nivel deducido (ej: Alto)"}
        ],
        "habilidades_blandas": [
            {"habilidad": "Soft Skill 1 (ej: Comunicaci√≥n)", "nivel": "Alto"},
            {"habilidad": "Soft Skill 2 (ej: Resolutividad)", "nivel": "Alto"}
        ],
        "herramientas": [
    {"herramienta": "Software mencionado", "nivel": "Estimaci√≥n 0-100% (ej: 85%)"}
],
        "plus": "Redacta aqu√≠ los 'Puntos fuertes' o ventajas log√≠sticas de las notas (ej: Capacidad de traducci√≥n t√©cnica-negocio).",
        "formacion_sugerida": "Si las notas mencionan gaps (ej: falta tal cosa), ponlo aqu√≠. Si no, pon 'Ninguna requerida actualmente'.",
        "conclusion_final": "Veredicto profesional basado en el tono de las notas (ej: Perfil altamente recomendado por su solidez t√©cnica y soft skills).",
        "responsable": "${responsable}"
      }
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();
    
    // Limpieza extra por si Gemini mete texto antes del JSON
    const jsonStart = text.indexOf('{');
    const jsonEnd = text.lastIndexOf('}');
    if (jsonStart !== -1 && jsonEnd !== -1) {
        text = text.substring(jsonStart, jsonEnd + 1);
    }

    return JSON.parse(text);

  } catch (error) {
    console.error("‚ùå Error IA (Cerebro V3):", error);
    return { nombre: "Error al procesar", resumen_ejecutivo: "Hubo un error interpretando las notas. Intente ser m√°s espec√≠fico." };
  }
}

// --- RUTAS ---

// ====================================================================
// üìÑ GENERADOR WORD V3 (MOTOR DE PLANTILLAS - EDICI√ìN VISUAL)
// ====================================================================
app.post("/download-docx", async (req, res) => {
  try {
      const data = req.body;
      console.log("üìù Generando Word con plantilla para:", data.nombre);

      // 1. CARGAR LA PLANTILLA
      // Busca 'plantilla.docx' en la carpeta ra√≠z
      const content = fs.readFileSync(path.resolve(__dirname, "plantilla.docx"), "binary");
      const zip = new PizZip(content);

      // 2. INICIALIZAR EL MOTOR
      const doc = new Docxtemplater(zip, {
          paragraphLoop: true,
          linebreaks: true,
      });

      // 3. PREPARAR DATOS (Mapeo exacto a las etiquetas de tu Word)
      // La fecha se genera en el momento
      const fechaHoy = new Date().toLocaleDateString("es-ES", { year: 'numeric', month: 'long', day: 'numeric' });

      const payload = {
          fecha: fechaHoy,
          nombre: data.nombre || "Candidato",
          puesto: data.puesto || "-",
          
          // Resumen (con fallback por si viene con otro nombre)
          resumen_ejecutivo: data.resumen_ejecutivo || data.resumen_profesional || "",
          
          // Ficha T√©cnica (Manejo seguro de nulos)
          ubicacion: data.ficha_tecnica?.ubicacion || "-",
          experiencia: data.ficha_tecnica?.nivel_experiencia || "-",
          formacion: data.ficha_tecnica?.formacion_formal || data.ficha_tecnica?.formacion || "-",
          ingles: data.ficha_tecnica?.nivel_ingles || data.ficha_tecnica?.idiomas || "-",
          disponibilidad: data.ficha_tecnica?.disponibilidad || "-",

          // Tablas (Arrays para los bucles)
          // Si no hay datos, enviamos array vac√≠o para que no rompa
          competencias_tecnicas: Array.isArray(data.competencias_tecnicas) ? data.competencias_tecnicas : [],
          habilidades_blandas: Array.isArray(data.habilidades_blandas) ? data.habilidades_blandas : [],
          herramientas: Array.isArray(data.herramientas) ? data.herramientas : [],

          // Secciones Finales
          plus: data.plus || "Sin informaci√≥n adicional.",
          formacion_sugerida: data.formacion_sugerida || "Ninguna espec√≠fica.",
          conclusion_final: data.recomendacion_final || data.conclusion_final || "",
          responsable: data.responsable || "Admin"
      };

      // 4. RENDERIZAR DOCUMENTO
      doc.render(payload);

      // 5. GENERAR Y ENVIAR
      const buf = doc.getZip().generate({
          type: "nodebuffer",
          compression: "DEFLATE",
      });

      // Limpiamos el nombre del archivo para que no tenga caracteres raros
      const safeName = (data.nombre || "Candidato").replace(/[^a-zA-Z0-9 ]/g, "").replace(/\s+/g, "_");
      const filename = `Informe_${safeName}.docx`;
      
      res.setHeader("Content-Disposition", `attachment; filename=${filename}`);
      res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
      res.send(buf);

  } catch (e) {
      console.error("‚ùå Error generando Word con plantilla:", e);
      // Si hay error de etiquetas, mostramos cu√°l es para ayudar a depurar
      if (e.properties && e.properties.errors) {
           e.properties.errors.forEach(err => console.error(`   - ${err.message}`));
      }
      res.status(500).json({ error: "Error al generar el documento. Verifica que 'plantilla.docx' exista y las etiquetas coincidan." });
  }
});

// 3. Normalizaci√≥n de texto b√°sica
function normalizeText(str) {
  return String(str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
}

// 4. Extracci√≥n simple de nombre (Fallback)
function extractNameFromBody(body, { knownEmail }) {
  // Intento muy b√°sico si no viene de Zoho
  if (knownEmail) return knownEmail.split("@")[0].replace(/[._]/g, " ");
  return "Candidato Desconocido";
}

// 5. Placeholder para audio (para que no rompa si falta ffmpeg)
async function extractAudioMono16k(videoPath) {
    // Si no ten√©s ffmpeg instalado en Render, esto va a fallar.
    // Retornamos null para que el c√≥digo siga sin transcripci√≥n.
    return null; 
}

// ==========================================
// üé• FUNCIONES DE AN√ÅLISIS DE VIDEO Y CV
// ==========================================

// Funci√≥n para verificar si un link de video es p√∫blico y accesible
async function verificarLinkVideoPublico(videoUrl) {
  try {
    // Hacemos un HEAD request para verificar sin descargar el archivo completo
    const response = await axios.head(videoUrl, {
      timeout: 5000,
      maxRedirects: 5,
      validateStatus: (status) => status < 400 // Acepta 2xx y 3xx
    });
    
    // Verificamos que el Content-Type sea de video
    const contentType = response.headers['content-type'] || '';
    const esVideo = contentType.startsWith('video/') || 
                     videoUrl.includes('drive.google.com') || 
                     videoUrl.includes('youtube.com') ||
                     videoUrl.includes('youtu.be');
    
    return {
      esPublico: true,
      esVideo: esVideo,
      contentType: contentType
    };
  } catch (error) {
    // Si falla, probablemente el link es privado o no accesible
    return {
      esPublico: false,
      esVideo: false,
      error: error.message
    };
  }
}

// Funci√≥n para generar rese√±a del CV
async function generarResenaCV(textoCV, puesto) {
  try {
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
    
    const prompt = `
      ACT√öA COMO: Reclutador Senior de Global Talent Connections.
      TAREA: Generar una rese√±a profesional y concisa del CV del candidato.
      
      CV DEL CANDIDATO (para el puesto de "${puesto}"):
      ${textoCV.slice(0, 15000)}
      
      GENERA UNA RESE√ëA que incluya:
      1. Experiencia relevante (a√±os, roles principales)
      2. Habilidades t√©cnicas destacadas
      3. Fortalezas del perfil
      4. Posibles debilidades o gaps
      
      Formato: P√°rrafo de 3-5 l√≠neas, profesional y objetivo.
      NO incluyas score ni recomendaciones, solo la rese√±a descriptiva.
    `;
    
    const result = await model.generateContent(prompt);
    const rese√±a = result.response.text().trim();
    
    return rese√±a;
  } catch (error) {
    console.error("‚ùå Error generando rese√±a del CV:", error.message);
    return "Error al generar rese√±a del CV. Revisar manualmente.";
  }
}

// Funci√≥n para procesar video y generar rese√±a
async function generarResenaVideo(videoUrl, puesto) {
  try {
    // Primero verificamos si el link es p√∫blico
    const verificacion = await verificarLinkVideoPublico(videoUrl);
    
    if (!verificacion.esPublico) {
      return {
        rese√±a: null,
        error: "El link del video no es p√∫blico o no es accesible. El candidato debe compartir el link como p√∫blico.",
        linkPublico: false
      };
    }
    
    if (!verificacion.esVideo && !videoUrl.includes('drive.google.com') && !videoUrl.includes('youtube.com')) {
      return {
        rese√±a: null,
        error: "El link no parece ser un video v√°lido.",
        linkPublico: true
      };
    }
    
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
    
    const prompt = `
      ACT√öA COMO: Reclutador Senior de Global Talent Connections.
      TAREA: Analizar el video de presentaci√≥n del candidato y generar una rese√±a profesional.
      
      CONTEXTO: Candidato postulando para el puesto de "${puesto}".
      
      ANALIZA EL VIDEO y genera una rese√±a que incluya:
      1. Comunicaci√≥n verbal (claridad, fluidez, profesionalismo)
      2. Presentaci√≥n personal (imagen, actitud)
      3. Contenido del mensaje (qu√© dice sobre su experiencia/motivaci√≥n)
      4. Nivel de ingl√©s (si habla en ingl√©s)
      5. Impresi√≥n general
      
      Formato: P√°rrafo de 3-5 l√≠neas, profesional y objetivo.
      NO incluyas score ni recomendaciones, solo la rese√±a descriptiva.
    `;
    
    // Gemini puede procesar video desde URL directamente
    // Nota: Gemini 2.5 Flash acepta videos desde URLs p√∫blicas
    // Usamos la sintaxis de partes m√∫ltiples: texto + video
    const parts = [
      { text: prompt },
      { 
        fileData: {
          fileUri: videoUrl,
          mimeType: "video/mp4"
        }
      }
    ];
    
    const result = await model.generateContent(parts);
    
    const rese√±a = result.response.text().trim();
    
    return {
      rese√±a: rese√±a,
      error: null,
      linkPublico: true
    };
  } catch (error) {
    console.error("‚ùå Error procesando video:", error.message);
    
    // Si el error es de acceso, probablemente el link es privado
    if (error.message.includes('403') || error.message.includes('permission') || error.message.includes('access')) {
      return {
        rese√±a: null,
        error: "El link del video no es p√∫blico o no es accesible. El candidato debe compartir el link como p√∫blico.",
        linkPublico: false
      };
    }
    
    return {
      rese√±a: null,
      error: `Error al procesar video: ${error.message}`,
      linkPublico: null
    };
  }
}

// ==========================================
// üß† CEREBRO IA: CLASIFICADOR VIVIANA/GLADYMAR/SANDRA (FINAL CON FLAGS)
// ==========================================
async function verificaConocimientosMinimos(puesto, textoCandidato, declaraciones = "", rese√±aCV = null, rese√±aVideo = null) {
  try {
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); 

    // Construir el prompt con las rese√±as si est√°n disponibles
    let fuentesInfo = `[DATOS T√âCNICOS Y RESPUESTAS DEL FORMULARIO]:\n${textoCandidato.slice(0, 15000)}`;
    
    if (rese√±aCV) {
      fuentesInfo += `\n\n[RESE√ëA DEL CV (An√°lisis Profesional)]:\n${rese√±aCV}`;
    }
    
    if (rese√±aVideo) {
      fuentesInfo += `\n\n[RESE√ëA DEL VIDEO DE PRESENTACI√ìN (An√°lisis Profesional)]:\n${rese√±aVideo}`;
    }

    const prompt = `
      ACT√öA COMO: Reclutador Senior de Global Talent Connections (Criterio Unificado).
      TU OBJETIVO: Evaluar a este candidato para el puesto de "${puesto}" y asignar Score + Alertas.
      
      === FUENTES DE INFORMACI√ìN ===
      ${fuentesInfo}

      === üõë REGLAS DE ORO (FILTROS DE MUERTE S√öBITA) ===
      Si detectas estos casos, el Score debe ser < 40 y DEBES AGREGAR LA ALERTA (Flag) correspondiente:
      
      1. RECHAZO DE SALARIO: Pide m√°s del presupuesto o dice "no".
         -> ACCI√ìN: Score 0. Flag OBLIGATORIA: "Rechazo Salario".
      2. RECHAZO DE MONITOREO: Se niega a usar Time Doctor/Trackers.
         -> ACCI√ìN: Score 0. Flag OBLIGATORIA: "Rechazo Monitoreo".
      3. DISPONIBILIDAD: No tiene disponibilidad inmediata o full-time.
         -> ACCI√ìN: Score 0. Flag OBLIGATORIA: "Sin Disponibilidad".
      4. DOBLE EMPLEO (Criterio Gladymar): Indica que mantendr√° otro trabajo.
         -> ACCI√ìN: Score 40-50. Flag OBLIGATORIA: "Doble Empleo".
      5. ACTITUD: Respuestas arrogantes o agresivas.
         -> ACCI√ìN: Score < 50. Flag OBLIGATORIA: "Mala Actitud".

      === üìã CRITERIOS DE PERFIL ===
      > SENIORITY: Junior (1-2), Semi-Senior (2-5), Senior (+5).
      > ROLES:
        - Automatizaci√≥n: Experiencia REAL en Make/Zapier.
        - Dev Web: Stack moderno + Portafolio.

      === üßÆ SALIDA JSON EXACTA ===
      Responde SOLO con este JSON:
      {
        "score": (0-100),
        "pasa": (true si score >= 70),
        "motivos": "Frase de 1 l√≠nea justificando el score.",
        "alertas": ["Array", "de", "Strings", "con", "las", "Flags", "detectadas"]
      }
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();
    
    // Limpieza de JSON por si la IA agrega texto extra
    const firstBrace = text.indexOf("{");
    const lastBrace = text.lastIndexOf("}");
    if (firstBrace !== -1 && lastBrace !== -1) {
        text = text.substring(firstBrace, lastBrace + 1);
    }

    const jsonFinal = JSON.parse(text);
    
    // Aseguramos que 'alertas' siempre sea un array (por seguridad del frontend)
    if (!Array.isArray(jsonFinal.alertas)) jsonFinal.alertas = [];

    return jsonFinal;

  } catch (e) {
    console.error("‚ùå Error en verificaConocimientosMinimos:", e.message);
    return { score: 50, pasa: false, motivos: "Error de an√°lisis IA. Revisar manual.", alertas: ["Error IA"] };
  }
}
// ==========================================
// üì® WEBHOOK ZOHO: CREACI√ìN BLINDADA (ANTI-CRASH + VIDEO)
// ==========================================
app.post("/webhook/zoho", upload.none(), async (req, res) => {
  try {
    console.log("üì® [Webhook] Datos recibidos de Zoho.");
    await registrarEstadoWebhook("zoho_form1", true); // Registro de ejecuci√≥n exitosa
    
    // 1. Detecci√≥n Inteligente del Payload (Por si llega encapsulado)
    let data = req.body;
    if (data.payload) {
        try { data = JSON.parse(data.payload); } catch(e) {}
    } else if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch(e) {}
    }
    
    // üîç LOG PARA DEBUG: Ver todos los campos relacionados con video
    const camposVideo = Object.keys(data).filter(k => 
        k.toLowerCase().includes('video') || 
        k.toLowerCase().includes('file') ||
        k.toLowerCase().includes('attachment')
    );
    if (camposVideo.length > 0) {
        console.log("üé• Campos relacionados con video encontrados:", camposVideo);
        camposVideo.forEach(campo => {
            console.log(`   ${campo}:`, typeof data[campo] === 'object' ? JSON.stringify(data[campo]).substring(0, 100) : data[campo]);
        });
    }

    // 2. SANITIZACI√ìN ID
    const emailRaw = (data.Email || "").trim().toLowerCase();
    if (!emailRaw) return res.status(400).send("Falta Email");
    
    // ID √öNICO
    const safeId = emailRaw.replace(/[^a-z0-9]/g, "_");

    // 3. FECHA EXACTA
    const nowISO = new Date().toISOString();

    // 4. OBJETO BASE (CON SEGURIDAD ANTI-CRASH || "")
    
    // üî• DETECCI√ìN INTELIGENTE DE VIDEO
    // Zoho puede enviar video de dos formas:
    // 1. Link directo (Video_Link): "https://drive.google.com/..."
    // 2. Archivo subido: Puede venir como Video_File, Video_Attachment, Video_URL, etc.
    let videoUrl = "";
    let videoTipo = "ninguno"; // "link" | "archivo" | "ninguno"
    
    // Prioridad 1: Link directo (campo Video_Link)
    if (data.Video_Link && data.Video_Link.trim() && data.Video_Link.startsWith('http')) {
      videoUrl = data.Video_Link.trim();
      videoTipo = "link";
    }
    // Prioridad 2: Otros campos posibles de Zoho para video subido
    else if (data.Video_File || data.Video_Attachment || data.Video_URL || data.Video) {
      // Si es un link de Zoho para descargar el archivo
      const videoField = data.Video_File || data.Video_Attachment || data.Video_URL || data.Video;
      if (typeof videoField === 'string' && videoField.startsWith('http')) {
        videoUrl = videoField;
        videoTipo = "archivo";
      } else if (typeof videoField === 'object' && videoField.url) {
        videoUrl = videoField.url;
        videoTipo = "archivo";
      } else {
        // Si es un objeto con m√°s info, guardamos la info completa para procesar despu√©s
        videoUrl = JSON.stringify(videoField);
        videoTipo = "archivo";
      }
    }
    
    // Log para debugging
    if (videoUrl) {
      console.log(`üé• Video detectado (${videoTipo}): ${videoUrl.substring(0, 50)}...`);
    }
    
    const candidato = {
      id: safeId,
      nombre: `${data.Nombre_Completo || ""} ${data.Apellido || ""}`.trim(),
      email: emailRaw,
      telefono: data.Telefono || "",
      puesto: data.Puesto_Solicitado || "General",
      
      // Video Link (Mejorado para manejar links y archivos)
      video_url: videoUrl,
      video_tipo: videoTipo, // Guardamos el tipo para referencia 
      
      respuestas_filtro: {
        // Aqu√≠ aplicamos la seguridad para que no explote Firestore si falta algo
        salario: data.Acepta_Salario || "",
        monitoreo: data.Acepta_Monitoreo || "",
        disponibilidad: data.Disponibilidad || "",
        herramientas: data.Top_Herramientas || "",
        logro_destacado: data.Logro_Destacado || ""
      },

      // ESTADO INICIAL
      ia_score: 0,
      ia_status: "waiting_cv", 
      ia_motivos: "Esperando recepci√≥n de CV para an√°lisis completo.",
      
      cv_url: "", 
      tiene_pdf: false,
      
      // ETIQUETAS DE ESTADO
      stage: 'stage_1',           
      status_interno: 'new',      
      
      creado_en: admin.firestore.FieldValue.serverTimestamp(),
      origen: "webhook_zoho_passive",

      // HISTORIAL INICIAL
      historial_movimientos: [
        {
            date: nowISO,
            event: 'Ingreso por Zoho',
            detail: 'Candidato recibido desde formulario web (Zoho Form 1)',
            usuario: 'Sistema (Zoho)'
        }
      ]
    };

    // 5. GUARDAR EN FIRESTORE
    await firestore.collection("CVs_staging").doc(safeId).set(candidato, { merge: true });

    console.log(`‚úÖ [Webhook] Candidato ${safeId} guardado correctamente.`);
    await registrarEstadoWebhook("zoho_form1", true); // Confirmaci√≥n final de √©xito
    res.status(200).send("OK");

  } catch (error) {
    console.error("‚ùå Error Webhook:", error);
    await registrarEstadoWebhook("zoho_form1", false, error.message); // Registro de error
    res.status(500).send("Error interno: " + error.message);
  }
});
// ==========================================
// üìä HELPER: REGISTRAR ESTADO DE WEBHOOK
// ==========================================
async function registrarEstadoWebhook(webhookName, exito, error = null) {
  try {
    const ahora = new Date().toISOString();
    const estadoDoc = {
      webhook: webhookName, // "zoho_form1" o "zoho_form2"
      ultima_ejecucion: ahora,
      exito: exito,
      error: error || null,
      timestamp: admin.firestore.FieldValue.serverTimestamp()
    };
    
    // Guardamos en una colecci√≥n separada para no mezclar con candidatos
    await firestore.collection("webhook_status").doc(webhookName).set(estadoDoc, { merge: true });
    
    // Tambi√©n guardamos en un historial para tener registro de errores recientes
    if (!exito) {
      await firestore.collection("webhook_status").doc(webhookName)
        .collection("errores_recientes").add({
          fecha: ahora,
          error: error,
          timestamp: admin.firestore.FieldValue.serverTimestamp()
        });
    }
  } catch (e) {
    console.error(`Error guardando estado de ${webhookName}:`, e);
  }
}
// ==========================================================================
// üì• NUEVA FUNCI√ìN: CARGA MANUAL CON CLASIFICACI√ìN (Persistente)
// ==========================================================================
// Reutilizamos 'upload' que ya tienes configurado con Multer (Fuente 118)

app.post("/candidatos/ingreso-manual", upload.single('cv'), async (req, res) => {
  try {
      console.log("‚ö° Iniciando carga manual persistente...");
      
      // 1. Validaciones Iniciales
      if (!req.file) return res.status(400).json({ error: "Falta el archivo PDF" });
      const { email, nombre, puesto } = req.body; // Datos que vienen del formulario manual
      
      // Generamos un ID seguro igual que en el correo (Fuente 74)
      const emailSafe = (email || "manual_no_email").trim().toLowerCase();
      const safeId = emailSafe.replace(/[^a-z0-9]/g, "_") + "_" + Date.now().toString().slice(-4);
      
      console.log(`üìÇ Procesando ingreso manual para ID: ${safeId}`);

      // 2. Subir a Google Cloud Storage (Igual que Fuente 75)
      // Esto permite que el "Analista Profundo" pueda leer el archivo despu√©s.
      const destFileName = `CVs_staging/files/${safeId}_CV.pdf`;
      const bucketFile = bucket.file(destFileName);
      
      // Leemos el archivo desde la ruta temporal de Multer
      const fs = require('fs');
      const fileBuffer = fs.readFileSync(req.file.path);
      
      await bucketFile.save(fileBuffer, { metadata: { contentType: "application/pdf" } });
      
      // Generamos URL firmada para el dashboard
      const [publicCvUrl] = await bucketFile.getSignedUrl({ action: 'read', expires: '01-01-2035' });

      // 3. Extraer Texto para la IA (Igual que Fuente 76)
      const pdfData = await pdfParse(fileBuffer);
      const textoCV = pdfData.text.slice(0, 20000); // L√≠mite de caracteres

      // 4. Ejecutar el Clasificador (IA) (Igual que Fuente 77-79)
      // Usamos tu funci√≥n existente 'verificaConocimientosMinimos' o el prompt directo
      // Aqu√≠ reutilizo la l√≥gica de Score que ya tienes implementada
      console.log("ü§ñ Ejecutando Clasificador IA...");
      
      // NOTA: Reutilizamos la funci√≥n verificaConocimientosMinimos que est√° en tu c√≥digo (Fuente 176)
      // Si no tienes esa funci√≥n exportada, usamos la l√≥gica directa.
      const analisisIA = await verificaConocimientosMinimos(
          puesto || "General", 
          textoCV
      );

      // 5. Guardar en Firestore (La Verdad √önica - Fuente 80)
      const nombreUsuario = req.body.usuario_accion || req.body.responsable || "Admin";
      
      const nuevoCandidato = {
          id: safeId,
          nombre: nombre || "Candidato Manual",
          email: emailSafe,
          puesto: puesto || "Sin especificar",
          
          // Datos del Archivo
          cv_url: publicCvUrl,
          cv_storage_path: destFileName,
          tiene_pdf: true,
          texto_extraido: textoCV, // Guardamos texto para no gastar OCR despu√©s
          
          // Datos de IA (Clasificaci√≥n Inicial)
          ia_score: analisisIA.score || 50,
          ia_motivos: analisisIA.motivos || "Ingresado manualmente",
          ia_alertas: analisisIA.alertas || [],
          ia_status: "processed",
          
          // Metadatos
          origen: "carga_manual",
          creado_en: admin.firestore.FieldValue.serverTimestamp(),
          actualizado_en: admin.firestore.FieldValue.serverTimestamp(),
          
          // ETIQUETAS DE ESTADO
          stage: 'stage_1',
          status_interno: 'new',
          
          // HISTORIAL INICIAL
          historial_movimientos: [
            {
                date: new Date().toISOString(),
                event: 'Ingreso Manual',
                detail: `Candidato cargado manualmente por: ${nombreUsuario}`,
                usuario: nombreUsuario
            }
          ]
      };

      // Escribimos en la colecci√≥n maestra (MAIN_COLLECTION definida en Fuente 29)
      await firestore.collection("CVs_staging").doc(safeId).set(nuevoCandidato);

      // Limpieza del archivo temporal local
      try { fs.unlinkSync(req.file.path); } catch(e) {}

      console.log(`‚úÖ Candidato manual guardado: ${safeId} - Score: ${analisisIA.score}`);
      res.json({ ok: true, id: safeId, score: analisisIA.score });

  } catch (error) {
      console.error("‚ùå Error en carga manual:", error);
      res.status(500).json({ error: error.message });
  }
});

// ==========================================
// üìä ENDPOINT: ESTADO DE WEBHOOKS (ANTES DE STATIC PARA QUE NO SE INTERCEPTE)
// ==========================================
app.get("/webhooks/status", async (req, res) => {
  try {
    const ahora = new Date();
    const hace24Horas = new Date(ahora.getTime() - 24 * 60 * 60 * 1000);
    const hace48Horas = new Date(ahora.getTime() - 48 * 60 * 60 * 1000);
    
    const webhooks = ["zoho_form1", "zoho_form2"];
    const estados = {};
    
    for (const webhookName of webhooks) {
      const docRef = firestore.collection("webhook_status").doc(webhookName);
      const doc = await docRef.get();
      
      if (!doc.exists) {
        // Si nunca se ejecut√≥, est√° rojo
        estados[webhookName] = {
          status: "rojo",
          razon: "Nunca se ha ejecutado",
          ultima_ejecucion: null
        };
        continue;
      }
      
      const data = doc.data();
      const ultimaEjecucion = data.ultima_ejecucion ? new Date(data.ultima_ejecucion) : null;
      
      // Contar errores recientes (√∫ltimas 24 horas)
      const erroresRef = docRef.collection("errores_recientes");
      const erroresSnap = await erroresRef
        .where("fecha", ">=", hace24Horas.toISOString())
        .get();
      const cantidadErrores = erroresSnap.size;
      
      // L√ìGICA: Verde o Rojo
      let status = "verde";
      let razon = "Funcionando correctamente";
      
      if (!ultimaEjecucion) {
        status = "rojo";
        razon = "Sin registro de ejecuci√≥n";
      } else if (ultimaEjecucion < hace48Horas) {
        status = "rojo";
        razon = `√öltima ejecuci√≥n hace m√°s de 48 horas (${Math.round((ahora - ultimaEjecucion) / (1000 * 60 * 60))} horas)`;
      } else if (cantidadErrores >= 3) {
        status = "rojo";
        razon = `${cantidadErrores} errores en las √∫ltimas 24 horas`;
      } else if (!data.exito) {
        status = "rojo";
        razon = data.error || "√öltima ejecuci√≥n fall√≥";
      } else if (ultimaEjecucion < hace24Horas) {
        status = "amarillo"; // Opcional: estado intermedio
        razon = `√öltima ejecuci√≥n hace ${Math.round((ahora - ultimaEjecucion) / (1000 * 60 * 60))} horas`;
      }
      
      estados[webhookName] = {
        status: status,
        razon: razon,
        ultima_ejecucion: ultimaEjecucion ? ultimaEjecucion.toISOString() : null,
        cantidad_errores_24h: cantidadErrores
      };
    }
    
    res.json(estados);
  } catch (error) {
    console.error("Error obteniendo estado de webhooks:", error);
    res.status(500).json({ error: error.message });
  }
});

// ==========================================
// üß™ ENDPOINT DE PRUEBA: CANDIDATO COMPLETO PARA TESTING
// ==========================================
// Handler GET para mostrar instrucciones si acceden desde navegador
app.get("/test/candidato-completo", (req, res) => {
  res.json({
    mensaje: "Este endpoint requiere m√©todo POST",
    instrucciones: [
      "Desde terminal: curl -X POST http://localhost:3001/test/candidato-completo",
      "O usa un cliente REST como Postman/Insomnia",
      "O ejecuta: fetch('/test/candidato-completo', {method: 'POST'}) desde la consola del navegador"
    ]
  });
});

app.post("/test/candidato-completo", async (req, res) => {
  try {
    console.log("üß™ Creando candidato de prueba completo...");
    
    // Generar ID √∫nico para el candidato de prueba
    const testId = `test_candidato_${Date.now()}`;
    const nowISO = new Date().toISOString();
    
    // Texto de CV de ejemplo (simulado)
    const textoCVEjemplo = `
    PERFIL PROFESIONAL
    Desarrollador Full Stack con 5 a√±os de experiencia en React, Node.js y bases de datos.
    
    EXPERIENCIA LABORAL
    - Desarrollador Senior en TechCorp (2020-2024)
      * Desarrollo de aplicaciones web con React y TypeScript
      * Implementaci√≥n de APIs REST con Node.js y Express
      * Gesti√≥n de bases de datos MongoDB y PostgreSQL
      * Liderazgo de equipo de 3 desarrolladores
    
    HABILIDADES T√âCNICAS
    - Frontend: React, TypeScript, HTML5, CSS3, Tailwind CSS
    - Backend: Node.js, Express, REST APIs
    - Bases de Datos: MongoDB, PostgreSQL, MySQL
    - Herramientas: Git, Docker, AWS
    
    EDUCACI√ìN
    - Ingenier√≠a en Sistemas, Universidad Nacional (2015-2019)
    `;
    
    // Transcripci√≥n de entrevista de ejemplo
    const transcripcionEjemplo = `
    ENTREVISTADOR: Hola, gracias por venir. Cu√©ntame sobre tu experiencia con React.
    
    CANDIDATO: Tengo 5 a√±os trabajando con React. He desarrollado aplicaciones complejas con hooks, 
    context API, y √∫ltimamente estoy usando Next.js para proyectos m√°s grandes. Tambi√©n tengo 
    experiencia con TypeScript que me ayuda mucho con el tipado.
    
    ENTREVISTADOR: ¬øC√≥mo manejas el estado en aplicaciones grandes?
    
    CANDIDATO: Depende del caso. Para estado local uso useState, para estado compartido uso Context 
    o Redux cuando es necesario. En proyectos recientes he usado Zustand que es m√°s ligero.
    
    ENTREVISTADOR: ¬øTienes experiencia con bases de datos?
    
    CANDIDATO: S√≠, he trabajado con MongoDB en proyectos NoSQL y PostgreSQL para datos relacionales. 
    Tambi√©n he dise√±ado esquemas y optimizado queries.
    
    ENTREVISTADOR: ¬øCu√°l es tu nivel de ingl√©s?
    
    CANDIDATO: Tengo nivel B2, puedo comunicarme bien en ingl√©s t√©cnico y participar en reuniones 
    con equipos internacionales.
    `;
    
    // Respuestas Form 1 (simuladas)
    const respuestasForm1 = {
      salario: "S√≠, acepta el rango salarial",
      monitoreo: "S√≠, acepta monitoreo",
      disponibilidad: "Tiempo completo, horario flexible",
      herramientas: "React, Node.js, MongoDB, PostgreSQL, TypeScript",
      logro_destacado: "Lider√© el desarrollo de una plataforma que aument√≥ las ventas en 40%"
    };
    
    // Respuestas Form 2 (simuladas)
    const respuestasForm2 = {
      experiencia_react: "5 a√±os",
      proyectos_complejos: "S√≠, he desarrollado aplicaciones con m√°s de 50 componentes",
      manejo_estado: "useState, Context API, Redux, Zustand",
      nivel_ingles: "B2 - Intermedio-Avanzado",
      disponibilidad_horaria: "Tiempo completo, horario flexible"
    };
    
    // An√°lisis inicial de IA (simulado)
    const analisisInicial = await verificaConocimientosMinimos(
      "Desarrollador Full Stack",
      textoCVEjemplo
    );
    
    // Crear candidato completo en stage_1
    const candidatoCompleto = {
      id: testId,
      nombre: "Juan P√©rez (TEST)",
      email: `test_${Date.now()}@example.com`,
      puesto: "Desarrollador Full Stack",
      telefono: "+54 11 1234-5678",
      
      // CV y texto
      texto_extraido: textoCVEjemplo,
      cv_url: "", // Sin CV real para prueba
      tiene_pdf: false,
      
      // Respuestas de formularios
      respuestas_filtro: respuestasForm1,
      respuestas_form2: {
        data: respuestasForm2,
        fecha_recepcion: nowISO
      },
      process_step_2_form: "received",
      
      // Datos de IA
      ia_score: Math.min(analisisInicial.score || 75, 80), // M√°ximo 80 en stage_1
      ia_motivos: analisisInicial.motivos || "Candidato con experiencia s√≥lida en tecnolog√≠as requeridas",
      ia_alertas: analisisInicial.alertas || [],
      ia_status: "processed",
      
      // Estado inicial
      stage: 'stage_1',
      status_interno: 'new',
      assignedTo: null,
      
      // Datos de entrevista (para cuando pase a stage_2)
      meet_link: "https://meet.google.com/test-abc-defg-hij",
      transcripcion_entrevista: transcripcionEjemplo, // Guardamos con este nombre (se mapea a interview_transcript en /buscar)
      interview_transcript: transcripcionEjemplo, // Tambi√©n guardamos con el nombre que espera el frontend
      
      // Metadatos
      origen: "test_completo",
      creado_en: admin.firestore.FieldValue.serverTimestamp(),
      actualizado_en: admin.firestore.FieldValue.serverTimestamp(),
      
      // Historial inicial
      historial_movimientos: [
        {
          date: nowISO,
          event: 'Ingreso al Pipeline',
          detail: 'Candidato de prueba creado autom√°ticamente',
          usuario: 'Sistema'
        }
      ]
    };
    
    // Guardar en Firestore
    await firestore.collection("CVs_staging").doc(testId).set(candidatoCompleto);
    
    console.log(`‚úÖ Candidato de prueba creado: ${testId}`);
    
    res.json({
      ok: true,
      id: testId,
      mensaje: "Candidato de prueba creado exitosamente",
      datos: {
        nombre: candidatoCompleto.nombre,
        email: candidatoCompleto.email,
        stage: candidatoCompleto.stage,
        score: candidatoCompleto.ia_score,
        tiene_form2: true,
        tiene_transcripcion: true
      },
      pasos_siguientes: [
        "1. Ve al dashboard y busca el candidato en 'Explorar' (stage_1)",
        "2. Aprueba el candidato a 'Gesti√≥n' (stage_2)",
        "3. Verifica que tenga meet_link y transcripci√≥n",
        "4. Analiza la entrevista con el bot√≥n 'Analizar con IA'",
        "5. Mueve a 'Informe' (stage_3) y genera el informe final"
      ]
    });
    
  } catch (error) {
    console.error("‚ùå Error creando candidato de prueba:", error);
    res.status(500).json({ error: error.message });
  }
});

// ==========================================
// üì¶ 2. FRONTEND (Sirve la p√°gina web)
// ==========================================
app.use(express.static(path.join(__dirname, "cliente_lite"))); 

app.get("*", (req, res) => {
  res.sendFile(path.join(__dirname, "cliente_lite", "dashboard.html"));
});
// ==========================================================================
// üìé ENDPOINT CORREGIDO: CARGA MANUAL DE ARCHIVOS (PDF/TXT)
// ==========================================================================

// Usamos nombres √∫nicos para evitar conflictos con variables de arriba
const uploadManual = multer({ storage: multer.memoryStorage() });
const pdfParser = require('pdf-parse'); 

app.post("/manual-upload", uploadManual.single('cv'), async (req, res) => {
    try {
        console.log("‚ö° Recibida petici√≥n de carga manual con archivo...");
        
        const { notas, puesto, responsable } = req.body;
        let textoCV = "";

        // Validaci√≥n: ¬øLleg√≥ el archivo?
        if (!req.file) {
            return res.status(400).json({ error: "Error: No lleg√≥ ning√∫n archivo al servidor." });
        }

        console.log(`üìÇ Procesando archivo: ${req.file.originalname} (${req.file.mimetype})`);

        // 1. Extracci√≥n de texto seg√∫n formato
        if (req.file.mimetype === "application/pdf") {
            const data = await pdfParser(req.file.buffer);
            textoCV = data.text;
        } else {
            // Asumimos texto plano o intentamos leerlo como tal
            textoCV = req.file.buffer.toString('utf-8');
        }

        // Validaci√≥n de contenido extra√≠do
        if (!textoCV || textoCV.length < 50) {
            throw new Error("El archivo parece vac√≠o o es una imagen escaneada sin texto seleccionable.");
        }

        // 2. Llamada a Gemini (Tu funci√≥n de IA existente)
        const informe = await generarDatosParaInforme(
            textoCV, 
            puesto || "Perfil Analizado Manualmente", 
            notas || "Sin notas adicionales",
            {}, // Sin form2
            "An√°lisis directo de archivo adjunto", 
            responsable || "Admin"
        );

        if (!informe) throw new Error("Gemini no devolvi√≥ resultados v√°lidos.");

        // 3. Respuesta exitosa
        res.json(informe);

    } catch (e) {
        console.error("‚ùå Error en manual-upload:", e.message);
        res.status(500).json({ error: e.message });
    }
});

// ==========================================
// üîå 3. HELPERS DE ARRANQUE Y SERVIDOR
// ==========================================

// Funci√≥n auxiliar que faltaba para verificar Storage
async function storageProbe() {
  try {
    if (!bucket) return false;
    const [exists] = await bucket.exists();
    if (exists) return true;
    console.log("‚ö†Ô∏è El bucket no existe o no es accesible.");
    return false; 
  } catch (e) {
    console.error("‚ùå Error verificando Storage:", e.message);
    return false;
  }
}
// ==========================================
// üõ†Ô∏è ENDPOINT INTELIGENTE (PATCH) - ACTUALIZA Y GUARDA HISTORIAL
// ==========================================
app.patch("/candidatos/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const updates = req.body; // Ej: { stage: 'stage_2', assignedTo: 'Gladymar' }

    if (!id || Object.keys(updates).length === 0) {
      return res.status(400).send("Faltan datos.");
    }

    // SIEMPRE apuntamos a la colecci√≥n maestra
    const docRef = firestore.collection("CVs_staging").doc(id);
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
        return res.status(404).send("Candidato no encontrado en CVs_staging");
    }

    // Preparar el objeto final de actualizaci√≥n
    let finalUpdate = {
      ...updates,
      actualizado_en: new Date().toISOString()
    };

    // üïµÔ∏è‚Äç‚ôÇÔ∏è DETECTIVE DE HISTORIAL: Trackear todos los eventos importantes
    const nombreAccion = updates.usuario_accion || updates.assignedTo || 'Sistema';
    let nuevoEvento = null;
    
    // 1. TRACKING DE STATUS_INTERNO (eventos espec√≠ficos)
    if (updates.status_interno === 'viewed') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Visto',
            detail: `Visto por: ${nombreAccion}`,
            usuario: nombreAccion
        };
    } 
    else if (updates.status_interno === 'interview_scheduled') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Link de Entrevista Enviada',
            detail: `Invitaci√≥n de Meet/Zoom enviada por: ${nombreAccion}`,
            usuario: nombreAccion
        };
    }
    else if (updates.status_interno === 'pending_form2') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Link de Formulario Enviado',
            detail: `Evaluaci√≥n t√©cnica (Form 2) enviada por: ${nombreAccion}`,
            usuario: nombreAccion
        };
    }
    // 1.5. TRACKING DE PROCESS_STEP_2_FORM (nuevo sistema)
    else if (updates.process_step_2_form === 'sent' && docSnap.data().process_step_2_form !== 'sent') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Link de Formulario Enviado',
            detail: `Evaluaci√≥n t√©cnica (Form 2) enviada por: ${nombreAccion}`,
            usuario: nombreAccion
        };
    }
    // 2. TRACKING DE CAMBIOS DE STAGE
    else if (updates.stage === 'stage_2') {
        // Siempre mostrar qui√©n lo aprob√≥, y si adem√°s se asigna, mencionarlo
        let detalle = `Aprobado por: ${nombreAccion}`;
        if (updates.assignedTo) {
            detalle += `. Asignado a: ${updates.assignedTo}`;
        }
        
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Aprobado a Gesti√≥n',
            detail: detalle,
            usuario: nombreAccion
        };
    } 
    else if (updates.stage === 'trash') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Movido a Papelera',
            detail: 'Descartado manualmente',
            usuario: nombreAccion
        };
    } 
    else if (updates.stage === 'stage_1' && docSnap.data().stage === 'trash') {
        // Solo trackear "Restaurado" si ven√≠a de papelera
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Restaurado',
            detail: 'Recuperado de Papelera a Exploraci√≥n',
            usuario: nombreAccion
        };
    } 
    else if (updates.stage === 'stage_3') {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Aprobado Informe',
            detail: 'Candidato aprobado para informe final',
            usuario: nombreAccion
        };
    }
    // 3. TRACKING DE ASIGNACI√ìN (solo si cambia assignedTo sin cambiar stage)
    else if (updates.assignedTo && !updates.stage) {
        nuevoEvento = {
            date: new Date().toISOString(),
            event: 'Asignado a Responsable',
            detail: `Asignado a: ${updates.assignedTo}`,
            usuario: nombreAccion
        };
    }

    // Si hay evento para agregar, lo guardamos
    if (nuevoEvento) {
        finalUpdate.historial_movimientos = admin.firestore.FieldValue.arrayUnion(nuevoEvento);
    }

    // Impactar en Firestore
    await docRef.update(finalUpdate);

    console.log(`‚úÖ [PATCH] Candidato ${id} actualizado en CVs_staging.`);
    res.json({ ok: true });

  } catch (error) {
    console.error("‚ùå Error actualizando candidato:", error);
    res.status(500).send("Error al actualizar.");
  }
});
// ==========================================
// üß† ENDPOINT: RE-AN√ÅLISIS POST-ENTREVISTA (FUSI√ìN DE DATOS)
// ==========================================
app.post("/candidatos/:id/analizar-entrevista", async (req, res) => {
  try {
    const { id } = req.params;
    const { transcript } = req.body; // Texto de la entrevista

    if (!transcript) return res.status(400).json({ error: "Falta la transcripci√≥n" });

    // 1. Usamos la colecci√≥n unificada
    const docRef = firestore.collection(MAIN_COLLECTION).doc(id);
    const docSnap = await docRef.get();
    
    if (!docSnap.exists) return res.status(404).json({ error: "Candidato no encontrado" });

    const data = docSnap.data();

    // 2. Prompt de Ingenier√≠a: Fusi√≥n de Contextos
    const prompt = `
      ACT√öA COMO: Reclutador Senior de Global Talent Connections.
      OBJETIVO: Recalcular el puntaje del candidato cruzando su CV original con la ENTREVISTA reci√©n realizada.

      --- CONTEXTO HIST√ìRICO ---
      PERFIL ORIGINAL (CV): "${data.puesto || 'General'}"
      AN√ÅLISIS PREVIO: "${data.ia_motivos || 'Sin an√°lisis previo'}"
      SCORE ANTERIOR: ${data.ia_score || 0}
      
      --- NUEVA EVIDENCIA (ENTREVISTA REAL) ---
      "${transcript.slice(0, 15000)}"

      --- TAREA DE FUSI√ìN ---
      1. VALIDACI√ìN: ¬øLa entrevista confirma lo que dec√≠a el CV o detectas inconsistencias/mentiras?
      2. CORRECCI√ìN: Si el candidato demostr√≥ ser mejor en vivo, SUBE el score. Si fue vago o mentiroso, B√ÅJALO.
      3. FLAGS: Genera nuevas alertas si detectas riesgos (ej: "Ingl√©s peor de lo esperado", "Dudas sobre disponibilidad").

      SALIDA JSON √öNICAMENTE:
      {
        "score": (0-100),
        "motivos": "Nuevo resumen integrando la entrevista. Ej: 'Mantiene un perfil s√≥lido en React, pero se detect√≥ nivel de ingl√©s inferior al B2 declarado en CV...'",
        "alertas": ["Alerta 1", "Alerta 2"]
      }
    `;

    // 3. Ejecuci√≥n IA
    const result = await model.generateContent(prompt);
    const responseText = result.response.text().replace(/```json/g, "").replace(/```/g, "").trim();
    
    // Extracci√≥n segura de JSON
    const jsonStart = responseText.indexOf('{');
    const jsonEnd = responseText.lastIndexOf('}');
    const analisis = JSON.parse(responseText.substring(jsonStart, jsonEnd + 1));

    // 4. Persistencia (Sobreescribimos para que la ficha quede actualizada)
    await docRef.update({
        ia_score: analisis.score,
        ia_motivos: analisis.motivos,
        ia_alertas: analisis.alertas || [],
        interview_analyzed: true,
        transcripcion_entrevista: transcript, // Guardar transcripci√≥n para el informe final
        actualizado_en: new Date().toISOString(),
        
        // HISTORIAL: Transcripci√≥n analizada
        historial_movimientos: admin.firestore.FieldValue.arrayUnion({
            date: new Date().toISOString(),
            event: 'Transcripci√≥n Analizada',
            detail: `An√°lisis post-entrevista completado. Nuevo score: ${analisis.score}/100`,
            usuario: req.body.responsable || 'Sistema'
        })
    });

    res.json({ ok: true, ...analisis });

  } catch (e) {
    console.error("Error re-analizando entrevista:", e);
    res.status(500).json({ error: e.message });
  }
});
// ==========================================
// üé£ WEBHOOK ZOHO FORM 2: VALIDACI√ìN T√âCNICA (CONECTADO)
// ==========================================
app.post("/webhook-form2", async (req, res) => {
  try {
    const data = req.body;
    console.log("üì© [Webhook Form 2] Datos recibidos:", JSON.stringify(data));
    await registrarEstadoWebhook("zoho_form2", true); // Registro de ejecuci√≥n exitosa

    // 1. Normalizar Email (Es la llave que configuramos en Zoho)
    const emailCandidate = (data.email || data.Email || "").trim().toLowerCase();
    
    if (!emailCandidate) {
        console.error("‚ùå Form 2 recibido SIN email. Imposible asociar.");
        return res.status(400).send("Falta el campo email para identificar al candidato.");
    }

    // 2. Buscar al candidato en la base de datos (CVs_staging)
    const snapshot = await firestore.collection(MAIN_COLLECTION)
        .where('email', '==', emailCandidate)
        .limit(1)
        .get();

    if (snapshot.empty) {
        console.warn(`‚ö†Ô∏è Webhook recibido pero no encontr√© candidato con email: ${emailCandidate}`);
        // Respondemos 200 a Zoho para que no se quede reintentando infinitamente
        return res.status(200).send("Candidato no encontrado en DB.");
    }

    const doc = snapshot.docs[0];
    
    // 3. Guardar las respuestas
    // Guardamos todo el objeto 'data' porque ya hiciste el trabajo duro de mapear
    // los nombres bonitos (herramienta_1, nivel_1, etc.) en Zoho.
    await doc.ref.update({
        process_step_2_form: 'received',  // üî• Enciende el sem√°foro VERDE
        respuestas_form2: {
            fecha_recepcion: new Date().toISOString(),
            data: data // Aqu√≠ va todo el paquete limpio que configuraste
        },
        actualizado_en: new Date().toISOString(),
        
        // HISTORIAL: Respuestas del Zoho 2 recibido
        historial_movimientos: admin.firestore.FieldValue.arrayUnion({
            date: new Date().toISOString(),
            event: 'Respuestas del Zoho 2 Recibido',
            detail: 'El candidato complet√≥ la validaci√≥n t√©cnica (Zoho Form 2)',
            usuario: 'Sistema (Zoho)'
        })
    });

    console.log(`‚úÖ [Webhook Form 2] Respuestas guardadas para: ${emailCandidate}`);
    await registrarEstadoWebhook("zoho_form2", true); // Confirmaci√≥n final de √©xito
    res.status(200).send("Recibido y procesado exitosamente.");

  } catch (error) {
    console.error("‚ùå Error procesando Webhook Form 2:", error);
    await registrarEstadoWebhook("zoho_form2", false, error.message); // Registro de error
    res.status(500).send("Error interno del servidor");
  }
});
// ==========================================
// üöÄ INICIO DEL SERVIDOR (CON BUCLE AUTOM√ÅTICO)
// ==========================================
app.listen(PORT, "0.0.0.0", async () => {
  console.log(`‚úÖ Servidor activo en http://0.0.0.0:${PORT}`);
  console.log("üîé Inicializando Firebase...");

  // Validaci√≥n de entorno
  const resolved = process.env.FIREBASE_STORAGE_BUCKET;
  if (!resolved) {
    console.error("‚ùå Falta FIREBASE_STORAGE_BUCKET en el archivo .env");
    return;
  }

  // Inicializaci√≥n global
  try {
      firestore = admin.firestore();
      bucket = admin.storage().bucket();
      console.log(`ü™£ Bucket en uso: ${bucket.name}`);

      // Verificamos conexi√≥n
      STORAGE_READY = await storageProbe();
      
      if (!STORAGE_READY) {
        console.warn("‚ö†Ô∏è Storage no respondi√≥ correctamente, pero el servidor seguir√° activo.");
      } else {
        console.log("‚úÖ Storage OK ‚Äî sistema operativo");
      }
      
  } catch (error) {
      console.error("‚ùå Error fatal inicializando servicios de Firebase:", error);
  }

  // üî• LA CORRECCI√ìN: CICLO INFINITO üî•
  console.log("üîå Iniciando servicio de lectura de correos (Ciclo Autom√°tico)...");
  
  // 1. Ejecutar inmediatamente al arrancar para no esperar
  analizarCorreos(); 
  
  // 2. Programar repetici√≥n cada 60 segundos (60000 ms)
  setInterval(() => {
      console.log("‚è∞ Ciclo programado: Buscando nuevos correos...");
      analizarCorreos();
  }, 60000); 
});
</file>

</files>
